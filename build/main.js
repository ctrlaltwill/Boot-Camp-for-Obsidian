/*
  Obsidian Plugin - Bundled with esbuild
  Output: plugin/main.js
*/
"use strict";var Te=Object.defineProperty;var sn=Object.getOwnPropertyDescriptor;var rn=Object.getOwnPropertyNames;var an=Object.prototype.hasOwnProperty;var on=(n,s,e)=>s in n?Te(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var ln=(n,s)=>{for(var e in s)Te(n,e,{get:s[e],enumerable:!0})},cn=(n,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of rn(s))!an.call(n,i)&&i!==e&&Te(n,i,{get:()=>s[i],enumerable:!(t=sn(s,i))||t.enumerable});return n};var dn=n=>cn(Te({},"__esModule",{value:!0}),n);var O=(n,s,e)=>(on(n,typeof s!="symbol"?s+"":s,e),e);var ei={};ln(ei,{default:()=>We});module.exports=dn(ei);var j=require("obsidian");var se="boot-camp-reviewer",W="boot-camp-widget",ie="boot-camp-browser",A="Boot Camp",le={reviewer:{showInfoByDefault:!1,dailyNewLimit:20,dailyReviewLimit:200,autoAdvanceEnabled:!0,autoAdvanceSeconds:10},scheduler:{learningStepsMinutes:[10,1440],relearningStepsMinutes:[10],requestRetention:.9},indexing:{ignoreInCodeFences:!0,idPlacement:"above"}};function Ne(n,s){let e=Array.isArray(n)?n.slice():{...n};for(let t of Object.keys(s||{})){let i=s[t];i&&typeof i=="object"&&!Array.isArray(i)?e[t]=Ne(e[t]||{},i):e[t]=i}return e}var un=/[\u200B\uFEFF]/g;function Ae(n){return(n!=null?n:"").replace(un,"")}function J(n){return Ae(n).replace(/^[\s\u00A0]+/,"").replace(/[\s\u00A0]+$/,"")}var pn=/^\^bc-(\d{9})$/,hn=/^(T|Q|A|I|MCQ|CQ|O)\s*(\||:)\s*/;function mt(n){n.registerMarkdownPostProcessor((s,e)=>{var t;try{s.dataset.bcRvRan="1";let i=(t=s.closest(".markdown-preview-view"))!=null?t:s.closest(".markdown-reading-view");if(i&&(i.dataset.bcRvRan="1"),s.closest(".cm-content")||!(!!s.closest(".markdown-preview-view")||!!s.closest(".markdown-reading-view")))return;fn(s)}catch(i){console.error("[BootCamp] readingView prettifier error",i)}},1e3)}function fn(n){var e,t;let s=mn(n);for(let i of s){if(((e=i.dataset)==null?void 0:e.bcPrettyDone)==="1"||i.closest(".bc-pretty-card"))continue;let r=(t=i.textContent)!=null?t:"",a=Ae(r);if(!/\^bc-\d{9}/.test(a))continue;i.dataset.bcPrettyCandidate="1";let o=gn(i);if(!o)continue;i.dataset.bcPrettyDone="1",o.cardEl.dataset.bcPretty="1";let l=i.parentElement;l&&l.classList.contains("el-p")&&l!==n?l.replaceWith(o.cardEl):i.replaceWith(o.cardEl)}}function mn(n){let s=[];n.tagName==="P"&&s.push(n),s.push(...Array.from(n.querySelectorAll(".el-p > p"))),s.push(...Array.from(n.querySelectorAll("p")));let e=new Set;return s.filter(t=>e.has(t)?!1:(e.add(t),!0))}function gn(n){var m;let s=yn(n);if(!s.length)return n.dataset.bcPrettyFail="no-lines",null;let e=J(ke(s[0])),t=e.match(pn);if(!t)return n.dataset.bcPrettyFail="no-anchor-match",n.dataset.bcPrettyFirst=e.slice(0,50),null;let i=t[1],r=[],a=null;for(let p=1;p<s.length;p++){let h=J(ke(s[p])),g=h.match(hn);if(g){a&&r.push(a);let f=g[1],y=g[2],v=s[p];bn(v,f,y),a={key:f,sep:y,lines:[v]},y==="|"&&ht(h)&&(ft(v),r.push(a),a=null);continue}if(!a)return n.dataset.bcPrettyFail="continuation-without-field",null;a.lines.push(s[p]),a.sep==="|"&&ht(h)&&(ft(s[p]),r.push(a),a=null)}a&&r.push(a);let o=r.some(p=>p.key==="Q"||p.key==="MCQ"||p.key==="CQ"),l=r.some(p=>p.key==="A"||p.key==="O"||p.key==="CQ");if(!o||!l)return n.dataset.bcPrettyFail="missing-q-or-a",n.dataset.bcPrettyKeys=r.map(p=>p.key).join(","),null;let d=Cn(r),u=(m=xn(r))!=null?m:`Card ${i}`;return{cardEl:_n(i,d,u,r)}}function yn(n){let s=[],e=[];for(let t of Array.from(n.childNodes)){if(t.nodeType===Node.ELEMENT_NODE&&t.tagName==="BR"){s.push(e),e=[];continue}e.push(t)}return e.length&&s.push(e),s.filter(t=>{let i=J(ke(t)),r=t.some(a=>a.nodeType===Node.ELEMENT_NODE);return i.length>0||r})}function ke(n){return n.map(s=>{var e;return(e=s.textContent)!=null?e:""}).join("")}function ht(n){return/\|[\s\u00A0\u200B\uFEFF]*$/.test(n)}function bn(n,s,e){var r;let t=new RegExp(`^[\\s\\u00A0\\u200B\\uFEFF]*${s}[\\s\\u00A0\\u200B\\uFEFF]*\\${e}[\\s\\u00A0\\u200B\\uFEFF]*`),i=wn(n);i&&(i.textContent=Ae((r=i.textContent)!=null?r:"").replace(t,""))}function ft(n){var t;let s=vn(n);if(!s)return;let e=Ae((t=s.textContent)!=null?t:"");s.textContent=e.replace(/\|[\s\u00A0]*$/,"").trimEnd()}function wn(n){var s,e;for(let t of n){if(t.nodeType===Node.TEXT_NODE){let i=t;if(J((s=i.textContent)!=null?s:"").length===0)continue;return i}if(t.nodeType===Node.ELEMENT_NODE){let i=t,r=document.createTreeWalker(i,NodeFilter.SHOW_TEXT);for(;;){let a=r.nextNode();if(!a)break;let o=a;if(J((e=o.textContent)!=null?e:"").length!==0)return o}}}return null}function vn(n){var s,e;for(let t=n.length-1;t>=0;t--){let i=n[t];if(i.nodeType===Node.TEXT_NODE){let r=i;if(J((s=r.textContent)!=null?s:"").length===0)continue;return r}if(i.nodeType===Node.ELEMENT_NODE){let r=i,a=document.createTreeWalker(r,NodeFilter.SHOW_TEXT),o=[];for(;;){let l=a.nextNode();if(!l)break;o.push(l)}for(let l=o.length-1;l>=0;l--){let d=o[l];if(J((e=d.textContent)!=null?e:"").length!==0)return d}}}return null}function Cn(n){return n.some(s=>s.key==="MCQ"||s.key==="O")?"mcq":n.some(s=>s.key==="CQ")?"cloze":"basic"}function xn(n){let s=n.find(t=>t.key==="T");return s&&s.lines.map(t=>J(ke(t))).join(`
`).trim()||null}function _n(n,s,e,t){let i=document.createElement("div");i.className="bc-pretty-card",i.dataset.bcId=n,i.dataset.bcType=s;let r=document.createElement("div");r.className="bc-pretty-card__meta";let a=document.createElement("div");a.className="bc-pretty-card__title",a.textContent=e;let o=document.createElement("div");o.className="bc-pretty-card__badge",o.textContent=s.toUpperCase(),r.appendChild(a),r.appendChild(o),i.appendChild(r);for(let l of t){if(l.key==="T")continue;let d=document.createElement("div");d.className="bc-pretty-card__section";let u=document.createElement("div");u.className="bc-pretty-card__label",u.textContent=Sn(l.key);let c=document.createElement("div");c.className="bc-pretty-card__content",l.lines.forEach((m,p)=>{for(let h of m)c.appendChild(h);p<l.lines.length-1&&c.appendChild(document.createElement("br"))}),d.appendChild(u),d.appendChild(c),i.appendChild(d)}return i}function Sn(n){switch(n){case"Q":return"Question";case"A":return"Answer";case"MCQ":return"MCQ";case"O":return"Options";case"CQ":return"Cloze";case"I":return"Info";default:return n}}var E=(n=>(n[n.New=0]="New",n[n.Learning=1]="Learning",n[n.Review=2]="Review",n[n.Relearning=3]="Relearning",n))(E||{}),M=(n=>(n[n.Manual=0]="Manual",n[n.Again=1]="Again",n[n.Hard=2]="Hard",n[n.Good=3]="Good",n[n.Easy=4]="Easy",n))(M||{}),I=class n{static card(s){return{...s,state:n.state(s.state),due:n.time(s.due),last_review:s.last_review?n.time(s.last_review):void 0}}static rating(s){if(typeof s=="string"){let e=s.charAt(0).toUpperCase(),t=s.slice(1).toLowerCase(),i=M[`${e}${t}`];if(i===void 0)throw new Error(`Invalid rating:[${s}]`);return i}else if(typeof s=="number")return s;throw new Error(`Invalid rating:[${s}]`)}static state(s){if(typeof s=="string"){let e=s.charAt(0).toUpperCase(),t=s.slice(1).toLowerCase(),i=E[`${e}${t}`];if(i===void 0)throw new Error(`Invalid state:[${s}]`);return i}else if(typeof s=="number")return s;throw new Error(`Invalid state:[${s}]`)}static time(s){let e=new Date(s);if(typeof s=="object"&&s!==null&&!Number.isNaN(Date.parse(s)||+e))return e;if(typeof s=="string"){let t=Date.parse(s);if(Number.isNaN(t))throw new Error(`Invalid date:[${s}]`);return new Date(t)}else if(typeof s=="number")return new Date(s);throw new Error(`Invalid date:[${s}]`)}static review_log(s){return{...s,due:n.time(s.due),rating:n.rating(s.rating),state:n.state(s.state),review:n.time(s.review)}}};Date.prototype.scheduler=function(n,s){return K(this,n,s)};Date.prototype.diff=function(n,s){return ce(this,n,s)};Date.prototype.format=function(){return En(this)};Date.prototype.dueFormat=function(n,s,e){return Mn(this,n,s,e)};function K(n,s,e){return new Date(e?I.time(n).getTime()+s*24*60*60*1e3:I.time(n).getTime()+s*60*1e3)}function ce(n,s,e){if(!n||!s)throw new Error("Invalid date");let t=I.time(n).getTime()-I.time(s).getTime(),i=0;switch(e){case"days":i=Math.floor(t/(24*60*60*1e3));break;case"minutes":i=Math.floor(t/(60*1e3));break}return i}function En(n){let s=I.time(n),e=s.getFullYear(),t=s.getMonth()+1,i=s.getDate(),r=s.getHours(),a=s.getMinutes(),o=s.getSeconds();return`${e}-${fe(t)}-${fe(i)} ${fe(r)}:${fe(a)}:${fe(o)}`}function fe(n){return n<10?`0${n}`:`${n}`}var Ke=[60,60,24,31,12],Ue=["second","min","hour","day","month","year"];function Mn(n,s,e,t=Ue){n=I.time(n),s=I.time(s),t.length!==Ue.length&&(t=Ue);let i=n.getTime()-s.getTime(),r=0;for(i/=1e3,r=0;r<Ke.length&&!(i<Ke[r]);r++)i/=Ke[r];return`${Math.floor(i)}${e?t[r]:""}`}var Tn=Object.freeze([M.Again,M.Hard,M.Good,M.Easy]),Nn=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function kn(n,s,e){let t=1;for(let a of Nn)t+=a.factor*Math.max(Math.min(n,a.end)-a.start,0);n=Math.min(n,e);let i=Math.max(2,Math.round(n-t)),r=Math.min(Math.round(n+t),e);return n>s&&(i=Math.max(i,s+1)),i=Math.min(i,r),{min_ivl:i,max_ivl:r}}function H(n,s,e){return Math.min(Math.max(n,s),e)}function qe(n,s){let e=Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()),t=Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate());return Math.floor((t-e)/864e5)}var An=n=>{let s=n.slice(-1),e=parseInt(n.slice(0,-1),10);if(Number.isNaN(e)||!Number.isFinite(e)||e<0)throw new Error(`Invalid step value: ${n}`);switch(s){case"m":return e;case"h":return e*60;case"d":return e*1440;default:throw new Error(`Invalid step unit: ${n}, expected m/h/d`)}},In=(n,s,e)=>{let t=s===E.Relearning||s===E.Review?n.relearning_steps:n.learning_steps,i=t.length;if(i===0||e>=i)return{};let r=t[0],a=An,o=()=>a(r),l=()=>{if(i===1)return Math.round(a(r)*1.5);let p=t[1];return Math.round((a(r)+a(p))/2)},d=p=>p<0||p>=i?null:t[p],u=p=>a(p),c={},m=d(Math.max(0,e));if(s===E.Review)return c[M.Again]={scheduled_minutes:a(m),next_step:0},c;{c[M.Again]={scheduled_minutes:o(),next_step:0},c[M.Hard]={scheduled_minutes:l(),next_step:e};let p=d(e+1);if(p){let h=u(p);h&&(c[M.Good]={scheduled_minutes:Math.round(h),next_step:e+1})}}return c};function Rn(){let n=this.review_time.getTime(),s=this.current.reps,e=this.current.difficulty*this.current.stability;return`${n}_${s}_${e}`}var Pe=(n=>(n.SCHEDULER="Scheduler",n.LEARNING_STEPS="LearningSteps",n.SEED="Seed",n))(Pe||{}),Re=class{constructor(s,e,t,i){O(this,"last");O(this,"current");O(this,"review_time");O(this,"next",new Map);O(this,"algorithm");O(this,"strategies");O(this,"elapsed_days",0);this.algorithm=t,this.last=I.card(s),this.current=I.card(s),this.review_time=I.time(e),this.strategies=i,this.init()}checkGrade(s){if(!Number.isFinite(s)||s<0||s>4)throw new Error(`Invalid grade "${s}",expected 1-4`)}init(){let{state:s,last_review:e}=this.current,t=0;s!==E.New&&e&&(t=qe(e,this.review_time)),this.current.last_review=this.review_time,this.elapsed_days=t,this.current.elapsed_days=t,this.current.reps+=1;let i=Rn;if(this.strategies){let r=this.strategies.get(Pe.SEED);r&&(i=r)}this.algorithm.seed=i.call(this)}preview(){return{[M.Again]:this.review(M.Again),[M.Hard]:this.review(M.Hard),[M.Good]:this.review(M.Good),[M.Easy]:this.review(M.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(let s of Tn)yield this.review(s)}review(s){let{state:e}=this.last,t;switch(this.checkGrade(s),e){case E.New:t=this.newState(s);break;case E.Learning:case E.Relearning:t=this.learningState(s);break;case E.Review:t=this.reviewState(s);break}return t}buildLog(s){let{last_review:e,due:t,elapsed_days:i}=this.last;return{rating:s,state:this.current.state,due:e||t,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.elapsed_days,last_elapsed_days:i,scheduled_days:this.current.scheduled_days,learning_steps:this.current.learning_steps,review:this.review_time}}},Ye=class{constructor(s){O(this,"c");O(this,"s0");O(this,"s1");O(this,"s2");let e=Ln();this.c=1,this.s0=e(" "),this.s1=e(" "),this.s2=e(" "),s==null&&(s=Date.now()),this.s0-=e(s),this.s0<0&&(this.s0+=1),this.s1-=e(s),this.s1<0&&(this.s1+=1),this.s2-=e(s),this.s2<0&&(this.s2+=1)}next(){let s=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.c=s|0,this.s2=s-this.c,this.s2}set state(s){this.c=s.c,this.s0=s.s0,this.s1=s.s1,this.s2=s.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}};function Ln(){let n=4022871197;return function(e){e=String(e);for(let t=0;t<e.length;t++){n+=e.charCodeAt(t);let i=.02519603282416938*n;n=i>>>0,i-=n,i*=n,n=i>>>0,i-=n,n+=i*4294967296}return(n>>>0)*23283064365386963e-26}}function Dn(n){let s=new Ye(n),e=()=>s.next();return e.int32=()=>s.next()*4294967296|0,e.double=()=>e()+(e()*2097152|0)*11102230246251565e-32,e.state=()=>s.state,e.importState=t=>(s.state=t,e),e}var Fn="5.2.3",qn=.9,Pn=36500,Bn=!1,Be=!0,$n=Object.freeze(["1m","10m"]),On=Object.freeze(["10m"]),ii=`v${Fn} using FSRS-6.0`,U=.001;var Ie=100,gt=.5,Hn=.1542,yt=Object.freeze([.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,Hn]),zn=2,Qn=(n,s=Be)=>[[U,Ie],[U,Ie],[U,Ie],[U,Ie],[1,10],[.001,4],[.001,4],[.001,.75],[0,4.5],[0,.8],[.001,3.5],[.001,5],[.001,.25],[.001,.9],[0,4],[0,1],[1,6],[0,n],[0,n],[s?.01:0,.8],[.1,.8]],Ge=(n,s,e=Be)=>{let t=zn;if(Math.max(0,s)>1){let r=-(Math.log(n[11])+Math.log(Math.pow(2,n[13])-1)+n[14]*.3)/s;t=H(+r.toFixed(8),.01,2)}return Qn(t,e).slice(0,n.length).map(([r,a],o)=>H(n[o]||0,r,a))};var et=(n,s=0,e=Be)=>{if(n===void 0)return[...yt];switch(n.length){case 21:return Ge(Array.from(n),s,e);case 19:return console.debug("[FSRS-6]auto fill w from 19 to 21 length"),Ge(Array.from(n),s,e).concat([0,gt]);case 17:{let t=Ge(Array.from(n),s,e);return t[4]=+(t[5]*2+t[4]).toFixed(8),t[5]=+(Math.log(t[5]*3+1)/3).toFixed(8),t[6]=+(t[6]+.5).toFixed(8),console.debug("[FSRS-6]auto fill w from 17 to 21 length"),t.concat([0,0,0,gt])}default:return console.warn("[FSRS]Invalid parameters length, using default parameters"),[...yt]}},Le=n=>{var r,a;let s=Array.isArray(n==null?void 0:n.learning_steps)?n.learning_steps:$n,e=Array.isArray(n==null?void 0:n.relearning_steps)?n.relearning_steps:On,t=(r=n==null?void 0:n.enable_short_term)!=null?r:Be,i=et(n==null?void 0:n.w,e.length,t);return{request_retention:(n==null?void 0:n.request_retention)||qn,maximum_interval:(n==null?void 0:n.maximum_interval)||Pn,w:i,enable_fuzz:(a=n==null?void 0:n.enable_fuzz)!=null?a:Bn,enable_short_term:t,learning_steps:s,relearning_steps:e}};function me(n,s){let e={due:n?I.time(n):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,learning_steps:0,state:E.New,last_review:void 0};return s&&typeof s=="function"?s(e):e}var bt=n=>{let s=typeof n=="number"?-n:-n[20],e=Math.exp(Math.pow(s,-1)*Math.log(.9))-1;return{decay:s,factor:+e.toFixed(8)}};function de(n,s,e){let{decay:t,factor:i}=bt(n);return+Math.pow(1+i*s/e,t).toFixed(8)}var Xe=class{constructor(s){O(this,"param");O(this,"intervalModifier");O(this,"_seed");O(this,"forgetting_curve");this.param=new Proxy(Le(s),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention),this.forgetting_curve=de.bind(this,this.param.w)}get interval_modifier(){return this.intervalModifier}set seed(s){this._seed=s}calculate_interval_modifier(s){if(s<=0||s>1)throw new Error("Requested retention rate should be in the range (0,1]");let{decay:e,factor:t}=bt(this.param.w);return+((Math.pow(s,1/e)-1)/t).toFixed(8)}get parameters(){return this.param}set parameters(s){this.update_parameters(s)}params_handler_proxy(){let s=this;return{set:function(e,t,i){return t==="request_retention"&&Number.isFinite(i)?s.intervalModifier=s.calculate_interval_modifier(Number(i)):t==="w"&&(i=et(i,e.relearning_steps.length,e.enable_short_term),s.forgetting_curve=de.bind(this,i),s.intervalModifier=s.calculate_interval_modifier(Number(e.request_retention))),Reflect.set(e,t,i),!0}}}update_parameters(s){let e=Le(s);for(let t in e){let i=t;this.param[i]=e[i]}}init_stability(s){return Math.max(this.param.w[s-1],.1)}init_difficulty(s){return+(this.param.w[4]-Math.exp((s-1)*this.param.w[5])+1).toFixed(8)}apply_fuzz(s,e){if(!this.param.enable_fuzz||s<2.5)return Math.round(s);let i=Dn(this._seed)(),{min_ivl:r,max_ivl:a}=kn(s,e,this.param.maximum_interval);return Math.floor(i*(a-r+1)+r)}next_interval(s,e){let t=Math.min(Math.max(1,Math.round(s*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(t,e)}linear_damping(s,e){return+(s*(10-e)/9).toFixed(8)}next_difficulty(s,e){let t=-this.param.w[6]*(e-3),i=s+this.linear_damping(t,s);return H(this.mean_reversion(this.init_difficulty(M.Easy),i),1,10)}mean_reversion(s,e){return+(this.param.w[7]*s+(1-this.param.w[7])*e).toFixed(8)}next_recall_stability(s,e,t,i){let r=M.Hard===i?this.param.w[15]:1,a=M.Easy===i?this.param.w[16]:1;return+H(e*(1+Math.exp(this.param.w[8])*(11-s)*Math.pow(e,-this.param.w[9])*(Math.exp((1-t)*this.param.w[10])-1)*r*a),U,36500).toFixed(8)}next_forget_stability(s,e,t){return+H(this.param.w[11]*Math.pow(s,-this.param.w[12])*(Math.pow(e+1,this.param.w[13])-1)*Math.exp((1-t)*this.param.w[14]),U,36500).toFixed(8)}next_short_term_stability(s,e){let t=Math.pow(s,-this.param.w[19])*Math.exp(this.param.w[17]*(e-3+this.param.w[18])),i=e>=3?Math.max(t,1):t;return+H(s*i,U,36500).toFixed(8)}next_state(s,e,t){let{difficulty:i,stability:r}=s!=null?s:{difficulty:0,stability:0};if(e<0)throw new Error(`Invalid delta_t "${e}"`);if(t<0||t>4)throw new Error(`Invalid grade "${t}"`);if(i===0&&r===0)return{difficulty:H(this.init_difficulty(t),1,10),stability:this.init_stability(t)};if(t===0)return{difficulty:i,stability:r};if(i<1||r<U)throw new Error(`Invalid memory state { difficulty: ${i}, stability: ${r} }`);let a=this.forgetting_curve(e,r),o=this.next_recall_stability(i,r,a,t),l=this.next_forget_stability(i,r,a),d=this.next_short_term_stability(r,t),u=o;if(t===1){let[m,p]=[0,0];this.param.enable_short_term&&(m=this.param.w[17],p=this.param.w[18]);let h=r/Math.exp(m*p);u=H(+h.toFixed(8),U,l)}return e===0&&this.param.enable_short_term&&(u=d),{difficulty:this.next_difficulty(i,t),stability:u}}},De=class extends Re{constructor(e,t,i,r){super(e,t,i,r);O(this,"learningStepsStrategy");let a=In;if(this.strategies){let o=this.strategies.get(Pe.LEARNING_STEPS);o&&(a=o)}this.learningStepsStrategy=a}getLearningInfo(e,t){var l,d,u,c;let i=this.algorithm.parameters;e.learning_steps=e.learning_steps||0;let r=this.learningStepsStrategy(i,e.state,this.current.state===E.Learning&&t!==M.Again&&t!==M.Hard?e.learning_steps+1:e.learning_steps),a=Math.max(0,(d=(l=r[t])==null?void 0:l.scheduled_minutes)!=null?d:0),o=Math.max(0,(c=(u=r[t])==null?void 0:u.next_step)!=null?c:0);return{scheduled_minutes:a,next_steps:o}}applyLearningSteps(e,t,i){let{scheduled_minutes:r,next_steps:a}=this.getLearningInfo(this.current,t);if(r>0&&r<1440)e.learning_steps=a,e.scheduled_days=0,e.state=i,e.due=K(this.review_time,Math.round(r),!1);else if(e.state=E.Review,r>=1440)e.learning_steps=a,e.due=K(this.review_time,Math.round(r),!1),e.scheduled_days=Math.floor(r/1440);else{e.learning_steps=0;let o=this.algorithm.next_interval(e.stability,this.elapsed_days);e.scheduled_days=o,e.due=K(this.review_time,o,!0)}}newState(e){let t=this.next.get(e);if(t)return t;let i=I.card(this.current);i.difficulty=H(this.algorithm.init_difficulty(e),1,10),i.stability=this.algorithm.init_stability(e),this.applyLearningSteps(i,e,E.Learning);let r={card:i,log:this.buildLog(e)};return this.next.set(e,r),r}learningState(e){let t=this.next.get(e);if(t)return t;let{state:i,difficulty:r,stability:a}=this.last,o=I.card(this.current);o.difficulty=this.algorithm.next_difficulty(r,e),o.stability=this.algorithm.next_short_term_stability(a,e),this.applyLearningSteps(o,e,i);let l={card:o,log:this.buildLog(e)};return this.next.set(e,l),l}reviewState(e){let t=this.next.get(e);if(t)return t;let i=this.elapsed_days,{difficulty:r,stability:a}=this.last,o=this.algorithm.forgetting_curve(i,a),l=I.card(this.current),d=I.card(this.current),u=I.card(this.current),c=I.card(this.current);this.next_ds(l,d,u,c,r,a,o),this.next_interval(d,u,c,i),this.next_state(d,u,c),this.applyLearningSteps(l,M.Again,E.Relearning),l.lapses+=1;let m={card:l,log:this.buildLog(M.Again)},p={card:d,log:super.buildLog(M.Hard)},h={card:u,log:super.buildLog(M.Good)},g={card:c,log:super.buildLog(M.Easy)};return this.next.set(M.Again,m),this.next.set(M.Hard,p),this.next.set(M.Good,h),this.next.set(M.Easy,g),this.next.get(e)}next_ds(e,t,i,r,a,o,l){e.difficulty=this.algorithm.next_difficulty(a,M.Again);let d=o/Math.exp(this.algorithm.parameters.w[17]*this.algorithm.parameters.w[18]),u=this.algorithm.next_forget_stability(a,o,l);e.stability=H(+d.toFixed(8),U,u),t.difficulty=this.algorithm.next_difficulty(a,M.Hard),t.stability=this.algorithm.next_recall_stability(a,o,l,M.Hard),i.difficulty=this.algorithm.next_difficulty(a,M.Good),i.stability=this.algorithm.next_recall_stability(a,o,l,M.Good),r.difficulty=this.algorithm.next_difficulty(a,M.Easy),r.stability=this.algorithm.next_recall_stability(a,o,l,M.Easy)}next_interval(e,t,i,r){let a,o;a=this.algorithm.next_interval(e.stability,r),o=this.algorithm.next_interval(t.stability,r),a=Math.min(a,o),o=Math.max(o,a+1);let l=Math.max(this.algorithm.next_interval(i.stability,r),o+1);e.scheduled_days=a,e.due=K(this.review_time,a,!0),t.scheduled_days=o,t.due=K(this.review_time,o,!0),i.scheduled_days=l,i.due=K(this.review_time,l,!0)}next_state(e,t,i){e.state=E.Review,e.learning_steps=0,t.state=E.Review,t.learning_steps=0,i.state=E.Review,i.learning_steps=0}},Fe=class extends Re{newState(s){let e=this.next.get(s);if(e)return e;this.current.scheduled_days=0,this.current.elapsed_days=0;let t=I.card(this.current),i=I.card(this.current),r=I.card(this.current),a=I.card(this.current);return this.init_ds(t,i,r,a),this.next_interval(t,i,r,a,0),this.next_state(t,i,r,a),this.update_next(t,i,r,a),this.next.get(s)}init_ds(s,e,t,i){s.difficulty=H(this.algorithm.init_difficulty(M.Again),1,10),s.stability=this.algorithm.init_stability(M.Again),e.difficulty=H(this.algorithm.init_difficulty(M.Hard),1,10),e.stability=this.algorithm.init_stability(M.Hard),t.difficulty=H(this.algorithm.init_difficulty(M.Good),1,10),t.stability=this.algorithm.init_stability(M.Good),i.difficulty=H(this.algorithm.init_difficulty(M.Easy),1,10),i.stability=this.algorithm.init_stability(M.Easy)}learningState(s){return this.reviewState(s)}reviewState(s){let e=this.next.get(s);if(e)return e;let t=this.elapsed_days,{difficulty:i,stability:r}=this.last,a=this.algorithm.forgetting_curve(t,r),o=I.card(this.current),l=I.card(this.current),d=I.card(this.current),u=I.card(this.current);return this.next_ds(o,l,d,u,i,r,a),this.next_interval(o,l,d,u,t),this.next_state(o,l,d,u),o.lapses+=1,this.update_next(o,l,d,u),this.next.get(s)}next_ds(s,e,t,i,r,a,o){s.difficulty=this.algorithm.next_difficulty(r,M.Again);let l=this.algorithm.next_forget_stability(r,a,o);s.stability=H(a,U,l),e.difficulty=this.algorithm.next_difficulty(r,M.Hard),e.stability=this.algorithm.next_recall_stability(r,a,o,M.Hard),t.difficulty=this.algorithm.next_difficulty(r,M.Good),t.stability=this.algorithm.next_recall_stability(r,a,o,M.Good),i.difficulty=this.algorithm.next_difficulty(r,M.Easy),i.stability=this.algorithm.next_recall_stability(r,a,o,M.Easy)}next_interval(s,e,t,i,r){let a,o,l,d;a=this.algorithm.next_interval(s.stability,r),o=this.algorithm.next_interval(e.stability,r),l=this.algorithm.next_interval(t.stability,r),d=this.algorithm.next_interval(i.stability,r),a=Math.min(a,o),o=Math.max(o,a+1),l=Math.max(l,o+1),d=Math.max(d,l+1),s.scheduled_days=a,s.due=K(this.review_time,a,!0),e.scheduled_days=o,e.due=K(this.review_time,o,!0),t.scheduled_days=l,t.due=K(this.review_time,l,!0),i.scheduled_days=d,i.due=K(this.review_time,d,!0)}next_state(s,e,t,i){s.state=E.Review,s.learning_steps=0,e.state=E.Review,e.learning_steps=0,t.state=E.Review,t.learning_steps=0,i.state=E.Review,i.learning_steps=0}update_next(s,e,t,i){let r={card:s,log:this.buildLog(M.Again)},a={card:e,log:super.buildLog(M.Hard)},o={card:t,log:super.buildLog(M.Good)},l={card:i,log:super.buildLog(M.Easy)};this.next.set(M.Again,r),this.next.set(M.Hard,a),this.next.set(M.Good,o),this.next.set(M.Easy,l)}},Ze=class{constructor(s){O(this,"fsrs");this.fsrs=s}replay(s,e,t){return this.fsrs.next(s,e,t)}handleManualRating(s,e,t,i,r,a,o){if(typeof e=="undefined")throw new Error("reschedule: state is required for manual rating");let l,d;if(e===E.New)l={rating:M.Manual,state:e,due:o!=null?o:t,stability:s.stability,difficulty:s.difficulty,elapsed_days:i,last_elapsed_days:s.elapsed_days,scheduled_days:s.scheduled_days,learning_steps:s.learning_steps,review:t},d=me(t),d.last_review=t;else{if(typeof o=="undefined")throw new Error("reschedule: due is required for manual rating");let u=ce(o,t,"days");l={rating:M.Manual,state:s.state,due:s.last_review||s.due,stability:s.stability,difficulty:s.difficulty,elapsed_days:i,last_elapsed_days:s.elapsed_days,scheduled_days:s.scheduled_days,learning_steps:s.learning_steps,review:t},d={...s,state:e,due:o,last_review:t,stability:r||s.stability,difficulty:a||s.difficulty,elapsed_days:i,scheduled_days:u,reps:s.reps+1}}return{card:d,log:l}}reschedule(s,e){let t=[],i=me(s.due);for(let r of e){let a;if(r.review=I.time(r.review),r.rating===M.Manual){let o=0;i.state!==E.New&&i.last_review&&(o=ce(r.review,i.last_review,"days")),a=this.handleManualRating(i,r.state,r.review,o,r.stability,r.difficulty,r.due?I.time(r.due):void 0)}else a=this.replay(i,r.review,r.rating);t.push(a),i=a.card}return t}calculateManualRecord(s,e,t,i){if(!t)return null;let{card:r,log:a}=t,o=I.card(s);return o.due.getTime()===r.due.getTime()?null:(o.scheduled_days=ce(r.due,o.due,"days"),this.handleManualRating(o,r.state,I.time(e),a.elapsed_days,i?r.stability:void 0,i?r.difficulty:void 0,r.due))}},Je=class extends Xe{constructor(e){super(e);O(this,"strategyHandler",new Map);O(this,"Scheduler");let{enable_short_term:t}=this.parameters;this.Scheduler=t?De:Fe}params_handler_proxy(){let e=this;return{set:function(t,i,r){return i==="request_retention"&&Number.isFinite(r)?e.intervalModifier=e.calculate_interval_modifier(Number(r)):i==="enable_short_term"?e.Scheduler=r===!0?De:Fe:i==="w"&&(r=et(r,t.relearning_steps.length,t.enable_short_term),e.forgetting_curve=de.bind(this,r),e.intervalModifier=e.calculate_interval_modifier(Number(t.request_retention))),Reflect.set(t,i,r),!0}}}useStrategy(e,t){return this.strategyHandler.set(e,t),this}clearStrategy(e){return e?this.strategyHandler.delete(e):this.strategyHandler.clear(),this}getScheduler(e,t){let r=this.strategyHandler.get(Pe.SCHEDULER)||this.Scheduler;return new r(e,t,this,this.strategyHandler)}repeat(e,t,i){let a=this.getScheduler(e,t).preview();return i&&typeof i=="function"?i(a):a}next(e,t,i,r){let a=this.getScheduler(e,t),o=I.rating(i);if(o===M.Manual)throw new Error("Cannot review a manual rating");let l=a.review(o);return r&&typeof r=="function"?r(l):l}get_retrievability(e,t,i=!0){let r=I.card(e);t=t?I.time(t):new Date;let a=r.state!==E.New?Math.max(ce(t,r.last_review,"days"),0):0,o=r.state!==E.New?this.forgetting_curve(a,+r.stability.toFixed(8)):0;return i?`${(o*100).toFixed(2)}%`:o}rollback(e,t,i){let r=I.card(e),a=I.review_log(t);if(a.rating===M.Manual)throw new Error("Cannot rollback a manual rating");let o,l,d;switch(a.state){case E.New:o=a.due,l=void 0,d=0;break;case E.Learning:case E.Relearning:case E.Review:o=a.review,l=a.due,d=r.lapses-(a.rating===M.Again&&a.state===E.Review?1:0);break}let u={...r,due:o,stability:a.stability,difficulty:a.difficulty,elapsed_days:a.last_elapsed_days,scheduled_days:a.scheduled_days,reps:Math.max(0,r.reps-1),lapses:Math.max(0,d),learning_steps:a.learning_steps,state:a.state,last_review:l};return i&&typeof i=="function"?i(u):u}forget(e,t,i=!1,r){let a=I.card(e);t=I.time(t);let o=a.state===E.New?0:ce(t,a.due,"days"),l={rating:M.Manual,state:a.state,due:a.due,stability:a.stability,difficulty:a.difficulty,elapsed_days:0,last_elapsed_days:a.elapsed_days,scheduled_days:o,learning_steps:a.learning_steps,review:t},u={card:{...a,due:t,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:i?0:a.reps,lapses:i?0:a.lapses,learning_steps:0,state:E.New,last_review:a.last_review},log:l};return r&&typeof r=="function"?r(u):u}reschedule(e,t=[],i={}){let{recordLogHandler:r,reviewsOrderBy:a,skipManual:o=!0,now:l=new Date,update_memory_state:d=!1}=i;a&&typeof a=="function"&&t.sort(a),o&&(t=t.filter(g=>g.rating!==M.Manual));let u=new Ze(this),c=u.reschedule(i.first_card||me(),t),m=c.length,p=I.card(e),h=u.calculateManualRecord(p,l,m?c[m-1]:void 0,d);return r&&typeof r=="function"?{collections:c.map(r),reschedule_item:h?r(h):null}:{collections:c,reschedule_item:h}}},wt=n=>new Je(n||{});function tt(){return{version:7,cards:{},states:{},reviewLog:[],quarantine:{}}}var $e=class{constructor(s){this.plugin=s,this.data=tt()}async load(s){var e,t;s&&s.store?this.data=s.store:this.data=tt(),(!this.data||typeof this.data!="object")&&(this.data=tt()),this.data.cards||(this.data.cards={}),this.data.states||(this.data.states={}),this.data.reviewLog||(this.data.reviewLog=[]),this.data.quarantine||(this.data.quarantine={}),Number.isFinite(this.data.version)||(this.data.version=0);for(let i of Object.values(this.data.states)){if(!i||typeof i!="object")continue;Number.isFinite(i.due)||(i.due=0),Number.isFinite(i.reps)||(i.reps=0),Number.isFinite(i.lapses)||(i.lapses=0),Number.isFinite(i.learningStepIndex)||(i.learningStepIndex=0);let r=(e=i.stage)!=null?e:"new";if(r==="new"||r==="learning"||r==="review"||r==="relearning"||r==="suspended"||(i.stage="new"),i.stage==="suspended"){i.fsrsState===void 0&&(i.fsrsState=E.New),(!Number.isFinite(i.scheduledDays)||i.scheduledDays<0)&&(i.scheduledDays=0),delete i.intervalDays,delete i.ease;continue}if(i.fsrsState===void 0&&(i.stage==="new"?i.fsrsState=E.New:i.stage==="review"?i.fsrsState=E.Review:i.stage==="relearning"?i.fsrsState=E.Relearning:i.fsrsState=((t=i.lapses)!=null?t:0)>0?E.Relearning:E.Learning),i.fsrsState===E.New?(i.stage="new",i.lastReviewed=void 0,i.stabilityDays=void 0,i.scheduledDays=0):i.fsrsState===E.Review?i.stage="review":i.fsrsState===E.Relearning?i.stage="relearning":i.fsrsState===E.Learning&&(i.stage="learning"),!Number.isFinite(i.scheduledDays)||i.scheduledDays<0){let o=i.intervalDays;Number.isFinite(o)&&o>=0?i.scheduledDays=Math.max(0,Math.floor(Number(o))):i.scheduledDays=0}else i.scheduledDays=Math.max(0,Math.floor(Number(i.scheduledDays)));delete i.intervalDays,delete i.ease}this.data.version<7&&(this.data.version=7)}async persist(){let s=await this.plugin.loadData()||{};s.settings=this.plugin.settings,s.store=this.data,await this.plugin.saveData(s)}getAllCards(){let s=this.data.quarantine||{};return Object.values(this.data.cards||{}).filter(e=>!s[String(e.id)])}getCardsByNote(s){return this.getAllCards().filter(e=>e.sourceNotePath===s)}getQuarantine(){return this.data.quarantine||{}}isQuarantined(s){return!!(this.data.quarantine&&this.data.quarantine[String(s)])}getState(s){return this.data.states[s]||null}upsertCard(s){this.data.cards[s.id]=s}upsertState(s){this.data.states[s.id]=s}appendReviewLog(s){this.data.reviewLog.push(s)}ensureState(s,e,t=2.5){this.data.states[s]||(this.data.states[s]={id:s,stage:"new",due:e,reps:0,lapses:0,learningStepIndex:0,fsrsState:E.New,scheduledDays:0});let i=this.data.states[s];if((!i.stage||i.stage==="")&&(i.stage="new"),delete i.intervalDays,delete i.ease,i.stage==="new"||i.fsrsState===E.New)i.lastReviewed=void 0,i.stabilityDays=void 0,i.scheduledDays=0;else if(!Number.isFinite(i.scheduledDays)||i.scheduledDays<0){let r=i.intervalDays;Number.isFinite(r)&&r>=0?i.scheduledDays=Math.max(0,Math.floor(Number(r))):i.scheduledDays=0}else i.scheduledDays=Math.max(0,Math.floor(Number(i.scheduledDays)));return Number.isFinite(i.due)||(i.due=e),Number.isFinite(i.reps)||(i.reps=0),Number.isFinite(i.lapses)||(i.lapses=0),Number.isFinite(i.learningStepIndex)||(i.learningStepIndex=0),i}};var V=require("obsidian");var vt=require("obsidian");function _(n,s,e){let t=document.createElement(n);return s&&(t.className=s),e!==void 0&&(t.textContent=e),t}function ge(n,s,e,t){let i=document.createElement("button");i.className="bc-btn",i.type="button",i.title=e||"";let r=_("span");r.style.display="inline-flex",r.style.alignItems="center",r.style.gap="8px";let a=_("span");return a.style.display="inline-flex",a.style.alignItems="center",(0,vt.setIcon)(a,n),r.appendChild(a),s&&r.appendChild(_("span",void 0,s)),i.appendChild(r),i.addEventListener("click",t),i}function Ct(n,s){let e=document.createElement("button");return e.className="bc-toggle",e.type="button",e.title=n?"Collapse":"Expand",e.textContent=n?"-":"+",e.addEventListener("click",t=>{t.stopPropagation(),s()}),e}function _t(n,s,e){return Math.max(s,Math.min(e,n))}function Vn(n){return n*24*60*60*1e3}function jn(n){let s=new Date(n);return s.setHours(0,0,0,0),s.setDate(s.getDate()+1),s.getTime()}var Wn=36500;function Kn(n){return n+Vn(Wn)}function xt(n){let s=Math.max(1,Math.round(n));return s%1440===0?`${s/1440}d`:s%60===0?`${s/60}h`:`${s}m`}function Un(n){var r;let s=((r=n.learningStepsMinutes)!=null?r:[]).map(xt),e=Array.isArray(n.relearningStepsMinutes)?n.relearningStepsMinutes:[],t=e.length>0?e.map(xt):[s.length?s[0]:"10m"],i=_t(Number(n.requestRetention)||.9,.8,.97);return Le({request_retention:i,maximum_interval:36500,enable_fuzz:!1,enable_short_term:!0,learning_steps:s.length?s:["10m"],relearning_steps:t})}function St(n){var s;return n.fsrsState!==void 0?n.fsrsState:n.stage==="suspended"?E.New:n.stage==="new"?E.New:n.stage==="review"?E.Review:((s=n.lapses)!=null?s:0)>0?E.Relearning:E.Learning}function Gn(n,s){var u;let e=new Date(s),t=St(n),i=Number.isFinite(n.due)?Number(n.due):s,r=t===E.New?0:Number.isFinite(n.scheduledDays)?Math.max(0,Math.floor(Number(n.scheduledDays))):0,a=Number.isFinite(n.lastReviewed)&&((u=n.lastReviewed)!=null?u:0)>0?new Date(n.lastReviewed):void 0;a&&a.getTime()>s&&(a=void 0),t===E.New&&(a=void 0),!a&&t!==E.New&&(t=E.New,a=void 0);let o=Number.isFinite(n.difficulty)?_t(Number(n.difficulty),1,10):5,l=t===E.New?0:Number.isFinite(n.stabilityDays)&&Number(n.stabilityDays)>0?Math.max(.1,Number(n.stabilityDays)):t===E.Review&&r>0?Math.max(.1,r):0,d=a&&t!==E.New?Math.max(0,qe(a,e)):0;return{due:new Date(i),stability:l,difficulty:o,elapsed_days:d,scheduled_days:r,reps:Math.max(0,n.reps||0),lapses:Math.max(0,n.lapses||0),learning_steps:Math.max(0,n.learningStepIndex||0),state:t,last_review:a}}function Yn(n,s){if(n.stage==="suspended")return{...n,due:n.due};let e=s.state===E.New?"new":s.state===E.Review?"review":s.state===E.Relearning?"relearning":"learning",t=Number.isFinite(s.scheduled_days)?Math.max(0,Math.floor(Number(s.scheduled_days))):0;return{...n,stage:e,fsrsState:s.state,due:s.due.getTime(),scheduledDays:t,reps:Math.max(0,s.reps||0),lapses:Math.max(0,s.lapses||0),learningStepIndex:Math.max(0,s.learning_steps||0),stabilityDays:Number.isFinite(s.stability)?s.stability:n.stabilityDays,difficulty:Number.isFinite(s.difficulty)?s.difficulty:n.difficulty,lastReviewed:s.last_review?s.last_review.getTime():n.lastReviewed}}function Xn(n){switch(n){case"again":return M.Again;case"hard":return M.Hard;case"good":return M.Good;case"easy":return M.Easy}}function Zn(n,s,e,t){var y,v,C,w;let i=n.due;if(n.stage==="suspended"){let b=St(n);return{nextState:n,prevDue:i,nextDue:n.due,metrics:{retrievabilityNow:null,retrievabilityTarget:null,elapsedDays:0,stabilityDays:Number((y=n.stabilityDays)!=null?y:0),difficulty:Number((v=n.difficulty)!=null?v:0),stateBefore:b,stateAfter:b}}}let r=t.scheduler,a=Un(r),o=wt(a),l=new Date(e),d=Gn(n,e),u=d.last_review&&d.state!==E.New?Math.max(0,qe(d.last_review,l)):0,c=d.last_review&&d.state!==E.New&&d.stability>0?de(a.w,u,d.stability):null,m=o.next(d,l,Xn(s)),p=Yn(n,m.card),h=m.card.due.getTime()-l.getTime(),g=Math.max(0,h/(24*60*60*1e3)),f=m.card.stability>0?de(a.w,g,m.card.stability):null;return{nextState:p,prevDue:i,nextDue:p.due,metrics:{retrievabilityNow:c,retrievabilityTarget:f,elapsedDays:u,stabilityDays:(C=p.stabilityDays)!=null?C:0,difficulty:(w=p.difficulty)!=null?w:0,stateBefore:d.state,stateAfter:m.card.state}}}function Oe(n,s,e,t){return Zn(n,s,e,t)}function Et(n,s){var i;let e=jn(s),t=Math.max(Number((i=n.due)!=null?i:0),e);return{...n,due:t}}function Mt(n,s){let e=Number.isFinite(n.due)?n.due:s;return{...n,stage:"suspended",suspendedDue:e,due:Kn(s)}}function Tt(n,s){if(n.stage!=="suspended")return n;let e=Number.isFinite(n.suspendedDue)?n.suspendedDue:s,t=n.fsrsState,i=t===E.Review?"review":t===E.Relearning?"relearning":t===E.Learning?"learning":"new";return{...n,stage:i,due:e,suspendedDue:void 0}}function Nt(n,s,e){let t=me(new Date(s));return{id:n.id,stage:"new",fsrsState:E.New,due:t.due.getTime(),reps:0,lapses:0,learningStepIndex:0,scheduledDays:0,stabilityDays:void 0,difficulty:void 0,lastReviewed:void 0,suspendedDue:void 0}}var Jn=/^\^bc-(\d{9})$/,es=/^(Q|MCQ|CQ):\s*(.*)\s*$/,kt=/^(T|A|O|I):\s*(.*)\s*$/,ts=/^(Q|MCQ|CQ)\s*\|\s*(.*)$/,ns=/^(T|A|I)\s*\|\s*(.*)$/,ss=/^T\s*\|\s*(.*)$/,nt=/^(?:\^bc-\d{9}|(?:Q|MCQ|CQ|T|A|O|I):|(?:Q|MCQ|CQ|T|A|I)\s*\|)\s*/;function is(n){let s=new Array(n.length).fill(!1),e=!1,t=null;for(let i=0;i<n.length;i++){let r=n[i].trimStart(),a=r.startsWith("```"),o=r.startsWith("~~~");if(!e&&(a||o)){e=!0,t=a?"```":"~~~",s[i]=!0;continue}e&&(s[i]=!0,t&&r.startsWith(t)&&(e=!1,t=null))}return s}function rs(n){return n&&n.replace(/[ \t]+\n/g,`
`).trim()}function ye(n){let s=n.replace(/[ \t]+$/g,"");if(!s.endsWith("|"))return{text:n,closed:!1};let e=0;for(let t=s.length-2;t>=0&&s[t]==="\\";t--)e++;return e%2===1?{text:n,closed:!1}:{text:s.slice(0,-1),closed:!0}}function be(n){return n.replace(/\\\\/g,"\\").replace(/\\\|/g,"|")}function as(n){let s=[],e="",t=!1;for(let i=0;i<n.length;i++){let r=n[i];if(t){e+=r,t=!1;continue}if(r==="\\"){t=!0;continue}if(r==="|"){s.push(e),e="";continue}e+=r}return s.push(e),s}function os(n){let s=[],e=n.replace(/\r?\n/g," ").trim(),t=e.includes("|")?as(e).map(a=>a.trim()).filter(Boolean):e.split(",").map(a=>a.trim()).filter(Boolean);t.length<2&&s.push("MCQ requires at least 2 options in O: line (separate options with |).");let i=-1,r=t.map((a,o)=>{let l=a.match(/^\*\*(.+)\*\*$/);return l?(i!==-1&&s.push("MCQ has more than one bold (correct) option."),i=o,l[1].trim()):a});return i===-1&&s.push("MCQ requires exactly one correct option wrapped in ** **."),{options:r,correctIndex:i,errors:s}}function ls(n){let s=[],e=/\{\{c(\d+)::(.*?)\}\}/g,t,i=0;for(;(t=e.exec(n))!==null;){i+=1;let r=Number(t[1]),a=(t[2]||"").trim();(!Number.isFinite(r)||r<=0)&&s.push("Cloze token has invalid number."),a||s.push("Cloze token content is empty.")}return i===0&&s.push("Cloze card requires at least one {{cN::...}} token."),s}function At(n,s,e,t,i){return{id:e||null,type:i==="Q"?"basic":i==="MCQ"?"mcq":"cloze",title:t||null,q:null,a:null,stem:null,optionsRaw:null,options:null,correctIndex:null,clozeText:null,info:null,sourceNotePath:n,sourceStartLine:s,errors:[]}}function we(n,s,e=!0){var f,y;let t=s.split(/\r?\n/),i=e?is(t):new Array(t.length).fill(!1),r=[],a=null,o=null,l=null,d=!1,u=!1,c=null,m=null,p=null,h=()=>{if(c){if(!c.title&&l&&(c.title=l,l=null),["title","q","a","stem","optionsRaw","clozeText","info"].forEach(v=>{c[v]&&(c[v]=rs(c[v]))}),!c.id&&a&&(c.id=a,a=null,o=null),c.type==="basic")c.q||c.errors.push("Missing Q:"),c.a||c.errors.push("Missing A:");else if(c.type==="mcq"){if(c.stem||c.errors.push("Missing MCQ:"),c.optionsRaw||c.errors.push("Missing O:"),c.optionsRaw){let{options:v,correctIndex:C,errors:w}=os(c.optionsRaw);c.options=v,c.correctIndex=C,w.forEach(b=>c.errors.push(b))}}else c.type==="cloze"&&(c.clozeText||c.errors.push("Missing CQ:"),c.clozeText&&ls(c.clozeText).forEach(v=>c.errors.push(v)));r.push(c),c=null,m=null,p=null}},g=(v,C,w)=>{let b=v;b[C]=(b[C]?b[C]+`
`:"")+w};for(let v=0;v<t.length;v++){let C=t[v];if(e&&i[v])continue;let w=C.trim().match(Jn);if(w){let T=w[1];c?c.id?c.id!==T&&c.errors.push(`Conflicting anchors in same card block: ^bc-${c.id} vs ^bc-${T}`):c.id=T:(a=T,o=v);continue}if(c&&p){let{text:T,closed:k}=ye(C),R=be(T);g(c,p,R),k&&(p=null,m=null);continue}if(!c&&u){let{text:T,closed:k}=ye(C),R=be(T);l=(l?l+`
`:"")+R,k&&(u=!1);continue}if(C.trim().length===0){h(),a=null,o=null,l=null,d=!1,u=!1;continue}let b=c?null:C.match(kt);if(!c&&b&&b[1]==="T"){l=(l?l+`
`:"")+(b[2]||""),d=!0,u=!1;continue}if(!c){let T=C.match(ss);if(T){let{text:k,closed:R}=ye(T[1]||""),B=be(k);l=(l?l+`
`:"")+B.trimEnd(),d=!1,u=!R;continue}}if(!c&&d&&!nt.test(C)){l=(l||"")+`
`+C;continue}let S=C.match(ts);if(S){h();let T=S[1];c=At(n,o!==null?o:v,a,l,T),a=null,o=null,l=null,d=!1,u=!1;let R=(f=S[2])!=null?f:"",{text:B,closed:P}=ye(R),L=be(B);T==="Q"&&(c.q=""),T==="MCQ"&&(c.stem=""),T==="CQ"&&(c.clozeText="");let q=T==="Q"?"q":T==="MCQ"?"stem":"clozeText";g(c,q,L),P||(p=q),m=null;continue}let x=C.match(es);if(x){h();let T=x[1],k=x[2]||"";c=At(n,o!==null?o:v,a,l,T),a=null,o=null,l=null,d=!1,u=!1,T==="Q"?(c.q=k,m="q"):T==="MCQ"?(c.stem=k,m="stem"):(c.clozeText=k,m="clozeText"),p=null;continue}let N=c?C.match(ns):null;if(N&&c){let T=N[1],k=(y=N[2])!=null?y:"",{text:R,closed:B}=ye(k),P=be(R),q={T:"title",A:"a",I:"info"}[T];c[q]=null,g(c,q,P),p=B?null:q,m=null;continue}let D=c?C.match(kt):null;if(D&&c){let T=D[1],k=D[2]||"";T==="T"?(c.title=(c.title?c.title+`
`:"")+k,m="title"):T==="A"?(c.a=(c.a?c.a+`
`:"")+k,m="a"):T==="O"?(c.optionsRaw=(c.optionsRaw?c.optionsRaw+`
`:"")+k,m="optionsRaw"):(c.info=(c.info?c.info+`
`:"")+k,m="info"),p=null;continue}if(c&&m&&!nt.test(C)){let T=c;T[m]=(T[m]?T[m]+`
`:"")+C;continue}if(c&&!p&&!m&&!nt.test(C)){h(),a=null,o=null,l=null,d=!1,u=!1;continue}c&&c.errors.push(`Unrecognised line inside card: "${C.trim().slice(0,60)}"`)}return h(),{cards:r}}function cs(){return String(Math.floor(1e8+Math.random()*9e8))}function st(n){for(let s=0;s<1e4;s++){let e=cs();if(!n.has(e))return n.add(e),e}throw new Error("Unable to generate unique 9-digit ID after many attempts.")}function He(n){if(!n)return"";let s={type:n.type,title:n.title||"",info:n.info||""};return n.type==="basic"?(s.q=n.q||"",s.a=n.a||""):n.type==="mcq"?(s.stem=n.stem||"",s.options=Array.isArray(n.options)?n.options:[],s.correctIndex=Number.isFinite(n.correctIndex)?n.correctIndex:-1):n.type==="cloze"&&(s.clozeText=n.clozeText||""),JSON.stringify(s)}var It=/^\^bc-(\d{9})$/;function ds(n,s){let e=a=>(a||"").trim().length===0,t=Math.max(0,Math.min(n.length-1,s)),i=t;for(;i>0&&!e(n[i-1]);)i--;let r=t;for(;r<n.length&&!e(n[r]);)r++;return{lo:i,hi:r}}function Rt(n,s){let{lo:e,hi:t}=ds(n,s),i=Math.max(0,Math.min(n.length-1,s)),r=/^\s*T\s*(?::|\|)\s*/;for(let a=e;a<i;a++)if(r.test(n[a]||""))return a;for(let a=i;a<t;a++)if(r.test(n[a]||""))return a;return i}function it(n){let s=new Set;for(let e of n){let t=(e||"").trim(),i=It.exec(t);i&&s.add(i[1])}return s}function Lt(n,s){let e=[];for(let t=0;t<n.length;t++){let i=(n[t]||"").trim(),r=It.exec(i);if(!r)continue;let a=r[1];s.has(a)||e.push(t)}return e}function Dt(n,s){var i,r;let e=new Map;for(let a of s){let o=Math.max(0,Math.min(n.length,a.lineIndex)),l=(i=e.get(o))!=null?i:[];l.push({...a,lineIndex:o}),e.set(o,l)}let t=Array.from(e.keys()).sort((a,o)=>o-a);for(let a of t){let o=(r=e.get(a))!=null?r:[],l=o.filter(u=>u.deleteLine),d=o.filter(u=>typeof u.insertText=="string"&&u.insertText.length);for(let u of l)a>=0&&a<n.length&&n.splice(a,1);for(let u of d){let c=String(u.insertText||"").split(`
`);n.splice(a,0,...c)}}return n}async function ee(n,s){let e=n.app.vault,t=Date.now(),i=await e.read(s),r=i.split(/\r?\n/),{cards:a}=we(s.path,i,n.settings.indexing.ignoreInCodeFences);for(let w of Object.keys(n.store.data.cards||{})){let b=n.store.data.cards[w];b&&b.sourceNotePath===s.path&&(b.lastSeenAt=0)}for(let w of Object.keys(n.store.data.quarantine||{})){let b=n.store.data.quarantine[w];b&&b.notePath===s.path&&(b.lastSeenAt=0)}let o=new Set([...Object.keys(n.store.data.cards||{}),...Object.keys(n.store.data.quarantine||{}),...it(r)]),l=it(r),d=[],u=new Set,c=0,m=0;for(let w of a){let b=w.id?String(w.id):null;if(b||(b=st(o),w.assignedId=b),o.add(b),u.add(b),!l.has(b)){let S=Rt(r,w.sourceStartLine);d.push({lineIndex:S,insertText:`^bc-${b}`}),c+=1,l.add(b)}}let p=Lt(r,u);for(let w of p)d.push({lineIndex:w,deleteLine:!0}),m+=1;d.length&&(Dt(r,d),await e.modify(s,r.join(`
`)));let h=0,g=0,f=0,y=0,v=[];for(let w of a){let b=String(w.id||w.assignedId||"");if(!b)continue;if(w.errors&&w.errors.length){n.store.data.quarantine[b]={id:b,notePath:w.sourceNotePath,sourceStartLine:w.sourceStartLine,reason:w.errors.join("; "),lastSeenAt:t},delete n.store.data.cards[b],n.store.ensureState(b,t,2.5),y+=1,v.push(b);continue}n.store.data.quarantine&&n.store.data.quarantine[b]&&delete n.store.data.quarantine[b];let S={id:b,type:w.type,title:w.title||void 0,q:w.type==="basic"?w.q||"":void 0,a:w.type==="basic"?w.a||"":void 0,stem:w.type==="mcq"?w.stem||"":void 0,options:w.type==="mcq"?w.options||[]:void 0,correctIndex:w.type==="mcq"?w.correctIndex:void 0,clozeText:w.type==="cloze"?w.clozeText||"":void 0,info:w.info||void 0,sourceNotePath:w.sourceNotePath,sourceStartLine:w.sourceStartLine,updatedAt:t,lastSeenAt:t},x=n.store.data.cards[b];x?He(x)!==He(S)?g+=1:f+=1:h+=1,n.store.upsertCard(S),n.store.ensureState(b,t,2.5)}let C=0;for(let w of Object.keys(n.store.data.cards||{})){let b=n.store.data.cards[w];b&&b.sourceNotePath===s.path&&b.lastSeenAt===0&&(delete n.store.data.cards[w],n.store.data.states&&delete n.store.data.states[w],C+=1)}for(let w of Object.keys(n.store.data.quarantine||{})){let b=n.store.data.quarantine[w];b&&b.notePath===s.path&&b.lastSeenAt===0&&(delete n.store.data.quarantine[w],n.store.data.states&&delete n.store.data.states[w],C+=1)}return await n.store.persist(),{idsInserted:c,anchorsRemoved:m,newCount:h,updatedCount:g,sameCount:f,quarantinedCount:y,quarantinedIds:v,removed:C}}async function rt(n){let s=Date.now(),e=n.app.vault,t=e.getMarkdownFiles();for(let h of Object.keys(n.store.data.cards||{}))n.store.data.cards[h]&&(n.store.data.cards[h].lastSeenAt=0);for(let h of Object.keys(n.store.data.quarantine||{}))n.store.data.quarantine[h]&&(n.store.data.quarantine[h].lastSeenAt=0);let i=0,r=0,a=0,o=0,l=0,d=0,u=[],c=new Set([...Object.keys(n.store.data.cards||{}),...Object.keys(n.store.data.quarantine||{})]),m=[],p=[];for(let h of t){let g=await e.read(h),f=g.split(/\r?\n/),{cards:y}=we(h.path,g,n.settings.indexing.ignoreInCodeFences);if(!y.length)continue;let v=it(f);for(let S of v)c.add(S);for(let S of y)S.id&&c.add(String(S.id));let C=new Set,w=[];for(let S of y){let x=S.id?String(S.id):null;if(x||(x=st(c),S.assignedId=x),c.add(x),C.add(x),!v.has(x)){let N=Rt(f,S.sourceStartLine);w.push({lineIndex:N,insertText:`^bc-${x}`}),i+=1,v.add(x)}p.push(S)}let b=Lt(f,C);for(let S of b)w.push({lineIndex:S,deleteLine:!0}),r+=1;w.length&&m.push({file:h,originalLines:f,edits:w})}for(let h of m){let g=h.originalLines.slice();Dt(g,h.edits),await e.modify(h.file,g.join(`
`))}for(let h of p){let g=String(h.id||h.assignedId||"");if(!g)continue;if(h.errors&&h.errors.length){n.store.data.quarantine[g]={id:g,notePath:h.sourceNotePath,sourceStartLine:h.sourceStartLine,reason:h.errors.join("; "),lastSeenAt:s},delete n.store.data.cards[g],n.store.ensureState(g,s,2.5),d+=1,u.push(g);continue}n.store.data.quarantine&&n.store.data.quarantine[g]&&delete n.store.data.quarantine[g];let f={id:g,type:h.type,title:h.title||void 0,q:h.type==="basic"?h.q||"":void 0,a:h.type==="basic"?h.a||"":void 0,stem:h.type==="mcq"?h.stem||"":void 0,options:h.type==="mcq"?h.options||[]:void 0,correctIndex:h.type==="mcq"?h.correctIndex:void 0,clozeText:h.type==="cloze"?h.clozeText||"":void 0,info:h.info||void 0,sourceNotePath:h.sourceNotePath,sourceStartLine:h.sourceStartLine,updatedAt:s,lastSeenAt:s},y=n.store.data.cards[g];y?He(y)!==He(f)?o+=1:l+=1:a+=1,n.store.upsertCard(f),n.store.ensureState(g,s,2.5)}for(let h of Object.keys(n.store.data.cards||{})){let g=n.store.data.cards[h];g&&g.lastSeenAt!==s&&(delete n.store.data.cards[h],delete n.store.data.states[h])}for(let h of Object.keys(n.store.data.quarantine||{})){let g=n.store.data.quarantine[h];g&&g.lastSeenAt!==s&&(delete n.store.data.quarantine[h],delete n.store.data.states[h])}return await n.store.persist(),{idsInserted:i,anchorsRemoved:r,newCount:a,updatedCount:o,sameCount:l,quarantinedCount:d,quarantinedIds:u}}var $=require("obsidian");var re=require("obsidian");var us=/^\^bc-(\d{9})$/,ps=/^<!--ID:(\d{9})-->$/,hs=/^(T|Title|Q|Question|A|Answer|I|Info|MCQ|O|Options|CQ|Cloze|C):\s*/;function ue(n){let s=(n||"").trim();return us.test(s)||ps.test(s)}function fs(n){let s=(n||"").trim();return ue(s)||hs.test(s)}function ms(n,s){let e=`^bc-${s}`,t=`<!--ID:${s}-->`,i=n.findIndex(o=>(o||"").trim()===e);if(i<0&&(i=n.findIndex(o=>(o||"").trim()===t)),i<0)throw new Error(`Could not locate ^bc-${s} (or ID comment) in note.`);let r=i;for(;r>0;){let o=(n[r-1]||"").trim();if(o===""&&r-2>=0&&ue((n[r-2]||"").trim())){r--;continue}if(ue(o)){r--;continue}break}let a=n.length;for(let o=i+1;o<n.length;o++){let l=(n[o]||"").trim();if(ue(l)){a=o;break}}return{start:r,end:a}}function gs(n){return String(n!=null?n:"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).map(t=>t.replace(/\s+$/g,""))}function te(n,s,e){var m,p;let t=e===void 0?null:gs(e),i=s.map(h=>new RegExp(`^${h}:\\s*`,"i")),r=-1,a=s[0];for(let h=0;h<n.length;h++){let g=(n[h]||"").trim();if(!ue(g)){for(let f=0;f<i.length;f++)if(i[f].test(n[h]||"")){r=h,a=s[f];break}if(r>=0)break}}if(t===null)return n;let o=t.join(`
`).trim()==="";if(r<0){if(o)return n;let h=0;for(;h<n.length&&ue((n[h]||"").trim());)h++;let g=`${a}: ${(m=t[0])!=null?m:""}`.replace(/\s+$/g,""),f=t.slice(1),y=[g,...f];return[...n.slice(0,h),...y,...n.slice(h)]}let l=r+1;for(;l<n.length;){let h=(n[l]||"").trim();if(fs(h))break;l++}if(o)return[...n.slice(0,r),...n.slice(l)];let d=`${a}: ${(p=t[0])!=null?p:""}`.replace(/\s+$/g,""),u=t.slice(1),c=[d,...u];return[...n.slice(0,r),...c,...n.slice(l)]}function ys(n,s){return n.map((t,i)=>{let r=(t||"").trim();return r?i===s?`**${r}**`:r:""}).filter(Boolean).join(" | ")}function Y(n,s){let e=n.createDiv({cls:"bc-edit-section-title"});return e.createEl("div",{text:s,cls:"bc-muted"}),e}var pe=class extends re.Modal{constructor(s,e,t){super(s),this.card=e,this.onSave=t}onOpen(){let{contentEl:s}=this;s.empty();let e=String(this.card.type||"basic"),t=String(this.card.id||"");s.createEl("h3",{text:`Quick edit flashcard ${t}`});let i=w=>{let b=s.createEl("input");return b.type="text",b.value=w||"",b.style.width="100%",b},r=(w,b=4)=>{let S=s.createEl("textarea");return S.value=w||"",S.rows=b,S.style.width="100%",S};Y(s,"Title");let a=i(String(this.card.title||"")),o=null,l=null,d=null,u=null,c=[],m=-1,p=(w="",b=!1)=>{let S=c.length,x=s.createDiv({cls:"bc-edit-mcq-option-row"});x.style.display="flex",x.style.alignItems="center",x.style.gap="8px";let N=x.createEl("div",{text:`Option ${S+1}`,cls:"bc-muted"});N.style.minWidth="70px";let D=x.createEl("input");D.type="text",D.value=w||"",D.style.flex="1",D.style.width="100%";let T=x.createEl("input");T.type="radio",T.name=`bc-mcq-correct-${t}`,T.title="Correct answer",T.checked=b;let k=x.createEl("button",{text:"\u2212"});k.type="button";let R={wrap:x,input:D,radio:T,delBtn:k};c.push(R);let B=()=>{m=c.findIndex(P=>P.radio.checked)};T.addEventListener("change",()=>{B()}),k.addEventListener("click",()=>{let P=c.indexOf(R);if(P<0)return;R.wrap.remove(),c.splice(P,1);let L=m;B(),L===P&&(m=c.findIndex(q=>q.radio.checked)),c.forEach((q,z)=>{let G=q.wrap.querySelector("div");G&&(G.textContent=`Option ${z+1}`)})}),b&&(m=S)};if(e==="cloze"){Y(s,"Cloze"),d=r(String(this.card.clozeText||""),5),Y(s,"Extra information");let w=r(String(this.card.info||""),4);this.renderButtons(e,a,{clozeEl:d,infoEl:w,getMcq:()=>null,qEl:null,aEl:null});return}if(e==="basic"){Y(s,"Question"),o=r(String(this.card.q||""),4),Y(s,"Answer"),l=r(String(this.card.a||""),4),Y(s,"Extra information");let w=r(String(this.card.info||""),4);this.renderButtons(e,a,{qEl:o,aEl:l,infoEl:w,getMcq:()=>null,clozeEl:null});return}Y(s,"Question"),u=r(String(this.card.stem||""),4),Y(s,"Options");let h=Array.isArray(this.card.options)?this.card.options:[],g=Number.isFinite(this.card.correctIndex)?Number(this.card.correctIndex):-1;(h.length?h:["",""]).forEach((w,b)=>p(w,b===g)),m=g;let y=s.createDiv({cls:"bc-edit-mcq-add-row"});y.style.display="flex",y.style.justifyContent="flex-end",y.style.marginTop="6px";let v=y.createEl("button",{text:"+"});v.type="button",v.onclick=()=>p("",!1),Y(s,"Extra information");let C=r(String(this.card.info||""),4);this.renderButtons(e,a,{qEl:null,aEl:null,clozeEl:null,infoEl:C,getMcq:()=>{var x;let w=c.map(N=>(N.input.value||"").trim()).filter(Boolean),b=c.findIndex(N=>N.radio.checked),S=b>=0?b:-1;return{stem:(x=u==null?void 0:u.value)!=null?x:"",options:w,correctIndex:S}}})}renderButtons(s,e,t){let{contentEl:i}=this,r=i.createDiv();r.style.display="flex",r.style.gap="8px",r.style.justifyContent="flex-end",r.style.marginTop="12px";let a=r.createEl("button",{text:"Cancel"});a.type="button",a.onclick=()=>this.close();let o=r.createEl("button",{text:"Save"});o.type="button",o.onclick=async()=>{var l,d,u,c,m,p,h,g,f,y,v;try{let C={title:(l=e.value)!=null?l:"",info:(d=t.infoEl.value)!=null?d:""};if(s==="basic")C.q=(c=(u=t.qEl)==null?void 0:u.value)!=null?c:"",C.a=(p=(m=t.aEl)==null?void 0:m.value)!=null?p:"";else if(s==="cloze")C.clozeText=(g=(h=t.clozeEl)==null?void 0:h.value)!=null?g:"";else if(s==="mcq"){let w=t.getMcq();C.stem=(f=w==null?void 0:w.stem)!=null?f:"",C.options=(y=w==null?void 0:w.options)!=null?y:[],C.correctIndex=(v=w==null?void 0:w.correctIndex)!=null?v:-1}await this.onSave(C),this.close()}catch(C){console.error(C),new re.Notice(`${A}: edit failed (${String((C==null?void 0:C.message)||C)})`)}}}};async function ze(n,s,e){let t=String(s.id||""),i=String(s.sourceNotePath||""),r=String(s.type||"basic");if(!t||!i)throw new Error("Missing card id or sourceNotePath.");let a=n.app.vault.getAbstractFileByPath(i);if(!(a instanceof re.TFile))throw new Error(`Note not found: ${i}`);let l=(await n.app.vault.read(a)).replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`),{start:d,end:u}=ms(l,t),c=l.slice(d,u);if(!c.some(g=>(g||"").trim()===`^bc-${t}`)&&!c.some(g=>(g||"").trim()===`<!--ID:${t}-->`))throw new Error(`Block found for ${t} does not contain anchor/comment marker; aborting.`);if(c=te(c,["T","Title"],e.title),c=te(c,["I","Info"],e.info),r==="basic")c=te(c,["Q","Question"],e.q),c=te(c,["A","Answer"],e.a);else if(r==="cloze")c=te(c,["CQ","Cloze","C"],e.clozeText);else if(r==="mcq"){c=te(c,["MCQ"],e.stem);let g=Array.isArray(e.options)?e.options:[],f=Number.isFinite(e.correctIndex)?Number(e.correctIndex):-1;if(g.length>0){let y=ys(g,f);c=te(c,["O","Options"],y)}else c=te(c,["O","Options"],"")}let p=[...l.slice(0,d),...c,...l.slice(u)].join(`
`);await n.app.vault.modify(a,p);let h=await ee(n,a);new re.Notice(`${A}: synced after edit \u2014 ${h.newCount} new; ${h.updatedCount} updated; ${h.sameCount} unchanged; ${h.idsInserted} IDs inserted.`)}function bs(n,s){let e=n.createDiv();e.style.border="1px solid rgba(220, 38, 38, 0.35)",e.style.background="rgba(220, 38, 38, 0.08)",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.margin="10px 0 12px",e.style.lineHeight="1.35",e.style.fontSize="13px";let t=e.createEl("div",{text:"How to fix parse errors"});t.style.fontWeight="600",t.style.marginBottom="6px";let i=e.createEl("div",{text:s});return i.style.whiteSpace="pre-wrap",e}function ws(n){return Array.isArray(n)&&n.every(s=>typeof s=="string")}function ve(n){return String(n!=null?n:"").replace(/\\/g,"\\\\").replace(/\|/g,"\\|")}function ne(n,s){var r,a,o,l;let t=String(s!=null?s:"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`);if(t.length<=1)return[`${n} | ${ve((r=t[0])!=null?r:"")} |`];let i=[];i.push(`${n} | ${ve((a=t[0])!=null?a:"")}`);for(let d=1;d<t.length-1;d++)i.push(ve((o=t[d])!=null?o:""));return i.push(`${ve((l=t[t.length-1])!=null?l:"")} |`),i}function vs(n,s){return`O: ${n.map((t,i)=>{let r=String(t!=null?t:"").trim();if(!r)return"";let a=ve(r);return i===s?`**${a}**`:a}).filter(Boolean).join(" | ")}`}var Ce=class extends $.Modal{constructor(s,e){super(s),this.plugin=e}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:`${A}: add flashcard`});let e=this.app.workspace.getActiveFile(),t=String((e==null?void 0:e.path)||""),i=s.createEl("div",{text:t?`Target: ${t}`:"Target: (no active note)"});i.style.opacity="0.8",i.style.fontSize="12px",i.style.marginBottom="10px";let r=s.createDiv();r.style.display="flex",r.style.gap="8px",r.style.alignItems="center",r.style.marginBottom="10px",r.createEl("div",{text:"Type",cls:"bc-muted"}).style.minWidth="50px";let a=r.createEl("select");a.style.flex="1",a.createEl("option",{text:"Basic (Q/A)",value:"basic"}),a.createEl("option",{text:"MCQ",value:"mcq"}),a.createEl("option",{text:"Cloze",value:"cloze"});let o=w=>{let b=s.createDiv();b.style.display="flex",b.style.flexDirection="column",b.style.gap="4px",b.style.marginBottom="10px";let S=b.createEl("div",{text:w,cls:"bc-muted"});S.style.fontSize="12px";let x=b.createEl("input");return x.type="text",x.style.width="100%",{wrap:b,input:x}},l=(w,b=4)=>{let S=s.createDiv();S.style.display="flex",S.style.flexDirection="column",S.style.gap="4px",S.style.marginBottom="10px";let x=S.createEl("div",{text:w,cls:"bc-muted"});x.style.fontSize="12px";let N=S.createEl("textarea");return N.rows=b,N.style.width="100%",{wrap:S,ta:N}},d=o("Title"),u=l("Question",4),c=l("Answer",4),m=l("MCQ stem",4),p=l("Options (one per line; prefix correct with * )",5),h=l("Cloze text",5),g=l("Extra info",4),f=()=>{let w=a.value;u.wrap.style.display=w==="basic"?"":"none",c.wrap.style.display=w==="basic"?"":"none",m.wrap.style.display=w==="mcq"?"":"none",p.wrap.style.display=w==="mcq"?"":"none",h.wrap.style.display=w==="cloze"?"":"none"};a.onchange=()=>f(),f();let y=s.createDiv();y.style.display="flex",y.style.gap="8px",y.style.justifyContent="flex-end",y.style.marginTop="12px";let v=y.createEl("button",{text:"Cancel"});v.type="button",v.onclick=()=>this.close();let C=y.createEl("button",{text:"Add"});C.type="button",C.onclick=async()=>{var w;try{let b=this.app.workspace.getActiveFile();if(!(b instanceof $.TFile)){new $.Notice(`${A}: open a markdown note first`);return}let S=a.value,x=[];if(x.push(...ne("T",d.input.value||"")),S==="basic")x.push(...ne("Q",u.ta.value||"")),x.push(...ne("A",c.ta.value||"")),x.push(...ne("I",g.ta.value||""));else if(S==="cloze")x.push(...ne("CQ",h.ta.value||"")),x.push(...ne("I",g.ta.value||""));else{x.push(...ne("MCQ",m.ta.value||""));let k=(p.ta.value||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).map(P=>P.trim()).filter(Boolean),R=-1,B=k.map((P,L)=>P.startsWith("*")?(R===-1&&(R=L),P.replace(/^\*\s*/,"")):P);B.length>=2?(R<0&&(R=0),x.push(vs(B,R))):x.push("O: "),x.push(...ne("I",g.ta.value||""))}x.push("");let N=x.join(`
`),D=this.app.workspace.getActiveViewOfType($.MarkdownView);if(((w=D==null?void 0:D.file)==null?void 0:w.path)===b.path&&D.editor){let k=D.editor,R=k.getCursor();k.replaceRange(N,R)}else{let k=await this.app.vault.read(b),R=(k.endsWith(`
`)?k:k+`
`)+N;await this.app.vault.modify(b,R)}let T=await ee(this.plugin,b);new $.Notice(`${A}: added + synced \u2014 ${T.newCount} new; ${T.updatedCount} updated; ${T.sameCount} unchanged; ${T.idsInserted} IDs inserted.`),this.close()}catch(b){console.error(b),new $.Notice(`${A}: add failed (${String((b==null?void 0:b.message)||b)})`)}}}},ae=class extends $.Modal{constructor(s,e,t){super(s),this.plugin=e,this.quarantinedIds=Array.isArray(t)?t:[]}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:`${A}: parse errors`}),bs(s,["Typical fixes:","\u2022 Ensure each card has exactly one start line: Q | ... |  or  MCQ | ... |  or  CQ | ... |","\u2022 Pipe-format fields (T | ... |, A | ... |, I | ... |, etc.) must end with a closing | (unless intentionally multiline, then close later).","\u2022 MCQ requires an O: line with \u22652 options separated by | and exactly one option wrapped in ** **.","\u2022 Cloze requires at least one {{cN::...}} token.","","Use Open to jump to the exact ^bc- anchor, or Edit to quick-fix the card."].join(`
`));let e=s.createDiv();e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px";for(let r of this.quarantinedIds){let a=this.resolveCardRef(r),o=e.createDiv();o.style.display="flex",o.style.flexDirection="column",o.style.gap="6px",o.style.padding="10px 12px",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="12px";let l=o.createDiv();l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="space-between",l.style.gap="10px";let d=l.createDiv();d.style.display="flex",d.style.flexDirection="column",d.style.gap="2px";let u=d.createEl("div",{text:`^bc-${r}`});u.style.fontWeight="600";let c=d.createEl("div",{text:a!=null&&a.sourceNotePath?a.sourceNotePath:"(note path unresolved; will try active note)"});c.addClass("bc-muted"),c.style.fontSize="12px",c.style.opacity="0.85";let m=l.createDiv();m.style.display="flex",m.style.alignItems="center",m.style.gap="8px";let p=m.createEl("button");p.type="button",p.className="clickable-icon",p.setAttribute("aria-label","Open at anchor"),(0,$.setIcon)(p,"arrow-up-right"),p.onclick=()=>void this.openAtAnchor(r);let h=m.createEl("button");h.type="button",h.className="clickable-icon",h.setAttribute("aria-label","Quick edit"),(0,$.setIcon)(h,"edit-3"),h.onclick=()=>void this.openQuickEdit(r);let g=((a==null?void 0:a.errors)||[]).filter(Boolean);if(g.length){let f=o.createEl("ul");f.style.margin="0",f.style.paddingLeft="18px",f.style.fontSize="13px";for(let y of g)f.createEl("li",{text:y})}else{let f=o.createEl("div",{text:"No error details available."});f.addClass("bc-muted"),f.style.fontSize="13px"}}let t=s.createDiv();t.style.display="flex",t.style.justifyContent="flex-end",t.style.marginTop="12px";let i=t.createEl("button",{text:"Close"});i.type="button",i.onclick=()=>this.close()}resolveCardRef(s){var l,d,u,c,m,p,h;let e=(l=this.plugin)==null?void 0:l.store,t=g=>{var f,y;return!g||typeof g!="object"?null:(y=(f=g[s])!=null?f:g[String(s)])!=null?y:null},i=[t((d=e==null?void 0:e.data)==null?void 0:d.quarantine),t((u=e==null?void 0:e.data)==null?void 0:u.quarantined),t((c=e==null?void 0:e.data)==null?void 0:c.parseErrors),t((m=e==null?void 0:e.data)==null?void 0:m.cards),t((p=e==null?void 0:e.data)==null?void 0:p.cardById),typeof(e==null?void 0:e.getCard)=="function"?e.getCard(s):null,typeof(e==null?void 0:e.getCardRecord)=="function"?e.getCardRecord(s):null].filter(Boolean),r=i.length?i[0]:null;if(r&&typeof r=="object"){let g=String(r.sourceNotePath||""),f=Number((h=r.sourceStartLine)!=null?h:0),y=r.errors,v=ws(y)?y:Array.isArray(y)?y.map(C=>String(C)):[];if(g)return{id:String(s),sourceNotePath:g,sourceStartLine:Number.isFinite(f)?f:0,errors:v}}let a=this.app.workspace.getActiveFile(),o=String((a==null?void 0:a.path)||"");return o?{id:String(s),sourceNotePath:o,sourceStartLine:0,errors:[]}:null}async openAtAnchor(s){var m;let e=this.resolveCardRef(s);if(!(e!=null&&e.sourceNotePath)){new $.Notice(`${A}: cannot resolve note path for ^bc-${s}`);return}let t=this.app.vault.getAbstractFileByPath(e.sourceNotePath);if(!(t instanceof $.TFile)){new $.Notice(`${A}: note not found (${e.sourceNotePath})`);return}let i=this.app.workspace.getLeaf(!0);await i.setViewState({type:"markdown",state:{file:t.path,mode:"source"},active:!0},{focus:!0});let r=i.view;if(!(r instanceof $.MarkdownView)){await this.app.workspace.openLinkText(`${e.sourceNotePath}#^bc-${s}`,e.sourceNotePath,!0);return}let o=await(async()=>{for(let p=0;p<30;p++){if(r.editor)return r.editor;await new Promise(h=>setTimeout(h,25))}return null})();if(!o)return;let l=`^bc-${s}`,u=(await this.app.vault.read(t)).split(/\r?\n/),c=u.findIndex(p=>(p||"").includes(l));if(c<0&&(c=Math.max(0,Number((m=e.sourceStartLine)!=null?m:0))),u[c]&&u[c].trim()===l){let p=c+1;for(;p<u.length&&(u[p]||"").trim()==="";)p++;p<u.length&&(c=p)}o.setCursor({line:c,ch:0}),o.scrollIntoView({from:{line:c,ch:0},to:{line:c,ch:0}},!0),o.focus()}async openQuickEdit(s){let e=this.resolveCardRef(s);if(!(e!=null&&e.sourceNotePath)){new $.Notice(`${A}: cannot resolve note path for ^bc-${s}`);return}let t=this.app.vault.getAbstractFileByPath(e.sourceNotePath);if(!(t instanceof $.TFile)){new $.Notice(`${A}: note not found (${e.sourceNotePath})`);return}let i=await this.app.vault.read(t),a=(we(e.sourceNotePath,i,!0).cards||[]).find(l=>String(l.id||"")===String(s)),o=a?{id:String(a.id||s),type:String(a.type||"basic"),title:a.title||"",q:a.q||"",a:a.a||"",clozeText:a.clozeText||"",stem:a.stem||"",options:Array.isArray(a.options)?a.options:[],correctIndex:Number.isFinite(a.correctIndex)?Number(a.correctIndex):-1,info:a.info||"",sourceNotePath:e.sourceNotePath}:{id:String(s),type:"basic",title:"",q:"",a:"",info:"",sourceNotePath:e.sourceNotePath};new pe(this.app,o,async l=>{await ze(this.plugin,o,l)}).open()}};function qt(n,s){if(!n||n.type==="vault")return!0;if(n.type==="folder"){let e=s.includes("/")?s.split("/").slice(0,-1).join("/"):"";return e===n.key||e.startsWith(n.key+"/")}return n.type==="note"?s===n.key:!0}function Cs(n){let s=new Date(n);return s.setHours(0,0,0,0),s.getTime()}function Ft(n){let s=Number(n);return Number.isFinite(s)?Math.max(0,Math.floor(s)):Number.POSITIVE_INFINITY}function xs(n,s,e){var l,d,u;let t=((d=(l=n.store)==null?void 0:l.data)==null?void 0:d.reviewLog)||[],i=new Map,r=new Set;for(let c of t){let m=String((u=c==null?void 0:c.id)!=null?u:"");if(!m||!s.has(m))continue;let p=Number(c==null?void 0:c.at);if(!Number.isFinite(p))continue;let h=i.get(m);(h===void 0||p<h)&&i.set(m,p),p>=e&&r.add(m)}let a=0,o=0;for(let c of r){let m=i.get(c);m!==void 0&&(m>=e?a+=1:o+=1)}return{newDoneToday:a,reviewDoneToday:o}}function _s(n,s){return!n||n.stage==="suspended"?!1:n.stage==="new"?!0:n.stage==="learning"||n.stage==="relearning"||n.stage==="review"?typeof n.due!="number"||!Number.isFinite(n.due)?!0:n.due<=s:!1}function Pt(n,s){var b,S;let e=Date.now(),t=Cs(e),r=(S=((b=n==null?void 0:n.settings)!=null?b:{}).reviewer)!=null?S:{},a=Ft(r.dailyNewLimit),o=Ft(r.dailyReviewLimit),l=n.store.getAllCards().filter(x=>qt(s,x.sourceNotePath)),d=n.store.data.states||{},u=new Set(l.map(x=>String(x.id))),{newDoneToday:c,reviewDoneToday:m}=xs(n,u,t),p=a===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Math.max(0,a-c),h=o===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Math.max(0,o-m),g=l.filter(x=>{let N=d[x.id];return _s(N,e)}),f=[],y=[];for(let x of g){let N=d[x.id];N&&(N.stage==="new"?y.push(x):(N.stage==="learning"||N.stage==="relearning"||N.stage,f.push(x)))}f.sort((x,N)=>{let D=d[x.id],T=d[N.id],k=D&&typeof D.due=="number"&&Number.isFinite(D.due)?Number(D.due):-1,R=T&&typeof T.due=="number"&&Number.isFinite(T.due)?Number(T.due):-1;return k!==R?k-R:String(x.id).localeCompare(String(N.id))}),y.sort((x,N)=>String(x.id).localeCompare(String(N.id)));let v=h===Number.POSITIVE_INFINITY?f:f.slice(0,h),C=p===Number.POSITIVE_INFINITY?y:y.slice(0,p),w=[...v,...C];return{scope:s,queue:w,index:0,graded:{},stats:{total:w.length,done:0}}}function Bt(n,s){let e=Date.now(),t=n.store.getAllCards().filter(a=>qt(s,a.sourceNotePath)),i=n.store.data.states||{},r=null;for(let a of t){let o=i[a.id];o&&o.stage!=="suspended"&&(o.stage==="learning"||o.stage==="relearning"||o.stage==="review")&&typeof o.due=="number"&&Number.isFinite(o.due)&&o.due>e&&(r===null||o.due<r)&&(r=o.due)}return r}function $t(n){let s=Math.max(0,Math.floor(n/1e3));if(s<60)return`${s} secs`;let e=Math.floor(s/60);if(e<60)return`${e} mins`;let t=Math.floor(e/60);return t<24?`${t} hours`:`${Math.floor(t/24)} days`}function Qe(n,s){var m;let e=_("div","");e.style.whiteSpace="pre-wrap",e.style.overflowWrap="anywhere";let t=document.createElement("p");t.setAttribute("dir","auto"),t.style.whiteSpace="pre-wrap",t.style.overflowWrap="anywhere",e.appendChild(t);let i=/\{\{c\d+::(.*?)\}\}/g,r=0,a,l=(()=>{let p=document.createElement("span");p.textContent="0000000000",p.style.position="absolute",p.style.visibility="hidden",p.style.whiteSpace="pre",t.appendChild(p);let h=p.getBoundingClientRect().width/10;return p.remove(),h||8})(),d=Math.max(0,Math.round(20/l)),u=()=>{var h;let p=t.lastChild;if(p&&p.nodeType===Node.TEXT_NODE){let g=(h=p.textContent)!=null?h:"";if(/\s$/.test(g))return;p.textContent=g+" ";return}p&&t.appendChild(document.createTextNode(" "))},c=p=>{let g="";for(let f=0;f<p;f++)g+=" ",(f+1)%6===0&&(g+="\u200B");return g};for(;a=i.exec(n);){a.index>r&&t.appendChild(document.createTextNode(n.slice(r,a.index)));let p=(m=a[1])!=null?m:"";if(s)t.appendChild(document.createTextNode(p));else{u();let h=document.createElement("span");h.className="bc-cloze-blank";let g=Math.max(4,Math.min(40,p.length)),f=Math.max(1,g-d);h.textContent=c(f),h.style.marginLeft="0",h.style.marginRight="10px",t.appendChild(h)}r=a.index+a[0].length}return r<n.length&&t.appendChild(document.createTextNode(n.slice(r))),e}function ot(){return{total:0,new:0,learning:0,review:0,relearning:0}}function Ss(n){return(n.split("/").pop()||n).replace(/\.md$/i,"")}function Es(n){let s=n.split("/").filter(Boolean);return s.length?s[s.length-1]:n}function Ms(n){var e,t;if(!n)return E.New;if(n.fsrsState!==void 0)return n.fsrsState;let s=(e=n.stage)!=null?e:"new";return s==="new"?E.New:s==="review"?E.Review:s==="relearning"?E.Relearning:((t=n.lapses)!=null?t:0)>0?E.Relearning:E.Learning}function at(n,s){n.total+=1,s===E.New?n.new+=1:s===E.Review?n.review+=1:s===E.Relearning?n.relearning+=1:n.learning+=1}function Ts(n,s){let e=n.children.get(s);if(e)return e;let t={type:"folder",key:s,name:Es(s),children:new Map,counts:ot()};return n.children.set(s,t),t}function Ns(n,s){let e=n.children.get(s);if(e)return e;let t={type:"note",key:s,name:Ss(s),children:new Map,counts:ot()};return n.children.set(s,t),t}function Ot(n,s,e,t){let i={type:"folder",key:"",name:t,children:new Map,counts:ot()};for(let r of n){let a=String(r.sourceNotePath||"");if(!a)continue;let o=s[String(r.id)]||null,l=Ms(o),d=a.split("/").filter(Boolean),u=d.slice(0,Math.max(0,d.length-1)),c=i,m="";at(c.counts,l);for(let h of u)m=m?`${m}/${h}`:h,c=Ts(c,m),at(c.counts,l);let p=Ns(c,a);at(p.counts,l)}return i}function Ht(n){var g,f;let{app:s,plugin:e,container:t}=n,i=Date.now(),r=e.store.getAllCards(),a=e.store.data.states||{},o=((f=(g=s==null?void 0:s.vault)==null?void 0:g.getName)==null?void 0:f.call(g))||"Vault",l=_("div","bc-deck"),d=_("div","bc-top-actions");d.appendChild(ge("play","Study all","Start a vault-wide session",()=>{n.openSession({type:"vault",key:"",name:o})})),d.appendChild(ge("refresh-cw","Sync flashcard database","Sync flashcards from the active note",()=>void n.resyncActiveFile()));let u=Ot(r,a,i,o),c=(y,v)=>{for(let C of y.children.values())C.type==="folder"&&(v.add(C.key),C.children.size&&c(C,v))};if(d.appendChild(ge("chevrons-down","Expand all","Expand all folders",()=>{let y=new Set([""]);c(u,y),n.setExpanded(y),n.rerender()})),d.appendChild(ge("chevrons-up","Collapse all","Collapse all folders",()=>{n.setExpanded(new Set([""])),n.rerender()})),l.appendChild(d),!r.length){l.appendChild(_("div","bc-muted","No cards found. Run \u201CSync Question Bank\u201D.")),t.appendChild(l);return}let m=_("div","bc-deck-header");m.appendChild(_("div","","Deck")),m.appendChild(_("div","bc-count","Total")),m.appendChild(_("div","bc-count bc-new","New")),m.appendChild(_("div","bc-count bc-relearn","Relearning")),m.appendChild(_("div","bc-count bc-learning","Learning")),m.appendChild(_("div","bc-count bc-review","Review")),l.appendChild(m);let p=_("div","bc-deck-body");p.style.overflowY="auto",p.style.minHeight="0",l.style.display="flex",l.style.flexDirection="column",l.style.minHeight="0",p.style.flex="1 1 auto";let h=(y,v=0)=>{let C=Array.from(y.children.values()).sort((w,b)=>w.name.localeCompare(b.name));for(let w of C){let b=_("div","bc-deck-row"),S=_("div","bc-deck-name");if(S.style.paddingLeft=`${v*14}px`,w.type==="folder"){let x=n.expanded.has(w.key);S.appendChild(Ct(x,()=>{let N=new Set(n.expanded);N.has(w.key)?N.delete(w.key):N.add(w.key),n.setExpanded(N),n.rerender()}))}else{let x=_("span","","");x.style.display="inline-block",x.style.width="26px",S.appendChild(x)}S.appendChild(_("span","bc-name-text",w.name)),b.appendChild(S),b.appendChild(_("div","bc-count",String(w.counts.total))),b.appendChild(_("div","bc-count bc-new",String(w.counts.new))),b.appendChild(_("div","bc-count bc-relearn",String(w.counts.relearning))),b.appendChild(_("div","bc-count bc-learning",String(w.counts.learning))),b.appendChild(_("div","bc-count bc-review",String(w.counts.review))),b.addEventListener("click",()=>{w.type==="folder"?n.openSession({type:"folder",key:w.key,name:w.key||w.name}):w.type==="note"&&n.openSession({type:"note",key:w.key,name:w.name})}),p.appendChild(b),w.type==="folder"&&n.expanded.has(w.key)&&w.children.size&&h(w,v+1)}};h(u,0),l.appendChild(p),t.appendChild(l)}var zt=require("obsidian");function ks(n){return String(n!=null?n:"").replace(/\s*\/\s*/g," / ").replace(/\s+/g," ").trim()}function As(n){let s=String(n!=null?n:"").trim();return s?(s=s.replace(/\\/g,"/").replace(/^\.\//,""),s=s.replace(/\.md$/i,""),ks(s)):"Note"}function Is(n){var i,r,a,o,l,d;if(!n)return null;let s=u=>{if(typeof u=="string"&&u.trim())return u.trim();if(Array.isArray(u)){let c=u.filter(m=>typeof m=="string").join(`
`).trim();return c||null}return null},e=(a=(r=(i=s(n.info))!=null?i:s(n.information))!=null?r:s(n.i))!=null?a:s(n.I);if(e)return e;let t=n.fields;if(t&&typeof t=="object"){let u=(d=(l=(o=s(t.info))!=null?o:s(t.information))!=null?l:s(t.i))!=null?d:s(t.I);if(u)return u}return null}function Rs(n){let s=n;return(!s.mcqOrderMap||typeof s.mcqOrderMap!="object")&&(s.mcqOrderMap={}),s.mcqOrderMap}function Ls(n,s){if(!Array.isArray(n)||n.length!==s)return!1;let e=new Array(s).fill(!1);for(let t of n){if(!Number.isInteger(t)||t<0||t>=s||e[t])return!1;e[t]=!0}return!0}function Ds(n){for(let s=n.length-1;s>0;s--){let e=Math.floor(Math.random()*(s+1)),t=n[s];n[s]=n[e],n[e]=t}}function Fs(n,s,e){var u;let t=(s==null?void 0:s.options)||[],i=Array.isArray(t)?t.length:0,r=Array.from({length:i},(c,m)=>m);if(!e||!n)return r;let a=String((u=s==null?void 0:s.id)!=null?u:"");if(!a)return r;let o=Rs(n),l=o[a];if(Ls(l,i))return l;let d=r.slice();if(Ds(d),i>=2){let c=!0;for(let m=0;m<i;m++)if(d[m]!==m){c=!1;break}if(c){let m=d[0];d[0]=d[1],d[1]=m}}return o[a]=d,d}function Qt(n){var w,b,S,x,N,D,T,k,R,B,P;let s=_("div","bc-card");s.classList.add("bc-widget");let e=n.currentCard(),t=e?String(e.id):"",i=_("div","bc-back");i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.gap="10px";let r=e&&(e.sourceNotePath||e.location||e.sourcePath)||((b=(w=n.session)==null?void 0:w.scope)==null?void 0:b.name)||"Note",a=As(r),o=e?`ID ${t} \u2022 ${a}`:a,l=_("div","bc-muted",o);l.style.flex="1 1 auto",l.style.minWidth="0";let d=document.createElement("button");d.type="button",d.className="clickable-icon view-action bc-back-x",d.setAttribute("aria-label","Exit back to deck browser"),d.title="Exit back to deck browser",(0,zt.setIcon)(d,"x"),d.addEventListener("click",L=>{L.preventDefault(),L.stopPropagation(),n.backToDecks()}),i.appendChild(l),i.appendChild(d),s.appendChild(i);let u=_("div","bc-flashcard");if(s.appendChild(u),!e){n.clearTimer(),n.clearCountdown(),u.appendChild(_("div","bc-hr")),u.appendChild(_("div","bc-title","No cards left"));let L=((x=(S=n.session)==null?void 0:S.stats)==null?void 0:x.done)||0,q=((D=(N=n.session)==null?void 0:N.stats)==null?void 0:D.total)||0;u.appendChild(_("div","bc-muted",`Reviewed: ${L}/${q}`)),u.appendChild(_("div","bc-hr"));let z=(T=n.session)==null?void 0:T.scope,G=z?n.getNextDueInScope(z):null;if(G){let Z=_("div","bc-muted","");n.startCountdown(G,Z),u.appendChild(Z)}else u.appendChild(_("div","bc-muted","No scheduled cards in scope."));n.container.appendChild(s);return}n.clearCountdown();let c=((k=n.session)==null?void 0:k.graded[t])||null,m=e.title||(e.type==="mcq"?"MCQ":e.type==="cloze"?"Cloze":"Basic"),p=_("div","bc-title");p.classList.add("bc-question-title"),p.style.whiteSpace="pre-wrap",p.style.overflowWrap="anywhere",p.textContent=String(m!=null?m:""),u.appendChild(p),u.appendChild(_("div","bc-hr"));let h=String(e.sourceNotePath||((B=(R=n.session)==null?void 0:R.scope)==null?void 0:B.name)||""),g=(L,q)=>{let z=_("div",`bc-field ${L}`);return z.style.whiteSpace="pre-wrap",z.style.overflowWrap="anywhere",n.renderMarkdownInto(z,q!=null?q:"",h),z},f=L=>_("div","bc-muted",L);if(e.type==="basic")u.appendChild(f("Question")),u.appendChild(g("bc-q",e.q||"")),(n.showAnswer||c)&&(u.appendChild(_("div","bc-hr")),u.appendChild(f("Answer")),u.appendChild(g("bc-a",e.a||"")));else if(e.type==="cloze"){let L=e.clozeText||"",q=n.showAnswer||!!c;u.appendChild(f(q?"Answer":"Question"));let z=n.renderClozeFront(L,q);z.style.whiteSpace="pre-wrap",z.style.overflowWrap="anywhere",u.appendChild(z)}else if(e.type==="mcq"){u.appendChild(f("Question")),u.appendChild(g("bc-q",e.stem||"")),u.appendChild(_("div","bc-hr")),u.appendChild(f("Options"));let L=e.options||[],q=(P=c==null?void 0:c.meta)==null?void 0:P.mcqChoice;Fs(n.session,e,!!n.randomizeMcqOptions).forEach((Z,tn)=>{var ut;let nn=(ut=L[Z])!=null?ut:"",oe=_("div","bc-option");c&&(Z===e.correctIndex&&oe.classList.add("correct"),typeof q=="number"&&q===Z&&q!==e.correctIndex&&oe.classList.add("wrong"));let he=document.createElement("button");he.type="button",he.className="bc-keybtn",he.appendChild(n.keybox(String(tn+1))),he.addEventListener("click",pt=>{pt.preventDefault(),pt.stopPropagation(),c||n.answerMcq(Z)});let Me=_("span","bc-option-text");Me.style.whiteSpace="pre-wrap",Me.style.overflowWrap="anywhere",Me.textContent=nn,oe.appendChild(he),oe.appendChild(Me),c||oe.addEventListener("click",()=>void n.answerMcq(Z)),u.appendChild(oe)});let G=e.a||e.answer||e.explain||e.explanation||"";(n.showAnswer||c)&&typeof G=="string"&&G.trim()&&(u.appendChild(_("div","bc-hr")),u.appendChild(f("Answer")),u.appendChild(g("bc-a",G)))}let y=Is(e);(n.showInfo||c)&&y&&(u.appendChild(_("div","bc-hr")),u.appendChild(f("Extra Information")),u.appendChild(g("bc-info",y))),u.appendChild(_("div","bc-hr"));let v=_("div","bc-row");if((e.type==="basic"||e.type==="cloze")&&!n.showAnswer){let L=n.makePlainButton("Reveal",()=>{n.setShowAnswer(!0),n.rerender()},"bc-btn blue-btn");n.appendKeyboxRight(L,"Enter"),v.appendChild(L)}u.appendChild(v);let C=_("div","bc-row");if(c){let L=n.makePlainButton("Next",()=>void n.nextCard(!0),"bc-btn blue-btn");n.appendKeyboxRight(L,"Enter"),C.appendChild(L)}else if((e.type==="basic"||e.type==="cloze")&&n.showAnswer){let L=n.makePlainButton("Again",()=>n.gradeCurrentRating("again",{}).then(()=>void n.nextCard(!0)),"bc-btn red-btn");n.appendKeyboxRight(L,"1"),C.appendChild(L);let q=n.makePlainButton("Easy",()=>n.gradeCurrentRating("easy",{}).then(()=>void n.nextCard(!0)),"bc-btn green-btn");n.appendKeyboxRight(q,"2"),C.appendChild(q)}else if(e.type==="mcq"){let L=(e.options||[]).length;C.appendChild(_("div","bc-muted",`Choose 1\u2013${L}.`))}u.appendChild(C),n.container.appendChild(s)}var xe=class extends V.ItemView{constructor(e,t){super(e);this.mode="deck";this.expanded=new Set([""]);this.session=null;this.showAnswer=!1;this._timer=null;this._keysBound=!1;this._countdownInterval=null;this._mdRenderSerial=0;this._moreOpen=!1;this._moreWrap=null;this._moreMenuEl=null;this._moreBtnEl=null;this._moreOutsideBound=!1;this.plugin=t}getViewType(){return se}getDisplayText(){return"Study Session (Boot Camp)"}getIcon(){return"brain"}async onOpen(){this.containerEl.tabIndex=0;let e=()=>this.containerEl.focus();this.containerEl.addEventListener("mousedown",e),this.containerEl.addEventListener("click",e),queueMicrotask(()=>e()),this._keysBound||(this._keysBound=!0,this.registerDomEvent(this.containerEl,"keydown",t=>this.handleKey(t)),this.registerDomEvent(window,"keydown",t=>this.handleKey(t),{capture:!0})),this._moreOutsideBound||(this._moreOutsideBound=!0,this.registerDomEvent(document,"mousedown",t=>{if(!this._moreOpen||!this.isActiveLeaf())return;let i=t.target;i&&(this._moreWrap&&this._moreWrap.contains(i)||this.closeMoreMenu())},{capture:!0})),this.render()}async onClose(){this.clearTimer(),this.clearCountdown(),this.closeMoreMenu()}onRefresh(){this.render()}clearTimer(){this._timer&&(window.clearTimeout(this._timer),this._timer=null)}clearCountdown(){this._countdownInterval&&(window.clearInterval(this._countdownInterval),this._countdownInterval=null)}startCountdown(e,t){this.clearCountdown();let i=()=>{let r=e-Date.now();t.textContent=`Next card due in: ${$t(r)}`};i(),this._countdownInterval=window.setInterval(i,1e3)}armTimer(){if(this.clearTimer(),this.mode!=="session"||!this.plugin.settings.reviewer.autoAdvanceEnabled)return;let e=Number(this.plugin.settings.reviewer.autoAdvanceSeconds);!Number.isFinite(e)||e<=0||(this._timer=window.setTimeout(()=>{this._timer=null,this.onAutoAdvance()},e*1e3))}onAutoAdvance(){if(this.mode!=="session"||!this.session)return;let e=this.currentCard();if(!e)return;this.session.graded[String(e.id)]?this.nextCard(!1):this.gradeCurrentRating("again",{auto:!0}).then(()=>void this.nextCard(!1))}buildSession(e){return Pt(this.plugin,e)}getNextDueInScope(e){return Bt(this.plugin,e)}currentCard(){return this.session&&this.session.queue[this.session.index]||null}async openCurrentCardInNote(){let e=this.currentCard();if(!e)return;let t=String(e.id||""),i=String(e.sourceNotePath||"");if(!t||!i)return;let r=this.app.vault.getAbstractFileByPath(i);if(!(r instanceof V.TFile))return;let a=this.app.workspace.getLeaf(!0);await a.setViewState({type:"markdown",state:{file:r.path,mode:"source"},active:!0},{focus:!0});let o=a.view;if(!(o instanceof V.MarkdownView))return;let d=await(async()=>{for(let h=0;h<30;h++){let g=o.editor;if(g)return g;await new Promise(f=>setTimeout(f,25))}return null})();if(!d)return;let u=`^bc-${t}`,m=(await this.app.vault.read(r)).split(/\r?\n/),p=m.findIndex(h=>h.includes(u));if(!(p<0)){if(m[p].trim()===u){let h=p+1;for(;h<m.length&&m[h].trim()==="";)h++;h<m.length&&(p=h)}d.setCursor({line:p,ch:0}),d.scrollIntoView({from:{line:p,ch:0},to:{line:p,ch:0}},!0),d.focus()}}openEditModalForCurrentCard(){let e=this.currentCard();e&&new pe(this.app,e,async t=>{var i;try{if(await ze(this.plugin,e,t),this.session){let r=String(e.id),a=(((i=this.plugin.store.data)==null?void 0:i.cards)||{})[r];a&&(this.session.queue[this.session.index]=a)}this.render()}catch(r){console.error(r),new V.Notice(`${A}: edit failed (${String((r==null?void 0:r.message)||r)})`)}}).open()}getStageCountsAll(){var i;let e={new:0,learning:0,review:0,relearning:0,suspended:0},t=this.plugin.store.getAllCards();for(let r of t){let a=this.plugin.store.getState(String(r.id)),o=(i=a==null?void 0:a.stage)!=null?i:"new";o==="new"?e.new+=1:o==="review"?e.review+=1:o==="relearning"?e.relearning+=1:o==="suspended"?e.suspended+=1:e.learning+=1}return e}isMcqOptionRandomisationEnabled(){var e;return!!((e=this.plugin.settings.reviewer)!=null&&e.randomizeMcqOptions)}getMcqOrderMap(){if(!this.session)return{};let e=this.session;return(!e.mcqOrderMap||typeof e.mcqOrderMap!="object")&&(e.mcqOrderMap={}),e.mcqOrderMap}isPermutation(e,t){if(!Array.isArray(e)||e.length!==t)return!1;let i=new Array(t).fill(!1);for(let r of e){if(!Number.isInteger(r)||r<0||r>=t||i[r])return!1;i[r]=!0}return!0}shuffleInPlace(e){for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[i],e[i]=r}}getMcqOptionOrder(e){var u;let t=(e==null?void 0:e.options)||[],i=Array.isArray(t)?t.length:0,r=Array.from({length:i},(c,m)=>m);if(!this.session||(e==null?void 0:e.type)!=="mcq"||!this.isMcqOptionRandomisationEnabled())return r;let a=String((u=e==null?void 0:e.id)!=null?u:"");if(!a)return r;let o=this.getMcqOrderMap(),l=o[a];if(this.isPermutation(l,i))return l;let d=r.slice();if(this.shuffleInPlace(d),i>=2){let c=!0;for(let m=0;m<i;m++)if(d[m]!==m){c=!1;break}if(c){let m=d[0];d[0]=d[1],d[1]=m}}return o[a]=d,d}fsrsStateName(e){switch(Number(e)){case 0:return"New";case 1:return"Learning";case 2:return"Review";case 3:return"Relearning";default:return String(e)}}logFsrsIfNeeded(e,t,i,r,a,o){if(!(t==="mcq"||i==="again"||i==="easy"))return;let d=new Date(a).toLocaleString(),u=t==="mcq"?` | mcqChoice=${o==null?void 0:o.mcqChoice} | mcqCorrect=${o==null?void 0:o.mcqCorrect} | mcqPass=${o==null?void 0:o.mcqPass}`:"",c=typeof(r==null?void 0:r.retrievabilityNow)=="number"?r.retrievabilityNow:null,m=typeof(r==null?void 0:r.retrievabilityTarget)=="number"?r.retrievabilityTarget:null,p=Number.isFinite(r==null?void 0:r.elapsedDays)?Number(r.elapsedDays):0,h=Number.isFinite(r==null?void 0:r.stabilityDays)?Number(r.stabilityDays):0,g=Number.isFinite(r==null?void 0:r.difficulty)?Number(r.difficulty):0,f=r==null?void 0:r.stateBefore,y=r==null?void 0:r.stateAfter,v=c===null?"\u2014":c.toFixed(4),C=m===null?"\u2014":m.toFixed(4),w=f===void 0&&y===void 0?"":f===y||f===void 0?`state=${this.fsrsStateName(y)}`:`state=${this.fsrsStateName(f)}\u2192${this.fsrsStateName(y)}`,b=c===null?"":` | t=${p}d`;console.log(`${A} FSRS: card ${e} | type=${t} | rating=${i} | ${w}${b} | R_now=${v} | R_target=${C} | S=${h.toFixed(2)}d | D=${g.toFixed(2)} | nextDue=${d}${u}`)}async gradeCurrentRating(e,t){let i=this.currentCard();if(!i||!this.session)return;let r=String(i.id);if(this.session.graded[r])return;let a=Date.now(),o=this.plugin.store.getState(r);if(!o)return;let{nextState:l,prevDue:d,nextDue:u,metrics:c}=Oe(o,e,a,this.plugin.settings);this.plugin.store.upsertState(l),this.plugin.store.appendReviewLog({id:r,at:a,result:e,prevDue:d,nextDue:u,meta:t||null}),await this.plugin.store.persist(),this.session.graded[r]={rating:e,at:a,meta:t||null},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!0,this.logFsrsIfNeeded(r,String(i.type||"unknown"),e,c,u,t||null)}async buryCurrentCard(){if(this.mode!=="session"||!this.session)return;let e=this.currentCard();if(!e)return;let t=String(e.id);if(this.session.graded[t])return;let i=this.plugin.store.getState(t);if(!i)return;let r=Date.now(),a=Et(i,r);this.plugin.store.upsertState(a),await this.plugin.store.persist(),this.session.graded[t]={rating:"again",at:r,meta:{action:"bury"}},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!1,this.nextCard(!0)}async suspendCurrentCard(){if(this.mode!=="session"||!this.session)return;let e=this.currentCard();if(!e)return;let t=String(e.id);if(this.session.graded[t])return;let i=this.plugin.store.getState(t);if(!i)return;let r=Date.now(),a=Mt(i,r);this.plugin.store.upsertState(a),await this.plugin.store.persist(),this.session.graded[t]={rating:"again",at:r,meta:{action:"suspend"}},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!1,this.nextCard(!0)}closeMoreMenu(){this._moreOpen=!1,this._moreMenuEl&&(this._moreMenuEl.style.display="none"),this._moreBtnEl&&this._moreBtnEl.setAttribute("aria-expanded","false")}toggleMoreMenu(e){var i;let t=typeof e=="boolean"?e:!this._moreOpen;if(this._moreOpen=t,this._moreMenuEl&&(this._moreMenuEl.style.display=t?"block":"none"),this._moreBtnEl&&this._moreBtnEl.setAttribute("aria-expanded",t?"true":"false"),t&&this._moreMenuEl){let r=this._moreMenuEl.querySelector("button");(i=r==null?void 0:r.focus)==null||i.call(r)}}injectMoreMenu(){var x,N,D,T;if(this.mode!=="session"||!this.session)return;let e=this.currentCard();if(!e)return;let t=String(e.id),i=!!this.session.graded[t],r=this.contentEl;r.querySelectorAll(['button[data-bc-action="bury-card"]','button[data-bc-action="suspend-card"]','button[data-bc-action="open-note"]','button[data-bc-action="edit-card"]','[data-bc-action="more-wrap"]','[data-bc-action="more-menu"]','button[data-bc-action="more-toggle"]'].join(",")).forEach(k=>k.remove());let a=(x=r.querySelector(".bc-flashcard"))!=null?x:r,o=Array.from(a.querySelectorAll(".bc-row"));if(!o.length)return;let l=(k,R)=>Array.from(k.querySelectorAll(".bc-btn-left")).some(P=>(P.textContent||"").trim().toLowerCase()===R.toLowerCase()),d=(k,R)=>R.some(B=>l(k,B)),u=["Again","Hard","Good","Easy"],c=(N=o.find(k=>d(k,u)))!=null?N:null,m=(D=o.find(k=>l(k,"Reveal")))!=null?D:null,p=(T=c!=null?c:m)!=null?T:o[o.length-1];if(!p)return;getComputedStyle(p).display!=="flex"&&(p.style.display="flex",p.style.alignItems="center"),this._moreWrap=null,this._moreMenuEl=null,this._moreBtnEl=null,this._moreOpen=!1;let g=_("span","bc-more-wrap");g.dataset.bcAction="more-wrap",g.style.position="relative",g.style.display="inline-flex",g.style.alignItems="center",g.style.marginLeft="auto",g.style.flex="0 0 auto";let f=this.makePlainButton("More",()=>this.toggleMoreMenu(),"bc-btn");f.dataset.bcAction="more-toggle",this.appendKeyboxRight(f,"M"),f.setAttribute("aria-haspopup","menu"),f.setAttribute("aria-expanded","false");let y=_("div","bc-more-menu");y.dataset.bcAction="more-menu",y.style.position="absolute",y.style.top="calc(100% + 6px)",y.style.right="0",y.style.zIndex="1000",y.style.display="none",y.style.minWidth="200px",y.style.padding="8px",y.style.border="1px solid var(--background-modifier-border)",y.style.borderRadius="10px",y.style.background="var(--background-primary)",y.style.boxShadow="0 10px 30px rgba(0,0,0,0.18)";let v=(k,R,B,P)=>{let L=this.makePlainButton(k,()=>{this.closeMoreMenu(),B()},"bc-btn");return L.style.width="100%",L.style.display="flex",L.style.justifyContent="space-between",L.style.marginBottom="6px",L.disabled=!!P,this.appendKeyboxRight(L,R),L},C=v("Bury","B",()=>void this.buryCurrentCard(),i);C.dataset.bcAction="bury-card";let w=v("Suspend","S",()=>void this.suspendCurrentCard(),i);w.dataset.bcAction="suspend-card";let b=v("Open Note","O",()=>void this.openCurrentCardInNote());b.dataset.bcAction="open-note";let S=v("Edit","E",()=>this.openEditModalForCurrentCard());S.dataset.bcAction="edit-card",S.style.marginBottom="0",y.appendChild(C),y.appendChild(w),y.appendChild(b),y.appendChild(S),y.addEventListener("mousedown",k=>k.stopPropagation()),g.appendChild(f),g.appendChild(y),p.appendChild(g);for(let k of o){let R=k.querySelector("button")!=null,B=(k.textContent||"").trim().length>0;!R&&!B&&k.remove()}this._moreWrap=g,this._moreMenuEl=y,this._moreBtnEl=f}async answerMcq(e){let t=this.currentCard();if(!t||t.type!=="mcq"||!this.session)return;let i=String(t.id);if(this.session.graded[i])return;let r=e===t.correctIndex,a=r?"easy":"again";if(!this.plugin.store.getState(i)){console.warn(`${A} MCQ: missing state for id=${i}; cannot grade/FSRS`);return}await this.gradeCurrentRating(a,{mcqChoice:e,mcqCorrect:t.correctIndex,mcqPass:r}),this.render()}async nextCard(e){if(!this.session)return;let t=this.currentCard();if(t){let i=String(t.id);this.session.graded[i]||await this.gradeCurrentRating("again",{auto:!0,via:"next"})}if(this.session.index<this.session.queue.length-1){this.session.index+=1;let i=this.currentCard();this.showAnswer=!!(i&&this.session.graded[String(i.id)]),this.render();return}this.session.index=this.session.queue.length,this.showAnswer=!0,this.render()}prevCard(){if(!this.session||this.session.index<=0)return;this.session.index-=1;let e=this.currentCard();this.showAnswer=!!(e&&this.session.graded[String(e.id)]),this.render()}openSession(e){if(this.clearTimer(),this.clearCountdown(),this.closeMoreMenu(),this.mode="session",this.session=this.buildSession(e),this.session){let t=this.session;(!t.mcqOrderMap||typeof t.mcqOrderMap!="object")&&(t.mcqOrderMap={})}this.showAnswer=!1,this.render()}backToDecks(){this.clearTimer(),this.clearCountdown(),this.closeMoreMenu(),this.mode="deck",this.session=null,this.showAnswer=!1,this.render()}keySymbol(e){return e.toLowerCase()==="enter"?"\u23CE":e}keybox(e,t=""){let i=_("span",`bc-keywrap${t?" "+t:""}`),r=_("span","bc-keybox");return r.textContent=this.keySymbol(e),i.appendChild(r),i}appendKeyboxRight(e,t){let i=_("span","bc-btn-right");i.appendChild(this.keybox(t)),e.appendChild(i)}makePlainButton(e,t,i="bc-btn"){let r=document.createElement("button");r.type="button",r.className=i,r.addEventListener("click",t);let a=_("span","bc-btn-left");return a.textContent=e,r.appendChild(a),r}isActiveLeaf(){var i,r,a,o,l;let e=this.app.workspace,t=(l=(o=(r=e==null?void 0:e.activeLeaf)!=null?r:(i=e==null?void 0:e.getMostRecentLeaf)==null?void 0:i.call(e))!=null?o:(a=e==null?void 0:e.getLeaf)==null?void 0:a.call(e,!1))!=null?l:null;return!!t&&t===this.leaf}handleKey(e){if(!this.isActiveLeaf())return;let t=e.target;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.tagName==="SELECT"||t.isContentEditable)||this.mode!=="session"||!this.session)return;if(e.key==="Escape"&&this._moreOpen){e.preventDefault(),e.stopPropagation(),this.closeMoreMenu();return}let i=this.currentCard();if(!i)return;let r=String(i.id),a=this.session.graded[r]||null,o=(e.key||"").toLowerCase();if(o==="m"){e.preventDefault(),e.stopPropagation(),this.toggleMoreMenu();return}if(o==="o"){e.preventDefault(),e.stopPropagation(),this.closeMoreMenu(),this.openCurrentCardInNote();return}if(o==="e"){e.preventDefault(),e.stopPropagation(),this.closeMoreMenu(),this.openEditModalForCurrentCard();return}if(!a&&(o==="b"||o==="s")){e.preventDefault(),e.stopPropagation(),this.closeMoreMenu(),o==="b"?this.buryCurrentCard():this.suspendCurrentCard();return}let l=e.key==="Enter"||e.code==="Enter"||e.code==="NumpadEnter";if(e.key==="ArrowLeft"){if(e.preventDefault(),e.stopPropagation(),this.closeMoreMenu(),(i.type==="basic"||i.type==="cloze")&&this.showAnswer){this.showAnswer=!1,this.render();return}this.prevCard();return}if(l&&a){e.preventDefault(),e.stopPropagation(),this.closeMoreMenu(),this.nextCard(!0);return}if(i.type==="mcq"){if(/^[1-9]$/.test(e.key)){e.preventDefault(),e.stopPropagation(),this.closeMoreMenu();let u=Number(e.key)-1,c=i.options||[];if(u<0||u>=c.length)return;let p=this.getMcqOptionOrder(i)[u];Number.isInteger(p)&&p>=0&&p<c.length&&this.answerMcq(p)}return}if(i.type==="basic"||i.type==="cloze"){if(l&&!a){e.preventDefault(),e.stopPropagation(),this.closeMoreMenu(),this.showAnswer||(this.showAnswer=!0,this.render());return}if(e.key==="1"||e.key==="2"){if(e.preventDefault(),e.stopPropagation(),this.closeMoreMenu(),!this.showAnswer){this.showAnswer=!0,this.render();return}if(!a){let u=e.key==="1"?"again":"easy";this.gradeCurrentRating(u,{}).then(()=>void this.nextCard(!0));return}this.nextCard(!0)}}}async resyncActiveFile(){let e=this.plugin._getActiveMarkdownFile();if(!e)return;let t=await ee(this.plugin,e);new V.Notice(`${A}: ${t.newCount} new; ${t.updatedCount} updated; ${t.sameCount} unchanged; ${t.idsInserted} IDs inserted.`),t.quarantinedCount>0&&new ae(this.plugin.app,this.plugin,t.quarantinedIds).open(),this.plugin._refreshOpenViews()}renderHeaderActions(){var t;let e=(t=this.containerEl.querySelector(":scope > .view-header .view-actions"))!=null?t:this.containerEl.querySelector(".view-header .view-actions");e&&e.replaceChildren(),this.addAction("more-vertical","More options",()=>{new V.Notice(`${A}: options clicked`)}),this.addAction("refresh-cw","Sync Flashcards",()=>{let i=this.plugin;typeof i._runSync=="function"?i._runSync():typeof i.syncBank=="function"?i.syncBank():this.resyncActiveFile()})}extractInfoField(e){var a,o,l,d,u,c;if(!e)return null;let t=m=>{if(typeof m=="string"&&m.trim())return m.trim();if(Array.isArray(m)){let p=m.filter(h=>typeof h=="string").join(`
`).trim();return p||null}return null},i=(l=(o=(a=t(e.info))!=null?a:t(e.information))!=null?o:t(e.i))!=null?l:t(e.I);if(i)return i;let r=e.fields;if(r&&typeof r=="object"){let m=(c=(u=(d=t(r.info))!=null?d:t(r.information))!=null?u:t(r.i))!=null?c:t(r.I);if(m)return m}return null}hasInfoField(e){return!!this.extractInfoField(e)}isImageExtension(e){switch(String(e||"").toLowerCase()){case"png":case"jpg":case"jpeg":case"gif":case"webp":case"svg":case"bmp":case"tif":case"tiff":case"avif":return!0;default:return!1}}hydrateInternalImageEmbeds(e,t){let i=Array.from(e.querySelectorAll("span.internal-embed[src]"));for(let r of i){let a=r.getAttribute("src")||"";if(!a)continue;let o=this.app.metadataCache.getFirstLinkpathDest(a,t);if(!o||!(o instanceof V.TFile)||!this.isImageExtension(o.extension))continue;let l=document.createElement("img");l.classList.add("bc-embed-image"),l.alt=r.getAttribute("alt")||o.basename||o.name,l.src=this.app.vault.getResourcePath(o);let d=r.getAttribute("width"),u=r.getAttribute("height");d&&l.setAttribute("width",d),u&&l.setAttribute("height",u),r.replaceWith(l)}}async renderMarkdownInto(e,t,i){var o,l,d;let r=++this._mdRenderSerial;e.empty(),e.classList.add("markdown-preview-view","markdown-rendered");let a=i||((d=(l=(o=this.plugin)._getActiveMarkdownFile)==null?void 0:l.call(o))==null?void 0:d.path)||"";await V.MarkdownRenderer.renderMarkdown(t!=null?t:"",e,a,this),r===this._mdRenderSerial&&this.hydrateInternalImageEmbeds(e,a)}render(){var o,l,d,u,c,m,p,h,g;let e=this.contentEl;e.empty(),this._moreOpen=!1,this._moreWrap=null,this._moreMenuEl=null,this._moreBtnEl=null,e.classList.add("bc-content-view"),this.containerEl.addClass("bc-root","bc-reviewer-root"),(o=this.setTitle)==null||o.call(this,"Study Session (Boot Camp)"),this.renderHeaderActions();let t=this.mode==="deck"?`${A} \u2013 Deck Browser`:`${A} \u2013 Study Mode`;if(this.mode==="session"&&this.session){let f=_("div","bc-title-row");f.style.display="flex",f.style.justifyContent="space-between",f.style.alignItems="baseline",f.style.gap="12px";let y=_("div","bc-title",t);f.appendChild(y);let v=Number((u=(d=(l=this.session)==null?void 0:l.stats)==null?void 0:d.total)!=null?u:0),C=Number((m=(c=this.session)==null?void 0:c.index)!=null?m:0),w=Number((g=(h=(p=this.session)==null?void 0:p.stats)==null?void 0:h.done)!=null?g:0),b="";if(v>0){let x=Math.min(C+1,v);b=C>=v?`${Math.min(w,v)}/${v}`:`${x}/${v}`}let S=_("div","bc-muted",b);S.style.whiteSpace="nowrap",f.appendChild(S),e.appendChild(f)}else e.appendChild(_("div","bc-title",t));if(this.mode==="deck"){this.clearTimer(),this.clearCountdown(),this.closeMoreMenu();let f=this.getStageCountsAll(),y=_("div","bc-subtitle");y.addClass("bc-count-strip");let v=(C,w,b)=>{let S=_("span",`count-pill ${b}`),x=_("span","count-pill-label",`${C}`),N=_("span","count-pill-value",String(w));return S.appendChild(x),S.appendChild(N),S};y.appendChild(v("New",f.new,"count-pill-new")),y.appendChild(v("Relearning",f.relearning,"count-pill-relearning")),y.appendChild(v("Learning",f.learning,"count-pill-learning")),y.appendChild(v("Review",f.review,"count-pill-review")),e.appendChild(y),Ht({app:this.app,plugin:this.plugin,container:e,expanded:this.expanded,setExpanded:C=>this.expanded=C,openSession:C=>this.openSession(C),resyncActiveFile:()=>this.resyncActiveFile(),rerender:()=>this.render()});return}if(!this.session)return;let i=this.currentCard(),r=this.hasInfoField(i),a=!!this.plugin.settings.reviewer.showInfoByDefault||this.showAnswer&&r;Qt({container:e,session:this.session,showAnswer:this.showAnswer,setShowAnswer:f=>this.showAnswer=f,currentCard:()=>this.currentCard(),backToDecks:()=>this.backToDecks(),nextCard:f=>this.nextCard(f),gradeCurrentRating:(f,y)=>this.gradeCurrentRating(f,y),answerMcq:f=>this.answerMcq(f),showInfo:a,clearTimer:()=>this.clearTimer(),clearCountdown:()=>this.clearCountdown(),getNextDueInScope:f=>this.getNextDueInScope(f),startCountdown:(f,y)=>this.startCountdown(f,y),renderClozeFront:(f,y)=>Qe(f,y),renderMarkdownInto:(f,y,v)=>this.renderMarkdownInto(f,y,v),keybox:(f,y)=>this.keybox(f,y),makePlainButton:(f,y,v)=>this.makePlainButton(f,y,v),appendKeyboxRight:(f,y)=>this.appendKeyboxRight(f,y),randomizeMcqOptions:this.isMcqOptionRandomisationEnabled(),rerender:()=>this.render()}),queueMicrotask(()=>this.injectMoreMenu()),this.armTimer()}};var Vt=require("obsidian");var _e=class extends Vt.ItemView{constructor(e,t){super(e);this.activeFile=null;this.mode="summary";this.session=null;this.showAnswer=!1;this._timer=null;this._keysBound=!1;this.plugin=t}getViewType(){return W}getDisplayText(){return"Flashcard Widget (Boot Camp)"}getIcon(){return"footprints"}async onOpen(){this.activeFile=this.app.workspace.getActiveFile(),this.containerEl.tabIndex=0,this.containerEl.addEventListener("mousedown",()=>this.containerEl.focus()),this._keysBound||(this._keysBound=!0,this.containerEl.addEventListener("keydown",e=>this.handleKey(e))),this.render()}onRefresh(){this.render()}onFileOpen(e){this.activeFile=e||null,this.mode==="session"&&(this.mode="summary",this.session=null,this.showAnswer=!1),this.render()}clearTimer(){this._timer&&(window.clearTimeout(this._timer),this._timer=null)}armTimer(){if(this.clearTimer(),this.mode!=="session"||!this.session||!this.plugin.settings.reviewer.autoAdvanceEnabled)return;let e=Number(this.plugin.settings.reviewer.autoAdvanceSeconds);!Number.isFinite(e)||e<=0||(this._timer=window.setTimeout(async()=>{this._timer=null,await this.nextCard()},e*1e3))}folderNotesAsDecksEnabled(){var t,i;return((i=(t=this.plugin.settings)==null?void 0:t.widget)==null?void 0:i.treatFolderNotesAsDecks)!==!1}getFolderNoteInfo(e){var a;let t=(a=e.parent)!=null?a:null,i=t&&typeof t.name=="string"?t.name:null,r=t&&typeof t.path=="string"?t.path:null;return!i||!r||e.basename!==i||!r||r==="/"?null:{folderPath:r,folderName:i}}isFolderNote(e){return e?this.getFolderNoteInfo(e)!==null:!1}getCardsInActiveNoteOnly(){let e=this.activeFile;return e?this.plugin.store.getAllCards().filter(t=>t.sourceNotePath===e.path):[]}getCardsInActiveScope(){let e=this.activeFile;if(!e)return[];let t=this.getFolderNoteInfo(e),i=this.plugin.store.getAllCards();if(!t)return i.filter(a=>a.sourceNotePath===e.path);if(!this.folderNotesAsDecksEnabled())return i.filter(a=>a.sourceNotePath===e.path);let r=t.folderPath.endsWith("/")?t.folderPath:t.folderPath+"/";return i.filter(a=>typeof a.sourceNotePath=="string"&&a.sourceNotePath.startsWith(r))}computeCounts(e){let t=Date.now(),i=this.plugin.store.data.states||{},r=e.length,a=0,o=0,l=0;for(let d of e){let u=i[d.id];u&&(u.stage==="new"?a++:u.stage==="learning"&&u.due<=t?o++:u.stage==="review"&&u.due<=t&&l++)}return{total:r,new:a,learn:o,due:l}}buildSessionForActiveNote(){var g,f;let e=this.activeFile;if(!e)return null;let t=Date.now(),i=this.getCardsInActiveScope(),r=this.plugin.store.data.states||{},a=i.filter(y=>r[y.id]&&r[y.id].stage==="learning"&&r[y.id].due<=t),o=i.filter(y=>r[y.id]&&r[y.id].stage==="review"&&r[y.id].due<=t),l=i.filter(y=>r[y.id]&&r[y.id].stage==="new"),d=(g=this.plugin.settings.reviewer.dailyReviewLimit)!=null?g:200,u=(f=this.plugin.settings.reviewer.dailyNewLimit)!=null?f:20,c=a.sort((y,v)=>r[y.id].due-r[v.id].due||String(y.id).localeCompare(String(v.id))).slice(0,d),m=o.sort((y,v)=>r[y.id].due-r[v.id].due||String(y.id).localeCompare(String(v.id))).slice(0,d),p=l.sort((y,v)=>String(y.id).localeCompare(String(v.id))).slice(0,u),h=c.concat(m).concat(p);return{scopeName:e.basename,queue:h,index:0,graded:{},stats:{total:h.length,done:0}}}currentCard(){return this.session&&this.session.queue[this.session.index]||null}async gradeCurrentRating(e,t){let i=this.currentCard();if(!i||!this.session)return;let r=String(i.id);if(this.session.graded[r])return;let a=Date.now(),o=this.plugin.store.getState(r);if(!o)return;let{nextState:l,prevDue:d,nextDue:u}=Oe(o,e,a,this.plugin.settings);this.plugin.store.upsertState(l),this.plugin.store.appendReviewLog({id:r,at:a,result:e,prevDue:d,nextDue:u,meta:t||null}),await this.plugin.store.persist(),this.session.graded[r]={rating:e,at:a,meta:t||null},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!0}async answerMcq(e){let t=this.currentCard();if(!t||t.type!=="mcq"||!this.session)return;let i=String(t.id);if(this.session.graded[i])return;let r=e===t.correctIndex;await this.gradeCurrentRating(r?"good":"again",{mcqChoice:e,mcqCorrect:t.correctIndex}),this.render()}async nextCard(){if(!this.session)return;let e=this.currentCard();if(e){let t=String(e.id);this.session.graded[t]||await this.gradeCurrentRating("again",{auto:!0,via:"next"})}if(this.session.index<this.session.queue.length-1){this.session.index+=1;let t=this.currentCard();this.showAnswer=!!(t&&this.session.graded[String(t.id)]),this.render();return}this.session.index=this.session.queue.length,this.showAnswer=!0,this.render()}startSession(){this.clearTimer(),this.session=this.buildSessionForActiveNote(),this.mode="session",this.showAnswer=!1,this.render()}backToSummary(){this.clearTimer(),this.mode="summary",this.session=null,this.showAnswer=!1,this.render()}handleKey(e){let t=e.target;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.tagName==="SELECT"||t.isContentEditable)||this.mode!=="session"||!this.session)return;let i=this.currentCard();if(!i)return;let r=this.session.graded[String(i.id)]||null;if(e.key===" "||e.code==="Space"||e.key==="Enter"||e.key==="ArrowRight"){if(e.preventDefault(),i.type==="basic"||i.type==="cloze"){if(!this.showAnswer){this.showAnswer=!0,this.render();return}this.nextCard();return}this.nextCard();return}if(e.key==="1"||e.key==="2"){if(e.preventDefault(),i.type==="basic"||i.type==="cloze"){if(!this.showAnswer){this.showAnswer=!0,this.render();return}if(!r){let o=e.key==="1"?"again":"easy";this.gradeCurrentRating(o,{}).then(()=>void this.nextCard());return}this.nextCard();return}this.nextCard()}}makeKeyedBtn(e,t,i,r){let a=document.createElement("button");a.type="button",a.className=t;let o=document.createElement("span");o.style.display="inline-flex",o.style.alignItems="center",o.style.gap="8px";let l=document.createElement("span");if(l.className="bc-btn-left",l.textContent=e,o.appendChild(l),i){let d=document.createElement("span");d.className="bc-btn-right";let u=document.createElement("span");u.className="bc-keywrap";let c=document.createElement("span");c.className="bc-keybox",c.textContent=i,u.appendChild(c),d.appendChild(u),o.appendChild(d)}return a.appendChild(o),a.addEventListener("click",r),a}renderSummary(e){let t=_("div","bc-card");t.classList.add("bc-widget");let i=this.activeFile,r=i?i.basename:"No note open",a=_("div","bc-back");a.classList.add("bc-widget-top");let o=_("button","bc-note-title",r);o.type="button",o.title=r,o.addEventListener("click",async()=>{if(!i)return;let p=this.plugin.app.vault.getAbstractFileByPath(i.path);p&&await this.plugin.app.workspace.getLeaf(!1).openFile(p)}),a.appendChild(o);let l=_("button","bc-back-btn","Open Reviewer");if(l.type="button",l.addEventListener("click",()=>this.plugin.openReviewerTab()),a.appendChild(l),t.appendChild(a),t.appendChild(_("div","bc-hr")),!i){t.appendChild(_("div","bc-muted","Open a note to see flashcards.")),e.appendChild(t);return}let d=this.getCardsInActiveScope(),u=this.computeCounts(d);if(t.appendChild(_("div","bc-muted bc-widget-countline",`Total: ${u.total} \u2022 New: ${u.new} \u2022 Learn: ${u.learn} \u2022 Due: ${u.due}`)),!d.length){t.appendChild(_("div","bc-hr"));let p=this.isFolderNote(i),h=this.folderNotesAsDecksEnabled();p?h?t.appendChild(_("div","bc-muted","No flashcards found in this note or folder.")):t.appendChild(_("div","bc-muted","No flashcards found in this note. If you would like to search this folder, enable \u201CTreat folder notes as decks\u201D in the settings.")):t.appendChild(_("div","bc-muted","No flashcards found in this note.")),e.appendChild(t);return}t.appendChild(_("div","bc-hr"));let c=_("div","bc-row"),m=this.makeKeyedBtn("Study","bc-btn blue-btn","\u23CE",()=>this.startSession());c.appendChild(m),t.appendChild(c),e.appendChild(t)}renderSession(e){var m,p,h,g,f,y,v;let t=_("div","bc-card");t.classList.add("bc-widget");let i=_("div","bc-back"),r=document.createElement("button");r.className="bc-back-btn",r.type="button",r.title="Back",r.textContent="Back",r.addEventListener("click",()=>this.backToSummary()),i.appendChild(r),i.appendChild(_("div","bc-muted",((m=this.session)==null?void 0:m.scopeName)||"Note")),t.appendChild(i),t.appendChild(_("div","bc-hr"));let a=this.currentCard();if(!a){t.appendChild(_("div","bc-title","Session complete")),t.appendChild(_("div","bc-muted",`Done: ${((h=(p=this.session)==null?void 0:p.stats)==null?void 0:h.done)||0}/${((f=(g=this.session)==null?void 0:g.stats)==null?void 0:f.total)||0}`)),e.appendChild(t),this.clearTimer();return}let o=String(a.id),l=((y=this.session)==null?void 0:y.graded[o])||null,d=a.title||(a.type==="mcq"?"MCQ":a.type==="cloze"?"Cloze":"Basic");if(t.appendChild(_("div","bc-title",d)),t.appendChild(_("div","bc-muted",`ID ${o} \u2022 ${this.session.index+1}/${this.session.stats.total}`)),t.appendChild(_("div","bc-hr")),a.type==="basic")t.appendChild(_("div","",a.q||"")),(this.showAnswer||l)&&(t.appendChild(_("div","bc-hr")),t.appendChild(_("div","",a.a||"")));else if(a.type==="cloze"){let C=a.clozeText||"",w=this.showAnswer||!!l;t.appendChild(Qe(C,w))}else if(a.type==="mcq"){t.appendChild(_("div","",a.stem||""));let C=a.options||[],w=(v=l==null?void 0:l.meta)==null?void 0:v.mcqChoice;C.forEach((b,S)=>{let x=_("div","bc-option",b);l||x.addEventListener("click",()=>this.answerMcq(S)),l&&(S===a.correctIndex&&x.classList.add("correct"),typeof w=="number"&&w===S&&w!==a.correctIndex&&x.classList.add("wrong")),t.appendChild(x)})}let u=_("div","bc-row");(a.type==="basic"||a.type==="cloze")&&!this.showAnswer&&u.appendChild(this.makeKeyedBtn("Reveal","bc-btn blue-btn","\u23CE",()=>{this.showAnswer=!0,this.render()})),t.appendChild(u);let c=_("div","bc-row");l?c.appendChild(this.makeKeyedBtn("Next","bc-btn blue-btn","\u23CE",async()=>{await this.nextCard()})):(a.type==="basic"||a.type==="cloze")&&this.showAnswer?(c.appendChild(this.makeKeyedBtn("Again","bc-btn red-btn","1",async()=>{await this.gradeCurrentRating("again",{}),this.render()})),c.appendChild(this.makeKeyedBtn("Easy","bc-btn green-btn","2",async()=>{await this.gradeCurrentRating("easy",{}),this.render()}))):a.type==="mcq"&&c.appendChild(_("div","bc-muted","Select an option.")),t.appendChild(c),e.appendChild(t),this.armTimer()}render(){let e=this.containerEl;e.empty(),e.addClass("bc-root"),this.mode==="session"?this.renderSession(e):this.renderSummary(e)}onunload(){this.clearTimer()}};var Q=require("obsidian");function qs(n){return!n||!Number.isFinite(n)?"\u2014":new Date(n).toLocaleString(void 0,{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function Ps(n){let s=(n||"").trim();return s?s.replace(/\.md$/i,"").split("/").filter(Boolean).join(" / "):"\u2014"}function Bs(){let n=new Date;return n.setHours(0,0,0,0),n.getTime()}function $s(){let n=new Date;return n.setHours(23,59,59,999),n.getTime()}function Os(n){var e;return[n.id,n.type,n.title||"",n.q||"",n.a||"",n.stem||"",(n.options||[]).join(" "),String((e=n.correctIndex)!=null?e:""),n.clozeText||"",n.info||"",n.sourceNotePath||""].join(`
`).toLowerCase()}function Ut(n){return(n||"").replace(/\\/g,"\\\\").replace(/\|/g,"\\|")}function Hs(n){let s=[],e="",t=!1;for(let i=0;i<n.length;i++){let r=n[i];if(t){e+=r,t=!1;continue}if(r==="\\"){t=!0;continue}if(r==="|"){s.push(e),e="";continue}e+=r}return s.push(e),s}function zs(n){let s=(n||"").replace(/\r?\n/g," ").trim();if(!s)throw new Error("MCQ options cannot be empty.");let e=s.includes("|")?Hs(s).map(r=>r.trim()).filter(Boolean):s.split(",").map(r=>r.trim()).filter(Boolean);if(e.length<2)throw new Error("MCQ requires at least 2 options (separate with |).");let t=-1,i=e.map((r,a)=>{let o=r.match(/^\*\*(.+)\*\*$/);if(o){if(t!==-1)throw new Error("MCQ has more than one bold (correct) option.");return t=a,o[1].trim()}return r});if(t===-1)throw new Error("MCQ requires exactly one correct option wrapped in ** **.");return{options:i,correctIndex:t}}function Qs(n){let s=(n||"").trim();if(!s)throw new Error("Cloze question (CQ) is required.");if(!/\{\{c\d+::.*?\}\}/.test(s))throw new Error("Cloze must include at least one {{cN::...}} token.")}function jt(n){return n.type==="basic"?n.q||"":n.type==="mcq"?n.stem||"":n.clozeText||""}function Wt(n){if(n.type==="basic")return n.a||"";if(n.type==="mcq"){let s=Array.isArray(n.options)?n.options:[],e=Number.isFinite(n.correctIndex)?n.correctIndex:-1;return s.map((i,r)=>{let a=Ut((i||"").trim());return r===e?`**${a}**`:a}).join(" | ")}return""}var Vs="There is no answer field for Cloze deletion cards. See the question field to adjust hidden fields.",js=/^<!--ID:(\d{9})-->$/,Ws=/^\^bc-(\d{9})$/;function Ve(n){let s=(n||"").trim();return js.test(s)||Ws.test(s)}function Ks(n,s){let e=`^bc-${s}`,t=`<!--ID:${s}-->`,i=n.findIndex(l=>(l||"").trim()===e);if(i===-1&&(i=n.findIndex(l=>(l||"").trim()===t),i===-1))throw new Error(`Could not locate card ${s} in note.`);let r=i;for(;r>0;){let l=(n[r-1]||"").trim();if(Ve(l)){r--;continue}if(l===""&&r-2>=0&&Ve(n[r-2]||"")){r--;continue}break}i=r;let a=!1,o=n.length;for(let l=i;l<n.length;l++){let d=(n[l]||"").trim();if(!a){if(d===""||Ve(d))continue;a=!0;continue}if(Ve(d)){o=l;break}}return{start:i,end:o}}function Us(n,s){let e=[];e.push(`^bc-${n}`);let t=(s.title||"").trim();if(t){let r=t.split(/\r?\n/);e.push(`T: ${r[0]}`);for(let a=1;a<r.length;a++)e.push(r[a])}if(s.type==="basic")e.push(`Q: ${(s.q||"").trim()}`),e.push(`A: ${(s.a||"").trim()}`);else if(s.type==="cloze")e.push(`CQ: ${(s.clozeText||"").trim()}`);else if(s.type==="mcq"){e.push(`MCQ: ${(s.stem||"").trim()}`);let r=Array.isArray(s.options)?s.options:[],a=Number.isFinite(s.correctIndex)?s.correctIndex:-1,o=r.map((l,d)=>{let u=Ut((l||"").trim());return d===a?`**${u}**`:u});e.push(`O: ${o.join(" | ")}`)}let i=(s.info||"").trim();if(i){let r=i.split(/\r?\n/);e.push(`I: ${r[0]}`);for(let a=1;a<r.length;a++)e.push(r[a])}return e.push(""),e}function Kt(n){return n==="basic"?"Basic":n==="mcq"?"MCQ":n==="cloze"?"Cloze":n}function lt(n){return n==="new"?"New":n==="learning"?"Learning":n==="relearning"?"Relearning":n==="review"?"Review":n==="suspended"?"Suspended":n}var Se=class extends Q.ItemView{constructor(e,t){super(e);this.query="";this.typeFilter="all";this.stageFilter="all";this.dueFilter="all";this.sortKey="due";this.sortAsc=!0;this.colWidths={id:120,type:90,stage:100,due:90,title:150,question:200,answer:200,info:250,location:150};this._colMin={id:120,type:90,stage:100,due:90,title:100,question:100,answer:100,info:150,location:100};this._colMax={id:500,type:500,stage:500,due:500,title:500,question:500,answer:500,info:500,location:500};this._tableBody=null;this._headerEls={};this._colEls={};this._colCount=9;this._saving=new Set;this._suppressHeaderClickUntil=0;this._summaryEl=null;this._unsuspending=new Set;this.plugin=t}getViewType(){return ie}getDisplayText(){return"Flashcard Browser (Boot Camp)"}getIcon(){return"table-2"}async onOpen(){this.render()}onRefresh(){this.render()}getStateFor(e){return this.plugin.store.getState(e)}async unsuspendById(e){if(this._unsuspending.has(e))return;let t=this.plugin.store.getState(e);if(!(!t||t.stage!=="suspended")){this._unsuspending.add(e);try{let i=Date.now(),r=Tt(t,i);this.plugin.store.upsertState(r),await this.plugin.store.persist(),new Q.Notice("Unsuspended card"),this.refreshTable()}catch(i){new Q.Notice(`${A}: ${(i==null?void 0:i.message)||String(i)}`)}finally{this._unsuspending.delete(e)}}}computeRows(){let e=this.plugin.store.getAllCards(),t=(this.query||"").trim().toLowerCase(),i=Date.now(),r=Bs(),a=$s(),o=e.map(u=>{var h;let c=this.getStateFor(String(u.id)),p=String((c==null?void 0:c.stage)||"new")==="suspended"?null:(h=c==null?void 0:c.due)!=null?h:null;return{card:u,state:c,dueMs:p}});this.typeFilter!=="all"&&(o=o.filter(u=>u.card.type===this.typeFilter)),this.stageFilter!=="all"&&(o=o.filter(u=>{var c;return(((c=u.state)==null?void 0:c.stage)||"new")===this.stageFilter})),this.dueFilter!=="all"&&(o=o.filter(u=>{let c=u.dueMs;return c==null||!Number.isFinite(c)?this.dueFilter==="later":this.dueFilter==="due"?c<=i:this.dueFilter==="today"?c>=r&&c<=a:c>a})),t&&(o=o.filter(u=>Os(u.card).includes(t)));let l=this.sortAsc?1:-1,d=this.sortKey;return o.sort((u,c)=>{let m=this.sortValueFor(u.card,u.state,u.dueMs,d),p=this.sortValueFor(c.card,c.state,c.dueMs,d);return typeof m=="number"&&typeof p=="number"?(m-p)*l:String(m).localeCompare(String(p))*l}),o}sortValueFor(e,t,i,r){return r==="due"?i!=null?i:Number.POSITIVE_INFINITY:r==="id"?e.id:r==="type"?Kt(e.type):r==="stage"?lt(String((t==null?void 0:t.stage)||"new")):r==="location"?e.sourceNotePath||"":r==="title"?(e.title||"").split(/\r?\n/)[0]||"":r==="question"?jt(e):r==="answer"?e.type==="cloze"?"":Wt(e):r==="info"&&e.info||""}_refreshHeaderSortStyles(){for(let e of Object.keys(this._headerEls)){let t=this._headerEls[e];t&&(e===this.sortKey?t.classList.add("is-sorted"):t.classList.remove("is-sorted"))}}toggleSort(e){this.sortKey===e?this.sortAsc=!this.sortAsc:(this.sortKey=e,this.sortAsc=!0),this._refreshHeaderSortStyles(),this.refreshTable()}applyValueToCard(e,t,i){let r=JSON.parse(JSON.stringify(e)),a=i!=null?i:"";if(t==="title")return r.title=a,r;if(t==="question")return r.type==="basic"?r.q=a:r.type==="mcq"?r.stem=a:r.type==="cloze"&&(r.clozeText=a),r;if(t==="answer"){if(r.type==="basic")return r.a=a,r;if(r.type==="mcq"){let o=zs(a);return r.options=o.options,r.correctIndex=o.correctIndex,r}return r}return t==="info"&&(r.info=a),r}async openSource(e){let t=`${e.sourceNotePath}#^bc-${e.id}`;this.app.workspace.openLinkText(t,e.sourceNotePath,!0)}async writeCardToMarkdown(e){var u,c,m,p;let t=this.app.vault.getAbstractFileByPath(e.sourceNotePath);if(!(t instanceof Q.TFile))throw new Error(`Source note not found: ${e.sourceNotePath}`);if(e.type==="basic"){if(!(e.q||"").trim())throw new Error("Q: is required.");if(!(e.a||"").trim())throw new Error("A: is required.")}else if(e.type==="cloze")Qs(e.clozeText||"");else if(e.type==="mcq"){if(!(e.stem||"").trim())throw new Error("MCQ: is required.");let h=Array.isArray(e.options)?e.options.map(g=>(g||"").trim()).filter(Boolean):[];if(h.length<2)throw new Error("MCQ requires at least 2 options.");if(!(Number.isFinite(e.correctIndex)&&e.correctIndex>=0&&e.correctIndex<h.length))throw new Error("MCQ requires exactly one correct option.");e.options=h}let r=(await this.app.vault.read(t)).split(/\r?\n/),{start:a,end:o}=Ks(r,e.id),l=Us(e.id,e);r.splice(a,o-a,...l),await this.app.vault.modify(t,r.join(`
`));let d=await ee(this.plugin,t);d.quarantinedCount>0?new Q.Notice(`Saved changes to flashcards (but ${d.quarantinedCount} card(s) quarantined).`):new Q.Notice("Saved changes to flashcards"),(c=(u=this.plugin)._refreshOpenViews)==null||c.call(u),(p=(m=this.plugin).refreshAllViews)==null||p.call(m)}makeResizableTh(e,t){e.style.position="relative";let i=14;e.style.paddingRight=`${i}px`;let r=document.createElement("div");r.className="bc-col-resize",r.title="Drag to resize",r.style.position="absolute",r.style.top="0",r.style.right="0",r.style.height="100%",r.style.width=`${i}px`,r.style.cursor="col-resize",r.style.userSelect="none",r.style.touchAction="none",e.appendChild(r);let a=o=>{var g,f;o.preventDefault(),o.stopPropagation();let l=o.clientX,d=this.colWidths[t]||120,u=(g=this._colMin[t])!=null?g:70,c=(f=this._colMax[t])!=null?f:500,m=!1;this._suppressHeaderClickUntil=Date.now()+400;let p=y=>{let v=y.clientX-l;!m&&Math.abs(v)>1&&(m=!0);let C=Math.min(c,Math.max(u,d+v));this.colWidths[t]=C;let w=this._colEls[t];w&&(w.style.width=`${C}px`)},h=()=>{document.removeEventListener("mousemove",p,!0),document.removeEventListener("mouseup",h,!0),this._suppressHeaderClickUntil=Date.now()+(m?500:250)};document.addEventListener("mousemove",p,!0),document.addEventListener("mouseup",h,!0)};r.addEventListener("mousedown",a),r.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation()})}refreshTable(){let e=this._tableBody;if(!e)return;let t=this.computeRows(),i=document.createElement("tbody");if(t.length===0){let r=document.createElement("tr");r.className="bc-tr";let a=document.createElement("td");a.className="bc-td bc-muted-cell",a.colSpan=this._colCount,a.style.textAlign="center",a.style.padding="14px 10px",a.textContent="No cards match your filters.",r.appendChild(a),i.appendChild(r),e.replaceWith(i),this._tableBody=i,this._summaryEl&&(this._summaryEl.textContent="0 card(s) shown");return}for(let{card:r,state:a,dueMs:o}of t){let l=document.createElement("tr");l.className="bc-tr";let d=(f,y)=>{let v=document.createElement("td");return v.className="bc-td bc-muted-cell",v.textContent=f,y&&(v.title=y),v},u=document.createElement("td");u.className="bc-td bc-muted-cell";let c=document.createElement("button");c.type="button",c.className="bc-id-pill count-pill count-pill-new",c.title=`Open card ^bc-${r.id}`,c.setAttribute("aria-label",`Open card ${r.id}`);let m=document.createElement("span");m.className="count-pill-value",m.textContent=r.id;let p=document.createElement("span");p.className="bc-id-pill-icon",p.setAttribute("aria-hidden","true"),(0,Q.setIcon)(p,"link"),c.appendChild(m),c.appendChild(p),c.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),this.openSource(r)}),u.appendChild(c),l.appendChild(u),l.appendChild(d(Kt(r.type)));let h=String((a==null?void 0:a.stage)||"new");if(h==="suspended"){let f=document.createElement("td");f.className="bc-td bc-muted-cell",f.style.whiteSpace="normal";let y=document.createElement("div");y.textContent=lt(h),f.appendChild(y);let v=document.createElement("button");v.type="button",v.className="bc-btn bc-unsuspend-btn",v.textContent="Unsuspend",v.title="Move card back to New (due now)",v.style.marginTop="6px",v.style.padding="2px 8px",v.style.fontSize="11px",v.disabled=this._unsuspending.has(r.id),v.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation(),this.unsuspendById(r.id)}),f.appendChild(v),l.appendChild(f)}else l.appendChild(d(lt(h)));if(h==="suspended"){let f=d("Card currently suspended, no due data.");f.style.whiteSpace="normal",f.style.lineHeight="1.2",l.appendChild(f)}else l.appendChild(d(qs(o)));let g=f=>{if(f==="answer"&&r.type==="cloze")return d(Vs);let y=document.createElement("td");y.className="bc-td bc-td-editor",y.style.position="relative";let v=f==="title"?r.title||"":f==="question"?jt(r):f==="answer"?Wt(r):f==="info"&&r.info||"",C=document.createElement("textarea");C.className="bc-cell-input bc-cell-input-always",C.value=v;let w=`${r.id}:${f}`,b=v;return C.addEventListener("focus",()=>{b=C.value}),C.addEventListener("keydown",S=>{S.key==="Escape"&&(S.preventDefault(),S.stopPropagation(),C.value=b)}),C.addEventListener("blur",async()=>{let S=C.value;if(S!==b&&!this._saving.has(w)){this._saving.add(w);try{let x=this.applyValueToCard(r,f,S);await this.writeCardToMarkdown(x),b=S}catch(x){new Q.Notice(`${A}: ${(x==null?void 0:x.message)||String(x)}`),C.value=b}finally{this._saving.delete(w)}}}),y.appendChild(C),y};l.appendChild(g("title")),l.appendChild(g("question")),l.appendChild(g("answer")),l.appendChild(g("info")),l.appendChild(d(Ps(r.sourceNotePath),r.sourceNotePath)),i.appendChild(l)}e.replaceWith(i),this._tableBody=i,this._summaryEl&&(this._summaryEl.textContent=`${t.length} card(s) shown`)}render(){var C,w;let e=this.contentEl;e.empty(),e.classList.add("bc-view-content"),this.containerEl.addClass("bc-root","bc-browser-root"),(C=this.setTitle)==null||C.call(this,"Flashcard Browser (Boot Camp)");let t=(w=this.containerEl.querySelector(":scope > .view-header .view-actions"))!=null?w:this.containerEl.querySelector(".view-header .view-actions");t&&t.querySelectorAll('[data-bc-action="sync-flashcards"]').forEach(b=>b.remove());let i=this.addAction("refresh-cw","Sync flashcards",()=>{let b=this.plugin;typeof b._runSync=="function"?b._runSync():typeof b.syncBank=="function"?b.syncBank():new Q.Notice("Sync not available (no sync method found).")});if(i.dataset.bcAction="sync-flashcards",t){let b=t.querySelector('button[aria-label="More options"]');b&&(window.getComputedStyle(t).flexDirection==="row-reverse"?b.insertAdjacentElement("afterend",i):t.insertBefore(i,b))}let r=document.createElement("div");r.className="bc-title",r.textContent=`${A} \u2013 Flashcard Browser`,e.appendChild(r);let a=document.createElement("div");a.style.display="flex",a.style.flexWrap="wrap",a.style.gap="8px",a.style.margin="10px 0",e.appendChild(a);let o=document.createElement("input");o.type="text",o.placeholder="Search\u2026",o.value=this.query,o.style.flex="1",o.addEventListener("input",()=>{this.query=o.value,this.refreshTable()}),a.appendChild(o);let l=(b,S,x)=>{let N=document.createElement("select");N.value=b;for(let D of S){let T=document.createElement("option");T.value=D.v,T.textContent=D.label,N.appendChild(T)}return N.onchange=()=>x(N.value),N};a.appendChild(l(this.typeFilter,[{v:"all",label:"All types"},{v:"basic",label:"Basic"},{v:"mcq",label:"MCQ"},{v:"cloze",label:"Cloze"}],b=>{this.typeFilter=b,this.refreshTable()})),a.appendChild(l(this.stageFilter,[{v:"all",label:"All stages"},{v:"new",label:"New"},{v:"learning",label:"Learning"},{v:"relearning",label:"Relearning"},{v:"review",label:"Review"},{v:"suspended",label:"Suspended"}],b=>{this.stageFilter=b,this.refreshTable()})),a.appendChild(l(this.dueFilter,[{v:"all",label:"All due"},{v:"due",label:"Due now"},{v:"today",label:"Due today"},{v:"later",label:"Later"}],b=>{this.dueFilter=b,this.refreshTable()}));let d=document.createElement("button");d.className="bc-btn",d.type="button",d.textContent="Sync bank",d.onclick=()=>{let b=this.plugin;typeof b._runSync=="function"?b._runSync():typeof b.syncBank=="function"?b.syncBank():new Q.Notice("Sync not available (no sync method found).")},a.appendChild(d);let u=document.createElement("div");u.className="bc-muted",e.appendChild(u),this._summaryEl=u;let c=document.createElement("div");c.className="bc-table-wrap",c.style.flex="1",c.style.minHeight="0",c.style.overflow="auto",c.style.position="relative",e.appendChild(c);let m=document.createElement("table");m.className="bc-browser-table",c.appendChild(m);let p=document.createElement("colgroup");m.appendChild(p),this._colEls={};let h=["id","type","stage","due","title","question","answer","info","location"];this._colCount=h.length,h.forEach(b=>{let S=document.createElement("col");S.setAttribute("data-col",b),S.style.width=`${this.colWidths[b]||120}px`,p.appendChild(S),this._colEls[b]=S});let g=document.createElement("thead");g.style.position="sticky",g.style.top="0",g.style.zIndex="3",g.style.background="var(--background-primary)",m.appendChild(g);let f=document.createElement("tr");g.appendChild(f),this._headerEls={};let y=(b,S)=>{let x=document.createElement("th");return x.className="bc-th bc-sortable",x.textContent=b,x.style.position="sticky",x.style.top="0",x.style.zIndex="4",x.style.background="var(--background-primary)",this._headerEls[S]=x,this.sortKey===S&&x.classList.add("is-sorted"),x.addEventListener("click",N=>{var T;if(Date.now()<this._suppressHeaderClickUntil){N.preventDefault(),N.stopPropagation();return}let D=N.target;if((T=D==null?void 0:D.closest)!=null&&T.call(D,".bc-col-resize")){N.preventDefault(),N.stopPropagation();return}this.toggleSort(S)}),this.makeResizableTh(x,S),x};f.appendChild(y("Unique ID","id")),f.appendChild(y("Type","type")),f.appendChild(y("Stage","stage")),f.appendChild(y("Due","due")),f.appendChild(y("Title","title")),f.appendChild(y("Question","question")),f.appendChild(y("Answer / Options","answer")),f.appendChild(y("Extra Information","info")),f.appendChild(y("Location","location"));let v=document.createElement("tbody");m.appendChild(v),this._tableBody=v,this._refreshHeaderSortStyles(),this.refreshTable()}};var F=require("obsidian");var Gs=/^\^bc-(\d{9})\s*$/,Ys=/^(Q|MCQ|CQ)\s*(?::|\|)\s*.*$/,Xs=/^(T|A|I)\s*(?::|\|)\s*.*$|^O:\s*.*$|^(C|K)\s*:\s*.*$|^(C|K)\s*\|\s*.*$/,ct=class extends F.Modal{constructor(s,e){super(s),this.plugin=e}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:"Reset scheduling for all cards?"}),s.createEl("p",{text:"This will reset all cards to new and clear scheduling fields (including FSRS fields). This cannot be undone."});let e=s.createDiv();e.style.display="flex",e.style.gap="8px",e.style.marginTop="12px";let t=e.createEl("button",{text:"Cancel"});t.onclick=()=>this.close();let i=e.createEl("button",{text:"Reset scheduling"});i.onclick=async()=>{this.close();try{let r=this.plugin.resetAllCardScheduling;if(typeof r!="function"){new F.Notice("Boot Camp: resetAllCardScheduling() not found on plugin. Implement it in main.ts.");return}await r.call(this.plugin),new F.Notice(`Boot Camp \u2013 Settings Updated
Scheduling reset for all cards`)}catch(r){console.error(r),new F.Notice("Boot Camp: failed to reset scheduling (see console).")}}}onClose(){this.contentEl.empty()}},dt=class extends F.Modal{constructor(s,e,t){super(s),this.plugin=e,this.onConfirm=t}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:"Delete ALL Boot Camp flashcards in this vault?"}),s.createEl("p").setText(["This will permanently delete Boot Camp flashcards from your notes and database.","","It will remove all Q/MCQ/CQ blocks (and their T/A/O/I lines), remove all ^bc-######### anchors, and clear Boot Camp data.","","This cannot be undone."].join(`
`));let t=s.createDiv();t.style.display="flex",t.style.gap="8px",t.style.marginTop="12px";let i=t.createEl("button",{text:"Cancel"});i.onclick=()=>this.close();let r=t.createEl("button",{text:"Delete ALL flashcards"});r.style.background="var(--background-modifier-error)",r.style.color="var(--text-on-accent)",r.onclick=async()=>{this.close();try{await this.onConfirm()}catch(a){console.error(a),new F.Notice("Boot Camp: failed to delete flashcards (see console).")}}}onClose(){this.contentEl.empty()}};function Gt(n){return n.split(",").map(s=>Number(s.trim())).filter(s=>Number.isFinite(s)&&s>0)}function Zs(n,s,e){return Math.max(s,Math.min(e,n))}function Yt(n,s){let e=Number(n);return Number.isFinite(e)?Math.max(0,Math.floor(e)):s}function X(n){if(typeof n=="boolean")return n?"On":"Off";if(typeof n=="number")return Number.isFinite(n)?String(n):"\u2014";if(typeof n=="string")return n;if(Array.isArray(n))return n.map(s=>String(s)).join(",");if(n==null)return"\u2014";try{return JSON.stringify(n)}catch(s){return String(n)}}function je(n){return Gs.test(n.trim())}function Xt(n){return Ys.test(n.trim())}function Jt(n){return Xs.test(n.trim())}function Zt(n,s){for(let t=1;t<=8&&s+t<n.length;t++){let i=n[s+t].trim();if(i)return!!(je(i)||Jt(i))}return!1}var Ee=class extends F.PluginSettingTab{constructor(e,t){super(e,t);this._noticeTimers=new Map;this.plugin=t}queueSettingsNotice(e,t,i=200){let r=this._noticeTimers.get(e);r&&window.clearTimeout(r);let a=window.setTimeout(()=>{this._noticeTimers.delete(e),new F.Notice(`Boot Camp \u2013 Settings Updated
${t}`)},Math.max(0,i));this._noticeTimers.set(e,a)}refreshAllWidgetViews(){let e=this.app.workspace.getLeavesOfType(W);for(let t of e){let i=t.view;try{typeof(i==null?void 0:i.resetToSummaryAndRender)=="function"?i.resetToSummaryAndRender():typeof(i==null?void 0:i.onRefresh)=="function"?i.onRefresh():typeof(i==null?void 0:i.render)=="function"&&i.render()}catch(r){console.error("Boot Camp: failed to refresh widget view",r)}}}refreshReviewerViewsIfPossible(){let e=this.plugin;try{typeof(e==null?void 0:e._refreshOpenViews)=="function"&&e._refreshOpenViews()}catch(t){console.warn("Boot Camp: failed to refresh open views",t)}}async deleteAllBootCampDataFromVault(){let e=this.app.vault.getMarkdownFiles(),t=0,i=0,r=0,a=0;for(let o of e){let d=(await this.app.vault.read(o)).split(/\r?\n/),u=[],c=!1;for(let m=0;m<d.length;m++){let p=d[m],h=p.trim();if(je(h)){i++,a++,c=!0;continue}if(Xt(h)&&Zt(d,m)){r++,a++,c=!0;let g=m+1;for(;g<d.length;g++){let f=d[g].trim();if(Xt(f)&&Zt(d,g))break;if(!f||je(f)||Jt(f)){je(f)&&i++,a++;continue}break}m=g-1;continue}u.push(p)}c&&(t++,await this.app.vault.modify(o,u.join(`
`)))}return{filesTouched:t,anchorsRemoved:i,cardsRemoved:r,linesRemoved:a}}async clearBootCampStore(){var t,i,r,a,o;let e=(i=(t=this.plugin)==null?void 0:t.store)==null?void 0:i.data;!e||typeof e!="object"||(e.cards={},e.states={},e.reviewLog=[],e.quarantine={},e.version=Math.max(Number(e.version)||0,5),typeof((a=(r=this.plugin)==null?void 0:r.store)==null?void 0:a.persist)=="function"?await this.plugin.store.persist():typeof((o=this.plugin)==null?void 0:o.saveAll)=="function"&&await this.plugin.saveAll())}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Boot Camp"}),e.createEl("h3",{text:"Reviewer"}),new F.Setting(e).setName("Daily new limit").setDesc("Maximum number of new cards introduced per day (per deck scope). 0 disables new cards.").addText(p=>p.setValue(String(this.plugin.settings.reviewer.dailyNewLimit)).onChange(async h=>{let g=this.plugin.settings.reviewer.dailyNewLimit,f=Yt(h,20);this.plugin.settings.reviewer.dailyNewLimit=f,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),g!==f&&this.queueSettingsNotice("reviewer.dailyNewLimit",`Daily new limit changed to ${X(f)}`)})),new F.Setting(e).setName("Daily review limit").setDesc("Maximum number of due (learning/relearning/review) cards studied per day (per deck scope). 0 disables reviews.").addText(p=>p.setValue(String(this.plugin.settings.reviewer.dailyReviewLimit)).onChange(async h=>{let g=this.plugin.settings.reviewer.dailyReviewLimit,f=Yt(h,200);this.plugin.settings.reviewer.dailyReviewLimit=f,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),g!==f&&this.queueSettingsNotice("reviewer.dailyReviewLimit",`Review limit changed to ${X(f)}`)})),new F.Setting(e).setName("Auto-advance questions").setDesc("If enabled, unanswered questions fail automatically and the reviewer advances after the timer.").addToggle(p=>p.setValue(this.plugin.settings.reviewer.autoAdvanceEnabled).onChange(async h=>{let g=this.plugin.settings.reviewer.autoAdvanceEnabled;this.plugin.settings.reviewer.autoAdvanceEnabled=h,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),g!==h&&this.queueSettingsNotice("reviewer.autoAdvanceEnabled",`Auto-advance turned ${h?"on":"off"}`)})),new F.Setting(e).setName("Auto-advance after (seconds)").setDesc("Applies to both the reviewer tab and the note widget.").addSlider(p=>p.setLimits(3,60,1).setValue(Number(this.plugin.settings.reviewer.autoAdvanceSeconds)||10).setDynamicTooltip().onChange(async h=>{let g=this.plugin.settings.reviewer.autoAdvanceSeconds,f=Number(h)||10;this.plugin.settings.reviewer.autoAdvanceSeconds=f,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),g!==f&&this.queueSettingsNotice("reviewer.autoAdvanceSeconds",`Auto-advance seconds changed to ${X(f)}`)})),new F.Setting(e).setName("Randomise MCQ options").setDesc("If enabled, MCQ answer options are shuffled per-card (stable during the session). Hotkeys 1\u20139 follow the displayed order.").addToggle(p=>{var g;let h=!!((g=this.plugin.settings.reviewer)!=null&&g.randomizeMcqOptions);p.setValue(h),p.onChange(async f=>{var v;let y=!!((v=this.plugin.settings.reviewer)!=null&&v.randomizeMcqOptions);this.plugin.settings.reviewer.randomizeMcqOptions=f,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),y!==f&&this.queueSettingsNotice("reviewer.randomizeMcqOptions",`Randomise MCQ options turned ${f?"on":"off"}`)})}),e.createEl("h3",{text:"Widget"}),new F.Setting(e).setName("Treat folder notes as decks").setDesc("If enabled, a note whose filename matches its parent folder name (e.g. Psychiatry/Psychiatry.md) will study cards from all descendant notes in that folder.").addToggle(p=>{var g,f;let h=(f=(g=this.plugin.settings)==null?void 0:g.widget)==null?void 0:f.treatFolderNotesAsDecks;p.setValue(h!==!1),p.onChange(async y=>{var C,w,b,S;let v=(w=(C=this.plugin.settings)==null?void 0:C.widget)==null?void 0:w.treatFolderNotesAsDecks;(S=(b=this.plugin.settings).widget)!=null||(b.widget={}),this.plugin.settings.widget.treatFolderNotesAsDecks=y,await this.plugin.saveAll(),this.refreshAllWidgetViews(),this.refreshReviewerViewsIfPossible(),v!==y&&this.queueSettingsNotice("widget.treatFolderNotesAsDecks",`Folder notes turned ${y?"on":"off"}`)})}),e.createEl("h3",{text:"Scheduler (FSRS)"});let t=this.plugin.settings.scheduler,i=p=>{let h=Number(p);return Number.isFinite(h)?Number(h.toFixed(2)):NaN},r=(p,h)=>{if(!Array.isArray(p)||!Array.isArray(h)||p.length!==h.length)return!1;for(let g=0;g<p.length;g++)if(Number(p[g])!==Number(h[g]))return!1;return!0},a=[{key:"custom",label:"Custom",desc:"Does not change current values. Use the fields below.",learning:[],relearning:[],retention:.9},{key:"relaxed",label:"Relaxed",desc:"Learning: 20m | Relearning: 20m | Retention: 0.88",learning:[20],relearning:[20],retention:.88},{key:"balanced",label:"Balanced",desc:"Learning: 10m, 1d | Relearning: 10m | Retention: 0.90",learning:[10,1440],relearning:[10],retention:.9},{key:"aggressive",label:"Aggressive",desc:"Learning: 5m, 30m, 1d | Relearning: 10m | Retention: 0.92",learning:[5,30,1440],relearning:[10],retention:.92}],o=()=>{var f,y;let p=(f=t.learningStepsMinutes)!=null?f:[],h=(y=t.relearningStepsMinutes)!=null?y:[],g=i(t.requestRetention);for(let v of a)if(v.key!=="custom"&&r(p,v.learning)&&r(h,v.relearning)&&i(v.retention)===g)return v.key;return"custom"},l=null,d=!1,u=()=>{var g,f;if(!l)return;let p=o();if(((f=(g=l.getValue)==null?void 0:g.call(l))!=null?f:l.value)!==p){d=!0;try{l.setValue(p)}finally{d=!1}}};new F.Setting(e).setName("Preset").setDesc("Apply a recommended FSRS configuration (or choose Custom to keep current values).").addDropdown(p=>{l=p;for(let h of a)p.addOption(h.key,h.label);p.setValue(o()),p.onChange(async h=>{var C,w;if(d)return;let g=a.find(b=>b.key===h);if(!g)return;if(g.key==="custom"){this.queueSettingsNotice("scheduler.preset","FSRS preset changed to custom"),new F.Notice("Boot Camp: preset set to Custom (no changes applied).");return}let f=((C=t.learningStepsMinutes)!=null?C:[]).slice(),y=((w=t.relearningStepsMinutes)!=null?w:[]).slice(),v=t.requestRetention;t.learningStepsMinutes=g.learning.slice(),t.relearningStepsMinutes=g.relearning.slice(),t.requestRetention=g.retention,await this.plugin.saveAll(),this.queueSettingsNotice("scheduler.preset",`FSRS preset changed to ${g.key}`,0),r(f,t.learningStepsMinutes)||this.queueSettingsNotice("scheduler.learningStepsMinutes",`Learning steps changed to ${X(t.learningStepsMinutes)}`),r(y,t.relearningStepsMinutes)||this.queueSettingsNotice("scheduler.relearningStepsMinutes",`Relearning steps changed to ${X(t.relearningStepsMinutes)}`),i(v)!==i(t.requestRetention)&&this.queueSettingsNotice("scheduler.requestRetention",`Requested retention changed to ${X(t.requestRetention)}`),this.display()})}),new F.Setting(e).setName("Learning steps (minutes)").setDesc("Comma-separated. Examples: 10  |  10,1440 (10m then 1d)").addText(p=>{var h;return p.setValue(String(((h=t.learningStepsMinutes)!=null?h:[]).join(","))).onChange(async g=>{var v,C;let f=((v=t.learningStepsMinutes)!=null?v:[]).slice(),y=Gt(g);y.length&&(t.learningStepsMinutes=y),await this.plugin.saveAll(),u(),r(f,(C=t.learningStepsMinutes)!=null?C:[])||this.queueSettingsNotice("scheduler.learningStepsMinutes",`Learning steps changed to ${X(t.learningStepsMinutes)}`)})}),new F.Setting(e).setName("Relearning steps (minutes)").setDesc("Comma-separated. Used after lapses (Again in Review). Common: 10").addText(p=>{var h;return p.setValue(String(((h=t.relearningStepsMinutes)!=null?h:[]).join(","))).onChange(async g=>{var v,C;let f=((v=t.relearningStepsMinutes)!=null?v:[]).slice(),y=Gt(g);y.length&&(t.relearningStepsMinutes=y),await this.plugin.saveAll(),u(),r(f,(C=t.relearningStepsMinutes)!=null?C:[])||this.queueSettingsNotice("scheduler.relearningStepsMinutes",`Relearning steps changed to ${X(t.relearningStepsMinutes)}`)})}),new F.Setting(e).setName("Requested retention").setDesc("Target recall probability at review time. Typical: 0.85\u20130.95. Recommended: 0.90.").addSlider(p=>p.setLimits(.8,.97,.01).setValue(Zs(Number(t.requestRetention)||.9,.8,.97)).setDynamicTooltip().onChange(async h=>{let g=i(t.requestRetention);t.requestRetention=Number(Number(h).toFixed(2)),await this.plugin.saveAll(),u(),g!==i(t.requestRetention)&&this.queueSettingsNotice("scheduler.requestRetention",`Requested retention changed to ${X(t.requestRetention)}`)})),new F.Setting(e).setName("Reset scheduling (all cards)").setDesc("Resets all cards to new and clears scheduling fields. Irreversible.").addButton(p=>p.setButtonText("Reset\u2026").onClick(()=>{new ct(this.app,this.plugin).open()})),e.createEl("h3",{text:"Danger Zone"}),new F.Setting(e).setName("Delete all flashcards (vault)").setDesc("Deletes all Boot Camp flashcards from notes and clears Boot Camp data. Irreversible.").addButton(p=>p.setButtonText("Delete\u2026").onClick(()=>{new dt(this.app,this.plugin,async()=>{let h=Date.now(),{filesTouched:g,anchorsRemoved:f,cardsRemoved:y}=await this.deleteAllBootCampDataFromVault();await this.clearBootCampStore(),this.refreshAllWidgetViews(),this.refreshReviewerViewsIfPossible();let v=Math.max(0,Math.round((Date.now()-h)/100)/10);new F.Notice(`Boot Camp \u2013 Settings Updated
Deleted all flashcards: removed ${y} cards and ${f} anchors in ${g} files (${v}s)`)}).open()})),e.createEl("h3",{text:"Indexing"}),new F.Setting(e).setName("Ignore fenced code blocks").addToggle(p=>p.setValue(this.plugin.settings.indexing.ignoreInCodeFences).onChange(async h=>{let g=this.plugin.settings.indexing.ignoreInCodeFences;this.plugin.settings.indexing.ignoreInCodeFences=h,await this.plugin.saveAll(),g!==h&&this.queueSettingsNotice("indexing.ignoreInCodeFences",`Ignore fenced code blocks turned ${h?"on":"off"}`)})),e.createEl("h3",{text:"Error cards (quarantine)"});let c=this.plugin.store.data.quarantine||{},m=Object.keys(c);if(!m.length){e.createEl("div",{text:"No quarantined cards."});return}m.sort((p,h)=>p.localeCompare(h)).slice(0,200).forEach(p=>{let h=c[p];new F.Setting(e).setName(`ID ${p}`).setDesc((h==null?void 0:h.reason)||"Parse error").addButton(g=>g.setButtonText("Open note").onClick(async()=>{let f=h.notePath,y=`^bc-${p}`;try{this.app.workspace.openLinkText(`${f}#${y}`,f,!1);return}catch(C){}let v=this.app.vault.getAbstractFileByPath(f);v instanceof F.TFile&&await this.app.workspace.getLeaf(!1).openFile(v)}))})}};function Js(n,s,e){return Math.max(s,Math.min(e,n))}function en(n,s){let t=(Array.isArray(n)?n:[]).map(i=>Number(i)).filter(i=>Number.isFinite(i)&&i>0);return t.length?t:s}var We=class extends j.Plugin{constructor(){super(...arguments);this._ribbonEl=null;this._ribbonMenu=null;this._menuOpen=!1;this._hoverCloseTimer=null;this._tooltipEl=null;this._tooltipTimer=null}_normaliseSettingsInPlace(){var i,r;let e=this.settings;(i=e.scheduler)!=null||(e.scheduler={}),e.scheduler.learningStepsMinutes=en(e.scheduler.learningStepsMinutes,le.scheduler.learningStepsMinutes),e.scheduler.relearningStepsMinutes=en(e.scheduler.relearningStepsMinutes,le.scheduler.relearningStepsMinutes),e.scheduler.requestRetention=Js(Number((r=e.scheduler.requestRetention)!=null?r:le.scheduler.requestRetention),.8,.97);let t=["graduatingIntervalDays","easyBonus","hardFactor","minEase","maxEase","easeDeltaAgain","easeDeltaHard","easeDeltaEasy"];for(let a of t)a in e.scheduler&&delete e.scheduler[a]}async onload(){try{this._bc={VIEW_TYPE_REVIEWER:se,VIEW_TYPE_WIDGET:W,VIEW_TYPE_BROWSER:ie,BRAND:A,DEFAULT_SETTINGS:le,deepMerge:Ne,BootCampReviewerView:xe,BootCampWidgetView:_e,BootCampCardBrowserView:Se,BootCampSettingsTab:Ee,syncQuestionBank:rt,AddCardModal:Ce,ParseErrorModal:ae};let e=await this.loadData()||{};if(this.settings=Ne(le,e.settings||{}),this._normaliseSettingsInPlace(),this.store=new $e(this),await this.store.load(e),mt(this),this.registerView(se,t=>new xe(t,this)),this.registerView(W,t=>new _e(t,this)),this.registerView(ie,t=>new Se(t,this)),this.addSettingTab(new Ee(this.app,this)),this.addCommand({id:"boot-camp-open-reviewer",name:`${A}: Open Reviewer`,callback:async()=>this.openReviewerTab()}),this.addCommand({id:"boot-camp-open-browser",name:`${A}: Open Flashcard Browser`,callback:async()=>this.openBrowserTab()}),this.addCommand({id:"boot-camp-sync-bank",name:`${A}: Sync Question Bank`,callback:async()=>this._runSync()}),this.addCommand({id:"boot-camp-open-widget",name:`${A}: Open Sidebar Widget`,callback:async()=>this.openWidget()}),this._registerRibbonDropdown(),this.registerEvent(this.app.workspace.on("file-open",t=>{let i=t instanceof j.TFile?t:null;this.app.workspace.getLeavesOfType(W).forEach(r=>{var a,o;return(o=(a=r.view)==null?void 0:a.onFileOpen)==null?void 0:o.call(a,i)})})),this.app.workspace.getLeavesOfType(W).length===0)try{await this.openWidget()}catch(t){console.error(`${A}: failed to open widget on load`,t)}await this.saveAll(),console.log(`${A}: loaded`)}catch(e){console.error(`${A}: failed to load`,e),new j.Notice(`${A}: failed to load. See console for details.`)}}onunload(){this._clearHoverCloseTimer(),this._destroyRibbonMenu(),this._destroyTooltip()}_getActiveMarkdownFile(){let e=this.app.workspace.getActiveFile();return e instanceof j.TFile?e:null}_ensureEditingNoteEditor(){let e=this.app.workspace.getActiveViewOfType(j.MarkdownView);if(!e||typeof e.getMode=="function"&&e.getMode()!=="source")return null;let t=e.editor;return t?{view:e,editor:t}:null}openAddFlashcardModal(){if(!this._ensureEditingNoteEditor()){new j.Notice("Must be editing a note to add a flashcard");return}new Ce(this.app,this).open()}async syncBank(){await this._runSync()}refreshAllViews(){this._refreshOpenViews()}async _runSync(){let e=await rt(this),t=(a,o,l)=>a===1?o:l,i="\u2022",r=["Sync complete:",`${i} ${e.newCount} ${t(e.newCount,"new flashcard","new flashcards")}`,`${i} ${e.updatedCount} ${t(e.updatedCount,"updated flashcard","updated flashcards")}`,`${i} ${e.sameCount} ${t(e.sameCount,"unmodified flashcard","unmodified flashcards")}`];e.idsInserted>0&&r.push(`${i} ${e.idsInserted} ${t(e.idsInserted,"ID inserted for new card","IDs inserted for new cards")}`),new j.Notice(r.join(`
`)),e.quarantinedCount>0&&new ae(this.app,this,e.quarantinedIds).open(),this._refreshOpenViews()}async saveAll(){let e=await this.loadData()||{};e.settings=this.settings,e.store=this.store.data,await this.saveData(e)}_refreshOpenViews(){this.app.workspace.getLeavesOfType(se).forEach(e=>{var t,i;return(i=(t=e.view)==null?void 0:t.onRefresh)==null?void 0:i.call(t)}),this.app.workspace.getLeavesOfType(W).forEach(e=>{var t,i;return(i=(t=e.view)==null?void 0:t.onRefresh)==null?void 0:i.call(t)}),this.app.workspace.getLeavesOfType(ie).forEach(e=>{var t,i;return(i=(t=e.view)==null?void 0:t.onRefresh)==null?void 0:i.call(t)})}_isCardStateLike(e){return!e||typeof e!="object"||!(e.stage==="new"||e.stage==="learning"||e.stage==="review"||e.stage==="relearning"||e.stage==="suspended")?!1:typeof e.due=="number"&&typeof e.scheduledDays=="number"&&typeof e.reps=="number"&&typeof e.lapses=="number"&&typeof e.learningStepIndex=="number"}_resetCardStateMapInPlace(e,t){let i=0;for(let[r,a]of Object.entries(e)){if(!this._isCardStateLike(a))continue;let o={id:r,...a};e[r]=Nt(o,t,this.settings),i++}return i}_looksLikeCardStateMap(e){if(!e||typeof e!="object"||Array.isArray(e))return!1;for(let t of Object.values(e))if(this._isCardStateLike(t))return!0;return!1}async resetAllCardScheduling(){let e=Date.now(),t=0,i=new Set,r=a=>{if(!(!a||typeof a!="object")&&!i.has(a)){i.add(a),this._looksLikeCardStateMap(a)&&(t+=this._resetCardStateMapInPlace(a,e));for(let o of Object.values(a))r(o)}};r(this.store.data),await this.saveAll(),this._refreshOpenViews(),new j.Notice(`${A}: reset scheduling for ${t} cards.`)}async openReviewerTab(){let e=this.app.workspace.getLeaf("tab");await e.setViewState({type:se,active:!0}),this.app.workspace.revealLeaf(e)}async openBrowserTab(){let e=this.app.workspace.getLeaf("tab");await e.setViewState({type:ie,active:!0}),this.app.workspace.revealLeaf(e)}async openWidget(){let e=this.app.workspace.getRightLeaf(!0)||this.app.workspace.getLeaf("split");await e.setViewState({type:W,active:!0}),this.app.workspace.revealLeaf(e)}_openBootCampSettings(){var t,i;let e=this.app;try{if(e!=null&&e.setting)typeof e.setting.open=="function"&&e.setting.open();else if((t=e==null?void 0:e.commands)!=null&&t.executeCommandById)try{e.commands.executeCommandById("app:open-settings")}catch(o){}let r=e==null?void 0:e.setting,a=(i=this.manifest)==null?void 0:i.id;if(r&&a){if(typeof r.openTabById=="function"){r.openTabById(a);return}if(typeof r.openTab=="function")try{r.openTab(a);return}catch(o){}}}catch(r){console.error(`${A}: failed to open settings`,r),new j.Notice(`${A}: Unable to open settings automatically. Open Settings \u2192 Community plugins \u2192 ${A}.`)}}_registerRibbonDropdown(){let e=this.addRibbonIcon("footprints",`${A} Menu`,()=>{});e.addClass("bc-ribbon-dropdown"),this._ribbonEl=e;let t=document.createElement("div");t.addClass("bc-ribbon-menu"),t.style.position="fixed",t.style.left="0px",t.style.top="0px",t.style.display="none",t.style.zIndex="10000",document.body.appendChild(t),this._ribbonMenu=t;let i=document.createElement("div");i.addClass("bc-ribbon-header"),i.textContent="Boot Camp Menu",t.appendChild(i);let r=(a,o,l)=>{let d=document.createElement("div");d.addClass("bc-ribbon-item");let u=document.createElement("span");u.addClass("bc-label"),u.textContent=a,d.appendChild(u),this.registerDomEvent(d,"mousedown",c=>{c.preventDefault(),c.stopPropagation(),this._closeRibbonMenu(),l()}),this.registerDomEvent(d,"mouseenter",()=>this._scheduleTooltip(d,o)),this.registerDomEvent(d,"mouseleave",()=>this._hideTooltip()),t.appendChild(d)};r("Start Study Session","Start revising your flashcards in a new tab.",()=>void this.openReviewerTab()),r("View All Flashcards","Browse, search, edit, and save flashcards back to their source notes.",()=>void this.openBrowserTab()),r("Sync Flashcard Database","Sync flashcards in your notes with the database.",()=>void this._runSync()),r("Add Flashcard to Note","Use a form to insert a new flashcard into the current note.",()=>this.openAddFlashcardModal()),r("Boot Camp Settings","View the Boot Camp settings.",()=>void this._openBootCampSettings()),this.registerDomEvent(e,"mousedown",a=>{a.preventDefault(),a.stopPropagation(),this._toggleRibbonMenu()}),this.registerDomEvent(e,"mouseenter",()=>this._openRibbonMenu()),this.registerDomEvent(e,"mouseleave",()=>this._scheduleCloseRibbonMenu()),this.registerDomEvent(t,"mouseenter",()=>{this._clearHoverCloseTimer(),this._hideTooltip()}),this.registerDomEvent(t,"mouseleave",()=>{this._hideTooltip(),this._scheduleCloseRibbonMenu()}),this.registerDomEvent(document,"mousedown",a=>{var l,d;if(!this._menuOpen)return;let o=a.target;o&&((l=this._ribbonEl)!=null&&l.contains(o)||(d=this._ribbonMenu)!=null&&d.contains(o)||this._closeRibbonMenu())},{capture:!0}),this.registerDomEvent(document,"keydown",a=>{a.key==="Escape"&&this._closeRibbonMenu()}),this.registerDomEvent(window,"resize",()=>{this._menuOpen&&(this._positionRibbonMenu(),this._repositionTooltip())}),this.registerDomEvent(window,"scroll",()=>{this._menuOpen&&(this._positionRibbonMenu(),this._repositionTooltip())})}_toggleRibbonMenu(){this._menuOpen?this._closeRibbonMenu():this._openRibbonMenu()}_openRibbonMenu(){!this._ribbonEl||!this._ribbonMenu||(this._clearHoverCloseTimer(),this._positionRibbonMenu(),this._ribbonMenu.style.display="block",this._ribbonMenu.addClass("is-visible"),this._menuOpen=!0)}_closeRibbonMenu(){this._ribbonMenu&&(this._clearHoverCloseTimer(),this._hideTooltip(),this._ribbonMenu.style.display="none",this._ribbonMenu.removeClass("is-visible"),this._menuOpen=!1)}_positionRibbonMenu(){if(!this._ribbonEl||!this._ribbonMenu)return;let e=this._ribbonEl.getBoundingClientRect(),t=this._ribbonMenu,i=t.style.display==="none";i&&(t.style.display="block");let r=t.getBoundingClientRect(),a=8,o=e.right+a,l=e.top,d=Math.min(Math.max(o,a),Math.max(a,window.innerWidth-r.width-a)),u=Math.min(Math.max(l,a),Math.max(a,window.innerHeight-r.height-a));t.style.left=`${d}px`,t.style.top=`${u}px`,i&&!this._menuOpen&&(t.style.display="none")}_scheduleCloseRibbonMenu(){this._clearHoverCloseTimer(),this._hoverCloseTimer=window.setTimeout(()=>this._closeRibbonMenu(),200)}_clearHoverCloseTimer(){this._hoverCloseTimer&&(window.clearTimeout(this._hoverCloseTimer),this._hoverCloseTimer=null)}_ensureTooltipEl(){if(this._tooltipEl)return this._tooltipEl;let e=document.createElement("div");return e.addClass("bc-ribbon-tooltip"),e.style.position="fixed",e.style.left="0px",e.style.top="0px",e.style.display="none",e.style.zIndex="10001",document.body.appendChild(e),this._tooltipEl=e,e}_scheduleTooltip(e,t){this._clearTooltipTimer(),this._tooltipTimer=window.setTimeout(()=>{if(!this._menuOpen)return;let i=this._ensureTooltipEl();i.textContent=t,i.style.display="block",this._positionTooltip(e)},800)}_positionTooltip(e){let t=this._tooltipEl;if(!t)return;let i=e.getBoundingClientRect();t.style.display==="none"&&(t.style.display="block");let a=t.getBoundingClientRect(),o=8,l=i.right+o;l+a.width+o>window.innerWidth&&(l=Math.max(o,i.left-a.width-o));let d=Math.min(Math.max(i.top,o),Math.max(o,window.innerHeight-a.height-o));t.style.left=`${l}px`,t.style.top=`${d}px`}_repositionTooltip(){this._hideTooltip()}_hideTooltip(){this._clearTooltipTimer(),this._tooltipEl&&(this._tooltipEl.style.display="none",this._tooltipEl.textContent="")}_clearTooltipTimer(){this._tooltipTimer&&(window.clearTimeout(this._tooltipTimer),this._tooltipTimer=null)}_destroyTooltip(){var e;this._clearTooltipTimer(),(e=this._tooltipEl)!=null&&e.parentElement&&this._tooltipEl.parentElement.removeChild(this._tooltipEl),this._tooltipEl=null}_destroyRibbonMenu(){var e;(e=this._ribbonMenu)!=null&&e.parentElement&&this._ribbonMenu.parentElement.removeChild(this._ribbonMenu),this._ribbonMenu=null,this._ribbonEl=null,this._menuOpen=!1}};
