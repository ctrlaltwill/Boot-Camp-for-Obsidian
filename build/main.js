/*
  Obsidian Plugin - Bundled with esbuild
  Output: plugin/main.js
*/
"use strict";var qe=Object.defineProperty;var Bn=Object.getOwnPropertyDescriptor;var qn=Object.getOwnPropertyNames;var $n=Object.prototype.hasOwnProperty;var On=(n,s,e)=>s in n?qe(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var Hn=(n,s)=>{for(var e in s)qe(n,e,{get:s[e],enumerable:!0})},zn=(n,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of qn(s))!$n.call(n,i)&&i!==e&&qe(n,i,{get:()=>s[i],enumerable:!(t=Bn(s,i))||t.enumerable});return n};var Qn=n=>zn(qe({},"__esModule",{value:!0}),n);var O=(n,s,e)=>(On(n,typeof s!="symbol"?s+"":s,e),e);var Fi={};Hn(Fi,{default:()=>at});module.exports=Qn(Fi);var j=require("obsidian");var Z={reviewer:{showInfoByDefault:!1,dailyNewLimit:20,dailyReviewLimit:200,autoAdvanceEnabled:!1,autoAdvanceSeconds:60,fourButtonMode:!1,enableSkipButton:!1,randomizeMcqOptions:!1},widget:{treatFolderNotesAsDecks:!0},scheduler:{learningStepsMinutes:[10,1440],relearningStepsMinutes:[10],requestRetention:.9},indexing:{ignoreInCodeFences:!0,idPlacement:"above"}};var pe="boot-camp-reviewer",G="boot-camp-widget",he="boot-camp-browser",I="Boot Camp";function $e(n,s){let e=Array.isArray(n)?n.slice():{...n};for(let t of Object.keys(s||{})){let i=s[t];i&&typeof i=="object"&&!Array.isArray(i)?e[t]=$e(e[t]||{},i):e[t]=i}return e}var Wn=/[\u200B\uFEFF]/g;function He(n){return(n!=null?n:"").replace(Wn,"")}function ae(n){return He(n).replace(/^[\s\u00A0]+/,"").replace(/[\s\u00A0]+$/,"")}var Vn=/^\^bc-(\d{9})$/,jn=/^(T|Q|A|I|MCQ|CQ|O)\s*(\||:)\s*/;function Wt(n){n.registerMarkdownPostProcessor((s,e)=>{var t;try{s.dataset.bcRvRan="1";let i=(t=s.closest(".markdown-preview-view"))!=null?t:s.closest(".markdown-reading-view");if(i&&(i.dataset.bcRvRan="1"),s.closest(".cm-content")||!(!!s.closest(".markdown-preview-view")||!!s.closest(".markdown-reading-view")))return;Kn(s)}catch(i){console.error("[BootCamp] readingView prettifier error",i)}},1e3)}function Kn(n){var e,t;let s=Un(n);for(let i of s){if(((e=i.dataset)==null?void 0:e.bcPrettyDone)==="1"||i.closest(".bc-pretty-card"))continue;let r=(t=i.textContent)!=null?t:"",o=He(r);if(!/\^bc-\d{9}/.test(o))continue;i.dataset.bcPrettyCandidate="1";let a=Gn(i);if(!a)continue;i.dataset.bcPrettyDone="1",a.cardEl.dataset.bcPretty="1";let l=i.parentElement;l&&l.classList.contains("el-p")&&l!==n?l.replaceWith(a.cardEl):i.replaceWith(a.cardEl)}}function Un(n){let s=[];n.tagName==="P"&&s.push(n),s.push(...Array.from(n.querySelectorAll(".el-p > p"))),s.push(...Array.from(n.querySelectorAll("p")));let e=new Set;return s.filter(t=>e.has(t)?!1:(e.add(t),!0))}function Gn(n){var h;let s=Yn(n);if(!s.length)return n.dataset.bcPrettyFail="no-lines",null;let e=ae(Oe(s[0])),t=e.match(Vn);if(!t)return n.dataset.bcPrettyFail="no-anchor-match",n.dataset.bcPrettyFirst=e.slice(0,50),null;let i=t[1],r=[],o=null;for(let p=1;p<s.length;p++){let u=ae(Oe(s[p])),m=u.match(jn);if(m){o&&r.push(o);let g=m[1],w=m[2],b=s[p];Zn(b,g,w),o={key:g,sep:w,lines:[b]},w==="|"&&zt(u)&&(Qt(b),r.push(o),o=null);continue}if(!o)return n.dataset.bcPrettyFail="continuation-without-field",null;o.lines.push(s[p]),o.sep==="|"&&zt(u)&&(Qt(s[p]),r.push(o),o=null)}o&&r.push(o);let a=r.some(p=>p.key==="Q"||p.key==="MCQ"||p.key==="CQ"),l=r.some(p=>p.key==="A"||p.key==="O"||p.key==="CQ");if(!a||!l)return n.dataset.bcPrettyFail="missing-q-or-a",n.dataset.bcPrettyKeys=r.map(p=>p.key).join(","),null;let d=es(r),f=(h=ts(r))!=null?h:`Card ${i}`;return{cardEl:ns(i,d,f,r)}}function Yn(n){let s=[],e=[];for(let t of Array.from(n.childNodes)){if(t.nodeType===Node.ELEMENT_NODE&&t.tagName==="BR"){s.push(e),e=[];continue}e.push(t)}return e.length&&s.push(e),s.filter(t=>{let i=ae(Oe(t)),r=t.some(o=>o.nodeType===Node.ELEMENT_NODE);return i.length>0||r})}function Oe(n){return n.map(s=>{var e;return(e=s.textContent)!=null?e:""}).join("")}function zt(n){return/\|[\s\u00A0\u200B\uFEFF]*$/.test(n)}function Zn(n,s,e){var r;let t=new RegExp(`^[\\s\\u00A0\\u200B\\uFEFF]*${s}[\\s\\u00A0\\u200B\\uFEFF]*\\${e}[\\s\\u00A0\\u200B\\uFEFF]*`),i=Xn(n);i&&(i.textContent=He((r=i.textContent)!=null?r:"").replace(t,""))}function Qt(n){var t;let s=Jn(n);if(!s)return;let e=He((t=s.textContent)!=null?t:"");s.textContent=e.replace(/\|[\s\u00A0]*$/,"").trimEnd()}function Xn(n){var s,e;for(let t of n){if(t.nodeType===Node.TEXT_NODE){let i=t;if(ae((s=i.textContent)!=null?s:"").length===0)continue;return i}if(t.nodeType===Node.ELEMENT_NODE){let i=t,r=document.createTreeWalker(i,NodeFilter.SHOW_TEXT);for(;;){let o=r.nextNode();if(!o)break;let a=o;if(ae((e=a.textContent)!=null?e:"").length!==0)return a}}}return null}function Jn(n){var s,e;for(let t=n.length-1;t>=0;t--){let i=n[t];if(i.nodeType===Node.TEXT_NODE){let r=i;if(ae((s=r.textContent)!=null?s:"").length===0)continue;return r}if(i.nodeType===Node.ELEMENT_NODE){let r=i,o=document.createTreeWalker(r,NodeFilter.SHOW_TEXT),a=[];for(;;){let l=o.nextNode();if(!l)break;a.push(l)}for(let l=a.length-1;l>=0;l--){let d=a[l];if(ae((e=d.textContent)!=null?e:"").length!==0)return d}}}return null}function es(n){return n.some(s=>s.key==="MCQ"||s.key==="O")?"mcq":n.some(s=>s.key==="CQ")?"cloze":"basic"}function ts(n){let s=n.find(t=>t.key==="T");return s&&s.lines.map(t=>ae(Oe(t))).join(`
`).trim()||null}function ns(n,s,e,t){let i=document.createElement("div");i.className="bc-pretty-card",i.dataset.bcId=n,i.dataset.bcType=s;let r=document.createElement("div");r.className="bc-pretty-card__meta";let o=document.createElement("div");o.className="bc-pretty-card__title",o.textContent=e;let a=document.createElement("div");a.className="bc-pretty-card__badge",a.textContent=s.toUpperCase(),r.appendChild(o),r.appendChild(a),i.appendChild(r);for(let l of t){if(l.key==="T")continue;let d=document.createElement("div");d.className="bc-pretty-card__section";let f=document.createElement("div");f.className="bc-pretty-card__label",f.textContent=ss(l.key);let c=document.createElement("div");c.className="bc-pretty-card__content",l.lines.forEach((h,p)=>{for(let u of h)c.appendChild(u);p<l.lines.length-1&&c.appendChild(document.createElement("br"))}),d.appendChild(f),d.appendChild(c),i.appendChild(d)}return i}function ss(n){switch(n){case"Q":return"Question";case"A":return"Answer";case"MCQ":return"MCQ";case"O":return"Options";case"CQ":return"Cloze";case"I":return"Info";default:return n}}var T=(n=>(n[n.New=0]="New",n[n.Learning=1]="Learning",n[n.Review=2]="Review",n[n.Relearning=3]="Relearning",n))(T||{}),M=(n=>(n[n.Manual=0]="Manual",n[n.Again=1]="Again",n[n.Hard=2]="Hard",n[n.Good=3]="Good",n[n.Easy=4]="Easy",n))(M||{}),D=class n{static card(s){return{...s,state:n.state(s.state),due:n.time(s.due),last_review:s.last_review?n.time(s.last_review):void 0}}static rating(s){if(typeof s=="string"){let e=s.charAt(0).toUpperCase(),t=s.slice(1).toLowerCase(),i=M[`${e}${t}`];if(i===void 0)throw new Error(`Invalid rating:[${s}]`);return i}else if(typeof s=="number")return s;throw new Error(`Invalid rating:[${s}]`)}static state(s){if(typeof s=="string"){let e=s.charAt(0).toUpperCase(),t=s.slice(1).toLowerCase(),i=T[`${e}${t}`];if(i===void 0)throw new Error(`Invalid state:[${s}]`);return i}else if(typeof s=="number")return s;throw new Error(`Invalid state:[${s}]`)}static time(s){let e=new Date(s);if(typeof s=="object"&&s!==null&&!Number.isNaN(Date.parse(s)||+e))return e;if(typeof s=="string"){let t=Date.parse(s);if(Number.isNaN(t))throw new Error(`Invalid date:[${s}]`);return new Date(t)}else if(typeof s=="number")return new Date(s);throw new Error(`Invalid date:[${s}]`)}static review_log(s){return{...s,due:n.time(s.due),rating:n.rating(s.rating),state:n.state(s.state),review:n.time(s.review)}}};Date.prototype.scheduler=function(n,s){return X(this,n,s)};Date.prototype.diff=function(n,s){return ge(this,n,s)};Date.prototype.format=function(){return is(this)};Date.prototype.dueFormat=function(n,s,e){return rs(this,n,s,e)};function X(n,s,e){return new Date(e?D.time(n).getTime()+s*24*60*60*1e3:D.time(n).getTime()+s*60*1e3)}function ge(n,s,e){if(!n||!s)throw new Error("Invalid date");let t=D.time(n).getTime()-D.time(s).getTime(),i=0;switch(e){case"days":i=Math.floor(t/(24*60*60*1e3));break;case"minutes":i=Math.floor(t/(60*1e3));break}return i}function is(n){let s=D.time(n),e=s.getFullYear(),t=s.getMonth()+1,i=s.getDate(),r=s.getHours(),o=s.getMinutes(),a=s.getSeconds();return`${e}-${xe(t)}-${xe(i)} ${xe(r)}:${xe(o)}:${xe(a)}`}function xe(n){return n<10?`0${n}`:`${n}`}var lt=[60,60,24,31,12],ct=["second","min","hour","day","month","year"];function rs(n,s,e,t=ct){n=D.time(n),s=D.time(s),t.length!==ct.length&&(t=ct);let i=n.getTime()-s.getTime(),r=0;for(i/=1e3,r=0;r<lt.length&&!(i<lt[r]);r++)i/=lt[r];return`${Math.floor(i)}${e?t[r]:""}`}var os=Object.freeze([M.Again,M.Hard,M.Good,M.Easy]),as=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function ls(n,s,e){let t=1;for(let o of as)t+=o.factor*Math.max(Math.min(n,o.end)-o.start,0);n=Math.min(n,e);let i=Math.max(2,Math.round(n-t)),r=Math.min(Math.round(n+t),e);return n>s&&(i=Math.max(i,s+1)),i=Math.min(i,r),{min_ivl:i,max_ivl:r}}function W(n,s,e){return Math.min(Math.max(n,s),e)}function Ke(n,s){let e=Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()),t=Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate());return Math.floor((t-e)/864e5)}var cs=n=>{let s=n.slice(-1),e=parseInt(n.slice(0,-1),10);if(Number.isNaN(e)||!Number.isFinite(e)||e<0)throw new Error(`Invalid step value: ${n}`);switch(s){case"m":return e;case"h":return e*60;case"d":return e*1440;default:throw new Error(`Invalid step unit: ${n}, expected m/h/d`)}},ds=(n,s,e)=>{let t=s===T.Relearning||s===T.Review?n.relearning_steps:n.learning_steps,i=t.length;if(i===0||e>=i)return{};let r=t[0],o=cs,a=()=>o(r),l=()=>{if(i===1)return Math.round(o(r)*1.5);let p=t[1];return Math.round((o(r)+o(p))/2)},d=p=>p<0||p>=i?null:t[p],f=p=>o(p),c={},h=d(Math.max(0,e));if(s===T.Review)return c[M.Again]={scheduled_minutes:o(h),next_step:0},c;{c[M.Again]={scheduled_minutes:a(),next_step:0},c[M.Hard]={scheduled_minutes:l(),next_step:e};let p=d(e+1);if(p){let u=f(p);u&&(c[M.Good]={scheduled_minutes:Math.round(u),next_step:e+1})}}return c};function us(){let n=this.review_time.getTime(),s=this.current.reps,e=this.current.difficulty*this.current.stability;return`${n}_${s}_${e}`}var Ue=(n=>(n.SCHEDULER="Scheduler",n.LEARNING_STEPS="LearningSteps",n.SEED="Seed",n))(Ue||{}),Qe=class{constructor(s,e,t,i){O(this,"last");O(this,"current");O(this,"review_time");O(this,"next",new Map);O(this,"algorithm");O(this,"strategies");O(this,"elapsed_days",0);this.algorithm=t,this.last=D.card(s),this.current=D.card(s),this.review_time=D.time(e),this.strategies=i,this.init()}checkGrade(s){if(!Number.isFinite(s)||s<0||s>4)throw new Error(`Invalid grade "${s}",expected 1-4`)}init(){let{state:s,last_review:e}=this.current,t=0;s!==T.New&&e&&(t=Ke(e,this.review_time)),this.current.last_review=this.review_time,this.elapsed_days=t,this.current.elapsed_days=t,this.current.reps+=1;let i=us;if(this.strategies){let r=this.strategies.get(Ue.SEED);r&&(i=r)}this.algorithm.seed=i.call(this)}preview(){return{[M.Again]:this.review(M.Again),[M.Hard]:this.review(M.Hard),[M.Good]:this.review(M.Good),[M.Easy]:this.review(M.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(let s of os)yield this.review(s)}review(s){let{state:e}=this.last,t;switch(this.checkGrade(s),e){case T.New:t=this.newState(s);break;case T.Learning:case T.Relearning:t=this.learningState(s);break;case T.Review:t=this.reviewState(s);break}return t}buildLog(s){let{last_review:e,due:t,elapsed_days:i}=this.last;return{rating:s,state:this.current.state,due:e||t,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.elapsed_days,last_elapsed_days:i,scheduled_days:this.current.scheduled_days,learning_steps:this.current.learning_steps,review:this.review_time}}},ut=class{constructor(s){O(this,"c");O(this,"s0");O(this,"s1");O(this,"s2");let e=ps();this.c=1,this.s0=e(" "),this.s1=e(" "),this.s2=e(" "),s==null&&(s=Date.now()),this.s0-=e(s),this.s0<0&&(this.s0+=1),this.s1-=e(s),this.s1<0&&(this.s1+=1),this.s2-=e(s),this.s2<0&&(this.s2+=1)}next(){let s=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.c=s|0,this.s2=s-this.c,this.s2}set state(s){this.c=s.c,this.s0=s.s0,this.s1=s.s1,this.s2=s.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}};function ps(){let n=4022871197;return function(e){e=String(e);for(let t=0;t<e.length;t++){n+=e.charCodeAt(t);let i=.02519603282416938*n;n=i>>>0,i-=n,i*=n,n=i>>>0,i-=n,n+=i*4294967296}return(n>>>0)*23283064365386963e-26}}function hs(n){let s=new ut(n),e=()=>s.next();return e.int32=()=>s.next()*4294967296|0,e.double=()=>e()+(e()*2097152|0)*11102230246251565e-32,e.state=()=>s.state,e.importState=t=>(s.state=t,e),e}var fs="5.2.3",ms=.9,gs=36500,ys=!1,Ge=!0,bs=Object.freeze(["1m","10m"]),ws=Object.freeze(["10m"]),zi=`v${fs} using FSRS-6.0`,J=.001;var ze=100,Vt=.5,vs=.1542,jt=Object.freeze([.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,vs]),Cs=2,xs=(n,s=Ge)=>[[J,ze],[J,ze],[J,ze],[J,ze],[1,10],[.001,4],[.001,4],[.001,.75],[0,4.5],[0,.8],[.001,3.5],[.001,5],[.001,.25],[.001,.9],[0,4],[0,1],[1,6],[0,n],[0,n],[s?.01:0,.8],[.1,.8]],dt=(n,s,e=Ge)=>{let t=Cs;if(Math.max(0,s)>1){let r=-(Math.log(n[11])+Math.log(Math.pow(2,n[13])-1)+n[14]*.3)/s;t=W(+r.toFixed(8),.01,2)}return xs(t,e).slice(0,n.length).map(([r,o],a)=>W(n[a]||0,r,o))};var mt=(n,s=0,e=Ge)=>{if(n===void 0)return[...jt];switch(n.length){case 21:return dt(Array.from(n),s,e);case 19:return console.debug("[FSRS-6]auto fill w from 19 to 21 length"),dt(Array.from(n),s,e).concat([0,Vt]);case 17:{let t=dt(Array.from(n),s,e);return t[4]=+(t[5]*2+t[4]).toFixed(8),t[5]=+(Math.log(t[5]*3+1)/3).toFixed(8),t[6]=+(t[6]+.5).toFixed(8),console.debug("[FSRS-6]auto fill w from 17 to 21 length"),t.concat([0,0,0,Vt])}default:return console.warn("[FSRS]Invalid parameters length, using default parameters"),[...jt]}},We=n=>{var r,o;let s=Array.isArray(n==null?void 0:n.learning_steps)?n.learning_steps:bs,e=Array.isArray(n==null?void 0:n.relearning_steps)?n.relearning_steps:ws,t=(r=n==null?void 0:n.enable_short_term)!=null?r:Ge,i=mt(n==null?void 0:n.w,e.length,t);return{request_retention:(n==null?void 0:n.request_retention)||ms,maximum_interval:(n==null?void 0:n.maximum_interval)||gs,w:i,enable_fuzz:(o=n==null?void 0:n.enable_fuzz)!=null?o:ys,enable_short_term:t,learning_steps:s,relearning_steps:e}};function Se(n,s){let e={due:n?D.time(n):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,learning_steps:0,state:T.New,last_review:void 0};return s&&typeof s=="function"?s(e):e}var Kt=n=>{let s=typeof n=="number"?-n:-n[20],e=Math.exp(Math.pow(s,-1)*Math.log(.9))-1;return{decay:s,factor:+e.toFixed(8)}};function ye(n,s,e){let{decay:t,factor:i}=Kt(n);return+Math.pow(1+i*s/e,t).toFixed(8)}var pt=class{constructor(s){O(this,"param");O(this,"intervalModifier");O(this,"_seed");O(this,"forgetting_curve");this.param=new Proxy(We(s),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention),this.forgetting_curve=ye.bind(this,this.param.w)}get interval_modifier(){return this.intervalModifier}set seed(s){this._seed=s}calculate_interval_modifier(s){if(s<=0||s>1)throw new Error("Requested retention rate should be in the range (0,1]");let{decay:e,factor:t}=Kt(this.param.w);return+((Math.pow(s,1/e)-1)/t).toFixed(8)}get parameters(){return this.param}set parameters(s){this.update_parameters(s)}params_handler_proxy(){let s=this;return{set:function(e,t,i){return t==="request_retention"&&Number.isFinite(i)?s.intervalModifier=s.calculate_interval_modifier(Number(i)):t==="w"&&(i=mt(i,e.relearning_steps.length,e.enable_short_term),s.forgetting_curve=ye.bind(this,i),s.intervalModifier=s.calculate_interval_modifier(Number(e.request_retention))),Reflect.set(e,t,i),!0}}}update_parameters(s){let e=We(s);for(let t in e){let i=t;this.param[i]=e[i]}}init_stability(s){return Math.max(this.param.w[s-1],.1)}init_difficulty(s){return+(this.param.w[4]-Math.exp((s-1)*this.param.w[5])+1).toFixed(8)}apply_fuzz(s,e){if(!this.param.enable_fuzz||s<2.5)return Math.round(s);let i=hs(this._seed)(),{min_ivl:r,max_ivl:o}=ls(s,e,this.param.maximum_interval);return Math.floor(i*(o-r+1)+r)}next_interval(s,e){let t=Math.min(Math.max(1,Math.round(s*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(t,e)}linear_damping(s,e){return+(s*(10-e)/9).toFixed(8)}next_difficulty(s,e){let t=-this.param.w[6]*(e-3),i=s+this.linear_damping(t,s);return W(this.mean_reversion(this.init_difficulty(M.Easy),i),1,10)}mean_reversion(s,e){return+(this.param.w[7]*s+(1-this.param.w[7])*e).toFixed(8)}next_recall_stability(s,e,t,i){let r=M.Hard===i?this.param.w[15]:1,o=M.Easy===i?this.param.w[16]:1;return+W(e*(1+Math.exp(this.param.w[8])*(11-s)*Math.pow(e,-this.param.w[9])*(Math.exp((1-t)*this.param.w[10])-1)*r*o),J,36500).toFixed(8)}next_forget_stability(s,e,t){return+W(this.param.w[11]*Math.pow(s,-this.param.w[12])*(Math.pow(e+1,this.param.w[13])-1)*Math.exp((1-t)*this.param.w[14]),J,36500).toFixed(8)}next_short_term_stability(s,e){let t=Math.pow(s,-this.param.w[19])*Math.exp(this.param.w[17]*(e-3+this.param.w[18])),i=e>=3?Math.max(t,1):t;return+W(s*i,J,36500).toFixed(8)}next_state(s,e,t){let{difficulty:i,stability:r}=s!=null?s:{difficulty:0,stability:0};if(e<0)throw new Error(`Invalid delta_t "${e}"`);if(t<0||t>4)throw new Error(`Invalid grade "${t}"`);if(i===0&&r===0)return{difficulty:W(this.init_difficulty(t),1,10),stability:this.init_stability(t)};if(t===0)return{difficulty:i,stability:r};if(i<1||r<J)throw new Error(`Invalid memory state { difficulty: ${i}, stability: ${r} }`);let o=this.forgetting_curve(e,r),a=this.next_recall_stability(i,r,o,t),l=this.next_forget_stability(i,r,o),d=this.next_short_term_stability(r,t),f=a;if(t===1){let[h,p]=[0,0];this.param.enable_short_term&&(h=this.param.w[17],p=this.param.w[18]);let u=r/Math.exp(h*p);f=W(+u.toFixed(8),J,l)}return e===0&&this.param.enable_short_term&&(f=d),{difficulty:this.next_difficulty(i,t),stability:f}}},Ve=class extends Qe{constructor(e,t,i,r){super(e,t,i,r);O(this,"learningStepsStrategy");let o=ds;if(this.strategies){let a=this.strategies.get(Ue.LEARNING_STEPS);a&&(o=a)}this.learningStepsStrategy=o}getLearningInfo(e,t){var l,d,f,c;let i=this.algorithm.parameters;e.learning_steps=e.learning_steps||0;let r=this.learningStepsStrategy(i,e.state,this.current.state===T.Learning&&t!==M.Again&&t!==M.Hard?e.learning_steps+1:e.learning_steps),o=Math.max(0,(d=(l=r[t])==null?void 0:l.scheduled_minutes)!=null?d:0),a=Math.max(0,(c=(f=r[t])==null?void 0:f.next_step)!=null?c:0);return{scheduled_minutes:o,next_steps:a}}applyLearningSteps(e,t,i){let{scheduled_minutes:r,next_steps:o}=this.getLearningInfo(this.current,t);if(r>0&&r<1440)e.learning_steps=o,e.scheduled_days=0,e.state=i,e.due=X(this.review_time,Math.round(r),!1);else if(e.state=T.Review,r>=1440)e.learning_steps=o,e.due=X(this.review_time,Math.round(r),!1),e.scheduled_days=Math.floor(r/1440);else{e.learning_steps=0;let a=this.algorithm.next_interval(e.stability,this.elapsed_days);e.scheduled_days=a,e.due=X(this.review_time,a,!0)}}newState(e){let t=this.next.get(e);if(t)return t;let i=D.card(this.current);i.difficulty=W(this.algorithm.init_difficulty(e),1,10),i.stability=this.algorithm.init_stability(e),this.applyLearningSteps(i,e,T.Learning);let r={card:i,log:this.buildLog(e)};return this.next.set(e,r),r}learningState(e){let t=this.next.get(e);if(t)return t;let{state:i,difficulty:r,stability:o}=this.last,a=D.card(this.current);a.difficulty=this.algorithm.next_difficulty(r,e),a.stability=this.algorithm.next_short_term_stability(o,e),this.applyLearningSteps(a,e,i);let l={card:a,log:this.buildLog(e)};return this.next.set(e,l),l}reviewState(e){let t=this.next.get(e);if(t)return t;let i=this.elapsed_days,{difficulty:r,stability:o}=this.last,a=this.algorithm.forgetting_curve(i,o),l=D.card(this.current),d=D.card(this.current),f=D.card(this.current),c=D.card(this.current);this.next_ds(l,d,f,c,r,o,a),this.next_interval(d,f,c,i),this.next_state(d,f,c),this.applyLearningSteps(l,M.Again,T.Relearning),l.lapses+=1;let h={card:l,log:this.buildLog(M.Again)},p={card:d,log:super.buildLog(M.Hard)},u={card:f,log:super.buildLog(M.Good)},m={card:c,log:super.buildLog(M.Easy)};return this.next.set(M.Again,h),this.next.set(M.Hard,p),this.next.set(M.Good,u),this.next.set(M.Easy,m),this.next.get(e)}next_ds(e,t,i,r,o,a,l){e.difficulty=this.algorithm.next_difficulty(o,M.Again);let d=a/Math.exp(this.algorithm.parameters.w[17]*this.algorithm.parameters.w[18]),f=this.algorithm.next_forget_stability(o,a,l);e.stability=W(+d.toFixed(8),J,f),t.difficulty=this.algorithm.next_difficulty(o,M.Hard),t.stability=this.algorithm.next_recall_stability(o,a,l,M.Hard),i.difficulty=this.algorithm.next_difficulty(o,M.Good),i.stability=this.algorithm.next_recall_stability(o,a,l,M.Good),r.difficulty=this.algorithm.next_difficulty(o,M.Easy),r.stability=this.algorithm.next_recall_stability(o,a,l,M.Easy)}next_interval(e,t,i,r){let o,a;o=this.algorithm.next_interval(e.stability,r),a=this.algorithm.next_interval(t.stability,r),o=Math.min(o,a),a=Math.max(a,o+1);let l=Math.max(this.algorithm.next_interval(i.stability,r),a+1);e.scheduled_days=o,e.due=X(this.review_time,o,!0),t.scheduled_days=a,t.due=X(this.review_time,a,!0),i.scheduled_days=l,i.due=X(this.review_time,l,!0)}next_state(e,t,i){e.state=T.Review,e.learning_steps=0,t.state=T.Review,t.learning_steps=0,i.state=T.Review,i.learning_steps=0}},je=class extends Qe{newState(s){let e=this.next.get(s);if(e)return e;this.current.scheduled_days=0,this.current.elapsed_days=0;let t=D.card(this.current),i=D.card(this.current),r=D.card(this.current),o=D.card(this.current);return this.init_ds(t,i,r,o),this.next_interval(t,i,r,o,0),this.next_state(t,i,r,o),this.update_next(t,i,r,o),this.next.get(s)}init_ds(s,e,t,i){s.difficulty=W(this.algorithm.init_difficulty(M.Again),1,10),s.stability=this.algorithm.init_stability(M.Again),e.difficulty=W(this.algorithm.init_difficulty(M.Hard),1,10),e.stability=this.algorithm.init_stability(M.Hard),t.difficulty=W(this.algorithm.init_difficulty(M.Good),1,10),t.stability=this.algorithm.init_stability(M.Good),i.difficulty=W(this.algorithm.init_difficulty(M.Easy),1,10),i.stability=this.algorithm.init_stability(M.Easy)}learningState(s){return this.reviewState(s)}reviewState(s){let e=this.next.get(s);if(e)return e;let t=this.elapsed_days,{difficulty:i,stability:r}=this.last,o=this.algorithm.forgetting_curve(t,r),a=D.card(this.current),l=D.card(this.current),d=D.card(this.current),f=D.card(this.current);return this.next_ds(a,l,d,f,i,r,o),this.next_interval(a,l,d,f,t),this.next_state(a,l,d,f),a.lapses+=1,this.update_next(a,l,d,f),this.next.get(s)}next_ds(s,e,t,i,r,o,a){s.difficulty=this.algorithm.next_difficulty(r,M.Again);let l=this.algorithm.next_forget_stability(r,o,a);s.stability=W(o,J,l),e.difficulty=this.algorithm.next_difficulty(r,M.Hard),e.stability=this.algorithm.next_recall_stability(r,o,a,M.Hard),t.difficulty=this.algorithm.next_difficulty(r,M.Good),t.stability=this.algorithm.next_recall_stability(r,o,a,M.Good),i.difficulty=this.algorithm.next_difficulty(r,M.Easy),i.stability=this.algorithm.next_recall_stability(r,o,a,M.Easy)}next_interval(s,e,t,i,r){let o,a,l,d;o=this.algorithm.next_interval(s.stability,r),a=this.algorithm.next_interval(e.stability,r),l=this.algorithm.next_interval(t.stability,r),d=this.algorithm.next_interval(i.stability,r),o=Math.min(o,a),a=Math.max(a,o+1),l=Math.max(l,a+1),d=Math.max(d,l+1),s.scheduled_days=o,s.due=X(this.review_time,o,!0),e.scheduled_days=a,e.due=X(this.review_time,a,!0),t.scheduled_days=l,t.due=X(this.review_time,l,!0),i.scheduled_days=d,i.due=X(this.review_time,d,!0)}next_state(s,e,t,i){s.state=T.Review,s.learning_steps=0,e.state=T.Review,e.learning_steps=0,t.state=T.Review,t.learning_steps=0,i.state=T.Review,i.learning_steps=0}update_next(s,e,t,i){let r={card:s,log:this.buildLog(M.Again)},o={card:e,log:super.buildLog(M.Hard)},a={card:t,log:super.buildLog(M.Good)},l={card:i,log:super.buildLog(M.Easy)};this.next.set(M.Again,r),this.next.set(M.Hard,o),this.next.set(M.Good,a),this.next.set(M.Easy,l)}},ht=class{constructor(s){O(this,"fsrs");this.fsrs=s}replay(s,e,t){return this.fsrs.next(s,e,t)}handleManualRating(s,e,t,i,r,o,a){if(typeof e=="undefined")throw new Error("reschedule: state is required for manual rating");let l,d;if(e===T.New)l={rating:M.Manual,state:e,due:a!=null?a:t,stability:s.stability,difficulty:s.difficulty,elapsed_days:i,last_elapsed_days:s.elapsed_days,scheduled_days:s.scheduled_days,learning_steps:s.learning_steps,review:t},d=Se(t),d.last_review=t;else{if(typeof a=="undefined")throw new Error("reschedule: due is required for manual rating");let f=ge(a,t,"days");l={rating:M.Manual,state:s.state,due:s.last_review||s.due,stability:s.stability,difficulty:s.difficulty,elapsed_days:i,last_elapsed_days:s.elapsed_days,scheduled_days:s.scheduled_days,learning_steps:s.learning_steps,review:t},d={...s,state:e,due:a,last_review:t,stability:r||s.stability,difficulty:o||s.difficulty,elapsed_days:i,scheduled_days:f,reps:s.reps+1}}return{card:d,log:l}}reschedule(s,e){let t=[],i=Se(s.due);for(let r of e){let o;if(r.review=D.time(r.review),r.rating===M.Manual){let a=0;i.state!==T.New&&i.last_review&&(a=ge(r.review,i.last_review,"days")),o=this.handleManualRating(i,r.state,r.review,a,r.stability,r.difficulty,r.due?D.time(r.due):void 0)}else o=this.replay(i,r.review,r.rating);t.push(o),i=o.card}return t}calculateManualRecord(s,e,t,i){if(!t)return null;let{card:r,log:o}=t,a=D.card(s);return a.due.getTime()===r.due.getTime()?null:(a.scheduled_days=ge(r.due,a.due,"days"),this.handleManualRating(a,r.state,D.time(e),o.elapsed_days,i?r.stability:void 0,i?r.difficulty:void 0,r.due))}},ft=class extends pt{constructor(e){super(e);O(this,"strategyHandler",new Map);O(this,"Scheduler");let{enable_short_term:t}=this.parameters;this.Scheduler=t?Ve:je}params_handler_proxy(){let e=this;return{set:function(t,i,r){return i==="request_retention"&&Number.isFinite(r)?e.intervalModifier=e.calculate_interval_modifier(Number(r)):i==="enable_short_term"?e.Scheduler=r===!0?Ve:je:i==="w"&&(r=mt(r,t.relearning_steps.length,t.enable_short_term),e.forgetting_curve=ye.bind(this,r),e.intervalModifier=e.calculate_interval_modifier(Number(t.request_retention))),Reflect.set(t,i,r),!0}}}useStrategy(e,t){return this.strategyHandler.set(e,t),this}clearStrategy(e){return e?this.strategyHandler.delete(e):this.strategyHandler.clear(),this}getScheduler(e,t){let r=this.strategyHandler.get(Ue.SCHEDULER)||this.Scheduler;return new r(e,t,this,this.strategyHandler)}repeat(e,t,i){let o=this.getScheduler(e,t).preview();return i&&typeof i=="function"?i(o):o}next(e,t,i,r){let o=this.getScheduler(e,t),a=D.rating(i);if(a===M.Manual)throw new Error("Cannot review a manual rating");let l=o.review(a);return r&&typeof r=="function"?r(l):l}get_retrievability(e,t,i=!0){let r=D.card(e);t=t?D.time(t):new Date;let o=r.state!==T.New?Math.max(ge(t,r.last_review,"days"),0):0,a=r.state!==T.New?this.forgetting_curve(o,+r.stability.toFixed(8)):0;return i?`${(a*100).toFixed(2)}%`:a}rollback(e,t,i){let r=D.card(e),o=D.review_log(t);if(o.rating===M.Manual)throw new Error("Cannot rollback a manual rating");let a,l,d;switch(o.state){case T.New:a=o.due,l=void 0,d=0;break;case T.Learning:case T.Relearning:case T.Review:a=o.review,l=o.due,d=r.lapses-(o.rating===M.Again&&o.state===T.Review?1:0);break}let f={...r,due:a,stability:o.stability,difficulty:o.difficulty,elapsed_days:o.last_elapsed_days,scheduled_days:o.scheduled_days,reps:Math.max(0,r.reps-1),lapses:Math.max(0,d),learning_steps:o.learning_steps,state:o.state,last_review:l};return i&&typeof i=="function"?i(f):f}forget(e,t,i=!1,r){let o=D.card(e);t=D.time(t);let a=o.state===T.New?0:ge(t,o.due,"days"),l={rating:M.Manual,state:o.state,due:o.due,stability:o.stability,difficulty:o.difficulty,elapsed_days:0,last_elapsed_days:o.elapsed_days,scheduled_days:a,learning_steps:o.learning_steps,review:t},f={card:{...o,due:t,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:i?0:o.reps,lapses:i?0:o.lapses,learning_steps:0,state:T.New,last_review:o.last_review},log:l};return r&&typeof r=="function"?r(f):f}reschedule(e,t=[],i={}){let{recordLogHandler:r,reviewsOrderBy:o,skipManual:a=!0,now:l=new Date,update_memory_state:d=!1}=i;o&&typeof o=="function"&&t.sort(o),a&&(t=t.filter(m=>m.rating!==M.Manual));let f=new ht(this),c=f.reschedule(i.first_card||Se(),t),h=c.length,p=D.card(e),u=f.calculateManualRecord(p,l,h?c[h-1]:void 0,d);return r&&typeof r=="function"?{collections:c.map(r),reschedule_item:u?r(u):null}:{collections:c,reschedule_item:u}}},Ut=n=>new ft(n||{});function gt(){return{version:7,cards:{},states:{},reviewLog:[],quarantine:{}}}var Ye=class{constructor(s){this.plugin=s,this.data=gt()}async load(s){var e,t;s&&s.store?this.data=s.store:this.data=gt(),(!this.data||typeof this.data!="object")&&(this.data=gt()),this.data.cards||(this.data.cards={}),this.data.states||(this.data.states={}),this.data.reviewLog||(this.data.reviewLog=[]),this.data.quarantine||(this.data.quarantine={}),Number.isFinite(this.data.version)||(this.data.version=0);for(let i of Object.values(this.data.states)){if(!i||typeof i!="object")continue;Number.isFinite(i.due)||(i.due=0),Number.isFinite(i.reps)||(i.reps=0),Number.isFinite(i.lapses)||(i.lapses=0),Number.isFinite(i.learningStepIndex)||(i.learningStepIndex=0);let r=(e=i.stage)!=null?e:"new";if(r==="new"||r==="learning"||r==="review"||r==="relearning"||r==="suspended"||(i.stage="new"),i.stage==="suspended"){i.fsrsState===void 0&&(i.fsrsState=T.New),(!Number.isFinite(i.scheduledDays)||i.scheduledDays<0)&&(i.scheduledDays=0),delete i.intervalDays,delete i.ease;continue}if(i.fsrsState===void 0&&(i.stage==="new"?i.fsrsState=T.New:i.stage==="review"?i.fsrsState=T.Review:i.stage==="relearning"?i.fsrsState=T.Relearning:i.fsrsState=((t=i.lapses)!=null?t:0)>0?T.Relearning:T.Learning),i.fsrsState===T.New?(i.stage="new",i.lastReviewed=void 0,i.stabilityDays=void 0,i.scheduledDays=0):i.fsrsState===T.Review?i.stage="review":i.fsrsState===T.Relearning?i.stage="relearning":i.fsrsState===T.Learning&&(i.stage="learning"),!Number.isFinite(i.scheduledDays)||i.scheduledDays<0){let a=i.intervalDays;Number.isFinite(a)&&a>=0?i.scheduledDays=Math.max(0,Math.floor(Number(a))):i.scheduledDays=0}else i.scheduledDays=Math.max(0,Math.floor(Number(i.scheduledDays)));delete i.intervalDays,delete i.ease}this.data.version<7&&(this.data.version=7)}async persist(){let s=await this.plugin.loadData()||{};s.settings=this.plugin.settings,s.store=this.data,await this.plugin.saveData(s)}getAllCards(){let s=this.data.quarantine||{};return Object.values(this.data.cards||{}).filter(e=>!s[String(e.id)])}getCardsByNote(s){return this.getAllCards().filter(e=>e.sourceNotePath===s)}getQuarantine(){return this.data.quarantine||{}}isQuarantined(s){return!!(this.data.quarantine&&this.data.quarantine[String(s)])}getState(s){return this.data.states[s]||null}upsertCard(s){this.data.cards[s.id]=s}upsertState(s){this.data.states[s.id]=s}appendReviewLog(s){this.data.reviewLog.push(s)}ensureState(s,e,t=2.5){this.data.states[s]||(this.data.states[s]={id:s,stage:"new",due:e,reps:0,lapses:0,learningStepIndex:0,fsrsState:T.New,scheduledDays:0});let i=this.data.states[s];if((!i.stage||i.stage==="")&&(i.stage="new"),delete i.intervalDays,delete i.ease,i.stage==="new"||i.fsrsState===T.New)i.lastReviewed=void 0,i.stabilityDays=void 0,i.scheduledDays=0;else if(!Number.isFinite(i.scheduledDays)||i.scheduledDays<0){let r=i.intervalDays;Number.isFinite(r)&&r>=0?i.scheduledDays=Math.max(0,Math.floor(Number(r))):i.scheduledDays=0}else i.scheduledDays=Math.max(0,Math.floor(Number(i.scheduledDays)));return Number.isFinite(i.due)||(i.due=e),Number.isFinite(i.reps)||(i.reps=0),Number.isFinite(i.lapses)||(i.lapses=0),Number.isFinite(i.learningStepIndex)||(i.learningStepIndex=0),i}};var U=require("obsidian");var Gt=require("obsidian");function E(n,s,e){let t=document.createElement(n);return s&&(t.className=s),e!==void 0&&(t.textContent=e),t}function Ee(n,s,e,t){let i=document.createElement("button");i.className="bc-btn",i.type="button",i.title=e||"";let r=E("span");r.style.display="inline-flex",r.style.alignItems="center",r.style.gap="8px";let o=E("span");return o.style.display="inline-flex",o.style.alignItems="center",(0,Gt.setIcon)(o,n),r.appendChild(o),s&&r.appendChild(E("span",void 0,s)),i.appendChild(r),i.addEventListener("click",t),i}function Yt(n,s){let e=document.createElement("button");return e.className="bc-toggle",e.type="button",e.title=n?"Collapse":"Expand",e.textContent=n?"-":"+",e.addEventListener("click",t=>{t.stopPropagation(),s()}),e}function Xt(n,s,e){return Math.max(s,Math.min(e,n))}function Zt(n){let s=Math.max(1,Math.round(n));return s%1440===0?`${s/1440}d`:s%60===0?`${s/60}h`:`${s}m`}function Ss(n){var r;let s=((r=n.learningStepsMinutes)!=null?r:[]).map(Zt),e=Array.isArray(n.relearningStepsMinutes)?n.relearningStepsMinutes:[],t=e.length>0?e.map(Zt):[s.length?s[0]:"10m"],i=Xt(Number(n.requestRetention)||.9,.8,.97);return We({request_retention:i,maximum_interval:36500,enable_fuzz:!1,enable_short_term:!0,learning_steps:s.length?s:["10m"],relearning_steps:t})}function Jt(n){var s;return n.fsrsState!==void 0?n.fsrsState:n.stage==="suspended"?T.New:n.stage==="new"?T.New:n.stage==="review"?T.Review:((s=n.lapses)!=null?s:0)>0?T.Relearning:T.Learning}function Es(n,s){var f;let e=new Date(s),t=Jt(n),i=Number.isFinite(n.due)?Number(n.due):s,r=t===T.New?0:Number.isFinite(n.scheduledDays)?Math.max(0,Math.floor(Number(n.scheduledDays))):0,o=Number.isFinite(n.lastReviewed)&&((f=n.lastReviewed)!=null?f:0)>0?new Date(n.lastReviewed):void 0;o&&o.getTime()>s&&(o=void 0),t===T.New&&(o=void 0),!o&&t!==T.New&&(t=T.New,o=void 0);let a=Number.isFinite(n.difficulty)?Xt(Number(n.difficulty),1,10):5,l=t===T.New?0:Number.isFinite(n.stabilityDays)&&Number(n.stabilityDays)>0?Math.max(.1,Number(n.stabilityDays)):t===T.Review&&r>0?Math.max(.1,r):0,d=o&&t!==T.New?Math.max(0,Ke(o,e)):0;return{due:new Date(i),stability:l,difficulty:a,elapsed_days:d,scheduled_days:r,reps:Math.max(0,n.reps||0),lapses:Math.max(0,n.lapses||0),learning_steps:Math.max(0,n.learningStepIndex||0),state:t,last_review:o}}function _s(n,s){if(n.stage==="suspended")return{...n,due:n.due};let e=s.state===T.New?"new":s.state===T.Review?"review":s.state===T.Relearning?"relearning":"learning",t=Number.isFinite(s.scheduled_days)?Math.max(0,Math.floor(Number(s.scheduled_days))):0;return{...n,stage:e,fsrsState:s.state,due:s.due.getTime(),scheduledDays:t,reps:Math.max(0,s.reps||0),lapses:Math.max(0,s.lapses||0),learningStepIndex:Math.max(0,s.learning_steps||0),stabilityDays:Number.isFinite(s.stability)?s.stability:n.stabilityDays,difficulty:Number.isFinite(s.difficulty)?s.difficulty:n.difficulty,lastReviewed:s.last_review?s.last_review.getTime():n.lastReviewed}}function Ts(n){switch(n){case"again":return M.Again;case"hard":return M.Hard;case"good":return M.Good;case"easy":return M.Easy;default:return M.Good}}function Ms(n,s,e,t){var w,b,C,y;let i=n.due;if(n.stage==="suspended"){let v=Jt(n);return{nextState:n,prevDue:i,nextDue:n.due,metrics:{retrievabilityNow:null,retrievabilityTarget:null,elapsedDays:0,stabilityDays:Number((w=n.stabilityDays)!=null?w:0),difficulty:Number((b=n.difficulty)!=null?b:0),stateBefore:v,stateAfter:v}}}let r=t.scheduler,o=Ss(r),a=Ut(o),l=new Date(e),d=Es(n,e),f=d.last_review&&d.state!==T.New?Math.max(0,Ke(d.last_review,l)):0,c=d.last_review&&d.state!==T.New&&d.stability>0?ye(o.w,f,d.stability):null,h=a.next(d,l,Ts(s)),p=_s(n,h.card),u=h.card.due.getTime()-l.getTime(),m=Math.max(0,u/(24*60*60*1e3)),g=h.card.stability>0?ye(o.w,m,h.card.stability):null;return{nextState:p,prevDue:i,nextDue:p.due,metrics:{retrievabilityNow:c,retrievabilityTarget:g,elapsedDays:f,stabilityDays:(C=p.stabilityDays)!=null?C:0,difficulty:(y=p.difficulty)!=null?y:0,stateBefore:d.state,stateAfter:h.card.state}}}function Ze(n,s,e,t){return Ms(n,s,e,t)}function en(n,s){if(n.stage!=="suspended")return n;let e=Number.isFinite(n.suspendedDue)?n.suspendedDue:s,t=n.fsrsState,i=t===T.Review?"review":t===T.Relearning?"relearning":t===T.Learning?"learning":"new";return{...n,stage:i,due:e,suspendedDue:void 0}}function tn(n,s,e){let t=Se(new Date(s));return{id:n.id,stage:"new",fsrsState:T.New,due:t.due.getTime(),reps:0,lapses:0,learningStepIndex:0,scheduledDays:0,stabilityDays:void 0,difficulty:void 0,lastReviewed:void 0,suspendedDue:void 0}}var Ns=/^\^bc-(\d{9})$/,ks=/^(Q|MCQ|CQ):\s*(.*)\s*$/,nn=/^(T|A|O|I):\s*(.*)\s*$/,As=/^(Q|MCQ|CQ)\s*\|\s*(.*)$/,Is=/^(T|A|I)\s*\|\s*(.*)$/,Rs=/^T\s*\|\s*(.*)$/,yt=/^(?:\^bc-\d{9}|(?:Q|MCQ|CQ|T|A|O|I):|(?:Q|MCQ|CQ|T|A|I)\s*\|)\s*/;function Ds(n){let s=new Array(n.length).fill(!1),e=!1,t=null;for(let i=0;i<n.length;i++){let r=n[i].trimStart(),o=r.startsWith("```"),a=r.startsWith("~~~");if(!e&&(o||a)){e=!0,t=o?"```":"~~~",s[i]=!0;continue}e&&(s[i]=!0,t&&r.startsWith(t)&&(e=!1,t=null))}return s}function Ls(n){return n&&n.replace(/[ \t]+\n/g,`
`).trim()}function _e(n){let s=n.replace(/[ \t]+$/g,"");if(!s.endsWith("|"))return{text:n,closed:!1};let e=0;for(let t=s.length-2;t>=0&&s[t]==="\\";t--)e++;return e%2===1?{text:n,closed:!1}:{text:s.slice(0,-1),closed:!0}}function Te(n){return n.replace(/\\\\/g,"\\").replace(/\\\|/g,"|")}function Ps(n){let s=[],e="",t=!1;for(let i=0;i<n.length;i++){let r=n[i];if(t){e+=r,t=!1;continue}if(r==="\\"){t=!0;continue}if(r==="|"){s.push(e),e="";continue}e+=r}return s.push(e),s}function Fs(n){let s=[],e=n.replace(/\r?\n/g," ").trim(),t=e.includes("|")?Ps(e).map(o=>o.trim()).filter(Boolean):e.split(",").map(o=>o.trim()).filter(Boolean);t.length<2&&s.push("MCQ requires at least 2 options in O: line (separate options with |).");let i=-1,r=t.map((o,a)=>{let l=o.match(/^\*\*(.+)\*\*$/);return l?(i!==-1&&s.push("MCQ has more than one bold (correct) option."),i=a,l[1].trim()):o});return i===-1&&s.push("MCQ requires exactly one correct option wrapped in ** **."),{options:r,correctIndex:i,errors:s}}function Bs(n){let s=[],e=/\{\{c(\d+)::(.*?)\}\}/g,t,i=0;for(;(t=e.exec(n))!==null;){i+=1;let r=Number(t[1]),o=(t[2]||"").trim();(!Number.isFinite(r)||r<=0)&&s.push("Cloze token has invalid number."),o||s.push("Cloze token content is empty.")}return i===0&&s.push("Cloze card requires at least one {{cN::...}} token."),s}function sn(n,s,e,t,i){return{id:e||null,type:i==="Q"?"basic":i==="MCQ"?"mcq":"cloze",title:t||null,q:null,a:null,stem:null,optionsRaw:null,options:null,correctIndex:null,clozeText:null,info:null,sourceNotePath:n,sourceStartLine:s,errors:[]}}function Me(n,s,e=!0){var g,w;let t=s.split(/\r?\n/),i=e?Ds(t):new Array(t.length).fill(!1),r=[],o=null,a=null,l=null,d=!1,f=!1,c=null,h=null,p=null,u=()=>{if(c){if(!c.title&&l&&(c.title=l,l=null),["title","q","a","stem","optionsRaw","clozeText","info"].forEach(b=>{c[b]&&(c[b]=Ls(c[b]))}),!c.id&&o&&(c.id=o,o=null,a=null),c.type==="basic")c.q||c.errors.push("Missing Q:"),c.a||c.errors.push("Missing A:");else if(c.type==="mcq"){if(c.stem||c.errors.push("Missing MCQ:"),c.optionsRaw||c.errors.push("Missing O:"),c.optionsRaw){let{options:b,correctIndex:C,errors:y}=Fs(c.optionsRaw);c.options=b,c.correctIndex=C,y.forEach(v=>c.errors.push(v))}}else c.type==="cloze"&&(c.clozeText||c.errors.push("Missing CQ:"),c.clozeText&&Bs(c.clozeText).forEach(b=>c.errors.push(b)));r.push(c),c=null,h=null,p=null}},m=(b,C,y)=>{let v=b;v[C]=(v[C]?v[C]+`
`:"")+y};for(let b=0;b<t.length;b++){let C=t[b];if(e&&i[b])continue;let y=C.trim().match(Ns);if(y){let _=y[1];c?c.id?c.id!==_&&c.errors.push(`Conflicting anchors in same card block: ^bc-${c.id} vs ^bc-${_}`):c.id=_:(o=_,a=b);continue}if(c&&p){let{text:_,closed:k}=_e(C),R=Te(_);m(c,p,R),k&&(p=null,h=null);continue}if(!c&&f){let{text:_,closed:k}=_e(C),R=Te(_);l=(l?l+`
`:"")+R,k&&(f=!1);continue}if(C.trim().length===0){u(),o=null,a=null,l=null,d=!1,f=!1;continue}let v=c?null:C.match(nn);if(!c&&v&&v[1]==="T"){l=(l?l+`
`:"")+(v[2]||""),d=!0,f=!1;continue}if(!c){let _=C.match(Rs);if(_){let{text:k,closed:R}=_e(_[1]||""),$=Te(k);l=(l?l+`
`:"")+$.trimEnd(),d=!1,f=!R;continue}}if(!c&&d&&!yt.test(C)){l=(l||"")+`
`+C;continue}let x=C.match(As);if(x){u();let _=x[1];c=sn(n,a!==null?a:b,o,l,_),o=null,a=null,l=null,d=!1,f=!1;let R=(g=x[2])!=null?g:"",{text:$,closed:P}=_e(R),Y=Te($);_==="Q"&&(c.q=""),_==="MCQ"&&(c.stem=""),_==="CQ"&&(c.clozeText="");let z=_==="Q"?"q":_==="MCQ"?"stem":"clozeText";m(c,z,Y),P||(p=z),h=null;continue}let S=C.match(ks);if(S){u();let _=S[1],k=S[2]||"";c=sn(n,a!==null?a:b,o,l,_),o=null,a=null,l=null,d=!1,f=!1,_==="Q"?(c.q=k,h="q"):_==="MCQ"?(c.stem=k,h="stem"):(c.clozeText=k,h="clozeText"),p=null;continue}let N=c?C.match(Is):null;if(N&&c){let _=N[1],k=(w=N[2])!=null?w:"",{text:R,closed:$}=_e(k),P=Te(R),z={T:"title",A:"a",I:"info"}[_];c[z]=null,m(c,z,P),p=$?null:z,h=null;continue}let A=c?C.match(nn):null;if(A&&c){let _=A[1],k=A[2]||"";_==="T"?(c.title=(c.title?c.title+`
`:"")+k,h="title"):_==="A"?(c.a=(c.a?c.a+`
`:"")+k,h="a"):_==="O"?(c.optionsRaw=(c.optionsRaw?c.optionsRaw+`
`:"")+k,h="optionsRaw"):(c.info=(c.info?c.info+`
`:"")+k,h="info"),p=null;continue}if(c&&h&&!yt.test(C)){let _=c;_[h]=(_[h]?_[h]+`
`:"")+C;continue}if(c&&!p&&!h&&!yt.test(C)){u(),o=null,a=null,l=null,d=!1,f=!1;continue}c&&c.errors.push(`Unrecognised line inside card: "${C.trim().slice(0,60)}"`)}return u(),{cards:r}}function qs(){return String(Math.floor(1e8+Math.random()*9e8))}function bt(n){for(let s=0;s<1e4;s++){let e=qs();if(!n.has(e))return n.add(e),e}throw new Error("Unable to generate unique 9-digit ID after many attempts.")}function Xe(n){if(!n)return"";let s={type:n.type,title:n.title||"",info:n.info||""};return n.type==="basic"?(s.q=n.q||"",s.a=n.a||""):n.type==="mcq"?(s.stem=n.stem||"",s.options=Array.isArray(n.options)?n.options:[],s.correctIndex=Number.isFinite(n.correctIndex)?n.correctIndex:-1):n.type==="cloze"&&(s.clozeText=n.clozeText||""),JSON.stringify(s)}var rn=/^\^bc-(\d{9})$/;function $s(n,s){let e=o=>(o||"").trim().length===0,t=Math.max(0,Math.min(n.length-1,s)),i=t;for(;i>0&&!e(n[i-1]);)i--;let r=t;for(;r<n.length&&!e(n[r]);)r++;return{lo:i,hi:r}}function on(n,s){let{lo:e,hi:t}=$s(n,s),i=Math.max(0,Math.min(n.length-1,s)),r=/^\s*T\s*(?::|\|)\s*/;for(let o=e;o<i;o++)if(r.test(n[o]||""))return o;for(let o=i;o<t;o++)if(r.test(n[o]||""))return o;return i}function wt(n){let s=new Set;for(let e of n){let t=(e||"").trim(),i=rn.exec(t);i&&s.add(i[1])}return s}function an(n,s){let e=[];for(let t=0;t<n.length;t++){let i=(n[t]||"").trim(),r=rn.exec(i);if(!r)continue;let o=r[1];s.has(o)||e.push(t)}return e}function ln(n,s){var i,r;let e=new Map;for(let o of s){let a=Math.max(0,Math.min(n.length,o.lineIndex)),l=(i=e.get(a))!=null?i:[];l.push({...o,lineIndex:a}),e.set(a,l)}let t=Array.from(e.keys()).sort((o,a)=>a-o);for(let o of t){let a=(r=e.get(o))!=null?r:[],l=a.filter(f=>f.deleteLine),d=a.filter(f=>typeof f.insertText=="string"&&f.insertText.length);for(let f of l)o>=0&&o<n.length&&n.splice(o,1);for(let f of d){let c=String(f.insertText||"").split(`
`);n.splice(o,0,...c)}}return n}async function le(n,s){let e=n.app.vault,t=Date.now(),i=await e.read(s),r=i.split(/\r?\n/),{cards:o}=Me(s.path,i,n.settings.indexing.ignoreInCodeFences);for(let y of Object.keys(n.store.data.cards||{})){let v=n.store.data.cards[y];v&&v.sourceNotePath===s.path&&(v.lastSeenAt=0)}for(let y of Object.keys(n.store.data.quarantine||{})){let v=n.store.data.quarantine[y];v&&v.notePath===s.path&&(v.lastSeenAt=0)}let a=new Set([...Object.keys(n.store.data.cards||{}),...Object.keys(n.store.data.quarantine||{}),...wt(r)]),l=wt(r),d=[],f=new Set,c=0,h=0;for(let y of o){let v=y.id?String(y.id):null;if(v||(v=bt(a),y.assignedId=v),a.add(v),f.add(v),!l.has(v)){let x=on(r,y.sourceStartLine);d.push({lineIndex:x,insertText:`^bc-${v}`}),c+=1,l.add(v)}}let p=an(r,f);for(let y of p)d.push({lineIndex:y,deleteLine:!0}),h+=1;d.length&&(ln(r,d),await e.modify(s,r.join(`
`)));let u=0,m=0,g=0,w=0,b=[];for(let y of o){let v=String(y.id||y.assignedId||"");if(!v)continue;if(y.errors&&y.errors.length){n.store.data.quarantine[v]={id:v,notePath:y.sourceNotePath,sourceStartLine:y.sourceStartLine,reason:y.errors.join("; "),lastSeenAt:t},delete n.store.data.cards[v],n.store.ensureState(v,t,2.5),w+=1,b.push(v);continue}n.store.data.quarantine&&n.store.data.quarantine[v]&&delete n.store.data.quarantine[v];let x={id:v,type:y.type,title:y.title||void 0,q:y.type==="basic"?y.q||"":void 0,a:y.type==="basic"?y.a||"":void 0,stem:y.type==="mcq"?y.stem||"":void 0,options:y.type==="mcq"?y.options||[]:void 0,correctIndex:y.type==="mcq"?y.correctIndex:void 0,clozeText:y.type==="cloze"?y.clozeText||"":void 0,info:y.info||void 0,sourceNotePath:y.sourceNotePath,sourceStartLine:y.sourceStartLine,updatedAt:t,lastSeenAt:t},S=n.store.data.cards[v];S?Xe(S)!==Xe(x)?m+=1:g+=1:u+=1,n.store.upsertCard(x),n.store.ensureState(v,t,2.5)}let C=0;for(let y of Object.keys(n.store.data.cards||{})){let v=n.store.data.cards[y];v&&v.sourceNotePath===s.path&&v.lastSeenAt===0&&(delete n.store.data.cards[y],n.store.data.states&&delete n.store.data.states[y],C+=1)}for(let y of Object.keys(n.store.data.quarantine||{})){let v=n.store.data.quarantine[y];v&&v.notePath===s.path&&v.lastSeenAt===0&&(delete n.store.data.quarantine[y],n.store.data.states&&delete n.store.data.states[y],C+=1)}return await n.store.persist(),{idsInserted:c,anchorsRemoved:h,newCount:u,updatedCount:m,sameCount:g,quarantinedCount:w,quarantinedIds:b,removed:C}}async function vt(n){let s=Date.now(),e=n.app.vault,t=e.getMarkdownFiles();for(let u of Object.keys(n.store.data.cards||{}))n.store.data.cards[u]&&(n.store.data.cards[u].lastSeenAt=0);for(let u of Object.keys(n.store.data.quarantine||{}))n.store.data.quarantine[u]&&(n.store.data.quarantine[u].lastSeenAt=0);let i=0,r=0,o=0,a=0,l=0,d=0,f=[],c=new Set([...Object.keys(n.store.data.cards||{}),...Object.keys(n.store.data.quarantine||{})]),h=[],p=[];for(let u of t){let m=await e.read(u),g=m.split(/\r?\n/),{cards:w}=Me(u.path,m,n.settings.indexing.ignoreInCodeFences);if(!w.length)continue;let b=wt(g);for(let x of b)c.add(x);for(let x of w)x.id&&c.add(String(x.id));let C=new Set,y=[];for(let x of w){let S=x.id?String(x.id):null;if(S||(S=bt(c),x.assignedId=S),c.add(S),C.add(S),!b.has(S)){let N=on(g,x.sourceStartLine);y.push({lineIndex:N,insertText:`^bc-${S}`}),i+=1,b.add(S)}p.push(x)}let v=an(g,C);for(let x of v)y.push({lineIndex:x,deleteLine:!0}),r+=1;y.length&&h.push({file:u,originalLines:g,edits:y})}for(let u of h){let m=u.originalLines.slice();ln(m,u.edits),await e.modify(u.file,m.join(`
`))}for(let u of p){let m=String(u.id||u.assignedId||"");if(!m)continue;if(u.errors&&u.errors.length){n.store.data.quarantine[m]={id:m,notePath:u.sourceNotePath,sourceStartLine:u.sourceStartLine,reason:u.errors.join("; "),lastSeenAt:s},delete n.store.data.cards[m],n.store.ensureState(m,s,2.5),d+=1,f.push(m);continue}n.store.data.quarantine&&n.store.data.quarantine[m]&&delete n.store.data.quarantine[m];let g={id:m,type:u.type,title:u.title||void 0,q:u.type==="basic"?u.q||"":void 0,a:u.type==="basic"?u.a||"":void 0,stem:u.type==="mcq"?u.stem||"":void 0,options:u.type==="mcq"?u.options||[]:void 0,correctIndex:u.type==="mcq"?u.correctIndex:void 0,clozeText:u.type==="cloze"?u.clozeText||"":void 0,info:u.info||void 0,sourceNotePath:u.sourceNotePath,sourceStartLine:u.sourceStartLine,updatedAt:s,lastSeenAt:s},w=n.store.data.cards[m];w?Xe(w)!==Xe(g)?a+=1:l+=1:o+=1,n.store.upsertCard(g),n.store.ensureState(m,s,2.5)}for(let u of Object.keys(n.store.data.cards||{})){let m=n.store.data.cards[u];m&&m.lastSeenAt!==s&&(delete n.store.data.cards[u],delete n.store.data.states[u])}for(let u of Object.keys(n.store.data.quarantine||{})){let m=n.store.data.quarantine[u];m&&m.lastSeenAt!==s&&(delete n.store.data.quarantine[u],delete n.store.data.states[u])}return await n.store.persist(),{idsInserted:i,anchorsRemoved:r,newCount:o,updatedCount:a,sameCount:l,quarantinedCount:d,quarantinedIds:f}}var q=require("obsidian");var fe=require("obsidian");var Os=/^\^bc-(\d{9})$/,Hs=/^<!--ID:(\d{9})-->$/,zs=/^(T|Title|Q|Question|A|Answer|I|Info|MCQ|O|Options|CQ|Cloze|C):\s*/;function be(n){let s=(n||"").trim();return Os.test(s)||Hs.test(s)}function Qs(n){let s=(n||"").trim();return be(s)||zs.test(s)}function Ws(n,s){let e=`^bc-${s}`,t=`<!--ID:${s}-->`,i=n.findIndex(a=>(a||"").trim()===e);if(i<0&&(i=n.findIndex(a=>(a||"").trim()===t)),i<0)throw new Error(`Could not locate ^bc-${s} (or ID comment) in note.`);let r=i;for(;r>0;){let a=(n[r-1]||"").trim();if(a===""&&r-2>=0&&be((n[r-2]||"").trim())){r--;continue}if(be(a)){r--;continue}break}let o=n.length;for(let a=i+1;a<n.length;a++){let l=(n[a]||"").trim();if(be(l)){o=a;break}}return{start:r,end:o}}function Vs(n){return String(n!=null?n:"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).map(t=>t.replace(/\s+$/g,""))}function ce(n,s,e){var h,p;let t=e===void 0?null:Vs(e),i=s.map(u=>new RegExp(`^${u}:\\s*`,"i")),r=-1,o=s[0];for(let u=0;u<n.length;u++){let m=(n[u]||"").trim();if(!be(m)){for(let g=0;g<i.length;g++)if(i[g].test(n[u]||"")){r=u,o=s[g];break}if(r>=0)break}}if(t===null)return n;let a=t.join(`
`).trim()==="";if(r<0){if(a)return n;let u=0;for(;u<n.length&&be((n[u]||"").trim());)u++;let m=`${o}: ${(h=t[0])!=null?h:""}`.replace(/\s+$/g,""),g=t.slice(1),w=[m,...g];return[...n.slice(0,u),...w,...n.slice(u)]}let l=r+1;for(;l<n.length;){let u=(n[l]||"").trim();if(Qs(u))break;l++}if(a)return[...n.slice(0,r),...n.slice(l)];let d=`${o}: ${(p=t[0])!=null?p:""}`.replace(/\s+$/g,""),f=t.slice(1),c=[d,...f];return[...n.slice(0,r),...c,...n.slice(l)]}function js(n,s){return n.map((t,i)=>{let r=(t||"").trim();return r?i===s?`**${r}**`:r:""}).filter(Boolean).join(" | ")}function se(n,s){let e=n.createDiv({cls:"bc-edit-section-title"});return e.createEl("div",{text:s,cls:"bc-muted"}),e}var we=class extends fe.Modal{constructor(s,e,t){super(s),this.card=e,this.onSave=t}onOpen(){this.modalEl.addClass("bc-modal"),this.modalEl.addClass("bc-edit-modal");let{contentEl:s}=this;s.empty();let e=String(this.card.type||"basic"),t=String(this.card.id||"");s.createEl("h3",{text:`Quick edit flashcard ${t}`});let i=y=>{let v=s.createEl("input");return v.type="text",v.value=y||"",v.style.width="100%",v},r=(y,v=4)=>{let x=s.createEl("textarea");return x.value=y||"",x.rows=v,x.style.width="100%",x};se(s,"Title");let o=i(String(this.card.title||"")),a=null,l=null,d=null,f=null,c=[],h=-1,p=(y="",v=!1)=>{let x=c.length,S=s.createDiv({cls:"bc-edit-mcq-option-row"});S.style.display="flex",S.style.alignItems="center",S.style.gap="8px";let N=S.createEl("div",{text:`Option ${x+1}`,cls:"bc-muted"});N.style.minWidth="70px";let A=S.createEl("input");A.type="text",A.value=y||"",A.style.flex="1",A.style.width="100%";let _=S.createEl("input");_.type="radio",_.name=`bc-mcq-correct-${t}`,_.title="Correct answer",_.checked=v;let k=S.createEl("button",{text:"\u2212"});k.type="button";let R={wrap:S,input:A,radio:_,delBtn:k};c.push(R);let $=()=>{h=c.findIndex(P=>P.radio.checked)};_.addEventListener("change",()=>{$()}),k.addEventListener("click",()=>{let P=c.indexOf(R);if(P<0)return;R.wrap.remove(),c.splice(P,1);let Y=h;$(),Y===P&&(h=c.findIndex(z=>z.radio.checked)),c.forEach((z,ue)=>{let re=z.wrap.querySelector("div");re&&(re.textContent=`Option ${ue+1}`)})}),v&&(h=x)};if(e==="cloze"){se(s,"Cloze"),d=r(String(this.card.clozeText||""),5),se(s,"Extra information");let y=r(String(this.card.info||""),4);this.renderButtons(e,o,{clozeEl:d,infoEl:y,getMcq:()=>null,qEl:null,aEl:null});return}if(e==="basic"){se(s,"Question"),a=r(String(this.card.q||""),4),se(s,"Answer"),l=r(String(this.card.a||""),4),se(s,"Extra information");let y=r(String(this.card.info||""),4);this.renderButtons(e,o,{qEl:a,aEl:l,infoEl:y,getMcq:()=>null,clozeEl:null});return}se(s,"Question"),f=r(String(this.card.stem||""),4),se(s,"Options");let u=Array.isArray(this.card.options)?this.card.options:[],m=Number.isFinite(this.card.correctIndex)?Number(this.card.correctIndex):-1;(u.length?u:["",""]).forEach((y,v)=>p(y,v===m)),h=m;let w=s.createDiv({cls:"bc-edit-mcq-add-row"});w.style.display="flex",w.style.justifyContent="flex-end",w.style.marginTop="6px";let b=w.createEl("button",{text:"+"});b.type="button",b.onclick=()=>p("",!1),se(s,"Extra information");let C=r(String(this.card.info||""),4);this.renderButtons(e,o,{qEl:null,aEl:null,clozeEl:null,infoEl:C,getMcq:()=>{var S;let y=c.map(N=>(N.input.value||"").trim()).filter(Boolean),v=c.findIndex(N=>N.radio.checked),x=v>=0?v:-1;return{stem:(S=f==null?void 0:f.value)!=null?S:"",options:y,correctIndex:x}}})}onClose(){this.modalEl.removeClass("bc-edit-modal"),this.modalEl.removeClass("bc-modal"),this.contentEl.empty()}renderButtons(s,e,t){let{contentEl:i}=this,r=i.createDiv();r.style.display="flex",r.style.gap="8px",r.style.justifyContent="flex-end",r.style.marginTop="12px";let o=r.createEl("button",{text:"Cancel"});o.type="button",o.onclick=()=>this.close();let a=r.createEl("button",{text:"Save"});a.type="button",a.onclick=async()=>{var l,d,f,c,h,p,u,m,g,w,b;try{let C={title:(l=e.value)!=null?l:"",info:(d=t.infoEl.value)!=null?d:""};if(s==="basic")C.q=(c=(f=t.qEl)==null?void 0:f.value)!=null?c:"",C.a=(p=(h=t.aEl)==null?void 0:h.value)!=null?p:"";else if(s==="cloze")C.clozeText=(m=(u=t.clozeEl)==null?void 0:u.value)!=null?m:"";else if(s==="mcq"){let y=t.getMcq();C.stem=(g=y==null?void 0:y.stem)!=null?g:"",C.options=(w=y==null?void 0:y.options)!=null?w:[],C.correctIndex=(b=y==null?void 0:y.correctIndex)!=null?b:-1}await this.onSave(C),this.close()}catch(C){console.error(C),new fe.Notice(`${I}: edit failed (${String((C==null?void 0:C.message)||C)})`)}}}};async function Je(n,s,e){let t=String(s.id||""),i=String(s.sourceNotePath||""),r=String(s.type||"basic");if(!t||!i)throw new Error("Missing card id or sourceNotePath.");let o=n.app.vault.getAbstractFileByPath(i);if(!(o instanceof fe.TFile))throw new Error(`Note not found: ${i}`);let l=(await n.app.vault.read(o)).replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`),{start:d,end:f}=Ws(l,t),c=l.slice(d,f);if(!c.some(m=>(m||"").trim()===`^bc-${t}`)&&!c.some(m=>(m||"").trim()===`<!--ID:${t}-->`))throw new Error(`Block found for ${t} does not contain anchor/comment marker; aborting.`);if(c=ce(c,["T","Title"],e.title),c=ce(c,["I","Info"],e.info),r==="basic")c=ce(c,["Q","Question"],e.q),c=ce(c,["A","Answer"],e.a);else if(r==="cloze")c=ce(c,["CQ","Cloze","C"],e.clozeText);else if(r==="mcq"){c=ce(c,["MCQ"],e.stem);let m=Array.isArray(e.options)?e.options:[],g=Number.isFinite(e.correctIndex)?Number(e.correctIndex):-1;if(m.length>0){let w=js(m,g);c=ce(c,["O","Options"],w)}else c=ce(c,["O","Options"],"")}let p=[...l.slice(0,d),...c,...l.slice(f)].join(`
`);await n.app.vault.modify(o,p);let u=await le(n,o);new fe.Notice(`${I}: synced after edit \u2014 ${u.newCount} new; ${u.updatedCount} updated; ${u.sameCount} unchanged; ${u.idsInserted} IDs inserted.`)}function Ks(n,s){let e=n.createDiv();e.style.border="1px solid rgba(220, 38, 38, 0.35)",e.style.background="rgba(220, 38, 38, 0.08)",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.margin="10px 0 12px",e.style.lineHeight="1.35",e.style.fontSize="13px";let t=e.createEl("div",{text:"How to fix parse errors"});t.style.fontWeight="600",t.style.marginBottom="6px";let i=e.createEl("div",{text:s});return i.style.whiteSpace="pre-wrap",e}function Us(n){return Array.isArray(n)&&n.every(s=>typeof s=="string")}function Ne(n){return String(n!=null?n:"").replace(/\\/g,"\\\\").replace(/\|/g,"\\|")}function de(n,s){var r,o,a,l;let t=String(s!=null?s:"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`);if(t.length<=1)return[`${n} | ${Ne((r=t[0])!=null?r:"")} |`];let i=[];i.push(`${n} | ${Ne((o=t[0])!=null?o:"")}`);for(let d=1;d<t.length-1;d++)i.push(Ne((a=t[d])!=null?a:""));return i.push(`${Ne((l=t[t.length-1])!=null?l:"")} |`),i}function Gs(n,s){return`O: ${n.map((t,i)=>{let r=String(t!=null?t:"").trim();if(!r)return"";let o=Ne(r);return i===s?`**${o}**`:o}).filter(Boolean).join(" | ")}`}var ke=class extends q.Modal{constructor(s,e){super(s),this.plugin=e}onOpen(){this.modalEl.addClass("bc-modals");let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:`${I}: add flashcard`});let e=this.app.workspace.getActiveFile(),t=String((e==null?void 0:e.path)||""),i=s.createEl("div",{text:t?`Target: ${t}`:"Target: (no active note)"});i.style.opacity="0.8",i.style.fontSize="12px",i.style.marginBottom="10px";let r=s.createDiv();r.style.display="flex",r.style.gap="8px",r.style.alignItems="center",r.style.marginBottom="10px",r.createEl("div",{text:"Type",cls:"bc-muted"}).style.minWidth="50px";let o=r.createEl("select");o.style.flex="1",o.createEl("option",{text:"Basic (Q/A)",value:"basic"}),o.createEl("option",{text:"MCQ",value:"mcq"}),o.createEl("option",{text:"Cloze",value:"cloze"});let a=y=>{let v=s.createDiv();v.style.display="flex",v.style.flexDirection="column",v.style.gap="4px",v.style.marginBottom="10px";let x=v.createEl("div",{text:y,cls:"bc-muted"});x.style.fontSize="12px";let S=v.createEl("input");return S.type="text",S.style.width="100%",{wrap:v,input:S}},l=(y,v=4)=>{let x=s.createDiv();x.style.display="flex",x.style.flexDirection="column",x.style.gap="4px",x.style.marginBottom="10px";let S=x.createEl("div",{text:y,cls:"bc-muted"});S.style.fontSize="12px";let N=x.createEl("textarea");return N.rows=v,N.style.width="100%",{wrap:x,ta:N}},d=a("Title"),f=l("Question",4),c=l("Answer",4),h=l("MCQ stem",4),p=l("Options (one per line; prefix correct with * )",5),u=l("Cloze text",5),m=l("Extra info",4),g=()=>{let y=o.value;f.wrap.style.display=y==="basic"?"":"none",c.wrap.style.display=y==="basic"?"":"none",h.wrap.style.display=y==="mcq"?"":"none",p.wrap.style.display=y==="mcq"?"":"none",u.wrap.style.display=y==="cloze"?"":"none"};o.onchange=()=>g(),g();let w=s.createDiv();w.style.display="flex",w.style.gap="8px",w.style.justifyContent="flex-end",w.style.marginTop="12px";let b=w.createEl("button",{text:"Cancel"});b.type="button",b.onclick=()=>this.close();let C=w.createEl("button",{text:"Add"});C.type="button",C.onclick=async()=>{var y;try{let v=this.app.workspace.getActiveFile();if(!(v instanceof q.TFile)){new q.Notice(`${I}: open a markdown note first`);return}let x=o.value,S=[];if(S.push(...de("T",d.input.value||"")),x==="basic")S.push(...de("Q",f.ta.value||"")),S.push(...de("A",c.ta.value||"")),S.push(...de("I",m.ta.value||""));else if(x==="cloze")S.push(...de("CQ",u.ta.value||"")),S.push(...de("I",m.ta.value||""));else{S.push(...de("MCQ",h.ta.value||""));let k=(p.ta.value||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).map(P=>P.trim()).filter(Boolean),R=-1,$=k.map((P,Y)=>P.startsWith("*")?(R===-1&&(R=Y),P.replace(/^\*\s*/,"")):P);$.length>=2?(R<0&&(R=0),S.push(Gs($,R))):S.push("O: "),S.push(...de("I",m.ta.value||""))}S.push("");let N=S.join(`
`),A=this.app.workspace.getActiveViewOfType(q.MarkdownView);if(((y=A==null?void 0:A.file)==null?void 0:y.path)===v.path&&A.editor){let k=A.editor,R=k.getCursor();k.replaceRange(N,R)}else{let k=await this.app.vault.read(v),R=(k.endsWith(`
`)?k:k+`
`)+N;await this.app.vault.modify(v,R)}let _=await le(this.plugin,v);new q.Notice(`${I}: added + synced \u2014 ${_.newCount} new; ${_.updatedCount} updated; ${_.sameCount} unchanged; ${_.idsInserted} IDs inserted.`),this.close()}catch(v){console.error(v),new q.Notice(`${I}: add failed (${String((v==null?void 0:v.message)||v)})`)}}}onClose(){this.modalEl.removeClass("bc-modals"),this.contentEl.empty()}},me=class extends q.Modal{constructor(s,e,t){super(s),this.plugin=e,this.quarantinedIds=Array.isArray(t)?t:[]}onOpen(){this.modalEl.addClass("bc-modals");let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:`${I}: parse errors`}),Ks(s,["Typical fixes:","\u2022 Ensure each card has exactly one start line: Q | ... |  or  MCQ | ... |  or  CQ | ... |","\u2022 Pipe-format fields (T | ... |, A | ... |, I | ... |, etc.) must end with a closing | (unless intentionally multiline, then close later).","\u2022 MCQ requires an O: line with \u22652 options separated by | and exactly one option wrapped in ** **.","\u2022 Cloze requires at least one {{cN::...}} token.","","Use Open to jump to the exact ^bc- anchor, or Edit to quick-fix the card."].join(`
`));let e=s.createDiv();e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px";for(let r of this.quarantinedIds){let o=this.resolveCardRef(r),a=e.createDiv();a.style.display="flex",a.style.flexDirection="column",a.style.gap="6px",a.style.padding="10px 12px",a.style.border="1px solid var(--background-modifier-border)",a.style.borderRadius="12px";let l=a.createDiv();l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="space-between",l.style.gap="10px";let d=l.createDiv();d.style.display="flex",d.style.flexDirection="column",d.style.gap="2px";let f=d.createEl("div",{text:`^bc-${r}`});f.style.fontWeight="600";let c=d.createEl("div",{text:o!=null&&o.sourceNotePath?o.sourceNotePath:"(note path unresolved; will try active note)"});c.addClass("bc-muted"),c.style.fontSize="12px",c.style.opacity="0.85";let h=l.createDiv();h.style.display="flex",h.style.alignItems="center",h.style.gap="8px";let p=h.createEl("button");p.type="button",p.className="clickable-icon",p.setAttribute("aria-label","Open at anchor"),(0,q.setIcon)(p,"arrow-up-right"),p.onclick=()=>void this.openAtAnchor(r);let u=h.createEl("button");u.type="button",u.className="clickable-icon",u.setAttribute("aria-label","Quick edit"),(0,q.setIcon)(u,"edit-3"),u.onclick=()=>void this.openQuickEdit(r);let m=((o==null?void 0:o.errors)||[]).filter(Boolean);if(m.length){let g=a.createEl("ul");g.style.margin="0",g.style.paddingLeft="18px",g.style.fontSize="13px";for(let w of m)g.createEl("li",{text:w})}else{let g=a.createEl("div",{text:"No error details available."});g.addClass("bc-muted"),g.style.fontSize="13px"}}let t=s.createDiv();t.style.display="flex",t.style.justifyContent="flex-end",t.style.marginTop="12px";let i=t.createEl("button",{text:"Close"});i.type="button",i.onclick=()=>this.close()}onClose(){this.modalEl.removeClass("bc-modals"),this.contentEl.empty()}resolveCardRef(s){var l,d,f,c,h,p,u;let e=(l=this.plugin)==null?void 0:l.store,t=m=>{var g,w;return!m||typeof m!="object"?null:(w=(g=m[s])!=null?g:m[String(s)])!=null?w:null},i=[t((d=e==null?void 0:e.data)==null?void 0:d.quarantine),t((f=e==null?void 0:e.data)==null?void 0:f.quarantined),t((c=e==null?void 0:e.data)==null?void 0:c.parseErrors),t((h=e==null?void 0:e.data)==null?void 0:h.cards),t((p=e==null?void 0:e.data)==null?void 0:p.cardById),typeof(e==null?void 0:e.getCard)=="function"?e.getCard(s):null,typeof(e==null?void 0:e.getCardRecord)=="function"?e.getCardRecord(s):null].filter(Boolean),r=i.length?i[0]:null;if(r&&typeof r=="object"){let m=String(r.sourceNotePath||""),g=Number((u=r.sourceStartLine)!=null?u:0),w=r.errors,b=Us(w)?w:Array.isArray(w)?w.map(C=>String(C)):[];if(m)return{id:String(s),sourceNotePath:m,sourceStartLine:Number.isFinite(g)?g:0,errors:b}}let o=this.app.workspace.getActiveFile(),a=String((o==null?void 0:o.path)||"");return a?{id:String(s),sourceNotePath:a,sourceStartLine:0,errors:[]}:null}async openAtAnchor(s){var h;let e=this.resolveCardRef(s);if(!(e!=null&&e.sourceNotePath)){new q.Notice(`${I}: cannot resolve note path for ^bc-${s}`);return}let t=this.app.vault.getAbstractFileByPath(e.sourceNotePath);if(!(t instanceof q.TFile)){new q.Notice(`${I}: note not found (${e.sourceNotePath})`);return}let i=this.app.workspace.getLeaf(!0);await i.setViewState({type:"markdown",state:{file:t.path,mode:"source"},active:!0},{focus:!0});let r=i.view;if(!(r instanceof q.MarkdownView)){await this.app.workspace.openLinkText(`${e.sourceNotePath}#^bc-${s}`,e.sourceNotePath,!0);return}let a=await(async()=>{for(let p=0;p<30;p++){if(r.editor)return r.editor;await new Promise(u=>setTimeout(u,25))}return null})();if(!a)return;let l=`^bc-${s}`,f=(await this.app.vault.read(t)).split(/\r?\n/),c=f.findIndex(p=>(p||"").includes(l));if(c<0&&(c=Math.max(0,Number((h=e.sourceStartLine)!=null?h:0))),f[c]&&f[c].trim()===l){let p=c+1;for(;p<f.length&&(f[p]||"").trim()==="";)p++;p<f.length&&(c=p)}a.setCursor({line:c,ch:0}),a.scrollIntoView({from:{line:c,ch:0},to:{line:c,ch:0}},!0),a.focus()}async openQuickEdit(s){let e=this.resolveCardRef(s);if(!(e!=null&&e.sourceNotePath)){new q.Notice(`${I}: cannot resolve note path for ^bc-${s}`);return}let t=this.app.vault.getAbstractFileByPath(e.sourceNotePath);if(!(t instanceof q.TFile)){new q.Notice(`${I}: note not found (${e.sourceNotePath})`);return}let i=await this.app.vault.read(t),o=(Me(e.sourceNotePath,i,!0).cards||[]).find(l=>String(l.id||"")===String(s)),a=o?{id:String(o.id||s),type:String(o.type||"basic"),title:o.title||"",q:o.q||"",a:o.a||"",clozeText:o.clozeText||"",stem:o.stem||"",options:Array.isArray(o.options)?o.options:[],correctIndex:Number.isFinite(o.correctIndex)?Number(o.correctIndex):-1,info:o.info||"",sourceNotePath:e.sourceNotePath}:{id:String(s),type:"basic",title:"",q:"",a:"",info:"",sourceNotePath:e.sourceNotePath};new we(this.app,a,async l=>{await Je(this.plugin,a,l)}).open()}};function dn(n,s){if(!n||n.type==="vault")return!0;if(n.type==="folder"){let e=s.includes("/")?s.split("/").slice(0,-1).join("/"):"";return e===n.key||e.startsWith(n.key+"/")}return n.type==="note"?s===n.key:!0}function Ys(n){let s=new Date(n);return s.setHours(0,0,0,0),s.getTime()}function cn(n){let s=Number(n);return Number.isFinite(s)?Math.max(0,Math.floor(s)):Number.POSITIVE_INFINITY}function Zs(n,s,e){var l,d,f;let t=((d=(l=n.store)==null?void 0:l.data)==null?void 0:d.reviewLog)||[],i=new Map,r=new Set;for(let c of t){let h=String((f=c==null?void 0:c.id)!=null?f:"");if(!h||!s.has(h))continue;let p=Number(c==null?void 0:c.at);if(!Number.isFinite(p))continue;let u=i.get(h);(u===void 0||p<u)&&i.set(h,p),p>=e&&r.add(h)}let o=0,a=0;for(let c of r){let h=i.get(c);h!==void 0&&(h>=e?o+=1:a+=1)}return{newDoneToday:o,reviewDoneToday:a}}function Xs(n,s){return!n||n.stage==="suspended"?!1:n.stage==="new"?!0:n.stage==="learning"||n.stage==="relearning"||n.stage==="review"?typeof n.due!="number"||!Number.isFinite(n.due)?!0:n.due<=s:!1}function un(n,s){var v,x;let e=Date.now(),t=Ys(e),r=(x=((v=n==null?void 0:n.settings)!=null?v:{}).reviewer)!=null?x:{},o=cn(r.dailyNewLimit),a=cn(r.dailyReviewLimit),l=n.store.getAllCards().filter(S=>dn(s,S.sourceNotePath)),d=n.store.data.states||{},f=new Set(l.map(S=>String(S.id))),{newDoneToday:c,reviewDoneToday:h}=Zs(n,f,t),p=o===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Math.max(0,o-c),u=a===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Math.max(0,a-h),m=l.filter(S=>{let N=d[S.id];return Xs(N,e)}),g=[],w=[];for(let S of m){let N=d[S.id];N&&(N.stage==="new"?w.push(S):(N.stage==="learning"||N.stage==="relearning"||N.stage,g.push(S)))}g.sort((S,N)=>{let A=d[S.id],_=d[N.id],k=A&&typeof A.due=="number"&&Number.isFinite(A.due)?Number(A.due):-1,R=_&&typeof _.due=="number"&&Number.isFinite(_.due)?Number(_.due):-1;return k!==R?k-R:String(S.id).localeCompare(String(N.id))}),w.sort((S,N)=>String(S.id).localeCompare(String(N.id)));let b=u===Number.POSITIVE_INFINITY?g:g.slice(0,u),C=p===Number.POSITIVE_INFINITY?w:w.slice(0,p),y=[...b,...C];return{scope:s,queue:y,index:0,graded:{},stats:{total:y.length,done:0}}}function pn(n,s){let e=Date.now(),t=n.store.getAllCards().filter(o=>dn(s,o.sourceNotePath)),i=n.store.data.states||{},r=null;for(let o of t){let a=i[o.id];a&&a.stage!=="suspended"&&(a.stage==="learning"||a.stage==="relearning"||a.stage==="review")&&typeof a.due=="number"&&Number.isFinite(a.due)&&a.due>e&&(r===null||a.due<r)&&(r=a.due)}return r}function hn(n){let s=Math.max(0,Math.floor(n/1e3));if(s<60)return`${s} secs`;let e=Math.floor(s/60);if(e<60)return`${e} mins`;let t=Math.floor(e/60);return t<24?`${t} hours`:`${Math.floor(t/24)} days`}function et(n,s){var h;let e=E("div","");e.style.whiteSpace="pre-wrap",e.style.overflowWrap="anywhere";let t=document.createElement("p");t.setAttribute("dir","auto"),t.style.whiteSpace="pre-wrap",t.style.overflowWrap="anywhere",e.appendChild(t);let i=/\{\{c\d+::(.*?)\}\}/g,r=0,o,l=(()=>{let p=document.createElement("span");p.textContent="0000000000",p.style.position="absolute",p.style.visibility="hidden",p.style.whiteSpace="pre",t.appendChild(p);let u=p.getBoundingClientRect().width/10;return p.remove(),u||8})(),d=Math.max(0,Math.round(20/l)),f=()=>{var u;let p=t.lastChild;if(p&&p.nodeType===Node.TEXT_NODE){let m=(u=p.textContent)!=null?u:"";if(/\s$/.test(m))return;p.textContent=m+" ";return}p&&t.appendChild(document.createTextNode(" "))},c=p=>{let m="";for(let g=0;g<p;g++)m+=" ",(g+1)%6===0&&(m+="\u200B");return m};for(;o=i.exec(n);){o.index>r&&t.appendChild(document.createTextNode(n.slice(r,o.index)));let p=(h=o[1])!=null?h:"";if(s)t.appendChild(document.createTextNode(p));else{f();let u=document.createElement("span");u.className="bc-cloze-blank";let m=Math.max(4,Math.min(40,p.length)),g=Math.max(1,m-d);u.textContent=c(g),u.style.marginLeft="0",u.style.marginRight="10px",t.appendChild(u)}r=o.index+o[0].length}return r<n.length&&t.appendChild(document.createTextNode(n.slice(r))),e}function xt(){return{total:0,new:0,learning:0,review:0,relearning:0}}function Js(n){return(n.split("/").pop()||n).replace(/\.md$/i,"")}function ei(n){let s=n.split("/").filter(Boolean);return s.length?s[s.length-1]:n}function ti(n){var e,t;if(!n)return T.New;if(n.fsrsState!==void 0)return n.fsrsState;let s=(e=n.stage)!=null?e:"new";return s==="new"?T.New:s==="review"?T.Review:s==="relearning"?T.Relearning:((t=n.lapses)!=null?t:0)>0?T.Relearning:T.Learning}function Ct(n,s){n.total+=1,s===T.New?n.new+=1:s===T.Review?n.review+=1:s===T.Relearning?n.relearning+=1:n.learning+=1}function ni(n,s){let e=n.children.get(s);if(e)return e;let t={type:"folder",key:s,name:ei(s),children:new Map,counts:xt()};return n.children.set(s,t),t}function si(n,s){let e=n.children.get(s);if(e)return e;let t={type:"note",key:s,name:Js(s),children:new Map,counts:xt()};return n.children.set(s,t),t}function fn(n,s,e,t){let i={type:"folder",key:"",name:t,children:new Map,counts:xt()};for(let r of n){let o=String(r.sourceNotePath||"");if(!o)continue;let a=s[String(r.id)]||null,l=ti(a),d=o.split("/").filter(Boolean),f=d.slice(0,Math.max(0,d.length-1)),c=i,h="";Ct(c.counts,l);for(let u of f)h=h?`${h}/${u}`:u,c=ni(c,h),Ct(c.counts,l);let p=si(c,o);Ct(p.counts,l)}return i}function mn(n){var m,g;let{app:s,plugin:e,container:t}=n,i=Date.now(),r=e.store.getAllCards(),o=e.store.data.states||{},a=((g=(m=s==null?void 0:s.vault)==null?void 0:m.getName)==null?void 0:g.call(m))||"Vault",l=E("div","bc-deck"),d=E("div","bc-top-actions");d.appendChild(Ee("play","Study all","Start a vault-wide session",()=>{n.openSession({type:"vault",key:"",name:a})})),d.appendChild(Ee("refresh-cw","Sync flashcard database","Sync flashcards from the active note",()=>void n.resyncActiveFile()));let f=fn(r,o,i,a),c=(w,b)=>{for(let C of w.children.values())C.type==="folder"&&(b.add(C.key),C.children.size&&c(C,b))};if(d.appendChild(Ee("chevrons-down","Expand all","Expand all folders",()=>{let w=new Set([""]);c(f,w),n.setExpanded(w),n.rerender()})),d.appendChild(Ee("chevrons-up","Collapse all","Collapse all folders",()=>{n.setExpanded(new Set([""])),n.rerender()})),l.appendChild(d),!r.length){l.appendChild(E("div","bc-muted","No cards found. Run \u201CSync Question Bank\u201D.")),t.appendChild(l);return}let h=E("div","bc-deck-header");h.appendChild(E("div","","Deck")),h.appendChild(E("div","bc-count","Total")),h.appendChild(E("div","bc-count bc-new","New")),h.appendChild(E("div","bc-count bc-relearn","Relearning")),h.appendChild(E("div","bc-count bc-learning","Learning")),h.appendChild(E("div","bc-count bc-review","Review")),l.appendChild(h);let p=E("div","bc-deck-body");p.style.overflowY="auto",p.style.minHeight="0",l.style.display="flex",l.style.flexDirection="column",l.style.minHeight="0",p.style.flex="1 1 auto";let u=(w,b=0)=>{let C=Array.from(w.children.values()).sort((y,v)=>y.name.localeCompare(v.name));for(let y of C){let v=E("div","bc-deck-row"),x=E("div","bc-deck-name");if(x.style.paddingLeft=`${b*14}px`,y.type==="folder"){let S=n.expanded.has(y.key);x.appendChild(Yt(S,()=>{let N=new Set(n.expanded);N.has(y.key)?N.delete(y.key):N.add(y.key),n.setExpanded(N),n.rerender()}))}else{let S=E("span","","");S.style.display="inline-block",S.style.width="26px",x.appendChild(S)}x.appendChild(E("span","bc-name-text",y.name)),v.appendChild(x),v.appendChild(E("div","bc-count",String(y.counts.total))),v.appendChild(E("div","bc-count bc-new",String(y.counts.new))),v.appendChild(E("div","bc-count bc-relearn",String(y.counts.relearning))),v.appendChild(E("div","bc-count bc-learning",String(y.counts.learning))),v.appendChild(E("div","bc-count bc-review",String(y.counts.review))),v.addEventListener("click",()=>{y.type==="folder"?n.openSession({type:"folder",key:y.key,name:y.key||y.name}):y.type==="note"&&n.openSession({type:"note",key:y.key,name:y.name})}),p.appendChild(v),y.type==="folder"&&n.expanded.has(y.key)&&y.children.size&&u(y,b+1)}};u(f,0),l.appendChild(p),t.appendChild(l)}var gn=require("obsidian");function ii(n){return String(n!=null?n:"").replace(/\s*\/\s*/g," / ").replace(/\s+/g," ").trim()}function ri(n){let s=String(n!=null?n:"").trim();return s?(s=s.replace(/\\/g,"/").replace(/^\.\//,""),s=s.replace(/\.md$/i,""),ii(s)):"Note"}function oi(n){var i,r,o,a,l,d;if(!n)return null;let s=f=>{if(typeof f=="string"&&f.trim())return f.trim();if(Array.isArray(f)){let c=f.filter(h=>typeof h=="string").join(`
`).trim();return c||null}return null},e=(o=(r=(i=s(n.info))!=null?i:s(n.information))!=null?r:s(n.i))!=null?o:s(n.I);if(e)return e;let t=n.fields;if(t&&typeof t=="object"){let f=(d=(l=(a=s(t.info))!=null?a:s(t.information))!=null?l:s(t.i))!=null?d:s(t.I);if(f)return f}return null}function ai(n,s){let e=String(n!=null?n:""),t=/\{\{c(\d+)::([\s\S]*?)(?:::([\s\S]*?))?\}\}/g;return e.replace(t,(i,r,o,a)=>{let l=String(o!=null?o:""),d=String(a!=null?a:"");return s?l.includes(`
`)?l:`==${l}==`:d.trim()?`____ _(${d.trim()})_`:"____"})}function li(n){let s=n;return(!s.mcqOrderMap||typeof s.mcqOrderMap!="object")&&(s.mcqOrderMap={}),s.mcqOrderMap}function ci(n,s){if(!Array.isArray(n)||n.length!==s)return!1;let e=new Array(s).fill(!1);for(let t of n){if(!Number.isInteger(t)||t<0||t>=s||e[t])return!1;e[t]=!0}return!0}function di(n){for(let s=n.length-1;s>0;s--){let e=Math.floor(Math.random()*(s+1)),t=n[s];n[s]=n[e],n[e]=t}}function ui(n,s,e){var f;let t=(s==null?void 0:s.options)||[],i=Array.isArray(t)?t.length:0,r=Array.from({length:i},(c,h)=>h);if(!e||!n)return r;let o=String((f=s==null?void 0:s.id)!=null?f:"");if(!o)return r;let a=li(n),l=a[o];if(ci(l,i))return l;let d=r.slice();if(di(d),i>=2){let c=!0;for(let h=0;h<i;h++)if(d[h]!==h){c=!1;break}if(c){let h=d[0];d[0]=d[1],d[1]=h}}return a[o]=d,d}function yn(n){var A,_,k,R,$,P,Y,z,ue,re,ve,K,qt,$t;let s=!!((A=n.enableSkipButton)!=null?A:n.skipEnabled),e=!!n.practiceMode,t=!!n.fourButtonMode,i=typeof n.startPractice=="function",r=!e&&(!!n.canStartPractice||i),o=E("div","bc-card");o.classList.add("bc-widget");let a=n.currentCard(),l=a?String(a.id):"",d=E("div","bc-back");d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="space-between",d.style.gap="10px";let f=a&&(a.sourceNotePath||a.location||a.sourcePath)||((k=(_=n.session)==null?void 0:_.scope)==null?void 0:k.name)||"Note",c=ri(f),h=a?`ID ${l} \u2022 ${c}`:c,p=E("div","bc-muted",h);p.style.flex="1 1 auto",p.style.minWidth="0";let u=document.createElement("button");u.type="button",u.className="clickable-icon view-action bc-back-x",u.setAttribute("aria-label","Exit back to deck browser"),u.title="Exit back to deck browser",(0,gn.setIcon)(u,"x"),u.addEventListener("click",B=>{B.preventDefault(),B.stopPropagation(),n.backToDecks()}),d.appendChild(p),d.appendChild(u),o.appendChild(d);let m=E("div","bc-flashcard");if(o.appendChild(m),!a){n.clearTimer(),n.clearCountdown(),m.appendChild(E("div","bc-hr")),m.appendChild(E("div","bc-title",e?"Practice complete":"No cards are due"));let B=Number((P=($=(R=n.session)==null?void 0:R.stats)==null?void 0:$.done)!=null?P:0),F=Number((ue=(z=(Y=n.session)==null?void 0:Y.stats)==null?void 0:z.total)!=null?ue:0);F>0&&m.appendChild(E("div","bc-muted",`Reviewed: ${Math.min(B,F)}/${F}`));let Q=E("div","bc-row");if(e){let te=n.makePlainButton("Back to Decks",()=>n.backToDecks(),"bc-btn blue-btn");n.appendKeyboxRight(te,"Enter"),Q.appendChild(te),m.appendChild(Q),m.appendChild(E("div","bc-muted","This was a practice session. Scheduling was not changed. Bury/Suspend are unavailable in practice."))}else if(r&&i){let te=F>0?"Continue in Practice":"Study Anyway",Fe=n.makePlainButton(te,()=>{var ne;return(ne=n.startPractice)==null?void 0:ne.call(n)},"bc-btn blue-btn");n.appendKeyboxRight(Fe,"Enter"),Q.appendChild(Fe),m.appendChild(Q),m.appendChild(E("div","bc-muted","Practice session: reviews not-due cards and does not affect FSRS scheduling. Note: Bury/Suspend are disabled in practice."))}else m.appendChild(E("div","bc-muted","No cards available for practice in this scope."));m.appendChild(E("div","bc-hr"));let ee=(re=n.session)==null?void 0:re.scope,oe=ee?n.getNextDueInScope(ee):null;if(oe){let te=E("div","bc-muted","");n.startCountdown(oe,te),m.appendChild(te)}else m.appendChild(E("div","bc-muted","No scheduled cards in scope."));n.container.appendChild(o);return}n.clearCountdown();let g=((ve=n.session)==null?void 0:ve.graded[l])||null,w=String(a.sourceNotePath||((qt=(K=n.session)==null?void 0:K.scope)==null?void 0:qt.name)||""),b=a.title||(a.type==="mcq"?"MCQ":a.type==="cloze"?"Cloze":"Basic"),C=E("div","bc-title");C.classList.add("bc-question-title"),C.style.whiteSpace="pre-wrap",C.style.overflowWrap="anywhere",n.renderMarkdownInto(C,String(b!=null?b:""),w),m.appendChild(C),m.appendChild(E("div","bc-hr"));let y=(B,F)=>{let Q=E("div",`bc-field ${B}`);return Q.style.whiteSpace="pre-wrap",Q.style.overflowWrap="anywhere",n.renderMarkdownInto(Q,F!=null?F:"",w),Q},v=B=>E("div","bc-muted",B);if(a.type==="basic")m.appendChild(v("Question")),m.appendChild(y("bc-q",a.q||"")),(n.showAnswer||g)&&(m.appendChild(E("div","bc-hr")),m.appendChild(v("Answer")),m.appendChild(y("bc-a",a.a||"")));else if(a.type==="cloze"){let B=String(a.clozeText||""),F=n.showAnswer||!!g;m.appendChild(v(F?"Answer":"Question"));let Q=ai(B,F);m.appendChild(y("bc-cloze",Q))}else if(a.type==="mcq"){m.appendChild(v("Question")),m.appendChild(y("bc-q",a.stem||"")),m.appendChild(E("div","bc-hr")),m.appendChild(v("Options"));let B=a.options||[],F=($t=g==null?void 0:g.meta)==null?void 0:$t.mcqChoice;ui(n.session,a,!!n.randomizeMcqOptions).forEach((oe,te)=>{var Ot;let Fe=(Ot=B[oe])!=null?Ot:"",ne=E("div","bc-option");g&&(oe===a.correctIndex&&ne.classList.add("correct"),typeof F=="number"&&F===oe&&F!==a.correctIndex&&ne.classList.add("wrong"));let Ce=document.createElement("button");Ce.type="button",Ce.className="bc-keybtn",Ce.appendChild(n.keybox(String(te+1))),Ce.addEventListener("click",Ht=>{Ht.preventDefault(),Ht.stopPropagation(),g||n.answerMcq(oe)});let Be=E("span","bc-option-text");Be.style.whiteSpace="pre-wrap",Be.style.overflowWrap="anywhere",Be.textContent=Fe,ne.appendChild(Ce),ne.appendChild(Be),g||ne.addEventListener("click",()=>void n.answerMcq(oe)),m.appendChild(ne)});let ee=a.a||a.answer||a.explain||a.explanation||"";(n.showAnswer||g)&&typeof ee=="string"&&ee.trim()&&(m.appendChild(E("div","bc-hr")),m.appendChild(v("Answer")),m.appendChild(y("bc-a",ee)))}let x=oi(a);(n.showInfo||g)&&x&&(m.appendChild(E("div","bc-hr")),m.appendChild(v("Extra Information")),m.appendChild(y("bc-info",x))),m.appendChild(E("div","bc-hr"));let S=E("div","bc-row");if((a.type==="basic"||a.type==="cloze")&&!n.showAnswer){let B=n.makePlainButton("Reveal",()=>{n.setShowAnswer(!0),n.rerender()},"bc-btn blue-btn");n.appendKeyboxRight(B,"Enter"),S.appendChild(B)}m.appendChild(S);let N=E("div","bc-row");if(g){let B=n.makePlainButton("Next",()=>void n.nextCard(!0),"bc-btn blue-btn");n.appendKeyboxRight(B,"Enter"),N.appendChild(B)}else if((a.type==="basic"||a.type==="cloze")&&n.showAnswer){let B=n.makePlainButton("Again",()=>n.gradeCurrentRating("again",{}).then(()=>void n.nextCard(!0)),"bc-btn red-btn");if(n.appendKeyboxRight(B,"1"),N.appendChild(B),t){let F=n.makePlainButton("Hard",()=>n.gradeCurrentRating("hard",{}).then(()=>void n.nextCard(!0)),"bc-btn amber-btn");n.appendKeyboxRight(F,"2"),N.appendChild(F);let Q=n.makePlainButton("Good",()=>n.gradeCurrentRating("good",{}).then(()=>void n.nextCard(!0)),"bc-btn green-btn");n.appendKeyboxRight(Q,"3"),N.appendChild(Q);let ee=n.makePlainButton("Easy",()=>n.gradeCurrentRating("easy",{}).then(()=>void n.nextCard(!0)),"bc-btn blue-btn");n.appendKeyboxRight(ee,"4"),N.appendChild(ee)}else{let F=n.makePlainButton("Good",()=>n.gradeCurrentRating("good",{}).then(()=>void n.nextCard(!0)),"bc-btn green-btn");n.appendKeyboxRight(F,"2"),N.appendChild(F)}if(s){let F=n.makePlainButton("Skip",()=>n.skipCurrentCard({uiSource:"skip-btn",uiKey:13,uiButtons:t?4:2}),"bc-btn");F.dataset.bcAction="skip-card",F.title="Skip (Enter)",n.appendKeyboxRight(F,"Enter"),N.appendChild(F)}}else if(a.type==="mcq"){let B=(a.options||[]).length;N.appendChild(E("div","bc-muted",`Choose 1\u2013${B}.`))}m.appendChild(N),n.container.appendChild(o)}var bn=require("obsidian"),St=class extends bn.Modal{constructor(s,e,t){super(s),this.src=e,this.alt=t||"Image"}onOpen(){this.contentEl.empty(),this.containerEl.addClass("bc-img-zoom-container"),this.modalEl.addClass("bc-img-zoom-modal"),this.contentEl.addClass("bc-img-zoom-content");let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.width="100%",s.style.height="100%";let e=document.createElement("img");e.className="bc-img-zoom-full",e.src=this.src,e.alt=this.alt,e.style.maxWidth="92vw",e.style.maxHeight="86vh",e.style.width="auto",e.style.height="auto",e.style.objectFit="contain",s.appendChild(e),this.contentEl.appendChild(s)}onClose(){this.contentEl.empty()}};function wn(n,s,e){s&&new St(n,s,e||"Image").open()}var nt=require("obsidian"),tt=class{constructor(s){this._serial=0;var e;this.app=s.app,this.owner=s.owner,this.onZoom=s.onZoom,this.maxHeightPx=Number((e=s.maxHeightPx)!=null?e:200)}isImageExtension(s){switch(String(s||"").toLowerCase()){case"png":case"jpg":case"jpeg":case"gif":case"webp":case"svg":case"bmp":case"tif":case"tiff":case"avif":return!0;default:return!1}}resolveImageToResourceUrl(s,e){let t=String(s!=null?s:"").trim().split("|")[0].trim();if(!t)return null;let i=this.app.metadataCache.getFirstLinkpathDest(t,e);return!i||!(i instanceof nt.TFile)||!this.isImageExtension(i.extension)?null:this.app.vault.getResourcePath(i)}expandImagesToRealMarkdown(s,e){let t=String(s!=null?s:"");return t=t.replace(/!\[\[([^\]\r\n|]+)(?:\|[^\]\r\n]+)?\]\]/g,(i,r)=>{let o=this.resolveImageToResourceUrl(String(r!=null?r:""),e);return o?`

![](<${o}>)

`:i}),t=t.replace(/!\[([^\]\r\n]+?)\](?!\s*\()/g,(i,r)=>{let o=this.resolveImageToResourceUrl(String(r!=null?r:""),e);return o?`

![](<${o}>)

`:i}),t=t.replace(/\n{3,}/g,`

`),t}decorateRenderedImages(s){var t;let e=Array.from(s.querySelectorAll("img"));for(let i of e)if(((t=i.dataset)==null?void 0:t.bcZoomBound)!=="1"){i.dataset.bcZoomBound="1",i.classList.add("bc-zoomable"),i.style.display="block",i.style.margin="8px 0",i.style.maxWidth="100%",i.style.height="auto",i.style.width="auto",i.style.maxHeight=`${this.maxHeightPx}px`,i.style.objectFit="contain",i.style.cursor="zoom-in";try{i.loading="lazy"}catch(r){}i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();let o=i.currentSrc||i.src;o&&this.onZoom(o,i.alt||"Image")})}}async renderInto(s,e,t){var a;let i=String(++this._serial);s.dataset.bcMdRid=i,(a=s.empty)==null||a.call(s),s.classList.add("markdown-preview-view","markdown-rendered");let r=String(t||""),o=this.expandImagesToRealMarkdown(e!=null?e:"",r);await nt.MarkdownRenderer.renderMarkdown(o,s,r,this.owner),(s.dataset.bcMdRid||"")===i&&this.decorateRenderedImages(s)}};function vn(n){var t;let s={new:0,learning:0,review:0,relearning:0,suspended:0},e=n.store.getAllCards();for(let i of e){let r=n.store.getState(String(i.id)),o=(t=r==null?void 0:r.stage)!=null?t:"new";o==="new"?s.new+=1:o==="review"?s.review+=1:o==="relearning"?s.relearning+=1:o==="suspended"?s.suspended+=1:s.learning+=1}return s}var st=require("obsidian");function _t(n){var s;return!!((s=n.settings.reviewer)!=null&&s.enableSkipButton)}function Tt(n){let s=n;(!s.skipCounts||typeof s.skipCounts!="object")&&(s.skipCounts={})}function pi(n){let s=Math.max(0,Number(n)||0),e=Math.round(s*.2);return Math.max(8,Math.min(20,e))}var Et=class extends st.Modal{constructor(s,e,t){super(s),this._onBury=e,this._onIgnore=t}onOpen(){let{contentEl:s}=this;s.empty();let e=s.createDiv();e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="space-between",e.style.gap="10px",e.style.marginBottom="10px",e.createEl("h3",{text:"Bury for today?"});let t=document.createElement("button");t.type="button",t.className="clickable-icon",t.setAttribute("aria-label","Close"),t.title="Close (Esc)",(0,st.setIcon)(t,"x"),t.onclick=()=>this.ignore(),e.appendChild(t),s.createEl("p").setText("You have skipped this card multiple times in this session. Burying will postpone it until tomorrow. Skipping does not change scheduling unless you confirm bury.");let r=s.createDiv();r.style.display="flex",r.style.gap="8px",r.style.marginTop="12px";let o=r.createEl("button",{text:"Ignore"});o.onclick=()=>this.ignore();let a=r.createEl("button",{text:"Bury for today"});a.style.background="var(--background-modifier-error)",a.style.color="var(--text-on-accent)",a.onclick=()=>this.bury(),this.scope.register([],"b",()=>(this.bury(),!1)),this.scope.register([],"i",()=>(this.ignore(),!1)),this.scope.register([],"Escape",()=>(this.ignore(),!1)),s.addEventListener("keydown",l=>{let d=(l.key||"").toLowerCase();d==="b"?(l.preventDefault(),l.stopPropagation(),this.bury()):(d==="i"||d==="escape")&&(l.preventDefault(),l.stopPropagation(),this.ignore())})}bury(){try{this.close()}finally{this._onBury()}}ignore(){try{this.close()}finally{this._onIgnore()}}onClose(){this.contentEl.empty()}};async function Cn(n){if(n.mode!=="session"||!n.session)return;let s=n.currentCard();if(!s)return;let e=String(s.type||"");if(e!=="basic"&&e!=="cloze")return;let t=String(s.id||"");if(!t||n.session.graded[t])return;let i=Math.max(0,n.session.queue.length-n.session.index-1),r=pi(i),o=n.session;(!o.skipCounts||typeof o.skipCounts!="object")&&(o.skipCounts={});let a=o.skipCounts,l=(Number(a[t])||0)+1;if(a[t]=l,l>=3){new Et(n.app,()=>{n.buryCurrentCard()},()=>{}).open();return}let d=l===1?r:Math.min(40,r*2),f=n.session.queue,c=n.session.index,[h]=f.splice(c,1);if(!h)return;let u=Math.max(0,f.length-c)<d?f.length:Math.min(f.length,c+d);f.splice(u,0,h),n.clearTimer(),n.clearCountdown(),n.showAnswer=!1,n.render()}function Mt(n){var s;return!!((s=n.settings.reviewer)!=null&&s.randomizeMcqOptions)}function Nt(n){let s=n;(!s.mcqOrderMap||typeof s.mcqOrderMap!="object")&&(s.mcqOrderMap={})}function hi(n,s){if(!Array.isArray(n)||n.length!==s)return!1;let e=new Array(s).fill(!1);for(let t of n){if(!Number.isInteger(t)||t<0||t>=s||e[t])return!1;e[t]=!0}return!0}function fi(n){for(let s=n.length-1;s>0;s--){let e=Math.floor(Math.random()*(s+1)),t=n[s];n[s]=n[e],n[e]=t}}function xn(n,s,e){var c;let t=(e==null?void 0:e.options)||[],i=Array.isArray(t)?t.length:0,r=Array.from({length:i},(h,p)=>p);if((e==null?void 0:e.type)!=="mcq"||!Mt(n))return r;let o=String((c=e==null?void 0:e.id)!=null?c:"");if(!o)return r;let a=s;(!a.mcqOrderMap||typeof a.mcqOrderMap!="object")&&(a.mcqOrderMap={});let l=a.mcqOrderMap,d=l[o];if(hi(d,i))return d;let f=r.slice();if(fi(f),i>=2){let h=!0;for(let p=0;p<i;p++)if(f[p]!==p){h=!1;break}if(h){let p=f[0];f[0]=f[1],f[1]=p}}return l[o]=f,f}function mi(n){return n.toLowerCase()==="enter"?"\u23CE":n}function kt(n,s=""){let e=E("span",`bc-keywrap${s?" "+s:""}`),t=E("span","bc-keybox");return t.textContent=mi(n),e.appendChild(t),e}function Ae(n,s){let e=E("span","bc-btn-right");e.appendChild(kt(s)),n.appendChild(e)}function Ie(n,s,e="bc-btn"){let t=document.createElement("button");t.type="button",t.className=e,t.addEventListener("click",s);let i=E("span","bc-btn-left");return i.textContent=n,t.appendChild(i),t}function H(n){n._moreOpen=!1,n._moreMenuEl&&(n._moreMenuEl.style.display="none"),n._moreBtnEl&&n._moreBtnEl.setAttribute("aria-expanded","false")}function At(n,s){var t;let e=typeof s=="boolean"?s:!n._moreOpen;if(n._moreOpen=e,n._moreMenuEl&&(n._moreMenuEl.style.display=e?"block":"none"),n._moreBtnEl&&n._moreBtnEl.setAttribute("aria-expanded",e?"true":"false"),e&&n._moreMenuEl){let i=n._moreMenuEl.querySelector("button");(t=i==null?void 0:i.focus)==null||t.call(i)}}function Sn(n){var x,S,N,A;if(n.mode!=="session"||!n.session)return;let s=n.currentCard();if(!s)return;let e=String(s.id),t=!!n.session.graded[e],i=n.contentEl;i.querySelectorAll(['button[data-bc-action="bury-card"]','button[data-bc-action="suspend-card"]','button[data-bc-action="open-note"]','button[data-bc-action="edit-card"]','[data-bc-action="more-wrap"]','[data-bc-action="more-menu"]','button[data-bc-action="more-toggle"]'].join(",")).forEach(_=>_.remove());let r=(x=i.querySelector(".bc-flashcard"))!=null?x:i,o=Array.from(r.querySelectorAll(".bc-row"));if(!o.length)return;let a=(_,k)=>Array.from(_.querySelectorAll(".bc-btn-left")).some($=>($.textContent||"").trim().toLowerCase()===k.toLowerCase()),l=(_,k)=>k.some(R=>a(_,R)),d=["Again","Hard","Good","Easy"],f=(S=o.find(_=>l(_,d)))!=null?S:null,c=(N=o.find(_=>a(_,"Reveal")))!=null?N:null,h=(A=f!=null?f:c)!=null?A:o[o.length-1];if(!h)return;getComputedStyle(h).display!=="flex"&&(h.style.display="flex",h.style.alignItems="center"),n._moreWrap=null,n._moreMenuEl=null,n._moreBtnEl=null,n._moreOpen=!1;let u=E("span","bc-more-wrap");u.dataset.bcAction="more-wrap",u.style.position="relative",u.style.display="inline-flex",u.style.alignItems="center",u.style.marginLeft="auto",u.style.flex="0 0 auto";let m=Ie("More",()=>At(n),"bc-btn");m.dataset.bcAction="more-toggle",Ae(m,"M"),m.setAttribute("aria-haspopup","menu"),m.setAttribute("aria-expanded","false");let g=E("div","bc-more-menu");g.dataset.bcAction="more-menu",g.style.position="absolute",g.style.top="calc(100% + 6px)",g.style.right="0",g.style.zIndex="1000",g.style.display="none",g.style.minWidth="200px",g.style.padding="8px",g.style.border="1px solid var(--background-modifier-border)",g.style.borderRadius="10px",g.style.background="var(--background-primary)",g.style.boxShadow="0 10px 30px rgba(0,0,0,0.18)";let w=(_,k,R,$)=>{let P=Ie(_,()=>{H(n),R()},"bc-btn");return P.style.width="100%",P.style.display="flex",P.style.justifyContent="space-between",P.style.marginBottom="6px",P.disabled=!!$,Ae(P,k),P},b=w("Bury","B",()=>void n.buryCurrentCard(),t);b.dataset.bcAction="bury-card";let C=w("Suspend","S",()=>void n.suspendCurrentCard(),t);C.dataset.bcAction="suspend-card";let y=w("Open Note","O",()=>void n.openCurrentCardInNote());y.dataset.bcAction="open-note";let v=w("Edit","E",()=>n.openEditModalForCurrentCard());v.dataset.bcAction="edit-card",v.style.marginBottom="0",g.appendChild(b),g.appendChild(C),g.appendChild(y),g.appendChild(v),g.addEventListener("mousedown",_=>_.stopPropagation()),u.appendChild(m),u.appendChild(g),h.appendChild(u);for(let _ of o){let k=_.querySelector("button")!=null,R=(_.textContent||"").trim().length>0;!k&&!R&&_.remove()}n._moreWrap=u,n._moreMenuEl=g,n._moreBtnEl=m}function It(n){switch(Number(n)){case 0:return"New";case 1:return"Learning";case 2:return"Review";case 3:return"Relearning";default:return String(n)}}function Rt(n){return String(n!=null?n:"").trim().toLowerCase()}function gi(n){let s=Number(n);if(!Number.isFinite(s)||s<=0)return"\u2014";try{return new Date(s).toLocaleString()}catch(e){return"\u2014"}}function Dt(n){var z,ue,re,ve;let{id:s,cardType:e}=n,t=n.metrics,i=(z=n.nextDue)!=null?z:0,r=(ue=n.meta)!=null?ue:{},o=Rt(e),a=Rt(n.rating),l=Rt(r==null?void 0:r.action),d=a==="skip"||l==="skip"||l.startsWith("skip"),f=Number((ve=(re=r==null?void 0:r.uiButtons)!=null?re:r==null?void 0:r.gradingButtons)!=null?ve:NaN),c=Number.isFinite(f)&&(f===2||f===4)?f:a==="hard"||a==="easy"?4:0,h=Number.isFinite(Number(r==null?void 0:r.uiKey))?Number(r==null?void 0:r.uiKey):0,p=typeof(r==null?void 0:r.uiSource)=="string"?String(r.uiSource):"",u=typeof(r==null?void 0:r.via)=="string"?String(r.via):"",m=!!(r!=null&&r.auto);if(!(d||o==="mcq"||a==="again"||a==="good"||a==="hard"||a==="easy"))return;let w=gi(i),b=o==="mcq"?` | mcqChoice=${r==null?void 0:r.mcqChoice} | mcqCorrect=${r==null?void 0:r.mcqCorrect} | mcqPass=${r==null?void 0:r.mcqPass}`:"",C=typeof(t==null?void 0:t.retrievabilityNow)=="number"?t.retrievabilityNow:null,y=typeof(t==null?void 0:t.retrievabilityTarget)=="number"?t.retrievabilityTarget:null,v=Number.isFinite(t==null?void 0:t.elapsedDays)?Number(t.elapsedDays):0,x=Number.isFinite(t==null?void 0:t.stabilityDays)?Number(t.stabilityDays):0,S=Number.isFinite(t==null?void 0:t.difficulty)?Number(t.difficulty):0,N=t==null?void 0:t.stateBefore,A=t==null?void 0:t.stateAfter,_=C===null?"\u2014":C.toFixed(4),k=y===null?"\u2014":y.toFixed(4),R=d||N===void 0&&A===void 0?"":N===A||N===void 0?`state=${It(A)}`:`state=${It(N)}\u2192${It(A)}`,$=d||C===null?"":` | t=${v}d`,P=(()=>{let K=[];return(c===2||c===4)&&K.push(`ui=${c}btn`),h>0&&K.push(`key=${h}`),p&&K.push(`src=${p}`),u&&K.push(`via=${u}`),m&&K.push("auto=1"),d&&K.push("skip=1"),Number.isFinite(Number(r==null?void 0:r.done))&&Number.isFinite(Number(r==null?void 0:r.total))&&K.push(`q=${Number(r.done)}/${Number(r.total)}`),typeof(r==null?void 0:r.skipMode)=="string"&&r.skipMode.trim()&&K.push(`skipMode=${String(r.skipMode).trim()}`),K.length?` | ${K.join(" ")}`:""})(),Y=d?`${I} SKIP:`:`${I} FSRS:`;console.log(`${Y} card ${s} | type=${o||"unknown"} | rating=${String(n.rating)}${P} | ${R}${$} | R_now=${_} | R_target=${k} | S=${x.toFixed(2)}d | D=${S.toFixed(2)} | nextDue=${w}${b}`+(d?" | note=scheduling_unchanged":""))}function En(n){var c;let{rootEl:s,session:e,card:t,renderMarkdownInto:i}=n;if(!e||!t)return;let r=s.querySelector(".bc-question-title");if(!r)return;let o=t.title||(t.type==="mcq"?"MCQ":t.type==="cloze"?"Cloze":"Basic"),a=String(o!=null?o:""),l=/!\[\[[^\]]+\]\]/.test(a),d=/!\[[^\]]+\](?!\s*\()/.test(a);if(!l&&!d)return;let f=String(t.sourceNotePath||((c=e==null?void 0:e.scope)==null?void 0:c.name)||"");i(r,a,f)}function it(n){var s,e;return!!((e=(s=n.settings)==null?void 0:s.reviewer)!=null&&e.fourButtonMode)}var Re=class extends U.ItemView{constructor(e,t){super(e);this.mode="deck";this.expanded=new Set([""]);this.session=null;this.showAnswer=!1;this._timer=null;this._keysBound=!1;this._countdownInterval=null;this._moreOpen=!1;this._moreWrap=null;this._moreMenuEl=null;this._moreBtnEl=null;this._moreOutsideBound=!1;this._isWideReviewer=!1;this._collapsedMaxWidth=null;this._widthToggleActionEl=null;this._imgMaxHeightPx=200;this._md=null;this.plugin=t}getViewType(){return pe}getDisplayText(){return"Study Session (Boot Camp)"}getIcon(){return"brain"}_wideReviewerLabel(){return this._isWideReviewer?"Collapse content":"Expand content"}_wideReviewerIcon(){return this._isWideReviewer?"minimize-2":"maximize-2"}_applyReviewerWidthMode(){let e=this.contentEl;if(!e)return;this._collapsedMaxWidth==null&&(this._collapsedMaxWidth=window.getComputedStyle(e).maxWidth||""),this._isWideReviewer?(e.style.maxWidth="none",e.style.width="100%"):(e.style.width="",e.style.maxWidth="");let t=this._widthToggleActionEl;if(t){let i=this._wideReviewerLabel();t.setAttribute("aria-label",i),t.setAttribute("title",i),t.querySelectorAll(".svg-icon, svg").forEach(r=>r.remove()),(0,U.setIcon)(t,this._wideReviewerIcon())}}isPracticeSession(){return!!(this.session&&this.session.practice)}normPath(e){return String(e!=null?e:"").replace(/\\/g,"/").replace(/^\.\//,"")}matchesScope(e,t){let i=this.normPath(t);if(e.type==="vault")return!0;if(e.type==="note")return i===this.normPath(e.key);if(e.type==="folder"){let r=this.normPath(e.key).replace(/\/+$/,"");return r?i.startsWith(r+"/"):!0}return!0}buildPracticeQueue(e,t){var l,d,f;let i=Date.now(),r=((l=this.plugin.store.data)==null?void 0:l.cards)||{},o=Object.values(r),a=[];for(let c of o){let h=String((d=c==null?void 0:c.id)!=null?d:"");if(!h||t!=null&&t.has(h))continue;let p=this.plugin.store.getState(h);if(!p||String(p.stage||"")==="suspended")continue;let u=Number((f=p.due)!=null?f:0);if(!Number.isFinite(u)||u<=i)continue;let m=String(c.sourceNotePath||c.sourcePath||c.location||"");m&&this.matchesScope(e,m)&&a.push(c)}return a.sort((c,h)=>{var m,g,w,b;let p=Number((g=(m=this.plugin.store.getState(String(c.id)))==null?void 0:m.due)!=null?g:Number.POSITIVE_INFINITY),u=Number((b=(w=this.plugin.store.getState(String(h.id)))==null?void 0:w.due)!=null?b:Number.POSITIVE_INFINITY);return p!==u?p-u:String(c.id).localeCompare(String(h.id))}),a}canStartPractice(e){if(!this.session||this.isPracticeSession()||this.currentCard())return!1;let i=new Set(Object.keys(this.session.graded||{}));return this.buildPracticeQueue(e,i).length>0||this.buildPracticeQueue(e).length>0}startPracticeFromCurrentScope(){if(!this.session||this.isPracticeSession())return;let e=this.session.scope,t=new Set(Object.keys(this.session.graded||{})),i=this.buildPracticeQueue(e,t);if(i.length||(i=this.buildPracticeQueue(e)),!i.length){new U.Notice(`${I}: no cards available for practice in this scope.`);return}this.clearTimer(),this.clearCountdown(),H(this);let r={scope:e,queue:i,index:0,graded:{},stats:{total:i.length,done:0}};r.practice=!0,this.mode="session",this.session=r,Nt(this.session),Tt(this.session),this.showAnswer=!1,this.render()}skipPracticeCard(){var a;if(!this.session)return;let e=this.currentCard();if(!e)return;let t=String((a=e.id)!=null?a:"");if(!t||this.session.graded[t])return;let i=this.session.queue,r=this.session.index;if(r<0||r>=i.length)return;if(i.length<=1){this.showAnswer=!1,this.render();return}let[o]=i.splice(r,1);i.push(o),this.showAnswer=!1,this.render()}doSkipCurrentCard(e){var r,o,a,l,d,f,c,h;if(!this.session)return;let t=this.currentCard();if(!t)return;let i=String((r=t.id)!=null?r:"");if(i&&!this.session.graded[i]){try{let p=e&&typeof e=="object"&&!Array.isArray(e)?e:{};Dt({id:i,cardType:String((o=t.type)!=null?o:"unknown"),rating:"skip",meta:{action:"skip",via:this.isPracticeSession()?"practice":"review",done:Number((d=(l=(a=this.session)==null?void 0:a.stats)==null?void 0:l.done)!=null?d:0),total:Number((h=(c=(f=this.session)==null?void 0:f.stats)==null?void 0:c.total)!=null?h:0),...p}})}catch(p){console.warn("Boot Camp: failed to log skip",p)}if(this.isPracticeSession()){this.skipPracticeCard();return}Cn(this)}}stripBurySuspendFromMoreMenuIfPractice(){var o,a;if(!this.isPracticeSession())return;let e=this.contentEl,i=e.querySelector('[data-bc-action="more-menu"]')||e.querySelector(".bc-more-menu")||null||e,r=Array.from(i.querySelectorAll("button"));for(let l of r){let f=(((a=(o=l.querySelector(".bc-btn-left"))==null?void 0:o.textContent)==null?void 0:a.trim())||l.textContent||"").trim().toLowerCase();(f==="bury"||f==="suspend")&&l.remove()}}ensureMarkdownHelper(){this._md||(this._md=new tt({app:this.app,owner:this,maxHeightPx:this._imgMaxHeightPx,onZoom:(e,t)=>wn(this.app,e,t)}))}async onOpen(){this.containerEl.tabIndex=0,this.ensureMarkdownHelper();let e=()=>this.containerEl.focus();this.containerEl.addEventListener("mousedown",e),this.containerEl.addEventListener("click",e),queueMicrotask(()=>e()),this._keysBound||(this._keysBound=!0,this.registerDomEvent(this.containerEl,"keydown",t=>this.handleKey(t)),this.registerDomEvent(window,"keydown",t=>this.handleKey(t),{capture:!0})),this._moreOutsideBound||(this._moreOutsideBound=!0,this.registerDomEvent(document,"mousedown",t=>{if(!this._moreOpen||!this.isActiveLeaf())return;let i=t.target;i&&(this._moreWrap&&this._moreWrap.contains(i)||H(this))},{capture:!0})),this.render()}async onClose(){this.clearTimer(),this.clearCountdown(),H(this)}onRefresh(){this.render()}clearTimer(){this._timer&&(window.clearTimeout(this._timer),this._timer=null)}clearCountdown(){this._countdownInterval&&(window.clearInterval(this._countdownInterval),this._countdownInterval=null)}startCountdown(e,t){this.clearCountdown();let i=()=>{let r=e-Date.now();t.textContent=`Next card due in: ${hn(r)}`};i(),this._countdownInterval=window.setInterval(i,1e3)}armTimer(){if(this.clearTimer(),this.mode!=="session"||!this.plugin.settings.reviewer.autoAdvanceEnabled)return;let e=Number(this.plugin.settings.reviewer.autoAdvanceSeconds);!Number.isFinite(e)||e<=0||(this._timer=window.setTimeout(()=>{this._timer=null,this.onAutoAdvance()},e*1e3))}onAutoAdvance(){if(this.mode!=="session"||!this.session)return;let e=this.currentCard();if(!e)return;this.session.graded[String(e.id)]?this.nextCard(!1):this.gradeCurrentRating("again",{auto:!0}).then(()=>void this.nextCard(!1))}buildSession(e){return un(this.plugin,e)}getNextDueInScope(e){return pn(this.plugin,e)}currentCard(){return this.session&&this.session.queue[this.session.index]||null}async openCurrentCardInNote(){let e=this.currentCard();if(!e)return;let t=String(e.id||""),i=String(e.sourceNotePath||"");if(!t||!i)return;let r=this.app.vault.getAbstractFileByPath(i);if(!(r instanceof U.TFile))return;let o=this.app.workspace.getLeaf(!0);await o.setViewState({type:"markdown",state:{file:r.path,mode:"source"},active:!0},{focus:!0});let a=o.view;if(!(a instanceof U.MarkdownView))return;let d=await(async()=>{for(let u=0;u<30;u++){let m=a.editor;if(m)return m;await new Promise(g=>setTimeout(g,25))}return null})();if(!d)return;let f=`^bc-${t}`,h=(await this.app.vault.read(r)).split(/\r?\n/),p=h.findIndex(u=>u.includes(f));if(!(p<0)){if(h[p].trim()===f){let u=p+1;for(;u<h.length&&h[u].trim()==="";)u++;u<h.length&&(p=u)}d.setCursor({line:p,ch:0}),d.scrollIntoView({from:{line:p,ch:0},to:{line:p,ch:0}},!0),d.focus()}}openEditModalForCurrentCard(){let e=this.currentCard();e&&new we(this.app,e,async t=>{var i;try{if(await Je(this.plugin,e,t),this.session){let r=String(e.id),o=(((i=this.plugin.store.data)==null?void 0:i.cards)||{})[r];o&&(this.session.queue[this.session.index]=o)}this.render()}catch(r){console.error(r),new U.Notice(`${I}: edit failed (${String((r==null?void 0:r.message)||r)})`)}}).open()}async renderMarkdownInto(e,t,i){this.ensureMarkdownHelper(),this._md&&await this._md.renderInto(e,t!=null?t:"",i!=null?i:"")}async gradeCurrentRating(e,t){let i=this.currentCard();if(!i||!this.session)return;let r=String(i.id);if(this.session.graded[r])return;if(this.isPracticeSession()){let h=Date.now();this.session.graded[r]={rating:e,at:h,meta:t||null},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!0;return}let o=Date.now(),a=this.plugin.store.getState(r);if(!a)return;let{nextState:l,prevDue:d,nextDue:f,metrics:c}=Ze(a,e,o,this.plugin.settings);this.plugin.store.upsertState(l),this.plugin.store.appendReviewLog({id:r,at:o,result:e,prevDue:d,nextDue:f,meta:t||null}),await this.plugin.store.persist(),this.session.graded[r]={rating:e,at:o,meta:t||null},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!0,Dt({id:r,cardType:String(i.type||"unknown"),rating:e,metrics:c,nextDue:f,meta:t||null})}async buryCurrentCard(){if(this.mode!=="session"||!this.session||this.isPracticeSession())return;let e=this.currentCard();if(!e)return;let t=String(e.id);if(this.session.graded[t])return;let i=this.plugin.store.getState(t);if(!i)return;let r=Date.now(),o={...i,due:r+24*60*60*1e3};this.plugin.store.upsertState(o),await this.plugin.store.persist(),this.session.graded[t]={rating:"again",at:r,meta:{action:"bury"}},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!1,this.nextCard(!0)}async suspendCurrentCard(){if(this.mode!=="session"||!this.session||this.isPracticeSession())return;let e=this.currentCard();if(!e)return;let t=String(e.id);if(this.session.graded[t])return;let i=this.plugin.store.getState(t);if(!i)return;let r=Date.now(),o={...i,stage:"suspended",due:r+3650*24*60*60*1e3};this.plugin.store.upsertState(o),await this.plugin.store.persist(),this.session.graded[t]={rating:"again",at:r,meta:{action:"suspend"}},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!1,this.nextCard(!0)}async answerMcq(e){let t=this.currentCard();if(!t||t.type!=="mcq"||!this.session)return;let i=String(t.id);if(this.session.graded[i])return;let r=e===t.correctIndex,o=it(this.plugin),a=r?o?"easy":"good":"again";if(!this.plugin.store.getState(i)&&!this.isPracticeSession()){console.warn(`${I} MCQ: missing state for id=${i}; cannot grade/FSRS`);return}await this.gradeCurrentRating(a,{mcqChoice:e,mcqCorrect:t.correctIndex,mcqPass:r}),this.render()}async nextCard(e){if(!this.session)return;let t=this.currentCard();if(t){let i=String(t.id);this.session.graded[i]||await this.gradeCurrentRating("again",{auto:!0,via:"next"})}if(this.session.index<this.session.queue.length-1){this.session.index+=1;let i=this.currentCard();this.showAnswer=!!(i&&this.session.graded[String(i.id)]),this.render();return}this.session.index=this.session.queue.length,this.showAnswer=!0,this.render()}prevCard(){if(!this.session||this.session.index<=0)return;this.session.index-=1;let e=this.currentCard();this.showAnswer=!!(e&&this.session.graded[String(e.id)]),this.render()}openSession(e){this.clearTimer(),this.clearCountdown(),H(this),this.mode="session",this.session=this.buildSession(e),this.session&&(Nt(this.session),Tt(this.session),this.session.practice=!1),this.showAnswer=!1,this.render()}backToDecks(){this.clearTimer(),this.clearCountdown(),H(this),this.mode="deck",this.session=null,this.showAnswer=!1,this.render()}isActiveLeaf(){var i,r,o,a,l;let e=this.app.workspace,t=(l=(a=(r=e==null?void 0:e.activeLeaf)!=null?r:(i=e==null?void 0:e.getMostRecentLeaf)==null?void 0:i.call(e))!=null?a:(o=e==null?void 0:e.getLeaf)==null?void 0:o.call(e,!1))!=null?l:null;return!!t&&t===this.leaf}handleKey(e){if(!this.isActiveLeaf())return;let t=e.target;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.tagName==="SELECT"||t.isContentEditable)||this.mode!=="session"||!this.session)return;if(e.key==="Escape"&&this._moreOpen){e.preventDefault(),e.stopPropagation(),H(this);return}let i=e.key==="Enter"||e.code==="Enter"||e.code==="NumpadEnter",r=this.currentCard();if(!r){if(i){if(e.preventDefault(),e.stopPropagation(),H(this),this.isPracticeSession()){this.backToDecks();return}if(this.canStartPractice(this.session.scope)){this.startPracticeFromCurrentScope();return}}return}let o=String(r.id),a=this.session.graded[o]||null,l=(e.key||"").toLowerCase();if(l==="m"){e.preventDefault(),e.stopPropagation(),At(this);return}if(l==="o"){e.preventDefault(),e.stopPropagation(),H(this),this.openCurrentCardInNote();return}if(l==="e"){e.preventDefault(),e.stopPropagation(),H(this),this.openEditModalForCurrentCard();return}if(!a&&!this.isPracticeSession()&&(l==="b"||l==="s")){e.preventDefault(),e.stopPropagation(),H(this),l==="b"?this.buryCurrentCard():this.suspendCurrentCard();return}if(e.key==="ArrowLeft"){if(e.preventDefault(),e.stopPropagation(),H(this),(r.type==="basic"||r.type==="cloze")&&this.showAnswer){this.showAnswer=!1,this.render();return}this.prevCard();return}if(i&&a){e.preventDefault(),e.stopPropagation(),H(this),this.nextCard(!0);return}if(r.type==="mcq"){if(/^[1-9]$/.test(e.key)){e.preventDefault(),e.stopPropagation(),H(this);let f=Number(e.key)-1,c=r.options||[];if(f<0||f>=c.length)return;let p=xn(this.plugin,this.session,r)[f];Number.isInteger(p)&&p>=0&&p<c.length&&this.answerMcq(p)}return}if(r.type==="basic"||r.type==="cloze"){if(i&&!a){if(e.preventDefault(),e.stopPropagation(),H(this),!this.showAnswer){this.showAnswer=!0,this.render();return}if(this.showAnswer&&_t(this.plugin)){this.doSkipCurrentCard({uiSource:"kbd-enter",uiKey:13,uiButtons:it(this.plugin)?4:2});return}return}let f=it(this.plugin);if(f?e.key==="1"||e.key==="2"||e.key==="3"||e.key==="4":e.key==="1"||e.key==="2"){if(e.preventDefault(),e.stopPropagation(),H(this),!this.showAnswer){this.showAnswer=!0,this.render();return}if(!a){let h;f?e.key==="1"?h="again":e.key==="2"?h="hard":e.key==="3"?h="good":h="easy":h=e.key==="1"?"again":"good",this.gradeCurrentRating(h,{}).then(()=>void this.nextCard(!0));return}this.nextCard(!0);return}return}}async resyncActiveFile(){let e=this.plugin._getActiveMarkdownFile();if(!e)return;let t=await le(this.plugin,e);new U.Notice(`${I}: ${t.newCount} new; ${t.updatedCount} updated; ${t.sameCount} unchanged; ${t.idsInserted} IDs inserted.`),t.quarantinedCount>0&&new me(this.plugin.app,this.plugin,t.quarantinedIds).open(),this.plugin._refreshOpenViews()}renderHeaderActions(){var o;let e=(o=this.containerEl.querySelector(":scope > .view-header .view-actions"))!=null?o:this.containerEl.querySelector(".view-header .view-actions");e&&e.replaceChildren();let t=this.addAction("more-vertical","More options",()=>{new U.Notice(`${I}: options clicked`)}),i=this.addAction("refresh-cw","Sync Flashcards",()=>{let a=this.plugin;typeof a._runSync=="function"?a._runSync():typeof a.syncBank=="function"?a.syncBank():this.resyncActiveFile()}),r=this.addAction(this._wideReviewerIcon(),this._wideReviewerLabel(),()=>{this._isWideReviewer=!this._isWideReviewer,this._applyReviewerWidthMode()});r.dataset.bcAction="toggle-reviewer-width",this._widthToggleActionEl=r,e&&(window.getComputedStyle(e).flexDirection==="row-reverse"?e.replaceChildren(t,i,r):e.replaceChildren(r,i,t)),this._applyReviewerWidthMode()}extractInfoField(e){var o,a,l,d,f,c;if(!e)return null;let t=h=>{if(typeof h=="string"&&h.trim())return h.trim();if(Array.isArray(h)){let p=h.filter(u=>typeof u=="string").join(`
`).trim();return p||null}return null},i=(l=(a=(o=t(e.info))!=null?o:t(e.information))!=null?a:t(e.i))!=null?l:t(e.I);if(i)return i;let r=e.fields;if(r&&typeof r=="object"){let h=(c=(f=(d=t(r.info))!=null?d:t(r.information))!=null?f:t(r.i))!=null?c:t(r.I);if(h)return h}return null}hasInfoField(e){return!!this.extractInfoField(e)}render(){var d,f,c,h,p,u,m,g,w;let e=this.contentEl;e.empty(),this._moreOpen=!1,this._moreWrap=null,this._moreMenuEl=null,this._moreBtnEl=null,e.classList.add("bc-content-view"),this.containerEl.addClass("bc-root","bc-reviewer-root"),(d=this.setTitle)==null||d.call(this,"Study Session (Boot Camp)"),this.renderHeaderActions();let t=this.mode==="deck"?`${I} \u2013 Deck Browser`:`${I} \u2013 Study Mode`;if(this.mode==="session"&&this.session){let b=E("div","bc-title-row");b.style.display="flex",b.style.justifyContent="space-between",b.style.alignItems="baseline",b.style.gap="12px";let C=E("div","bc-title",t);b.appendChild(C);let y=Number((h=(c=(f=this.session)==null?void 0:f.stats)==null?void 0:c.total)!=null?h:0),v=Number((u=(p=this.session)==null?void 0:p.index)!=null?u:0),x=Number((w=(g=(m=this.session)==null?void 0:m.stats)==null?void 0:g.done)!=null?w:0),S="";if(y>0){let A=Math.min(v+1,y);S=v>=y?`${Math.min(x,y)}/${y}`:`${A}/${y}`}let N=E("div","bc-muted",S);N.style.whiteSpace="nowrap",b.appendChild(N),e.appendChild(b)}else e.appendChild(E("div","bc-title",t));if(this.mode==="deck"){this.clearTimer(),this.clearCountdown(),H(this);let b=vn(this.plugin),C=E("div","bc-subtitle");C.addClass("bc-count-strip");let y=(v,x,S)=>{let N=E("span",`count-pill ${S}`),A=E("span","count-pill-label",`${v}`),_=E("span","count-pill-value",String(x));return N.appendChild(A),N.appendChild(_),N};C.appendChild(y("New",b.new,"count-pill-new")),C.appendChild(y("Relearning",b.relearning,"count-pill-relearning")),C.appendChild(y("Learning",b.learning,"count-pill-learning")),C.appendChild(y("Review",b.review,"count-pill-review")),e.appendChild(C),mn({app:this.app,plugin:this.plugin,container:e,expanded:this.expanded,setExpanded:v=>this.expanded=v,openSession:v=>this.openSession(v),resyncActiveFile:()=>this.resyncActiveFile(),rerender:()=>this.render()});return}if(!this.session)return;let i=this.currentCard(),r=this.hasInfoField(i),o=!!this.plugin.settings.reviewer.showInfoByDefault||this.showAnswer&&r,a=this.isPracticeSession(),l=!a&&!i&&this.canStartPractice(this.session.scope);yn({container:e,session:this.session,showAnswer:this.showAnswer,setShowAnswer:b=>this.showAnswer=b,currentCard:()=>this.currentCard(),backToDecks:()=>this.backToDecks(),nextCard:b=>this.nextCard(b),gradeCurrentRating:(b,C)=>this.gradeCurrentRating(b,C),answerMcq:b=>this.answerMcq(b),enableSkipButton:_t(this.plugin),skipCurrentCard:b=>this.doSkipCurrentCard(b),practiceMode:a,canStartPractice:l,startPractice:()=>this.startPracticeFromCurrentScope(),showInfo:o,clearTimer:()=>this.clearTimer(),clearCountdown:()=>this.clearCountdown(),getNextDueInScope:b=>this.getNextDueInScope(b),startCountdown:(b,C)=>this.startCountdown(b,C),renderClozeFront:(b,C)=>et(b,C),renderMarkdownInto:(b,C,y)=>this.renderMarkdownInto(b,C,y),keybox:kt,makePlainButton:Ie,appendKeyboxRight:Ae,randomizeMcqOptions:Mt(this.plugin),fourButtonMode:it(this.plugin),rerender:()=>this.render()}),queueMicrotask(()=>En({rootEl:this.contentEl,session:this.session,card:this.currentCard(),renderMarkdownInto:(b,C,y)=>this.renderMarkdownInto(b,C,y)})),queueMicrotask(()=>{Sn(this),this.stripBurySuspendFromMoreMenuIfPractice()}),this.armTimer()}};var _n=require("obsidian");var De=class extends _n.ItemView{constructor(e,t){super(e);this.activeFile=null;this.mode="summary";this.session=null;this.showAnswer=!1;this._timer=null;this._keysBound=!1;this.plugin=t}getViewType(){return G}getDisplayText(){return"Flashcard Widget (Boot Camp)"}getIcon(){return"footprints"}async onOpen(){this.activeFile=this.app.workspace.getActiveFile(),this.containerEl.tabIndex=0,this.containerEl.addEventListener("mousedown",()=>this.containerEl.focus()),this._keysBound||(this._keysBound=!0,this.containerEl.addEventListener("keydown",e=>this.handleKey(e))),this.render()}onRefresh(){this.render()}onFileOpen(e){this.activeFile=e||null,this.mode==="session"&&(this.mode="summary",this.session=null,this.showAnswer=!1),this.render()}clearTimer(){this._timer&&(window.clearTimeout(this._timer),this._timer=null)}armTimer(){if(this.clearTimer(),this.mode!=="session"||!this.session||!this.plugin.settings.reviewer.autoAdvanceEnabled)return;let e=Number(this.plugin.settings.reviewer.autoAdvanceSeconds);!Number.isFinite(e)||e<=0||(this._timer=window.setTimeout(async()=>{this._timer=null,await this.nextCard()},e*1e3))}folderNotesAsDecksEnabled(){var t,i;return((i=(t=this.plugin.settings)==null?void 0:t.widget)==null?void 0:i.treatFolderNotesAsDecks)!==!1}getFolderNoteInfo(e){var o;let t=(o=e.parent)!=null?o:null,i=t&&typeof t.name=="string"?t.name:null,r=t&&typeof t.path=="string"?t.path:null;return!i||!r||e.basename!==i||!r||r==="/"?null:{folderPath:r,folderName:i}}isFolderNote(e){return e?this.getFolderNoteInfo(e)!==null:!1}getCardsInActiveNoteOnly(){let e=this.activeFile;return e?this.plugin.store.getAllCards().filter(t=>t.sourceNotePath===e.path):[]}getCardsInActiveScope(){let e=this.activeFile;if(!e)return[];let t=this.getFolderNoteInfo(e),i=this.plugin.store.getAllCards();if(!t)return i.filter(o=>o.sourceNotePath===e.path);if(!this.folderNotesAsDecksEnabled())return i.filter(o=>o.sourceNotePath===e.path);let r=t.folderPath.endsWith("/")?t.folderPath:t.folderPath+"/";return i.filter(o=>typeof o.sourceNotePath=="string"&&o.sourceNotePath.startsWith(r))}computeCounts(e){let t=Date.now(),i=this.plugin.store.data.states||{},r=e.length,o=0,a=0,l=0;for(let d of e){let f=i[d.id];f&&(f.stage==="new"?o++:f.stage==="learning"&&f.due<=t?a++:f.stage==="review"&&f.due<=t&&l++)}return{total:r,new:o,learn:a,due:l}}buildSessionForActiveNote(){var m,g;let e=this.activeFile;if(!e)return null;let t=Date.now(),i=this.getCardsInActiveScope(),r=this.plugin.store.data.states||{},o=i.filter(w=>r[w.id]&&r[w.id].stage==="learning"&&r[w.id].due<=t),a=i.filter(w=>r[w.id]&&r[w.id].stage==="review"&&r[w.id].due<=t),l=i.filter(w=>r[w.id]&&r[w.id].stage==="new"),d=(m=this.plugin.settings.reviewer.dailyReviewLimit)!=null?m:200,f=(g=this.plugin.settings.reviewer.dailyNewLimit)!=null?g:20,c=o.sort((w,b)=>r[w.id].due-r[b.id].due||String(w.id).localeCompare(String(b.id))).slice(0,d),h=a.sort((w,b)=>r[w.id].due-r[b.id].due||String(w.id).localeCompare(String(b.id))).slice(0,d),p=l.sort((w,b)=>String(w.id).localeCompare(String(b.id))).slice(0,f),u=c.concat(h).concat(p);return{scopeName:e.basename,queue:u,index:0,graded:{},stats:{total:u.length,done:0}}}currentCard(){return this.session&&this.session.queue[this.session.index]||null}async gradeCurrentRating(e,t){let i=this.currentCard();if(!i||!this.session)return;let r=String(i.id);if(this.session.graded[r])return;let o=Date.now(),a=this.plugin.store.getState(r);if(!a)return;let{nextState:l,prevDue:d,nextDue:f}=Ze(a,e,o,this.plugin.settings);this.plugin.store.upsertState(l),this.plugin.store.appendReviewLog({id:r,at:o,result:e,prevDue:d,nextDue:f,meta:t||null}),await this.plugin.store.persist(),this.session.graded[r]={rating:e,at:o,meta:t||null},this.session.stats.done=Object.keys(this.session.graded).length,this.showAnswer=!0}async answerMcq(e){let t=this.currentCard();if(!t||t.type!=="mcq"||!this.session)return;let i=String(t.id);if(this.session.graded[i])return;let r=e===t.correctIndex;await this.gradeCurrentRating(r?"good":"again",{mcqChoice:e,mcqCorrect:t.correctIndex}),this.render()}async nextCard(){if(!this.session)return;let e=this.currentCard();if(e){let t=String(e.id);this.session.graded[t]||await this.gradeCurrentRating("again",{auto:!0,via:"next"})}if(this.session.index<this.session.queue.length-1){this.session.index+=1;let t=this.currentCard();this.showAnswer=!!(t&&this.session.graded[String(t.id)]),this.render();return}this.session.index=this.session.queue.length,this.showAnswer=!0,this.render()}startSession(){this.clearTimer(),this.session=this.buildSessionForActiveNote(),this.mode="session",this.showAnswer=!1,this.render()}backToSummary(){this.clearTimer(),this.mode="summary",this.session=null,this.showAnswer=!1,this.render()}handleKey(e){let t=e.target;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.tagName==="SELECT"||t.isContentEditable)||this.mode!=="session"||!this.session)return;let i=this.currentCard();if(!i)return;let r=this.session.graded[String(i.id)]||null;if(e.key===" "||e.code==="Space"||e.key==="Enter"||e.key==="ArrowRight"){if(e.preventDefault(),i.type==="basic"||i.type==="cloze"){if(!this.showAnswer){this.showAnswer=!0,this.render();return}this.nextCard();return}this.nextCard();return}if(e.key==="1"||e.key==="2"){if(e.preventDefault(),i.type==="basic"||i.type==="cloze"){if(!this.showAnswer){this.showAnswer=!0,this.render();return}if(!r){let a=e.key==="1"?"again":"easy";this.gradeCurrentRating(a,{}).then(()=>void this.nextCard());return}this.nextCard();return}this.nextCard()}}makeKeyedBtn(e,t,i,r){let o=document.createElement("button");o.type="button",o.className=t;let a=document.createElement("span");a.style.display="inline-flex",a.style.alignItems="center",a.style.gap="8px";let l=document.createElement("span");if(l.className="bc-btn-left",l.textContent=e,a.appendChild(l),i){let d=document.createElement("span");d.className="bc-btn-right";let f=document.createElement("span");f.className="bc-keywrap";let c=document.createElement("span");c.className="bc-keybox",c.textContent=i,f.appendChild(c),d.appendChild(f),a.appendChild(d)}return o.appendChild(a),o.addEventListener("click",r),o}renderSummary(e){let t=E("div","bc-card");t.classList.add("bc-widget");let i=this.activeFile,r=i?i.basename:"No note open",o=E("div","bc-back");o.classList.add("bc-widget-top");let a=E("button","bc-note-title",r);a.type="button",a.title=r,a.addEventListener("click",async()=>{if(!i)return;let p=this.plugin.app.vault.getAbstractFileByPath(i.path);p&&await this.plugin.app.workspace.getLeaf(!1).openFile(p)}),o.appendChild(a);let l=E("button","bc-back-btn","Open Reviewer");if(l.type="button",l.addEventListener("click",()=>this.plugin.openReviewerTab()),o.appendChild(l),t.appendChild(o),t.appendChild(E("div","bc-hr")),!i){t.appendChild(E("div","bc-muted","Open a note to see flashcards.")),e.appendChild(t);return}let d=this.getCardsInActiveScope(),f=this.computeCounts(d);if(t.appendChild(E("div","bc-muted bc-widget-countline",`Total: ${f.total} \u2022 New: ${f.new} \u2022 Learn: ${f.learn} \u2022 Due: ${f.due}`)),!d.length){t.appendChild(E("div","bc-hr"));let p=this.isFolderNote(i),u=this.folderNotesAsDecksEnabled();p?u?t.appendChild(E("div","bc-muted","No flashcards found in this note or folder.")):t.appendChild(E("div","bc-muted","No flashcards found in this note. If you would like to search this folder, enable \u201CTreat folder notes as decks\u201D in the settings.")):t.appendChild(E("div","bc-muted","No flashcards found in this note.")),e.appendChild(t);return}t.appendChild(E("div","bc-hr"));let c=E("div","bc-row"),h=this.makeKeyedBtn("Study","bc-btn blue-btn","\u23CE",()=>this.startSession());c.appendChild(h),t.appendChild(c),e.appendChild(t)}renderSession(e){var h,p,u,m,g,w,b;let t=E("div","bc-card");t.classList.add("bc-widget");let i=E("div","bc-back"),r=document.createElement("button");r.className="bc-back-btn",r.type="button",r.title="Back",r.textContent="Back",r.addEventListener("click",()=>this.backToSummary()),i.appendChild(r),i.appendChild(E("div","bc-muted",((h=this.session)==null?void 0:h.scopeName)||"Note")),t.appendChild(i),t.appendChild(E("div","bc-hr"));let o=this.currentCard();if(!o){t.appendChild(E("div","bc-title","Session complete")),t.appendChild(E("div","bc-muted",`Done: ${((u=(p=this.session)==null?void 0:p.stats)==null?void 0:u.done)||0}/${((g=(m=this.session)==null?void 0:m.stats)==null?void 0:g.total)||0}`)),e.appendChild(t),this.clearTimer();return}let a=String(o.id),l=((w=this.session)==null?void 0:w.graded[a])||null,d=o.title||(o.type==="mcq"?"MCQ":o.type==="cloze"?"Cloze":"Basic");if(t.appendChild(E("div","bc-title",d)),t.appendChild(E("div","bc-muted",`ID ${a} \u2022 ${this.session.index+1}/${this.session.stats.total}`)),t.appendChild(E("div","bc-hr")),o.type==="basic")t.appendChild(E("div","",o.q||"")),(this.showAnswer||l)&&(t.appendChild(E("div","bc-hr")),t.appendChild(E("div","",o.a||"")));else if(o.type==="cloze"){let C=o.clozeText||"",y=this.showAnswer||!!l;t.appendChild(et(C,y))}else if(o.type==="mcq"){t.appendChild(E("div","",o.stem||""));let C=o.options||[],y=(b=l==null?void 0:l.meta)==null?void 0:b.mcqChoice;C.forEach((v,x)=>{let S=E("div","bc-option",v);l||S.addEventListener("click",()=>this.answerMcq(x)),l&&(x===o.correctIndex&&S.classList.add("correct"),typeof y=="number"&&y===x&&y!==o.correctIndex&&S.classList.add("wrong")),t.appendChild(S)})}let f=E("div","bc-row");(o.type==="basic"||o.type==="cloze")&&!this.showAnswer&&f.appendChild(this.makeKeyedBtn("Reveal","bc-btn blue-btn","\u23CE",()=>{this.showAnswer=!0,this.render()})),t.appendChild(f);let c=E("div","bc-row");l?c.appendChild(this.makeKeyedBtn("Next","bc-btn blue-btn","\u23CE",async()=>{await this.nextCard()})):(o.type==="basic"||o.type==="cloze")&&this.showAnswer?(c.appendChild(this.makeKeyedBtn("Again","bc-btn red-btn","1",async()=>{await this.gradeCurrentRating("again",{}),this.render()})),c.appendChild(this.makeKeyedBtn("Easy","bc-btn green-btn","2",async()=>{await this.gradeCurrentRating("easy",{}),this.render()}))):o.type==="mcq"&&c.appendChild(E("div","bc-muted","Select an option.")),t.appendChild(c),e.appendChild(t),this.armTimer()}render(){let e=this.containerEl;e.empty(),e.addClass("bc-root"),this.mode==="session"?this.renderSession(e):this.renderSummary(e)}onunload(){this.clearTimer()}};var V=require("obsidian");function yi(n){return!n||!Number.isFinite(n)?"\u2014":new Date(n).toLocaleString(void 0,{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function bi(n){let s=(n||"").trim();return s?s.replace(/\.md$/i,"").split("/").filter(Boolean).join(" / "):"\u2014"}function wi(){let n=new Date;return n.setHours(0,0,0,0),n.getTime()}function vi(){let n=new Date;return n.setHours(23,59,59,999),n.getTime()}function Ci(n){var e;return[n.id,n.type,n.title||"",n.q||"",n.a||"",n.stem||"",(n.options||[]).join(" "),String((e=n.correctIndex)!=null?e:""),n.clozeText||"",n.info||"",n.sourceNotePath||""].join(`
`).toLowerCase()}function kn(n){return(n||"").replace(/\\/g,"\\\\").replace(/\|/g,"\\|")}function xi(n){let s=[],e="",t=!1;for(let i=0;i<n.length;i++){let r=n[i];if(t){e+=r,t=!1;continue}if(r==="\\"){t=!0;continue}if(r==="|"){s.push(e),e="";continue}e+=r}return s.push(e),s}function Si(n){let s=(n||"").replace(/\r?\n/g," ").trim();if(!s)throw new Error("MCQ options cannot be empty.");let e=s.includes("|")?xi(s).map(r=>r.trim()).filter(Boolean):s.split(",").map(r=>r.trim()).filter(Boolean);if(e.length<2)throw new Error("MCQ requires at least 2 options (separate with |).");let t=-1,i=e.map((r,o)=>{let a=r.match(/^\*\*(.+)\*\*$/);if(a){if(t!==-1)throw new Error("MCQ has more than one bold (correct) option.");return t=o,a[1].trim()}return r});if(t===-1)throw new Error("MCQ requires exactly one correct option wrapped in ** **.");return{options:i,correctIndex:t}}function Ei(n){let s=(n||"").trim();if(!s)throw new Error("Cloze question (CQ) is required.");if(!/\{\{c\d+::.*?\}\}/.test(s))throw new Error("Cloze must include at least one {{cN::...}} token.")}function Tn(n){return n.type==="basic"?n.q||"":n.type==="mcq"?n.stem||"":n.clozeText||""}function Mn(n){if(n.type==="basic")return n.a||"";if(n.type==="mcq"){let s=Array.isArray(n.options)?n.options:[],e=Number.isFinite(n.correctIndex)?n.correctIndex:-1;return s.map((i,r)=>{let o=kn((i||"").trim());return r===e?`**${o}**`:o}).join(" | ")}return""}var _i="There is no answer field for Cloze deletion cards. See the question field to adjust hidden fields.",Ti=/^<!--ID:(\d{9})-->$/,Mi=/^\^bc-(\d{9})$/;function rt(n){let s=(n||"").trim();return Ti.test(s)||Mi.test(s)}function Ni(n,s){let e=`^bc-${s}`,t=`<!--ID:${s}-->`,i=n.findIndex(l=>(l||"").trim()===e);if(i===-1&&(i=n.findIndex(l=>(l||"").trim()===t),i===-1))throw new Error(`Could not locate card ${s} in note.`);let r=i;for(;r>0;){let l=(n[r-1]||"").trim();if(rt(l)){r--;continue}if(l===""&&r-2>=0&&rt(n[r-2]||"")){r--;continue}break}i=r;let o=!1,a=n.length;for(let l=i;l<n.length;l++){let d=(n[l]||"").trim();if(!o){if(d===""||rt(d))continue;o=!0;continue}if(rt(d)){a=l;break}}return{start:i,end:a}}function ki(n,s){let e=[];e.push(`^bc-${n}`);let t=(s.title||"").trim();if(t){let r=t.split(/\r?\n/);e.push(`T: ${r[0]}`);for(let o=1;o<r.length;o++)e.push(r[o])}if(s.type==="basic")e.push(`Q: ${(s.q||"").trim()}`),e.push(`A: ${(s.a||"").trim()}`);else if(s.type==="cloze")e.push(`CQ: ${(s.clozeText||"").trim()}`);else if(s.type==="mcq"){e.push(`MCQ: ${(s.stem||"").trim()}`);let r=Array.isArray(s.options)?s.options:[],o=Number.isFinite(s.correctIndex)?s.correctIndex:-1,a=r.map((l,d)=>{let f=kn((l||"").trim());return d===o?`**${f}**`:f});e.push(`O: ${a.join(" | ")}`)}let i=(s.info||"").trim();if(i){let r=i.split(/\r?\n/);e.push(`I: ${r[0]}`);for(let o=1;o<r.length;o++)e.push(r[o])}return e.push(""),e}function Nn(n){return n==="basic"?"Basic":n==="mcq"?"MCQ":n==="cloze"?"Cloze":n}function Lt(n){return n==="new"?"New":n==="learning"?"Learning":n==="relearning"?"Relearning":n==="review"?"Review":n==="suspended"?"Suspended":n}var Le=class extends V.ItemView{constructor(e,t){super(e);this.query="";this.typeFilter="all";this.stageFilter="all";this.dueFilter="all";this.sortKey="due";this.sortAsc=!0;this.colWidths={id:120,type:90,stage:100,due:90,title:150,question:200,answer:200,info:250,location:150};this._colMin={id:120,type:90,stage:100,due:90,title:100,question:100,answer:100,info:150,location:100};this._colMax={id:500,type:500,stage:500,due:500,title:500,question:500,answer:500,info:500,location:500};this._tableBody=null;this._headerEls={};this._colEls={};this._colCount=9;this._saving=new Set;this._suppressHeaderClickUntil=0;this._summaryEl=null;this._unsuspending=new Set;this._isWideTable=!1;this._collapsedMaxWidth=null;this._rootEl=null;this._widthToggleActionEl=null;this.plugin=t}getViewType(){return he}getDisplayText(){return"Flashcard Browser (Boot Camp)"}getIcon(){return"table-2"}async onOpen(){this.render()}onRefresh(){this.render()}_wideLabel(){return this._isWideTable?"Collapse table":"Expand table"}_wideIcon(){return this._isWideTable?"minimize-2":"maximize-2"}_applyWidthMode(){let e=this._rootEl;if(!e)return;if(this._collapsedMaxWidth==null){let i=window.getComputedStyle(e).maxWidth||"";this._collapsedMaxWidth=i}if(this._isWideTable)e.style.maxWidth="none",e.style.width="100%";else{e.style.width="",e.style.maxWidth="";let i=(this._collapsedMaxWidth||"").trim();i&&i!=="none"&&(e.style.maxWidth=i)}let t=this._widthToggleActionEl;if(t){let i=this._wideLabel();t.setAttribute("aria-label",i),t.setAttribute("title",i),t.classList.toggle("is-active",this._isWideTable),t.querySelectorAll(".svg-icon, svg").forEach(r=>r.remove()),(0,V.setIcon)(t,this._wideIcon())}}getStateFor(e){return this.plugin.store.getState(e)}async unsuspendById(e){if(this._unsuspending.has(e))return;let t=this.plugin.store.getState(e);if(!(!t||t.stage!=="suspended")){this._unsuspending.add(e);try{let i=Date.now(),r=en(t,i);this.plugin.store.upsertState(r),await this.plugin.store.persist(),new V.Notice("Unsuspended card"),this.refreshTable()}catch(i){new V.Notice(`${I}: ${(i==null?void 0:i.message)||String(i)}`)}finally{this._unsuspending.delete(e)}}}computeRows(){let e=this.plugin.store.getAllCards(),t=(this.query||"").trim().toLowerCase(),i=Date.now(),r=wi(),o=vi(),a=e.map(f=>{var u;let c=this.getStateFor(String(f.id)),p=String((c==null?void 0:c.stage)||"new")==="suspended"?null:(u=c==null?void 0:c.due)!=null?u:null;return{card:f,state:c,dueMs:p}});this.typeFilter!=="all"&&(a=a.filter(f=>f.card.type===this.typeFilter)),this.stageFilter!=="all"&&(a=a.filter(f=>{var c;return(((c=f.state)==null?void 0:c.stage)||"new")===this.stageFilter})),this.dueFilter!=="all"&&(a=a.filter(f=>{let c=f.dueMs;return c==null||!Number.isFinite(c)?this.dueFilter==="later":this.dueFilter==="due"?c<=i:this.dueFilter==="today"?c>=r&&c<=o:c>o})),t&&(a=a.filter(f=>Ci(f.card).includes(t)));let l=this.sortAsc?1:-1,d=this.sortKey;return a.sort((f,c)=>{let h=this.sortValueFor(f.card,f.state,f.dueMs,d),p=this.sortValueFor(c.card,c.state,c.dueMs,d);return typeof h=="number"&&typeof p=="number"?(h-p)*l:String(h).localeCompare(String(p))*l}),a}sortValueFor(e,t,i,r){return r==="due"?i!=null?i:Number.POSITIVE_INFINITY:r==="id"?e.id:r==="type"?Nn(e.type):r==="stage"?Lt(String((t==null?void 0:t.stage)||"new")):r==="location"?e.sourceNotePath||"":r==="title"?(e.title||"").split(/\r?\n/)[0]||"":r==="question"?Tn(e):r==="answer"?e.type==="cloze"?"":Mn(e):r==="info"&&e.info||""}_refreshHeaderSortStyles(){for(let e of Object.keys(this._headerEls)){let t=this._headerEls[e];t&&(e===this.sortKey?t.classList.add("is-sorted"):t.classList.remove("is-sorted"))}}toggleSort(e){this.sortKey===e?this.sortAsc=!this.sortAsc:(this.sortKey=e,this.sortAsc=!0),this._refreshHeaderSortStyles(),this.refreshTable()}applyValueToCard(e,t,i){let r=JSON.parse(JSON.stringify(e)),o=i!=null?i:"";if(t==="title")return r.title=o,r;if(t==="question")return r.type==="basic"?r.q=o:r.type==="mcq"?r.stem=o:r.type==="cloze"&&(r.clozeText=o),r;if(t==="answer"){if(r.type==="basic")return r.a=o,r;if(r.type==="mcq"){let a=Si(o);return r.options=a.options,r.correctIndex=a.correctIndex,r}return r}return t==="info"&&(r.info=o),r}async openSource(e){let t=`${e.sourceNotePath}#^bc-${e.id}`;this.app.workspace.openLinkText(t,e.sourceNotePath,!0)}async writeCardToMarkdown(e){var f,c,h,p;let t=this.app.vault.getAbstractFileByPath(e.sourceNotePath);if(!(t instanceof V.TFile))throw new Error(`Source note not found: ${e.sourceNotePath}`);if(e.type==="basic"){if(!(e.q||"").trim())throw new Error("Q: is required.");if(!(e.a||"").trim())throw new Error("A: is required.")}else if(e.type==="cloze")Ei(e.clozeText||"");else if(e.type==="mcq"){if(!(e.stem||"").trim())throw new Error("MCQ: is required.");let u=Array.isArray(e.options)?e.options.map(m=>(m||"").trim()).filter(Boolean):[];if(u.length<2)throw new Error("MCQ requires at least 2 options.");if(!(Number.isFinite(e.correctIndex)&&e.correctIndex>=0&&e.correctIndex<u.length))throw new Error("MCQ requires exactly one correct option.");e.options=u}let r=(await this.app.vault.read(t)).split(/\r?\n/),{start:o,end:a}=Ni(r,e.id),l=ki(e.id,e);r.splice(o,a-o,...l),await this.app.vault.modify(t,r.join(`
`));let d=await le(this.plugin,t);d.quarantinedCount>0?new V.Notice(`Saved changes to flashcards (but ${d.quarantinedCount} card(s) quarantined).`):new V.Notice("Saved changes to flashcards"),(c=(f=this.plugin)._refreshOpenViews)==null||c.call(f),(p=(h=this.plugin).refreshAllViews)==null||p.call(h)}makeResizableTh(e,t){e.style.position="relative";let i=14;e.style.paddingRight=`${i}px`;let r=document.createElement("div");r.className="bc-col-resize",r.title="Drag to resize",r.style.position="absolute",r.style.top="0",r.style.right="0",r.style.height="100%",r.style.width=`${i}px`,r.style.cursor="col-resize",r.style.userSelect="none",r.style.touchAction="none",e.appendChild(r);let o=a=>{var m,g;a.preventDefault(),a.stopPropagation();let l=a.clientX,d=this.colWidths[t]||120,f=(m=this._colMin[t])!=null?m:70,c=(g=this._colMax[t])!=null?g:500,h=!1;this._suppressHeaderClickUntil=Date.now()+400;let p=w=>{let b=w.clientX-l;!h&&Math.abs(b)>1&&(h=!0);let C=Math.min(c,Math.max(f,d+b));this.colWidths[t]=C;let y=this._colEls[t];y&&(y.style.width=`${C}px`)},u=()=>{document.removeEventListener("mousemove",p,!0),document.removeEventListener("mouseup",u,!0),this._suppressHeaderClickUntil=Date.now()+(h?500:250)};document.addEventListener("mousemove",p,!0),document.addEventListener("mouseup",u,!0)};r.addEventListener("mousedown",o),r.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation()})}refreshTable(){let e=this._tableBody;if(!e)return;let t=this.computeRows(),i=document.createElement("tbody");if(t.length===0){let r=document.createElement("tr");r.className="bc-tr";let o=document.createElement("td");o.className="bc-td bc-muted-cell",o.colSpan=this._colCount,o.style.textAlign="center",o.style.padding="14px 10px",o.textContent="No cards match your filters.",r.appendChild(o),i.appendChild(r),e.replaceWith(i),this._tableBody=i,this._summaryEl&&(this._summaryEl.textContent="0 card(s) shown");return}for(let{card:r,state:o,dueMs:a}of t){let l=document.createElement("tr");l.className="bc-tr";let d=(g,w)=>{let b=document.createElement("td");return b.className="bc-td bc-muted-cell",b.textContent=g,w&&(b.title=w),b},f=document.createElement("td");f.className="bc-td bc-muted-cell";let c=document.createElement("button");c.type="button",c.className="bc-id-pill count-pill count-pill-new",c.title=`Open card ^bc-${r.id}`,c.setAttribute("aria-label",`Open card ${r.id}`);let h=document.createElement("span");h.className="count-pill-value",h.textContent=r.id;let p=document.createElement("span");p.className="bc-id-pill-icon",p.setAttribute("aria-hidden","true"),(0,V.setIcon)(p,"link"),c.appendChild(h),c.appendChild(p),c.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),this.openSource(r)}),f.appendChild(c),l.appendChild(f),l.appendChild(d(Nn(r.type)));let u=String((o==null?void 0:o.stage)||"new");if(u==="suspended"){let g=document.createElement("td");g.className="bc-td bc-muted-cell",g.style.whiteSpace="normal";let w=document.createElement("div");w.textContent=Lt(u),g.appendChild(w);let b=document.createElement("button");b.type="button",b.className="bc-btn bc-unsuspend-btn",b.textContent="Unsuspend",b.title="Move card back to New (due now)",b.style.marginTop="6px",b.style.padding="2px 8px",b.style.fontSize="11px",b.disabled=this._unsuspending.has(r.id),b.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation(),this.unsuspendById(r.id)}),g.appendChild(b),l.appendChild(g)}else l.appendChild(d(Lt(u)));if(u==="suspended"){let g=d("Card currently suspended, no due data.");g.style.whiteSpace="normal",g.style.lineHeight="1.2",l.appendChild(g)}else l.appendChild(d(yi(a)));let m=g=>{if(g==="answer"&&r.type==="cloze")return d(_i);let w=document.createElement("td");w.className="bc-td bc-td-editor",w.style.position="relative";let b=g==="title"?r.title||"":g==="question"?Tn(r):g==="answer"?Mn(r):g==="info"&&r.info||"",C=document.createElement("textarea");C.className="bc-cell-input bc-cell-input-always",C.value=b;let y=`${r.id}:${g}`,v=b;return C.addEventListener("focus",()=>{v=C.value}),C.addEventListener("keydown",x=>{x.key==="Escape"&&(x.preventDefault(),x.stopPropagation(),C.value=v)}),C.addEventListener("blur",async()=>{let x=C.value;if(x!==v&&!this._saving.has(y)){this._saving.add(y);try{let S=this.applyValueToCard(r,g,x);await this.writeCardToMarkdown(S),v=x}catch(S){new V.Notice(`${I}: ${(S==null?void 0:S.message)||String(S)}`),C.value=v}finally{this._saving.delete(y)}}}),w.appendChild(C),w};l.appendChild(m("title")),l.appendChild(m("question")),l.appendChild(m("answer")),l.appendChild(m("info")),l.appendChild(d(bi(r.sourceNotePath),r.sourceNotePath)),i.appendChild(l)}e.replaceWith(i),this._tableBody=i,this._summaryEl&&(this._summaryEl.textContent=`${t.length} card(s) shown`)}render(){var y,v;let e=this.contentEl;e.empty(),this._rootEl=e,e.classList.add("bc-view-content"),this.containerEl.addClass("bc-root","bc-browser-root"),(y=this.setTitle)==null||y.call(this,"Flashcard Browser (Boot Camp)");let t=(v=this.containerEl.querySelector(":scope > .view-header .view-actions"))!=null?v:this.containerEl.querySelector(".view-header .view-actions");t&&(t.querySelectorAll('[data-bc-action="sync-flashcards"]').forEach(x=>x.remove()),t.querySelectorAll('[data-bc-action="toggle-browser-width"]').forEach(x=>x.remove()));let i=this.addAction(this._wideIcon(),this._wideLabel(),()=>{this._isWideTable=!this._isWideTable,this._applyWidthMode()});i.dataset.bcAction="toggle-browser-width",this._widthToggleActionEl=i;let r=this.addAction("refresh-cw","Sync flashcards",()=>{let x=this.plugin;typeof x._runSync=="function"?x._runSync():typeof x.syncBank=="function"?x.syncBank():new V.Notice("Sync not available (no sync method found).")});if(r.dataset.bcAction="sync-flashcards",t){let x=t.querySelector('button[aria-label="More options"]');x&&(window.getComputedStyle(t).flexDirection==="row-reverse"?(x.insertAdjacentElement("afterend",i),x.insertAdjacentElement("afterend",r)):(t.insertBefore(i,x),t.insertBefore(r,x)))}this._applyWidthMode();let o=document.createElement("div");o.className="bc-title",o.textContent=`${I} \u2013 Flashcard Browser`,e.appendChild(o);let a=document.createElement("div");a.style.display="flex",a.style.flexWrap="wrap",a.style.gap="8px",a.style.margin="10px 0",e.appendChild(a);let l=document.createElement("input");l.type="text",l.placeholder="Search\u2026",l.value=this.query,l.style.flex="1",l.addEventListener("input",()=>{this.query=l.value,this.refreshTable()}),a.appendChild(l);let d=(x,S,N)=>{let A=document.createElement("select");A.value=x;for(let _ of S){let k=document.createElement("option");k.value=_.v,k.textContent=_.label,A.appendChild(k)}return A.onchange=()=>N(A.value),A};a.appendChild(d(this.typeFilter,[{v:"all",label:"All types"},{v:"basic",label:"Basic"},{v:"mcq",label:"MCQ"},{v:"cloze",label:"Cloze"}],x=>{this.typeFilter=x,this.refreshTable()})),a.appendChild(d(this.stageFilter,[{v:"all",label:"All stages"},{v:"new",label:"New"},{v:"learning",label:"Learning"},{v:"relearning",label:"Relearning"},{v:"review",label:"Review"},{v:"suspended",label:"Suspended"}],x=>{this.stageFilter=x,this.refreshTable()})),a.appendChild(d(this.dueFilter,[{v:"all",label:"All due"},{v:"due",label:"Due now"},{v:"today",label:"Due today"},{v:"later",label:"Later"}],x=>{this.dueFilter=x,this.refreshTable()}));let f=document.createElement("button");f.className="bc-btn",f.type="button",f.textContent="Sync bank",f.onclick=()=>{let x=this.plugin;typeof x._runSync=="function"?x._runSync():typeof x.syncBank=="function"?x.syncBank():new V.Notice("Sync not available (no sync method found).")},a.appendChild(f);let c=document.createElement("div");c.className="bc-muted",e.appendChild(c),this._summaryEl=c;let h=document.createElement("div");h.className="bc-table-wrap",h.style.flex="1",h.style.minHeight="0",h.style.overflow="auto",h.style.position="relative",e.appendChild(h);let p=document.createElement("table");p.className="bc-browser-table",h.appendChild(p);let u=document.createElement("colgroup");p.appendChild(u),this._colEls={};let m=["id","type","stage","due","title","question","answer","info","location"];this._colCount=m.length,m.forEach(x=>{let S=document.createElement("col");S.setAttribute("data-col",x),S.style.width=`${this.colWidths[x]||120}px`,u.appendChild(S),this._colEls[x]=S});let g=document.createElement("thead");g.style.position="sticky",g.style.top="0",g.style.zIndex="3",g.style.background="var(--background-primary)",p.appendChild(g);let w=document.createElement("tr");g.appendChild(w),this._headerEls={};let b=(x,S)=>{let N=document.createElement("th");return N.className="bc-th bc-sortable",N.textContent=x,N.style.position="sticky",N.style.top="0",N.style.zIndex="4",N.style.background="var(--background-primary)",this._headerEls[S]=N,this.sortKey===S&&N.classList.add("is-sorted"),N.addEventListener("click",A=>{var k;if(Date.now()<this._suppressHeaderClickUntil){A.preventDefault(),A.stopPropagation();return}let _=A.target;if((k=_==null?void 0:_.closest)!=null&&k.call(_,".bc-col-resize")){A.preventDefault(),A.stopPropagation();return}this.toggleSort(S)}),this.makeResizableTh(N,S),N};w.appendChild(b("Unique ID","id")),w.appendChild(b("Type","type")),w.appendChild(b("Stage","stage")),w.appendChild(b("Due","due")),w.appendChild(b("Title","title")),w.appendChild(b("Question","question")),w.appendChild(b("Answer / Options","answer")),w.appendChild(b("Extra Information","info")),w.appendChild(b("Location","location"));let C=document.createElement("tbody");p.appendChild(C),this._tableBody=C,this._refreshHeaderSortStyles(),this.refreshTable()}};var L=require("obsidian");var Ai=/^\^bc-(\d{9})\s*$/,Ii=/^(Q|MCQ|CQ)\s*(?::|\|)\s*.*$/,Ri=/^(T|A|I)\s*(?::|\|)\s*.*$|^O:\s*.*$|^(C|K)\s*:\s*.*$|^(C|K)\s*\|\s*.*$/,Pt=class extends L.Modal{constructor(s,e){super(s),this.plugin=e}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:"Reset scheduling for all cards?"}),s.createEl("p",{text:"This resets all cards to New and clears scheduling fields. This cannot be undone."});let e=s.createDiv();e.style.display="flex",e.style.gap="8px",e.style.marginTop="12px";let t=e.createEl("button",{text:"Cancel"});t.onclick=()=>this.close();let i=e.createEl("button",{text:"Reset scheduling"});i.onclick=async()=>{this.close();try{let r=this.plugin.resetAllCardScheduling;if(typeof r!="function"){new L.Notice("Boot Camp: resetAllCardScheduling() not found on plugin. Implement it in main.ts.");return}await r.call(this.plugin),new L.Notice(`Boot Camp \u2013 Settings Updated
Scheduling reset for all cards`)}catch(r){console.error(r),new L.Notice("Boot Camp: failed to reset scheduling (see console).")}}}onClose(){this.contentEl.empty()}},Ft=class extends L.Modal{constructor(s,e,t){super(s),this.plugin=e,this.onConfirm=t}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:"Delete ALL Boot Camp flashcards in this vault?"}),s.createEl("p").setText(["This will permanently delete Boot Camp flashcards from your notes and database.","","It removes all Q/MCQ/CQ blocks (and their T/A/O/I lines), removes all ^bc-######### anchors, and clears Boot Camp data.","","This cannot be undone."].join(`
`));let t=s.createDiv();t.style.display="flex",t.style.gap="8px",t.style.marginTop="12px";let i=t.createEl("button",{text:"Cancel"});i.onclick=()=>this.close();let r=t.createEl("button",{text:"Delete all flashcards"});r.style.background="var(--background-modifier-error)",r.style.color="var(--text-on-accent)",r.onclick=async()=>{this.close();try{await this.onConfirm()}catch(o){console.error(o),new L.Notice("Boot Camp: failed to delete flashcards (see console).")}}}onClose(){this.contentEl.empty()}},Bt=class extends L.Modal{constructor(s,e){super(s),this.onConfirm=e}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h3",{text:"Reset Boot Camp settings to defaults?"}),s.createEl("p",{text:"This resets Boot Camp settings back to their defaults. It does not delete cards or change scheduling. This cannot be undone."});let e=s.createDiv();e.style.display="flex",e.style.gap="8px",e.style.marginTop="12px";let t=e.createEl("button",{text:"Cancel"});t.onclick=()=>this.close();let i=e.createEl("button",{text:"Reset settings"});i.style.background="var(--background-modifier-error)",i.style.color="var(--text-on-accent)",i.onclick=async()=>{this.close();try{await this.onConfirm()}catch(r){console.error(r),new L.Notice("Boot Camp: failed to reset settings (see console).")}}}onClose(){this.contentEl.empty()}};function An(n){return n.split(",").map(s=>Number(s.trim())).filter(s=>Number.isFinite(s)&&s>0)}function Di(n,s,e){return Math.max(s,Math.min(e,n))}function In(n,s){let e=Number(n);return Number.isFinite(e)?Math.max(0,Math.floor(e)):s}function ie(n){if(typeof n=="boolean")return n?"On":"Off";if(typeof n=="number")return Number.isFinite(n)?String(n):"\u2014";if(typeof n=="string")return n;if(Array.isArray(n))return n.map(s=>String(s)).join(",");if(n==null)return"\u2014";try{return JSON.stringify(n)}catch(s){return String(n)}}function ot(n){return Ai.test(n.trim())}function Rn(n){return Ii.test(n.trim())}function Pn(n){return Ri.test(n.trim())}function Dn(n,s){for(let t=1;t<=8&&s+t<n.length;t++){let i=n[s+t].trim();if(i)return!!(ot(i)||Pn(i))}return!1}function Ln(n){let s=globalThis==null?void 0:globalThis.structuredClone;return typeof s=="function"?s(n):JSON.parse(JSON.stringify(n))}var Pe=class extends L.PluginSettingTab{constructor(e,t){super(e,t);this._noticeTimers=new Map;this.plugin=t}queueSettingsNotice(e,t,i=200){let r=this._noticeTimers.get(e);r&&window.clearTimeout(r);let o=window.setTimeout(()=>{this._noticeTimers.delete(e),new L.Notice(`Boot Camp \u2013 Settings Updated
${t}`)},Math.max(0,i));this._noticeTimers.set(e,o)}refreshAllWidgetViews(){let e=this.app.workspace.getLeavesOfType(G);for(let t of e){let i=t.view;try{typeof(i==null?void 0:i.resetToSummaryAndRender)=="function"?i.resetToSummaryAndRender():typeof(i==null?void 0:i.onRefresh)=="function"?i.onRefresh():typeof(i==null?void 0:i.render)=="function"&&i.render()}catch(r){console.error("Boot Camp: failed to refresh widget view",r)}}}refreshReviewerViewsIfPossible(){let e=this.plugin;try{typeof(e==null?void 0:e._refreshOpenViews)=="function"&&e._refreshOpenViews()}catch(t){console.warn("Boot Camp: failed to refresh open views",t)}}async deleteAllBootCampDataFromVault(){let e=this.app.vault.getMarkdownFiles(),t=0,i=0,r=0,o=0;for(let a of e){let d=(await this.app.vault.read(a)).split(/\r?\n/),f=[],c=!1;for(let h=0;h<d.length;h++){let p=d[h],u=p.trim();if(ot(u)){i++,o++,c=!0;continue}if(Rn(u)&&Dn(d,h)){r++,o++,c=!0;let m=h+1;for(;m<d.length;m++){let g=d[m].trim();if(Rn(g)&&Dn(d,m))break;if(!g||ot(g)||Pn(g)){ot(g)&&i++,o++;continue}break}h=m-1;continue}f.push(p)}c&&(t++,await this.app.vault.modify(a,f.join(`
`)))}return{filesTouched:t,anchorsRemoved:i,cardsRemoved:r,linesRemoved:o}}async clearBootCampStore(){var t,i,r,o,a;let e=(i=(t=this.plugin)==null?void 0:t.store)==null?void 0:i.data;!e||typeof e!="object"||(e.cards={},e.states={},e.reviewLog=[],e.quarantine={},e.version=Math.max(Number(e.version)||0,5),typeof((o=(r=this.plugin)==null?void 0:r.store)==null?void 0:o.persist)=="function"?await this.plugin.store.persist():typeof((a=this.plugin)==null?void 0:a.saveAll)=="function"&&await this.plugin.saveAll())}async resetSettingsToDefaults(){let e=this.plugin,t=["resetSettingsToDefaults","resetToDefaultSettings","resetDefaultSettings","loadDefaultSettings"];for(let o of t){let a=e==null?void 0:e[o];if(typeof a=="function"){await a.call(this.plugin);return}}let r=[e==null?void 0:e.DEFAULT_SETTINGS,e==null?void 0:e.DEFAULT_BOOTCAMP_SETTINGS,e==null?void 0:e.defaultSettings,e==null?void 0:e.defaults].find(o=>o&&typeof o=="object");if(!r)throw new Error("No reset function found and no DEFAULT_SETTINGS-like object available on plugin.");this.plugin.settings=Ln(r),typeof(e==null?void 0:e.saveAll)=="function"?await e.saveAll():typeof(e==null?void 0:e.saveSettings)=="function"&&await e.saveSettings()}renderQuarantineList(e){var r,o,a;let t=((a=(o=(r=this.plugin)==null?void 0:r.store)==null?void 0:o.data)==null?void 0:a.quarantine)||{},i=Object.keys(t);if(!i.length){e.createDiv({cls:"setting-item"}).createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-description",text:"No quarantined cards."});return}i.sort((l,d)=>l.localeCompare(d)).slice(0,200).forEach(l=>{let d=t[l],f=e.createDiv({cls:"setting-item"}),c=f.createDiv({cls:"setting-item-info"});c.createDiv({cls:"setting-item-name",text:`ID ${l}`}),c.createDiv({cls:"setting-item-description",text:(d==null?void 0:d.reason)||"Parse error"});let p=f.createDiv({cls:"setting-item-control"}).createEl("button",{text:"Open note"});p.onclick=async()=>{let u=d==null?void 0:d.notePath;if(!u)return;let m=`^bc-${l}`;try{this.app.workspace.openLinkText(`${u}#${m}`,u,!1);return}catch(w){}let g=this.app.vault.getAbstractFileByPath(u);g instanceof L.TFile&&await this.app.workspace.getLeaf(!1).openFile(g)}})}display(){let{containerEl:e}=this;e.empty(),e.addClass("bc-settings"),e.createEl("h2",{text:"Boot Camp"}),e.createEl("h3",{text:"General"}),new L.Setting(e).setName("Reset settings").setDesc("Resets Boot Camp settings back to their defaults. Does not delete cards or change scheduling.").addButton(h=>h.setButtonText("Reset\u2026").onClick(()=>{new Bt(this.app,async()=>{let p=Ln(this.plugin.settings);try{await this.resetSettingsToDefaults(),this.refreshReviewerViewsIfPossible(),this.refreshAllWidgetViews(),this.display(),this.queueSettingsNotice("settings.resetDefaults","Settings reset to defaults",0)}catch(u){this.plugin.settings=p,console.error(u),new L.Notice("Boot Camp: could not reset settings to defaults. Implement resetSettingsToDefaults() or expose DEFAULT_SETTINGS on the plugin (see console).")}}).open()})),e.createEl("h3",{text:"Study"}),new L.Setting(e).setName("Daily new limit").setDesc("Maximum new cards introduced per day (per deck). 0 disables new cards.").addText(h=>h.setValue(String(this.plugin.settings.reviewer.dailyNewLimit)).onChange(async p=>{let u=this.plugin.settings.reviewer.dailyNewLimit,m=In(p,20);this.plugin.settings.reviewer.dailyNewLimit=m,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),u!==m&&this.queueSettingsNotice("reviewer.dailyNewLimit",`Daily new limit: ${ie(m)}`)})),new L.Setting(e).setName("Daily review limit").setDesc("Maximum due cards studied per day (per deck). 0 disables reviews.").addText(h=>h.setValue(String(this.plugin.settings.reviewer.dailyReviewLimit)).onChange(async p=>{let u=this.plugin.settings.reviewer.dailyReviewLimit,m=In(p,200);this.plugin.settings.reviewer.dailyReviewLimit=m,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),u!==m&&this.queueSettingsNotice("reviewer.dailyReviewLimit",`Daily review limit: ${ie(m)}`)}));let t=null;new L.Setting(e).setName("Auto-advance").setDesc("Automatically fails unanswered cards and advances after the timer.").addToggle(h=>h.setValue(this.plugin.settings.reviewer.autoAdvanceEnabled).onChange(async p=>{let u=this.plugin.settings.reviewer.autoAdvanceEnabled;this.plugin.settings.reviewer.autoAdvanceEnabled=p,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),t==null||t.setDisabled(!p),u!==p&&this.queueSettingsNotice("reviewer.autoAdvanceEnabled",`Auto-advance: ${p?"On":"Off"}`)})),t=new L.Setting(e).setName("Auto-advance after").setDesc("Seconds (applies to the reviewer and widget).").addSlider(h=>h.setLimits(3,60,1).setValue(Number(this.plugin.settings.reviewer.autoAdvanceSeconds)||10).setDynamicTooltip().onChange(async p=>{let u=this.plugin.settings.reviewer.autoAdvanceSeconds,m=Number(p)||10;this.plugin.settings.reviewer.autoAdvanceSeconds=m,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),u!==m&&this.queueSettingsNotice("reviewer.autoAdvanceSeconds",`Auto-advance: ${ie(m)}s`)})),t.setDisabled(!this.plugin.settings.reviewer.autoAdvanceEnabled),new L.Setting(e).setName("Grading buttons").setDesc("Choose two buttons (Again, Good) or four buttons (Again, Hard, Good, Easy).").addDropdown(h=>{var u;h.addOption("two","Two buttons"),h.addOption("four","Four buttons");let p=!!((u=this.plugin.settings.reviewer)!=null&&u.fourButtonMode);h.setValue(p?"four":"two"),h.onChange(async m=>{var b;let g=!!((b=this.plugin.settings.reviewer)!=null&&b.fourButtonMode),w=m==="four";this.plugin.settings.reviewer.fourButtonMode=w,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),this.refreshAllWidgetViews(),g!==w&&this.queueSettingsNotice("reviewer.gradingSystem",`Grading buttons: ${w?"Four":"Two"}`)})}),new L.Setting(e).setName("Skip button").setDesc("Shows a Skip button (Enter). Skip postpones within the session and does not affect scheduling.").addToggle(h=>{var u;let p=!!((u=this.plugin.settings.reviewer)!=null&&u.enableSkipButton);h.setValue(p),h.onChange(async m=>{var w;let g=!!((w=this.plugin.settings.reviewer)!=null&&w.enableSkipButton);this.plugin.settings.reviewer.enableSkipButton=m,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),g!==m&&this.queueSettingsNotice("reviewer.enableSkipButton",`Skip button: ${m?"On":"Off"}`)})}),new L.Setting(e).setName("Randomise MCQ options").setDesc("Shuffles MCQ options per card (stable during the session). Hotkeys follow the displayed order.").addToggle(h=>{var u;let p=!!((u=this.plugin.settings.reviewer)!=null&&u.randomizeMcqOptions);h.setValue(p),h.onChange(async m=>{var w;let g=!!((w=this.plugin.settings.reviewer)!=null&&w.randomizeMcqOptions);this.plugin.settings.reviewer.randomizeMcqOptions=m,await this.plugin.saveAll(),this.refreshReviewerViewsIfPossible(),g!==m&&this.queueSettingsNotice("reviewer.randomizeMcqOptions",`Randomise MCQ options: ${m?"On":"Off"}`)})}),e.createEl("h3",{text:"Widget"}),new L.Setting(e).setName("Treat folder notes as decks").setDesc("If enabled, a folder note studies cards from all notes in that folder and its subfolders.").addToggle(h=>{var u,m;let p=(m=(u=this.plugin.settings)==null?void 0:u.widget)==null?void 0:m.treatFolderNotesAsDecks;h.setValue(p!==!1),h.onChange(async g=>{var b,C,y,v;let w=(C=(b=this.plugin.settings)==null?void 0:b.widget)==null?void 0:C.treatFolderNotesAsDecks;(v=(y=this.plugin.settings).widget)!=null||(y.widget={}),this.plugin.settings.widget.treatFolderNotesAsDecks=g,await this.plugin.saveAll(),this.refreshAllWidgetViews(),this.refreshReviewerViewsIfPossible(),w!==g&&this.queueSettingsNotice("widget.treatFolderNotesAsDecks",`Folder notes: ${g?"On":"Off"}`)})}),e.createEl("h3",{text:"Scheduler (FSRS)"});let i=this.plugin.settings.scheduler,r=h=>{let p=Number(h);return Number.isFinite(p)?Number(p.toFixed(2)):NaN},o=(h,p)=>{if(!Array.isArray(h)||!Array.isArray(p)||h.length!==p.length)return!1;for(let u=0;u<h.length;u++)if(Number(h[u])!==Number(p[u]))return!1;return!0},a=[{key:"custom",label:"Custom",desc:"Keep your current values.",learning:[],relearning:[],retention:.9},{key:"relaxed",label:"Relaxed",desc:"Learning: 20m | Relearning: 20m | Retention: 0.88",learning:[20],relearning:[20],retention:.88},{key:"balanced",label:"Balanced",desc:"Learning: 10m, 1d | Relearning: 10m | Retention: 0.90",learning:[10,1440],relearning:[10],retention:.9},{key:"aggressive",label:"Aggressive",desc:"Learning: 5m, 30m, 1d | Relearning: 10m | Retention: 0.92",learning:[5,30,1440],relearning:[10],retention:.92}],l=()=>{var m,g;let h=(m=i.learningStepsMinutes)!=null?m:[],p=(g=i.relearningStepsMinutes)!=null?g:[],u=r(i.requestRetention);for(let w of a)if(w.key!=="custom"&&o(h,w.learning)&&o(p,w.relearning)&&r(w.retention)===u)return w.key;return"custom"},d=null,f=!1,c=()=>{var u,m;if(!d)return;let h=l();if(((m=(u=d.getValue)==null?void 0:u.call(d))!=null?m:d.value)!==h){f=!0;try{d.setValue(h)}finally{f=!1}}};new L.Setting(e).setName("Preset").setDesc("Apply a recommended configuration, or choose Custom to keep your current values.").addDropdown(h=>{d=h;for(let p of a)h.addOption(p.key,p.label);h.setValue(l()),h.onChange(async p=>{var b,C;if(f)return;let u=a.find(y=>y.key===p);if(!u)return;if(u.key==="custom"){this.queueSettingsNotice("scheduler.preset","FSRS preset: Custom");return}let m=((b=i.learningStepsMinutes)!=null?b:[]).slice(),g=((C=i.relearningStepsMinutes)!=null?C:[]).slice(),w=i.requestRetention;i.learningStepsMinutes=u.learning.slice(),i.relearningStepsMinutes=u.relearning.slice(),i.requestRetention=u.retention,await this.plugin.saveAll(),this.queueSettingsNotice("scheduler.preset",`FSRS preset: ${u.label}`,0),o(m,i.learningStepsMinutes)||this.queueSettingsNotice("scheduler.learningStepsMinutes",`Learning steps: ${ie(i.learningStepsMinutes)}`),o(g,i.relearningStepsMinutes)||this.queueSettingsNotice("scheduler.relearningStepsMinutes",`Relearning steps: ${ie(i.relearningStepsMinutes)}`),r(w)!==r(i.requestRetention)&&this.queueSettingsNotice("scheduler.requestRetention",`Requested retention: ${ie(i.requestRetention)}`),this.display()})}),new L.Setting(e).setName("Learning steps").setDesc("Minutes, comma-separated. Examples: 10  |  10,1440").addText(h=>{var p;return h.setValue(String(((p=i.learningStepsMinutes)!=null?p:[]).join(","))).onChange(async u=>{var w,b;let m=((w=i.learningStepsMinutes)!=null?w:[]).slice(),g=An(u);g.length&&(i.learningStepsMinutes=g),await this.plugin.saveAll(),c(),o(m,(b=i.learningStepsMinutes)!=null?b:[])||this.queueSettingsNotice("scheduler.learningStepsMinutes",`Learning steps: ${ie(i.learningStepsMinutes)}`)})}),new L.Setting(e).setName("Relearning steps").setDesc("Minutes, comma-separated. Used after lapses.").addText(h=>{var p;return h.setValue(String(((p=i.relearningStepsMinutes)!=null?p:[]).join(","))).onChange(async u=>{var w,b;let m=((w=i.relearningStepsMinutes)!=null?w:[]).slice(),g=An(u);g.length&&(i.relearningStepsMinutes=g),await this.plugin.saveAll(),c(),o(m,(b=i.relearningStepsMinutes)!=null?b:[])||this.queueSettingsNotice("scheduler.relearningStepsMinutes",`Relearning steps: ${ie(i.relearningStepsMinutes)}`)})}),new L.Setting(e).setName("Requested retention").setDesc("Target recall probability at review time. Typical: 0.85\u20130.95.").addSlider(h=>h.setLimits(.8,.97,.01).setValue(Di(Number(i.requestRetention)||.9,.8,.97)).setDynamicTooltip().onChange(async p=>{let u=r(i.requestRetention);i.requestRetention=Number(Number(p).toFixed(2)),await this.plugin.saveAll(),c(),u!==r(i.requestRetention)&&this.queueSettingsNotice("scheduler.requestRetention",`Requested retention: ${ie(i.requestRetention)}`)})),new L.Setting(e).setName("Reset scheduling").setDesc("Resets all cards to New and clears scheduling fields. Irreversible.").addButton(h=>h.setButtonText("Reset\u2026").onClick(()=>{new Pt(this.app,this.plugin).open()})),e.createEl("h3",{text:"Indexing"}),new L.Setting(e).setName("Ignore fenced code blocks").setDesc("Prevents indexing of cards inside ``` fenced code blocks.").addToggle(h=>h.setValue(this.plugin.settings.indexing.ignoreInCodeFences).onChange(async p=>{let u=this.plugin.settings.indexing.ignoreInCodeFences;this.plugin.settings.indexing.ignoreInCodeFences=p,await this.plugin.saveAll(),u!==p&&this.queueSettingsNotice("indexing.ignoreInCodeFences",`Ignore code blocks: ${p?"On":"Off"}`)})),e.createEl("h3",{text:"Danger zone"}),new L.Setting(e).setName("Delete all flashcards").setDesc("Deletes Boot Camp flashcards from notes and clears Boot Camp data. Irreversible.").addButton(h=>h.setButtonText("Delete\u2026").onClick(()=>{new Ft(this.app,this.plugin,async()=>{let p=Date.now(),{filesTouched:u,anchorsRemoved:m,cardsRemoved:g}=await this.deleteAllBootCampDataFromVault();await this.clearBootCampStore(),this.refreshAllWidgetViews(),this.refreshReviewerViewsIfPossible();let w=Math.max(0,Math.round((Date.now()-p)/100)/10);new L.Notice(`Boot Camp \u2013 Settings Updated
Deleted ${g} cards and ${m} anchors in ${u} files (${w}s)`)}).open()})),e.createEl("h3",{text:"Quarantined cards"}),e.createDiv({cls:"setting-item"}).createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-description",text:"Cards that could not be parsed. Open the source note to fix them."}),this.renderQuarantineList(e)}};function Li(n,s,e){return Math.max(s,Math.min(e,n))}function Fn(n,s){let t=(Array.isArray(n)?n:[]).map(i=>Number(i)).filter(i=>Number.isFinite(i)&&i>0);return t.length?t:s}function Pi(n){let s=globalThis==null?void 0:globalThis.structuredClone;return typeof s=="function"?s(n):JSON.parse(JSON.stringify(n))}var at=class extends j.Plugin{constructor(){super(...arguments);this.DEFAULT_SETTINGS=Z;this.defaultSettings=Z;this.defaults=Z;this._ribbonEl=null;this._ribbonMenu=null;this._menuOpen=!1;this._hoverCloseTimer=null;this._tooltipEl=null;this._tooltipTimer=null}_normaliseSettingsInPlace(){var i,r;let e=this.settings;(i=e.scheduler)!=null||(e.scheduler={}),e.scheduler.learningStepsMinutes=Fn(e.scheduler.learningStepsMinutes,Z.scheduler.learningStepsMinutes),e.scheduler.relearningStepsMinutes=Fn(e.scheduler.relearningStepsMinutes,Z.scheduler.relearningStepsMinutes),e.scheduler.requestRetention=Li(Number((r=e.scheduler.requestRetention)!=null?r:Z.scheduler.requestRetention),.8,.97);let t=["graduatingIntervalDays","easyBonus","hardFactor","minEase","maxEase","easeDeltaAgain","easeDeltaHard","easeDeltaEasy"];for(let o of t)o in e.scheduler&&delete e.scheduler[o]}async onload(){try{this._bc={VIEW_TYPE_REVIEWER:pe,VIEW_TYPE_WIDGET:G,VIEW_TYPE_BROWSER:he,BRAND:I,DEFAULT_SETTINGS:Z,deepMerge:$e,BootCampReviewerView:Re,BootCampWidgetView:De,BootCampCardBrowserView:Le,BootCampSettingsTab:Pe,syncQuestionBank:vt,AddCardModal:ke,ParseErrorModal:me};let e=await this.loadData()||{};this.settings=$e(Z,e.settings||{}),this._normaliseSettingsInPlace(),this.store=new Ye(this),await this.store.load(e),Wt(this),this.registerView(pe,t=>new Re(t,this)),this.registerView(G,t=>new De(t,this)),this.registerView(he,t=>new Le(t,this)),this.addSettingTab(new Pe(this.app,this)),this.addCommand({id:"boot-camp-open-reviewer",name:`${I}: Open Reviewer`,callback:async()=>this.openReviewerTab()}),this.addCommand({id:"boot-camp-open-browser",name:`${I}: Open Flashcard Browser`,callback:async()=>this.openBrowserTab()}),this.addCommand({id:"boot-camp-sync-bank",name:`${I}: Sync Question Bank`,callback:async()=>this._runSync()}),this.addCommand({id:"boot-camp-open-widget",name:`${I}: Open Sidebar Widget`,callback:async()=>this.openWidgetSafe()}),this._registerRibbonDropdown(),this.registerEvent(this.app.workspace.on("file-open",t=>{let i=t instanceof j.TFile?t:null;this.app.workspace.getLeavesOfType(G).forEach(r=>{var o,a;return(a=(o=r.view)==null?void 0:o.onFileOpen)==null?void 0:a.call(o,i)})})),this.app.workspace.onLayoutReady(()=>{this.app.workspace.getLeavesOfType(G).length===0&&this.openWidgetSafe()}),await this.saveAll(),console.log(`${I}: loaded`)}catch(e){console.error(`${I}: failed to load`,e),new j.Notice(`${I}: failed to load. See console for details.`)}}onunload(){this._clearHoverCloseTimer(),this._destroyRibbonMenu(),this._destroyTooltip()}_getActiveMarkdownFile(){let e=this.app.workspace.getActiveFile();return e instanceof j.TFile?e:null}_ensureEditingNoteEditor(){let e=this.app.workspace.getActiveViewOfType(j.MarkdownView);if(!e||typeof e.getMode=="function"&&e.getMode()!=="source")return null;let t=e.editor;return t?{view:e,editor:t}:null}openAddFlashcardModal(){if(!this._ensureEditingNoteEditor()){new j.Notice("Must be editing a note to add a flashcard");return}new ke(this.app,this).open()}async syncBank(){await this._runSync()}refreshAllViews(){this._refreshOpenViews()}async _runSync(){let e=await vt(this),t=(o,a,l)=>o===1?a:l,i="\u2022",r=["Sync complete:",`${i} ${e.newCount} ${t(e.newCount,"new flashcard","new flashcards")}`,`${i} ${e.updatedCount} ${t(e.updatedCount,"updated flashcard","updated flashcards")}`,`${i} ${e.sameCount} ${t(e.sameCount,"unmodified flashcard","unmodified flashcards")}`];e.idsInserted>0&&r.push(`${i} ${e.idsInserted} ${t(e.idsInserted,"ID inserted for new card","IDs inserted for new cards")}`),new j.Notice(r.join(`
`)),e.quarantinedCount>0&&new me(this.app,this,e.quarantinedIds).open(),this._refreshOpenViews()}async saveAll(){let e=await this.loadData()||{};e.settings=this.settings,e.store=this.store.data,await this.saveData(e)}_refreshOpenViews(){this.app.workspace.getLeavesOfType(pe).forEach(e=>{var t,i;return(i=(t=e.view)==null?void 0:t.onRefresh)==null?void 0:i.call(t)}),this.app.workspace.getLeavesOfType(G).forEach(e=>{var t,i;return(i=(t=e.view)==null?void 0:t.onRefresh)==null?void 0:i.call(t)}),this.app.workspace.getLeavesOfType(he).forEach(e=>{var t,i;return(i=(t=e.view)==null?void 0:t.onRefresh)==null?void 0:i.call(t)})}async resetSettingsToDefaults(){this.settings=Pi(Z),this._normaliseSettingsInPlace(),await this.saveAll(),this._refreshOpenViews()}async resetToDefaultSettings(){return this.resetSettingsToDefaults()}async resetDefaultSettings(){return this.resetSettingsToDefaults()}async loadDefaultSettings(){return this.resetSettingsToDefaults()}_isCardStateLike(e){return!e||typeof e!="object"||!(e.stage==="new"||e.stage==="learning"||e.stage==="review"||e.stage==="relearning"||e.stage==="suspended")?!1:typeof e.due=="number"&&typeof e.scheduledDays=="number"&&typeof e.reps=="number"&&typeof e.lapses=="number"&&typeof e.learningStepIndex=="number"}_resetCardStateMapInPlace(e,t){let i=0;for(let[r,o]of Object.entries(e)){if(!this._isCardStateLike(o))continue;let a={id:r,...o};e[r]=tn(a,t,this.settings),i++}return i}_looksLikeCardStateMap(e){if(!e||typeof e!="object"||Array.isArray(e))return!1;for(let t of Object.values(e))if(this._isCardStateLike(t))return!0;return!1}async resetAllCardScheduling(){let e=Date.now(),t=0,i=new Set,r=o=>{if(!(!o||typeof o!="object")&&!i.has(o)){i.add(o),this._looksLikeCardStateMap(o)&&(t+=this._resetCardStateMapInPlace(o,e));for(let a of Object.values(o))r(a)}};r(this.store.data),await this.saveAll(),this._refreshOpenViews(),new j.Notice(`${I}: reset scheduling for ${t} cards.`)}async openReviewerTab(){let e=this.app.workspace.getLeaf("tab");await e.setViewState({type:pe,active:!0}),this.app.workspace.revealLeaf(e)}async openBrowserTab(){let e=this.app.workspace.getLeaf("tab");await e.setViewState({type:he,active:!0}),this.app.workspace.revealLeaf(e)}async openWidgetSafe(){try{await this.openWidget()}catch(e){console.error(`${I}: failed to open widget`,e),new j.Notice(`${I}: failed to open widget. See console for details.`)}}async openWidget(){var i;let e=this.app.workspace.getLeavesOfType(G)[0];if(e){this.app.workspace.revealLeaf(e);return}let t=(i=this.app.workspace.getRightLeaf(!1))!=null?i:this.app.workspace.getRightLeaf(!0);t||(t=this.app.workspace.getLeaf("tab")),t&&(await t.setViewState({type:G,active:!0,state:{}}),this.app.workspace.revealLeaf(t))}_openBootCampSettings(){var t,i;let e=this.app;try{if(e!=null&&e.setting)typeof e.setting.open=="function"&&e.setting.open();else if((t=e==null?void 0:e.commands)!=null&&t.executeCommandById)try{e.commands.executeCommandById("app:open-settings")}catch(a){}let r=e==null?void 0:e.setting,o=(i=this.manifest)==null?void 0:i.id;if(r&&o){if(typeof r.openTabById=="function"){r.openTabById(o);return}if(typeof r.openTab=="function")try{r.openTab(o);return}catch(a){}}}catch(r){console.error(`${I}: failed to open settings`,r),new j.Notice(`${I}: Unable to open settings automatically. Open Settings \u2192 Community plugins \u2192 ${I}.`)}}_registerRibbonDropdown(){let e=this.addRibbonIcon("footprints",`${I} Menu`,()=>{});e.addClass("bc-ribbon-dropdown"),this._ribbonEl=e;let t=document.createElement("div");t.addClass("bc-ribbon-menu"),t.style.position="fixed",t.style.left="0px",t.style.top="0px",t.style.display="none",t.style.zIndex="10000",document.body.appendChild(t),this._ribbonMenu=t;let i=document.createElement("div");i.addClass("bc-ribbon-header"),i.textContent="Boot Camp Menu",t.appendChild(i);let r=(o,a,l)=>{let d=document.createElement("div");d.addClass("bc-ribbon-item");let f=document.createElement("span");f.addClass("bc-label"),f.textContent=o,d.appendChild(f),this.registerDomEvent(d,"mousedown",c=>{c.preventDefault(),c.stopPropagation(),this._closeRibbonMenu(),l()}),this.registerDomEvent(d,"mouseenter",()=>this._scheduleTooltip(d,a)),this.registerDomEvent(d,"mouseleave",()=>this._hideTooltip()),t.appendChild(d)};r("Start Study Session","Start revising your flashcards in a new tab.",()=>void this.openReviewerTab()),r("View All Flashcards","Browse, search, edit, and save flashcards back to their source notes.",()=>void this.openBrowserTab()),r("Sync Flashcard Database","Sync flashcards in your notes with the database.",()=>void this._runSync()),r("Add Flashcard to Note","Use a form to insert a new flashcard into the current note.",()=>this.openAddFlashcardModal()),r("Boot Camp Settings","View the Boot Camp settings.",()=>void this._openBootCampSettings()),this.registerDomEvent(e,"mousedown",o=>{o.preventDefault(),o.stopPropagation(),this._toggleRibbonMenu()}),this.registerDomEvent(e,"mouseenter",()=>this._openRibbonMenu()),this.registerDomEvent(e,"mouseleave",()=>this._scheduleCloseRibbonMenu()),this.registerDomEvent(t,"mouseenter",()=>{this._clearHoverCloseTimer(),this._hideTooltip()}),this.registerDomEvent(t,"mouseleave",()=>{this._hideTooltip(),this._scheduleCloseRibbonMenu()}),this.registerDomEvent(document,"mousedown",o=>{var l,d;if(!this._menuOpen)return;let a=o.target;a&&((l=this._ribbonEl)!=null&&l.contains(a)||(d=this._ribbonMenu)!=null&&d.contains(a)||this._closeRibbonMenu())},{capture:!0}),this.registerDomEvent(document,"keydown",o=>{o.key==="Escape"&&this._closeRibbonMenu()}),this.registerDomEvent(window,"resize",()=>{this._menuOpen&&(this._positionRibbonMenu(),this._repositionTooltip())}),this.registerDomEvent(window,"scroll",()=>{this._menuOpen&&(this._positionRibbonMenu(),this._repositionTooltip())})}_toggleRibbonMenu(){this._menuOpen?this._closeRibbonMenu():this._openRibbonMenu()}_openRibbonMenu(){!this._ribbonEl||!this._ribbonMenu||(this._clearHoverCloseTimer(),this._positionRibbonMenu(),this._ribbonMenu.style.display="block",this._ribbonMenu.addClass("is-visible"),this._menuOpen=!0)}_closeRibbonMenu(){this._ribbonMenu&&(this._clearHoverCloseTimer(),this._hideTooltip(),this._ribbonMenu.style.display="none",this._ribbonMenu.removeClass("is-visible"),this._menuOpen=!1)}_positionRibbonMenu(){if(!this._ribbonEl||!this._ribbonMenu)return;let e=this._ribbonEl.getBoundingClientRect(),t=this._ribbonMenu,i=t.style.display==="none";i&&(t.style.display="block");let r=t.getBoundingClientRect(),o=8,a=e.right+o,l=e.top,d=Math.min(Math.max(a,o),Math.max(o,window.innerWidth-r.width-o)),f=Math.min(Math.max(l,o),Math.max(o,window.innerHeight-r.height-o));t.style.left=`${d}px`,t.style.top=`${f}px`,i&&!this._menuOpen&&(t.style.display="none")}_scheduleCloseRibbonMenu(){this._clearHoverCloseTimer(),this._hoverCloseTimer=window.setTimeout(()=>this._closeRibbonMenu(),200)}_clearHoverCloseTimer(){this._hoverCloseTimer&&(window.clearTimeout(this._hoverCloseTimer),this._hoverCloseTimer=null)}_ensureTooltipEl(){if(this._tooltipEl)return this._tooltipEl;let e=document.createElement("div");return e.addClass("bc-ribbon-tooltip"),e.style.position="fixed",e.style.left="0px",e.style.top="0px",e.style.display="none",e.style.zIndex="10001",document.body.appendChild(e),this._tooltipEl=e,e}_scheduleTooltip(e,t){this._clearTooltipTimer(),this._tooltipTimer=window.setTimeout(()=>{if(!this._menuOpen)return;let i=this._ensureTooltipEl();i.textContent=t,i.style.display="block",this._positionTooltip(e)},800)}_positionTooltip(e){let t=this._tooltipEl;if(!t)return;let i=e.getBoundingClientRect();t.style.display==="none"&&(t.style.display="block");let o=t.getBoundingClientRect(),a=8,l=i.right+a;l+o.width+a>window.innerWidth&&(l=Math.max(a,i.left-o.width-a));let d=Math.min(Math.max(i.top,a),Math.max(a,window.innerHeight-o.height-a));t.style.left=`${l}px`,t.style.top=`${d}px`}_repositionTooltip(){this._hideTooltip()}_hideTooltip(){this._clearTooltipTimer(),this._tooltipEl&&(this._tooltipEl.style.display="none",this._tooltipEl.textContent="")}_clearTooltipTimer(){this._tooltipTimer&&(window.clearTimeout(this._tooltipTimer),this._tooltipTimer=null)}_destroyTooltip(){var e;this._clearTooltipTimer(),(e=this._tooltipEl)!=null&&e.parentElement&&this._tooltipEl.parentElement.removeChild(this._tooltipEl),this._tooltipEl=null}_destroyRibbonMenu(){var e;(e=this._ribbonMenu)!=null&&e.parentElement&&this._ribbonMenu.parentElement.removeChild(this._ribbonMenu),this._ribbonMenu=null,this._ribbonEl=null,this._menuOpen=!1}};
